# VCG/VIBE SSOT Design Master 設計調査レポート
# 作成日: 2026-01-12
# 対象: integrate/20260111 ブランチ
# 目的: DEEPリサーチ結果の統合・AI参照用整理

---

## 【メタ情報】
- 調査範囲: Part00〜Part20、glossary、decisions、checks
- 情報ソース: 複数LLMによるDEEPリサーチ結果
- 一次情報優先: 公式ドキュメント、GitHub、標準仕様を根拠とする

---

# ■■■ 第1部: 重大な矛盾・欠落（P0） ■■■

## P0-001: HumanGate承認者の定義が存在しない
- 場所: Part09.md セクション5.1.4
- 問題: 「人間による明示的な承認」の要件は定義されているが、「誰が」「どのタイミングで」「どの手法で」承認するかの具体例が一切記載されていない
- 関連: Part00 未決事項 U-0001「ADR承認フロー」が未解決
- 影響: 緊急時に承認者が特定できず、変更が永遠にブロックされる
- 根拠: GitHub Docs "About protected branches" (2025-12-15)

## P0-002: Verifyスクリプトが未実装
- 場所: checks/verify_repo.ps1
- 問題: Part10で「実装済み前提」としているが、実際のPowerShellコードが存在しない
- 影響: Part10の機械判定（V-0001〜V-0005）が動作しない、SSOT破壊を検知する品質ゲートが機能しない
- 根拠: Part10.md L.45-50（前提）、L.190-210（Fastモードの説明）

## P0-003: Evidence ファイル拡張子が Part10 と Part12 で矛盾
- Part10: YYYYMMDD_HHMMSS_<category>.txt と定義
- Part12: 同じ証跡ファイルを .md として参照
- 影響: 監査時にファイルが見つからず「証跡 lost」として FAIL 判定される

## P0-004: Part10とPart12の証跡保持方針が矛盾
- Part10 セクション6.3: 「最新PASS証跡1セットのみ保持」を推奨
- Part12 R-1201: 「Evidence保存義務」では「削除しない」と規定
- 影響: 運用時に「削除するべきか保持すべきか」判断不能

## P0-005: sources/改変禁止の検証手段が不完全
- 場所: Part10 V-0004
- 問題: `git diff` で検出と記載されているが、新規追加時に既存ファイルが改変されたかどうかの差分検出ロジックが不明確
- 影響: sources/改変が検知できず、SSOTの根拠が汚染されるリスク

## P0-006: MCPセキュリティが2025年スペックに準拠していない
- 場所: Part03.md
- 問題: 2025年6月のOAuth Resource Server分類・2025年11月のUser Consent必須化に未対応
- 根拠: MCP Spec 2025-11-25「Hosts must obtain explicit user consent」
- 影響: 本番運用時のセキュリティポリシー不整合、機密情報漏洩リスク

## P0-007: ADRテンプレートとStatus Indicatorが未定義
- 場所: Part14.md
- 問題: ADRテンプレート・Status（Proposed/Accepted/Deprecated/Superseded）・ライフサイクルが定義されていない
- 根拠: AWS ADR Best Practice (2025)、TechTarget (2025-06-19)
- 影響: decisions/に何を追加するか形式が不明確、古い決定がSupersededされずに共存

## P0-008: Glossary未定義用語の増殖
- 場所: glossary/GLOSSARY.md
- 未定義用語: VAULT、RELEASE、WORK、RFC、VIBEKANBAN、Context Pack、Patchset
- 影響: docs/で意味が曖昧、Verify（用語揺れチェック）が通らない、新規参加者が困惑

## P0-009: 用語集が複数箇所に存在
- 場所: docs/Part02 と glossary/GLOSSARY.md
- 問題: 用語を別々に定義しており、SSOT（一元管理）原則に反する
- 影響: 複数ソースの不整合リスク

## P0-010: Part14見出しの重複
- 問題: Part14が2回登場（ファイル行4699行と5089行）
- 影響: 番号の整合性が失われ、参照混乱の原因となる

---

# ■■■ 第2部: 改善推奨事項（P1/P2） ■■■

## 【P1: 高優先度改善】

### P1-001: HumanGate承認フローが定義されていない
- 場所: Part00 U-0001
- 問題: 「ADR承認フローが不明」のまま放置
- 改善案: Part00 セクション7（例外処理）にHumanGateフロー図を追加

### P1-002: MCP（Model Context Protocol）の具体的実装手順が不足
- 場所: Part03 R-0303
- 問題: Phase1〜3の概念のみで、具体的なツール選定・設定手順がない
- 改善案: 2026年1月時点のMCP対応ツール一覧と導入チェックリストを追加

### P1-003: FACTS_LEDGERの未決事項が整理されていない
- 問題: 部分ごとの「11. 未決事項」とFACTS_LEDGER.mdのU-XXXXセクションが対応不明確
- 改善案: 未決事項セクションを拡充し、優先度flag（高/中/低）を付与

### P1-004: Evidence Packの構成が曖昧
- 場所: Part01 R-0101
- 問題: format（diff/manifest/sha256/SBOM）・命名規則・保存パスが曖昧
- 改善案: Part12に Evidence Pack 標準 format を定義

### P1-005: CI/CD連携の明記
- 問題: GitHub ActionsなどCIツールとの連携が不明確
- 改善案: Verify GateをGitHub Actionsで自動実行・ブランチ保護による必須ステータスチェック化

### P1-006: SBOMフォーマットの規格化
- 推奨: OWASP CycloneDX v1.5を標準フォーマットとして採用
- 根拠: 業界標準のBOM形式、多くの企業・政府機関で採用

## 【P2: 中優先度改善】

### P2-001: セマンティック・バージョニング採用
- 改善案: SemVer (MAJOR.MINOR.PATCH) を明記
- 効果: 互換性破壊の変更でメジャーバージョンを上げる規則が明確化

### P2-002: AIエージェントの最新モデル活用
- 改善案: Core4やAI Packの説明に「最新かつ高性能なモデル優先使用」を追記
- 効果: AIによる誤作動・推論エラー低減

### P2-003: 連鎖的思考（Chain-of-Thought）の促進
- 改善案: 複雑タスクでAIにステップごとの思考過程を明示させる手法を運用手順に組み込む
- 効果: AIの誤判断減少、安全性・透明性向上

### P2-004: 1Part=1Branch原則がGitで強制されていない
- 場所: Part02 セクション5.2
- 改善案: Branch Protectionで feature/part-NN-* パターンのみ許可

### P2-005: 「軽量モデルの制限」の具体的検出方法がない
- 場所: Part03 R-0305
- 改善案: Git commit時のauthor情報を検証するpre-commit hookを提案

---

# ■■■ 第3部: 具体的修正案（Patch案） ■■■

## 修正案 #1: HumanGate承認フロー明確化

### ファイル: docs/Part09.md
### 追加位置: セクション5.1.4の後に新規セクション追加

```markdown
#### 5.1.5 HumanGate承認フロー

##### 承認者の指定
- プロジェクト開始時に以下の承認者を決定し decisions/0004-humangate-approvers.md に記録する:
  1. 主要承認者: プロジェクト責任者（最低1名）
  2. 代理承認者: 主要承認者が不在時の代理（最低1名）
  3. 緊急承認者: 24時間365日対応可能な担当者（任意）

##### 承認手順
1. 承認要求の作成: 操作内容・リスク・代替案を明確化
2. 承認者への通知: 主要承認者→代理承認者→緊急承認者の優先順位
3. 応答期限: 承認要求後24時間以内に応答がない場合、エスカレーション
4. 記録: 承認結果は evidence/humangate_approvals/ に保存

##### ADR承認フロー
- ADR作成者 ≠ 承認者の原則: 自己承認禁止
- 承認判断基準:
  1. Part00との整合性があるか
  2. 影響範囲分析が十分か
  3. ロールバック手順が明確か
- 承認後: ADRステータスを「承認済み」に更新し、docs/更新を許可
```

### 理由: HumanGateとADR承認フローを具体的に定義し、Part00の未決事項U-0001を解決

---

## 修正案 #2: Part10とPart12の矛盾解消

### ファイル: docs/Part10.md
### 変更: セクション6.3「証跡の保持・削除ルール」を置換

```markdown
### 6.3 証跡の保持・削除ルール

#### 原則: 証跡は削除しない
- MUST: 全てのVerify証跡は evidence/verify_reports/ に永続保存する（Part12 R-1201に準拠）
- SHOULD: Git管理下に置き、リポジトリ履歴として追跡可能とする

#### 整理ルール
- 推奨: 証跡ファイルが多すぎる場合、年代別フォルダで整理
  - evidence/verify_reports/2026/01/ のように月次フォルダを作成
- 禁止: 証跡ファイルの手動削除（Git履歴からの削除も禁止）
- 例外: 誤生成されたFAIL証跡は未追跡のまま放置可

#### Part12との整合性
本ルールは Part12「Evidence運用」の R-1201「Evidence保存義務」を具体化したものである。
証跡削除の必要性が生じた場合は、先に decisions/ にADRを追加し、Part00 R-0002「変更手順」に従うこと。
```

### 理由: Part10とPart12の証跡保持方針を統一し、運用時の混乱を防止

---

## 修正案 #3: MCPセキュリティコンプライアンス追加

### ファイル: docs/Part03.md
### 追加位置: Section 5 に新規ルール R-0304 を追加

```markdown
#### R-0304: MCPセキュリティコンプライアンス【MUST】

##### User Consent（明示的opt-in）
- MCPツール使用前にユーザーの明示的同意を取得する
- 同意記録は evidence/mcp_consent/ に保存する

##### Data Privacy Boundary
- docs/: アクセス許可（ReadOnly）
- sources/: アクセス禁止（機密情報混入リスク）
- VAULT/: アクセス禁止（暗号化必須領域）

##### Tool Safety Gate
- 実行前確認フロー: MCPツール実行前にリスク評価を実施
- 高リスク操作: HumanGate承認必須
- 中リスク操作: Dry-run + diff確認
- 低リスク操作: Auto-approve可能

##### OAuth 2.1 + RFC 8707 Compliance
- 認証: OAuth 2.1準拠
- Resource Indicator: RFC 8707に基づくリソース指定
```

### 理由: MCP Spec 2025-11-25準拠、セキュリティポリシー整合

---

## 修正案 #4: ADRテンプレート作成

### ファイル: decisions/ADR_TEMPLATE.md（新規作成）

```markdown
# ADR-XXXX: [タイトル]

## Status
- [ ] Proposed
- [ ] Accepted
- [ ] Deprecated
- [ ] Superseded by ADR-YYYY

## Context
[決定が必要になった背景・状況]

## Decision
[決定内容]

## Rationale
[決定の理由・根拠]

## Consequences
### Positive
- [利点1]
- [利点2]

### Negative
- [欠点・リスク1]
- [欠点・リスク2]

## Supersedes
- なし / ADR-ZZZZ

## Related
- Part: [関連Part]
- ADR: [関連ADR]
- Issue: [関連Issue]

## Approval
- 作成者: 
- 作成日: 
- 承認者: 
- 承認日: 
```

### 理由: ADR形式を標準化し、Part14 R-1402の強制力を担保

---

## 修正案 #5: Glossary未定義用語の定義追加

### ファイル: glossary/GLOSSARY.md
### 追加位置: 用語セクション末尾

```markdown
## 追加定義（2026-01-12）

### VAULT
- 定義: 機密情報暗号化フォルダ
- 構造: sources/とは別の隔離領域
- 用途: APIキー、認証情報、個人情報等の保管
- 暗号化: git-crypt/age/OpenSSLのいずれかを使用
- アクセス権限: HumanGate承認必須

### RELEASE
- 定義: 不変成果物フォルダ
- 構造: RELEASE/RELEASE_YYYYMMDD_HHMMSS/
- 用途: 凍結された成果物の保管
- 属性: Read-Only、sha256チェックサム、SBOM付与
- 参照Part: Part13

### VIBEKANBAN
- 定義: タスク管理ダッシュボード
- 構造: 000_INBOX → 100_SPEC → 200_BUILD → 300_VERIFY → 400_REPAIR → 900_RELEASE
- 用途: 作業状態の可視化、並列タスク管理
- 参照Part: Part04

### RFC (Request for Comments)
- 定義: 変更提案の初期段階ドキュメント
- 用途: ADR作成前の議論・検討フェーズ
- ステータス: Draft → Review → ADR化 or Rejected

### Patchset
- 定義: 最小差分単位
- 原則: 1つのPatchsetは1つの目的のみを達成する
- 用途: 変更の原子性担保、レビュー効率化

### Context Pack
- 定義: MCPメタデータパッケージ
- 構造: JSON形式でツール情報・実行コンテキストを格納
- 保存先: evidence/context_packs/
- 用途: AI間のコンテキスト共有、再現性担保

### WORK
- 定義: スパイク用隔離フォルダ
- 用途: 実験的実装、PoC（Proof of Concept）
- 原則: 成果は別途Specへ移す、mainにマージしない
```

### 理由: 未定義用語を解消し、新規参加者の理解を促進

---

## 修正案 #6: sources/改変検出スクリプト実装

### ファイル: checks/verify_sources_integrity.ps1（新規作成）

```powershell
<#
.SYNOPSIS
    sources/ ディレクトリの改変を検出するVerify Gate
.DESCRIPTION
    Part00 R-0003「sources/改変・削除禁止」の機械判定実装
#>

param(
    [string]$RepoPath = ".",
    [switch]$Verbose
)

function Test-SourcesIntegrity {
    param([string]$Path)
    
    $failureCount = 0
    
    # Check 1: Modified files detection
    $modifiedFiles = git diff HEAD~1 HEAD --name-only -- sources/
    if ($modifiedFiles) {
        Write-Host "[FAIL] sources/ に改変が検出されました:" -ForegroundColor Red
        $modifiedFiles | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
        $failureCount++
    }
    
    # Check 2: Deleted files detection
    $deletedFiles = git diff HEAD~1 HEAD --diff-filter=D --name-only -- sources/
    if ($deletedFiles) {
        Write-Host "[FAIL] sources/ でファイル削除が検出されました:" -ForegroundColor Red
        $deletedFiles | ForEach-Object { Write-Host "  - $_" -ForegroundColor Yellow }
        $failureCount++
    }
    
    # Check 3: Append-only validation (新規追加は許可)
    $addedFiles = git diff HEAD~1 HEAD --diff-filter=A --name-only -- sources/
    if ($addedFiles) {
        Write-Host "[INFO] sources/ に新規ファイルが追加されました（許可）:" -ForegroundColor Green
        $addedFiles | ForEach-Object { Write-Host "  + $_" -ForegroundColor Green }
    }
    
    if ($failureCount -eq 0) {
        Write-Host "[PASS] sources_integrity: 改変なし" -ForegroundColor Green
        return $true
    } else {
        Write-Host "[FAIL] sources_integrity: $failureCount 件の違反" -ForegroundColor Red
        return $false
    }
}

# 実行
$result = Test-SourcesIntegrity -Path $RepoPath

# Evidence出力
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$evidencePath = "evidence/verify_reports/${timestamp}_sources_integrity.md"
$status = if ($result) { "PASS" } else { "FAIL" }

@"
# sources/ Integrity Check
- 実行日時: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
- 結果: $status
- 検証コミット: $(git rev-parse HEAD)
"@ | Out-File $evidencePath -Encoding utf8

if (-not $result) { exit 1 }
```

### 理由: Part00 R-0003の機械判定を実装し、sources/改変を自動検出
