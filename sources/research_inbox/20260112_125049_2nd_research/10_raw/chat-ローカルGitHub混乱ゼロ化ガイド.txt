### USER

---

## ③ ツール使い分け・小さな修正（ローカル/GitHub混乱ゼロ化 + 実装パッチ案）
```text
あなたは「運用Runbook化＆小さな改善（混乱ゼロ化）」担当です。
添付の DESIGN_MASTER と調査レポート Part1-3 を読んで、次を作ってください。

目的：
- “ローカルで何をして、GitHubで何をするか”を、誰でも迷わないレベルまで落とす。
- 小さな表記・リンク・手順のズレを洗い出し、修正パッチ案にする。

必須テーマ：
1) ローカル/IDE/CLI/GitHub の役割分担（やっていいこと/ダメなこと）
2) ブランチ運用（main / integrate / feature）、PR、マージ方式、復旧手順
3) Verify Gate の走らせ方（ローカル/CI）と、証跡の扱い（md、recent-3）
4) “混乱ポイント”を想定したFAQ（10項目以上）

出力フォーマット：
A. 役割分担の最終版（1枚で分かる表：場所×作業×責任×証跡）
B. 一本道Runbook（手順を番号で：迷う分岐はYes/Noにする）
C. 修正候補リスト（軽微な表記、リンク、手順、矛盾：優先度付き）
D. 可能なら「repoへ入れるパッチ案」：どのファイルにどう追記/修正するか（差分の形でもOK）
E. 参照URL（必要なら）


### ASSISTANT
# VCG/VIBE SSOT 運用Runbook & 混乱ゼロ化パッチ

## A. 役割分担の最終版（1枚で分かる表）

| 場所/ツール | やっていいこと | ダメなこと | 責任 | 証跡 |
|-------------|--------------|-----------|------|------|
| **ローカル環境** | • ブランチ作成・切り替え<br>• コーディング・編集<br>• Fast Verify実行<br>• Conflict解決 | • mainブランチ直接操作<br>• sources/の編集（追記のみ可）<br>• ローカルでFast Verify FAILのコミット | 作業者 | • evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_*.md<br>• pre-commit hookによる自動検証 |
| **IDE (VS Code等)** | • ファイル編集<br>• Git操作UI利用<br>• MCPツール実行（ReadOnly）<br>• RAG検索 | • sources/の削除・編集<br>• mainへ直接コミット/プッシュ<br>• 禁止コマンド実行（rm -rf, git push --force） | 作業者 | • IDE操作ログ（自動記録なし）<br>• コミットメッセージ |
| **CLI (ターミナル)** | • Git操作（push/pull/merge/rebase）<br>• Fast/Full Verify実行<br>• pre-commit hook検証<br>• Evidence整理 | • sources/の強制削除<br>• 承認なしのgit reset --hard<br>• 外部ツールの危険なコマンド実行 | 作業者 | • コマンド履歴<br>• スクリプト実行ログ |
| **GitHub (WebUI)** | • PR作成・レビュー<br>• Issue管理<br>• Discussions<br>• CI/CDパイプライン確認<br>• ブランチ保護設定 | • main/integrateへの直接編集<br>• 承認なしのマージ<br>• 保護ブランチへのforce push | レビュアー/承認者 | • PRレビューログ<br>• CI/CD実行結果<br>• Auditログ |
| **CI/CD (GitHub Actions)** | • Full Verify自動実行<br>• ブランチ保護ルール適用<br>• マージ条件の自動検証<br>• Evidenceアーカイブ処理 | • HumanGate承認スキップ<br>• エラー発生時の自動マージ<br>• 権限昇格 | システム | • GitHub Actionsログ<br>• evidence/verify_reports/YYYYMMDD_HHMMSS_Full_*.md |

## B. 一本道Runbook（迷わない手順）

### 【Phase 0】環境準備
1. リポジトリをクローン:
   ```bash
   git clone https://github.com/your-org/vibe-spec-ssot.git
   cd vibe-spec-ssot
   ```
2. Git Hooksを有効化:
   ```bash
   chmod +x .git/hooks/pre-commit
   ```
3. Verifyスクリプトの実行権限付与:
   ```bash
   chmod +x checks/verify_*.ps1
   ```

### 【Phase 1】タスク開始
1. 新しいタスクをVIBEKANBANに登録 → YES/NO: 
   - YES: VIBEKANBAN/000_INBOX/に新規チケット作成
   - NO: 既存タスクを選択
2. ブランチ作成 → YES/NO: 新しいfeatureブランチが必要か？
   - YES:
     ```bash
     git fetch origin main
     git checkout -b feat/<チケットID>-<説明> origin/main
     ```
   - NO: 既存ブランチをチェックアウト
3. 作業範囲確認 → YES/NO: docs/の編集が必要か？
   - YES: ADRの必要性を確認
   - NO: 次へ進む

### 【Phase 2】ローカル作業
1. 編集対象確認 → YES/NO: PartXX.mdを編集するか？
   - YES: 1Part=1Branch原則確認
   - NO: sources/編集の場合は追記のみ
2. 実装・編集実行
3. Fast Verify実行:
   ```bash
   pwsh ./checks/verify_repo.ps1 -Mode Fast
   ```
4. 結果確認 → YES/NO: 全てPASSか？
   - YES: 次へ進む
   - NO: 失敗箇所を修正して再実行
5. コミット作成:
   ```bash
   git add .
   git commit -m "feat(PartXX): 説明文"
   ```

### 【Phase 3】PR作成・マージ
1. リモート最新状態に追従:
   ```bash
   git fetch origin main
   git rebase origin/main
   ```
2. 競合解決 → YES/NO: 競合が発生したか？
   - YES: 競合解決 → Fast Verify再実行
   - NO: 次へ進む
3. リモートブランチへプッシュ:
   ```bash
   git push -u origin feat/<チケットID>-<説明>
   ```
4. PR作成:
   ```bash
   gh pr create --base integrate --head feat/<チケットID>-<説明> --title "feat(PartXX): 説明文"
   ```
5. レビュー待ち → YES/NO: レビュー承認とCI/CDパスか？
   - YES: マージ方法選択
   - NO: フィードバック対応
6. マージ方法選択 → YES/NO: 複数コミットがあるか？
   - YES: "Squash and merge"
   - NO: "Rebase and merge"

### 【Phase 4】リリース準備
1. integrateブランチでの確認:
   - Full Verify実行
   - HumanGate承認取得
2. リリース準備 → YES/NO: 問題なし？
   - YES: mainへのマージ
   - NO: 修正ブランチ作成
3. mainマージ:
   ```bash
   git checkout main
   git pull origin main
   git merge --no-ff integrate
   git push origin main
   ```
4. タグ作成:
   ```bash
   git tag -a v1.2.3 -m "Release v1.2.3"
   git push origin v1.2.3
   ```

### 【緊急復旧手順】
→ YES/NO: 誤マージが発生したか？
- YES: ローカルのみ → `git merge --abort`
- YES: リモートに反映済み → `git revert -m 1 <マージコミットハッシュ>`
- NO: 正常継続

## C. 修正候補リスト（優先度付き）

### 【P0：即時対応（24時間以内）】
1. **Verifyスクリプトの未実装** (P0-002)
   - 現状: checks/verify_repo.ps1が存在しない
   - 影響: 全ての機械的検証が動作せず
   - 対応: Part3の9.1実装スクリプトをチェック

2. **HumanGate承認者の定義不足** (P0-001)
   - 現状: Part09.mdに「誰が承認するか」が不明
   - 影響: 緊急時に承認フローが停止
   - 対応: 修正案#1を適用

3. **Evidence拡張子の矛盾** (P0-003)
   - 現状: Part10(.txt)とPart12(.md)で拡張子不一致
   - 対応: 全て.mdに統一

4. **sources/改変検出ロジック未実装** (P0-005)
   - 現状: Part10のV-0004が未実装
   - 対応: 修正案#6を適用

5. **MCPセキュリティ不整合** (P0-006)
   - 現状: 2025年11月MCP必須要件に未対応
   - 対応: 修正案#3を適用

### 【P1：高優先度（1週間以内）】
6. **ADRテンプレート未定義** (P0-007)
   - 現状: decisions/に何を追加するか形式不明
   - 対応: 修正案#4を適用

7. **Glossary分散** (P0-009, P0-010)
   - 現状: docs/Part02とglossary/GLOSSARY.mdの二重管理
   - 対応: 一方に統合、他方を削除

8. **証跡保持方針の矛盾** (P0-004)
   - 現状: Part10(最新1セットのみ)とPart12(削除禁止)の矛盾
   - 対応: 修正案#2を適用

9. **ブランチ命名規則の明記不足** (P1-1)
   - 現状: feat/123とfeature/fix-bugが混在
   - 対応: 5.2の3層ブランチ戦略を明記

10. **PRテンプレート未整備** (P1-5)
    - 現状: PR作成時に何を書くべきか不明
    - 対応: .github/PULL_REQUEST_TEMPLATE.md作成

### 【P2：中優先度（1ヶ月以内）】
11. **VIBEKANBAN構造の明確化** (P2-1)
    - 現状: 000_INBOX～900_RELEASEの詳細なルール未定義
    - 対応: 各ステージの入出基準を明記

12. **Evidenceアーカイブ処理未自動化** (P1-3)
    - 現状: recent-3ポリシーが手動
    - 対応: Part3の9.3スクリプトをCIに組み込み

13. **SBOMフォーマット未標準化** (P1-006)
    - 現状: 複数フォーマット候補
    - 対応: CycloneDX v1.5を標準に採用

14. **コンフリクトマーカー検出未実装** (P0-3)
    - 現状: 競合発生時の自動検出なし
    - 対応: 5.4のConflict Marker検出をVerify Gateに追加

15. **APIコスト監視の仕組みなし** (U-2101)
    - 現状: AIツール利用コストの可視化なし
    - 対応: evidence/metrics/api_cost.csvへの自動記録

## D. repoへ入れるパッチ案

### パッチ案 #1: PRテンプレートの作成
```diff
# ファイル: .github/PULL_REQUEST_TEMPLATE.md（新規作成）
+ ## 変更の概要
+ - [ ] このPRの目的を簡潔に説明
+ 
+ ## 関連するPart/ADR
+ - Part: [対象Part番号]
+ - ADR: [関連ADR番号、なければ"なし"]
+ - Issue: #[関連Issue番号、なければ"なし"]
+ 
+ ## 変更内容の詳細
+ - [ ] 変更点を箇条書きで記載
+ - [ ] 変更理由を明記
+ 
+ ## 検証結果
+ - [ ] Fast Verify: [PASS/FAIL]（証跡ファイル: evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_*.md）
+ - [ ] Conflictチェック: [PASS/FAIL]
+ - [ ] 用語揺れチェック: [PASS/FAIL]
+ 
+ ## HumanGate承認（必要時）
+ - [ ] 承認者: [名前]
+ - [ ] 承認日: [日付]
+ - [ ] 承認証跡: [ファイルパス]
+ 
+ ## マージ後のTODO
+ - [ ] 確認すべき項目を記載
+ - [ ] 後続タスクがあれば記載
```

### パッチ案 #2: ブランチ命名規則の明記
```diff
# ファイル: docs/Part02.md
## 5.2 Git運用の詳細ルール
### ブランチ命名規則
- ✅ 許可される形式:
  - `feat/<issue-id>-<description>`: 機能追加（例: feat/123-add-user-auth）
  - `bugfix/<issue-id>-<description>`: バグ修正
  - `hotfix/<issue-id>-<description>`: 緊急修正（HumanGate承認必須）
  - `spike/<issue-id>-<description>`: 調査・PoC
  - `integrate`: 統合ブランチ（固定名）
- ❌ 禁止される形式:
  - `feature/<description>`（issue-idなし）
  - `fix/<description>`（issue-idなし）
  - `main`以外のprotected branchへの直接push

# ファイル: .github/branch-protection.yml（新規作成）
+ branch_protection_rules:
+   - branch: main
+     required_pull_request_reviews:
+       required_approving_review_count: 2
+       require_code_owner_reviews: true
+     required_status_checks:
+       strict: true
+       contexts: ["Fast Verify", "Full Verify", "HumanGate Approval"]
+     enforce_admins: true
+     required_linear_history: true
+     allow_force_pushes: false
+     allow_deletions: false
+     
+   - branch: integrate
+     required_pull_request_reviews:
+       required_approving_review_count: 1
+       require_code_owner_reviews: true
+     required_status_checks:
+       strict: true
+       contexts: ["Fast Verify", "Full Verify"]
+     enforce_admins: true
```

### パッチ案 #3: Evidence命名規則の統一
```diff
# ファイル: docs/Part10.md
### 6.2 証跡ファイルの命名規則
- ✅ 標準フォーマット: `YYYYMMDD_HHMMSS_<verify-mode>_<status>.md`
+ 例: `20260111_230526_Fast_PASS.md`
+ 例: `20260111_231500_Full_FAIL.md`
- ✅ 拡張子: 全ての証跡ファイルは`.md`（Markdown）とする
- ❌ `.txt`拡張子の使用禁止（Part12 R-1201との整合性確保）

# ファイル: docs/Part12.md
### R-1201 Evidence保存義務
- 現在: 「証跡は削除しない」
+ 更新: 
+ 1. 全ての証跡は`evidence/`以下に`.md`拡張子で保存する
+ 2. 基本原則: 証跡は削除しない
+ 3. 例外: `evidence/verify_reports/`はrecent-3ポリシーを適用
+    - 最新3件のみ保持
+    - 古いファイルは`evidence/archive/YYYY/`に自動移動
+ 4. 削除が必要な場合は、ADRを作成し、Part00 R-0002に従って承認を得る
```

### パッチ案 #4: コンフリクトマーカー検出の追加
```diff
# ファイル: checks/verify_repo.ps1
# 関数Test-ConflictMarkersを追加
function Test-ConflictMarkers {
    # Fast-5: Conflict Marker 検出
    $markers = Select-String -Path docs/*.md, checks/*.ps1, evidence/*.md -Pattern '<<<<<<<|=======' -Quiet
    if ($markers) {
        Write-Host "[FAIL] conflict_markers: Conflict markers found" -ForegroundColor Red
        # 詳細表示
        $conflictFiles = Get-ChildItem -Path docs, checks, evidence -Recurse -Include *.md, *.ps1 |
            Where-Object { Select-String -Path $_.FullName -Pattern '<<<<<<<|=======' -Quiet }
        foreach ($file in $conflictFiles) {
            Write-Host "  - $($file.FullName)" -ForegroundColor Yellow
        }
        return $false
    } else {
        Write-Host "[PASS] conflict_markers: No conflict markers" -ForegroundColor Green
        return $true
    }
}

# ファイル: .git/hooks/pre-commit
# 先頭に追加
#!/bin/sh
# sources/ 保護 & Conflict Marker 検出
# 1. sources/ 改変禁止
MODIFIED_SOURCES=$(git diff --cached --name-only | grep '^sources/')
if [ -n "$MODIFIED_SOURCES" ]; then
    echo "[ERROR] sources/ の改変は禁止されています:"
    echo "$MODIFIED_SOURCES"
    echo "追記のみ許可されています。"
    exit 1
fi

# 2. Conflict Marker 検出
CONFLICT_MARKERS=$(git diff --cached --name-only | xargs grep -l '<<<<<<<\|=======' 2>/dev/null)
if [ -n "$CONFLICT_MARKERS" ]; then
    echo "[ERROR] Conflict markers が検出されました:"
    echo "$CONFLICT_MARKERS"
    exit 1
fi

# 3. Fast Verify 実行
pwsh ./checks/verify_repo.ps1 -Mode Fast
if [ $? -ne 0 ]; then
    echo "[ERROR] Verify FAIL: コミットを中止します"
    exit 1
fi
exit 0
```

## E. 参照URL

1. **GitHub Branch Protection 設定**
   - URL: https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches
   - 参照理由: ブランチ保護ルールの公式ドキュメント

2. **MCP Security Specification 2025-11-25**
   - URL: https://modelcontextprotocol.io/spec/security/2025-11-25
   - 参照理由: User Consent必須化の根拠

3. **CycloneDX SBOM Standard**
   - URL: https://cyclonedx.org/
   - 参照理由: SBOMフォーマット標準化の根拠

4. **Semantic Versioning 2.0.0**
   - URL: https://semver.org/
   - 参照理由: バージョニング規則の標準

5. **Git Hooks Documentation**
   - URL: https://git-scm.com/docs/githooks
   - 参照理由: pre-commit hook実装の公式情報

6. **PowerShell Best Practices**
   - URL: https://learn.microsoft.com/en-us/powershell/scripting/dev-cross-plat/performance/script-authoring-considerations
   - 参照理由: Verifyスクリプト実装の品質確保

7. **AWS ADR Best Practice**
   - URL: https://aws.amazon.com/blogs/devops/architecture-decision-records-the-what-and-the-why-of-architecture-decisions/
   - 参照理由: ADRテンプレートの標準化

8. **UK GDS ADR Framework**
   - URL: https://gds-way.cloudapps.digital/standards/architecture-decision-record.html
   - 参照理由: ADRライフサイクル管理のベストプラクティス

---

## 混乱ポイントFAQ（10項目以上）

**Q1: ローカルでFast Verify FAILなのにコミットしてもいいですか？**  
A: 絶対にダメです。pre-commit hookで自動ブロックされます。FAILの原因を修正し、PASSになるまでコミットできません。

**Q2: sources/フォルダに新規ファイルを追加できますか？**  
A: はい、追加のみ可能です。既存ファイルの編集・削除は禁止です。追加時はFast Verifyのsources_integrityチェックにPASSする必要があります。

**Q3: 緊急でmainに直接修正を入れたい場合は？**  
A: できません。緊急時でもfeature/hotfixブランチを作成し、HumanGate承認（緊急承認者）を得てからintegrate→mainとマージします。

**Q4: PRレビューで修正依頼を受けた場合の手順は？**  
A: 1. ローカルブランチに修正を追加 2. Fast Verify実行 3. git pushで更新 4. PRコメントで対応完了を通知。レビュアーの再承認待ち。

**Q5: integrateブランチでコンフリクトが発生した場合は？**  
A: 1. featureブランチに戻りmainをrebase 2. 競合解決 3. 再度Fast Verify 4. PRを更新。integrateブランチでの直接解決は禁止。

**Q6: Evidenceファイルが多すぎてディスク容量が心配です**  
A: evidence/verify_reports/はrecent-3ルールが適用され、古いファイルは自動でevidence/archive/に移動されます。削除は必要ありません。

**Q7: AIツールを実行した時の証跡はどう保存すればいいですか？**  
A: MCPツール実行時は自動でevidence/mcp_logs/に記録されます。手動実行の場合は、コマンドと結果をevidence/context_packs/に保存してください。

**Q8: HumanGate承認者が不在で緊急対応が必要な場合は？**  
A: 1. 緊急連絡手段（Slack/Teams）で代理承認者に連絡 2. 72時間応答なしの場合は自動エスカレーション 3. Part19のEmergencyApproverプロトコルを参照。

**Q9: ローカルでgit resetしてしまった場合の復旧方法は？**  
A: ローカルのみの場合: `git reflog`でコミットハッシュを確認し、`git reset --hard <ハッシュ>`で復旧。リモートに影響を与えた場合はrevertを使用。

**Q10: 新しいAIツールを使いたいがPermission Tierが不明です**  
A: 新規ツールはまずPatchOnly権限でテスト実行し、security reviewを経て承認を得てから使用します。未承認ツールの実行はAuditログで記録されます。

**Q11: PRマージ後に重大なバグを発見した場合は？**  
A: 1. revertコミットを作成 2. evidence/incidents/に記録 3. 新規ADRを作成して再発防止策を策定 4. 修正ブランチを作成し通常フローで再マージ。

**Q12: 証跡ファイルの拡張子に迷います（.txt vs .md）**  
A: 全ての証跡ファイルは.md拡張子で統一しています。.txt拡張子の使用は禁止です。

**Q13: 外部リンクの死活チェックはどのタイミングで実行されますか？**  
A: Fast Verifyでは内部リンクのみをチェックします。外部リンクチェックはFull Verify（CI/CD実行時）で実施されます。

**Q14: ADRとRFCの違いは何ですか？**  
A: RFC（Request for Comments）は変更提案の初期検討フェーズ、ADR（Architectural Decision Record）は決定が確定した後の正式記録です。RFC→ADRの流れを推奨します。

### USER
深堀してください。

### ASSISTANT
# VCG/VIBE SSOT 運用Runbook 深堀版

## A. 役割分担の最終版（詳細拡充）

### **ローカル環境とGitHubの境界線を厳格化**

| 場所/ツール | やっていいこと | ダメなこと | 責任 | 証跡 | 例外処理 |
|-------------|--------------|-----------|------|------|----------|
| **ローカル環境** | • ブランチ作成・切り替え<br>• コーディング・編集<br>• **Fast Verify実行（必須）**<br>• Conflict解決<br>• **pre-commit hookによる自動検証** | • mainブランチ直接操作<br>• sources/の編集（追記のみ可）<br>• **Verify FAILのコミット**<br>• 検証なしのgit push | 作業者<br>（AIエージェント含む） | • evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_*.md<br>• pre-commit hook実行ログ<br>• **evidence/mcp_logs/にMCP実行記録** | • 緊急時: 管理者承認を得て<br>  `git commit --no-verify`<br>• 検証後にADR作成必須 |
| **IDE (VS Code)** | • ファイル編集<br>• Git操作UI利用<br>• **MCPツール実行（ReadOnlyのみ）**<br>• RAG検索<br>• **.mcp/config.jsonで権限設定** | • sources/操作（検索のみ）<br>• mainへ直接コミット/プッシュ<br>• **禁止コマンド実行**<br>（rm -rf, git push --force） | 作業者 | • IDE操作ログ（自動記録なし）<br>• コミットメッセージ<br>• **evidence/context_packs/にコンテキスト保存** | • 1人1アカウント原則<br>• 共有端末使用時は<br>  `git config --local` で設定分離 |
| **CLI (ターミナル)** | • Git操作（push/pull/merge/rebase）<br>• Fast/Full Verify実行<br>• pre-commit hook検証<br>• Evidence整理<br>• **.git/hooks/設定変更（管理者のみ）** | • sources/の強制削除<br>• 承認なしのgit reset --hard<br>• **MCP Toolの無制限実行**<br>• 保護ブランチへの直接操作 | 作業者<br>（管理者は権限昇格可） | • コマンド履歴（~/.bash_history）<br>• スクリプト実行ログ<br>• **evidence/audit/に操作記録** | • 災害復旧時のみ管理者が<br>  権限昇格可能<br>• 事後報告義務あり |
| **GitHub (WebUI)** | • PR作成・レビュー<br>• Issue管理<br>• Discussions<br>• **CI/CDパイプライン確認**<br>• **Branch protection設定（管理者）** | • main/integrateへの直接編集<br>• 承認なしのマージ<br>• **保護ブランチへのforce push**<br>• マージコミットの削除 | レビュアー/承認者<br>（管理者は設定変更可） | • PRレビューログ<br>• CI/CD実行結果<br>• **Auditログ（90日保持）**<br>• evidence/humangate_approvals/ | • 緊急ホットフィックス時:<br>  管理者が一時的にルール緩和<br>• 24時間以内に復旧必須 |
| **CI/CD (GitHub Actions)** | • Full Verify自動実行<br>• **Branch protectionルール適用**<br>• マージ条件の自動検証<br>• Evidenceアーカイブ処理<br>• **四半期監査の自動実行** | • HumanGate承認スキップ<br>• エラー発生時の自動マージ<br>• **機密情報の平文ログ出力**<br>• 権限昇格 | システム<br>（管理者がワークフロー管理） | • GitHub Actionsログ<br>• evidence/verify_reports/YYYYMMDD_HHMMSS_Full_*.md<br>• **evidence/audit/quarterly_report.md** | • 災害復旧時のみ<br>  手動介入可能<br>• 介入ログは必須 |

### **Permission Tierの詳細定義（MCP/AIツール用）**

| Tier | 許可操作 | 禁止操作 | 適用ツール | 設定方法 |
|------|----------|----------|------------|----------|
| **ReadOnly** | • ファイル読み込み<br>• RAG検索<br>• メタデータ取得 | • いかなる書き込み<br>• ファイル削除<br>• コミット/プッシュ | • Gemini CLI<br>• Claude Desktop（閲覧モード） | `.mcp/config.json`<br>`"permission": "readonly"` |
| **PatchOnly** | • ファイルの新規作成<br>• 小規模編集（1ファイル/コミット）<br>• Fast Verify実行 | • ディレクトリ削除<br>• 複数ファイルの一括編集<br>• ブランチ作成/削除<br>• HumanGate承認操作 | • Claude Code<br>• Z.ai Lite<br>• ChatGPT（編集モード） | `.mcp/config.json`<br>`"permission": "patchonly"`<br>`"max_files_per_commit": 1` |
| **ExecLimited** | • 許可されたスクリプト実行<br>• テスト環境での実行<br>• 一時ファイル作成 | • システムコマンド実行<br>（rm, sudo, curl \| sh）<br>• ネットワーク外部接続<br>• 永続的な環境変数設定 | • Claude Code（管理者モード）<br>• GitHub Actions（特定ジョブ） | `.mcp/config.json`<br>`"permission": "execlimited"`<br>`"allowed_commands": ["pwsh", "git"]` |
| **Admin** | • 全操作許可<br>• 権限昇格<br>• 災害復旧操作 | • なし（原則） | • プロジェクト管理者<br>• 緊急対応チーム | GitHub Team権限<br>`.github/CODEOWNERS`<br>`@admin-team *` |

## B. 一本道Runbook（完全版）

### 【Phase 0】環境準備（初回のみ）
```bash
# 1. リポジトリクローン
git clone https://github.com/your-org/vibe-spec-ssot.git
cd vibe-spec-ssot

# 2. Git Hooksの有効化（管理者実行）
chmod +x .git/hooks/*
# Linux/Mac: 
find .git/hooks -type f -exec chmod +x {} \;
# Windows (PowerShell):
Get-ChildItem .git/hooks -File | ForEach-Object { $_.Attributes = "Normal" }

# 3. MCP設定ファイル作成
cat > .mcp/config.json << EOF
{
  "permission_tier": "patchonly",
  "data_boundary": {
    "read_only": ["docs/"],
    "forbidden": ["sources/", "VAULT/"],
    "write_allowed": ["evidence/context_packs/"]
  },
  "cache_ttl": {
    "resources": "6h",
    "tools": "24h",
    "prompts": "7d"
  }
}
EOF

# 4. Verifyスクリプトの実行権限付与
chmod +x checks/*.ps1
```

### 【Phase 1】タスク開始 - VIBEKANBANとの連携
1. **VIBEKANBAN状態確認** → YES/NO: 000_INBOXに未処理チケットがあるか？
   - YES: 
     ```bash
     # チケットIDを取得（例: INBOX-123）
     TICKET_ID=$(ls VIBEKANBAN/000_INBOX/ | head -1 | cut -d'_' -f1)
     echo "処理対象チケット: $TICKET_ID"
     ```
   - NO: 新規タスク作成 → VIBEKANBAN/000_INBOX/にファイル作成
     ```bash
     touch VIBEKANBAN/000_INBOX/${TICKET_ID}_new_task.md
     ```

2. **チケット移動** → YES/NO: タスクをSPECフェーズに移動するか？
   - YES: 
     ```bash
     mv VIBEKANBAN/000_INBOX/${TICKET_ID}_*.md VIBEKANBAN/100_SPEC/
     ```
   - NO: 既存チケットを選択

3. **ADR要否判断** → YES/NO: 破壊的変更 or 新規機能か？
   - YES: decisions/にADR作成（ADR_TEMPLATE.md参照）
     ```bash
     cp decisions/ADR_TEMPLATE.md decisions/${TICKET_ID}_new_feature.md
     code decisions/${TICKET_ID}_new_feature.md
     ```
   - NO: 次へ進む

### 【Phase 2】ローカル作業 - 検証付き実装
1. **ブランチ作成** → YES/NO: 新しいfeatureブランチが必要か？
   - YES:
     ```bash
     # mainから最新状態を取得
     git fetch origin main
     git checkout -b feat/${TICKET_ID}-$(echo ${TASK_DESC} | tr ' ' '-' | tr -dc '[:alnum:]-') origin/main
     ```
   - NO: 既存ブランチをチェックアウト

2. **編集対象確認** → YES/NO: PartXX.mdを編集するか？
   - YES: 
     - 1Part=1Branch原則確認
     - 同時編集中のPartがないか確認
       ```bash
       # 現在編集中のPartを検出
       git diff --name-only | grep -o 'Part[0-9]\+' | sort -u | while read part; do
         echo "⚠️ 警告: $part は現在編集中です"
         echo "   VIBEKANBAN/200_BUILD/ で確認してください"
       done
       ```
   - NO: sources/編集の場合は **追記のみ許可**

3. **MCPツール実行ルール** → YES/NO: MCPツールを使用するか？
   - YES:
     ```bash
     # 1. User Consentの取得（必須）
     echo "⚠️ MCPツール実行前に同意が必要です"
     read -p "同意しますか？ (y/n): " consent
     if [ "$consent" != "y" ]; then exit 1; fi
     
     # 2. 機密情報チェック
     if grep -r "API_KEY\|SECRET\|TOKEN" docs/; then
       echo "❌ 機密情報が検出されました。VAULT/に移動してください"
       exit 1
     fi
     
     # 3. 実行と証跡保存
     mcp-tool --command "analyze Part10.md" --output evidence/context_packs/${TICKET_ID}_context.json
     ```
   - NO: 通常編集を続行

4. **Fast Verify実行**:
   ```bash
   pwsh ./checks/verify_repo.ps1 -Mode Fast
   ```

5. **結果確認** → YES/NO: 全てPASSか？
   - YES: 次へ進む
   - NO: 
     ```bash
     # 失敗理由の特定
     grep -A 10 "\[FAIL\]" evidence/verify_reports/*_Fast_FAIL.md
     
     # 自動修復の提案（オプション）
     if [ -f "scripts/auto_fix.sh" ]; then
       ./scripts/auto_fix.sh --fix-broken-links
     fi
     ```

### 【Phase 3】PR作成・マージ - CI/CD連携
1. **リモート最新状態に追従**:
   ```bash
   git fetch origin main
   git rebase origin/main
   ```

2. **競合解決** → YES/NO: 競合が発生したか？
   - YES:
     ```bash
     # 1. 競合ファイルの特定
     git diff --name-only --diff-filter=U
     
     # 2. 競合内容の表示
     git diff --check
     
     # 3. 編集（手動）
     code $(git diff --name-only --diff-filter=U)
     
     # 4. 解決後
     git add <resolved-file>
     git rebase --continue
     
     # 5. 再検証（必須）
     pwsh ./checks/verify_repo.ps1 -Mode Fast
     ```
   - NO: 次へ進む

3. **Evidenceの整理**:
   ```bash
   # recent-3ポリシー適用
   pwsh ./checks/cleanup_evidence.ps1 -EvidenceDir "evidence/verify_reports" -Limit 3
   ```

4. **PR作成**:
   ```bash
   git push -u origin HEAD
   
   # GitHub CLIでPR作成（テンプレート使用）
   gh pr create \
     --base integrate \
     --title "feat(${TICKET_ID}): $(echo ${TASK_DESC} | cut -c 1-50)" \
     --body "$(cat .github/PULL_REQUEST_TEMPLATE.md | sed "s/<TICKET_ID>/${TICKET_ID}/g")"
   ```

5. **レビュー待ち** → YES/NO: レビュー承認とCI/CDパスか？
   - YES: マージ方法選択
   - NO: 
     ```bash
     # フィードバック対応
     git checkout feat/${TICKET_ID}-*
     # 修正 → 再検証 → 再push
     git add .
     git commit --amend --no-edit
     git push --force-with-lease
     ```

6. **マージ方法選択** → YES/NO: 複数コミットがあるか？
   - YES: "Squash and merge"（推奨）
   - NO: "Rebase and merge"

### 【Phase 4】リリース準備 - HumanGate承認フロー
1. **integrateブランチでの確認**:
   - Full Verify実行（CI/CD自動）
   - HumanGate承認取得

2. **承認フロー** → YES/NO: 承認が必要か？
   - YES:
     ```bash
     # 1. 承認要求の作成
     cat > evidence/humangate_approvals/${TICKET_ID}_approval_request.md << EOF
     # 承認要求: ${TICKET_ID}
     - 作成者: $(git config user.name)
     - 作成日: $(date +%Y-%m-%d)
     - 操作内容: [具体的な変更内容]
     - リスク分析: [潜在的なリスク]
     - 代替案: [検討した代替手段]
     EOF
     
     # 2. 承認者への通知
     APPROVERS=$(cat decisions/0004-humangate-approvers.md | grep -E '主要承認者|代理承認者' | cut -d':' -f2 | tr -d ' ')
     echo "承認者に通知: $APPROVERS"
     gh issue create --title "承認要求: ${TICKET_ID}" --body "@$APPROVERS 承認が必要です"
     ```
   - NO: 次へ進む

3. **緊急エスカレーション** → YES/NO: 24時間以内に承認がないか？
   - YES: 
     ```bash
     # 自動エスカレーション
     EMERGENCY_APPROVER=$(cat decisions/0004-humangate-approvers.md | grep '緊急承認者' | cut -d':' -f2 | tr -d ' ')
     gh issue comment <ISSUE_ID> --body "@$EMERGENCY_APPROVER 緊急エスカレーション: 24時間応答なし"
     ```
   - NO: 次へ進む

### 【緊急復旧手順】完全版
→ YES/NO: 誤マージが発生したか？
- YES: 
  ```bash
  # 1. 影響範囲の特定
  git log -p -1 <BAD_COMMIT>
  
  # 2. 復旧方法の選択
  if [ "$(git rev-parse --abbrev-ref HEAD)" == "main" ]; then
    # mainブランチ: revertのみ許可
    git revert -m 1 <BAD_COMMIT>
    # 証跡保存
    cp evidence/incidents/INCIDENT_TEMPLATE.md evidence/incidents/INCIDENT_$(date +%Y%m%d)_${TICKET_ID}.md
  elif [ "$(git rev-parse --abbrev-ref HEAD)" == "local-only" ]; then
    # ローカルのみ: merge --abort
    git merge --abort
  else
    # その他のケース
    echo "⚠️ 管理者に連絡: 復旧方法が不明確です"
    exit 1
  fi
  
  # 3. 再発防止策
  echo "再発防止策: [具体的な対策]" >> evidence/incidents/INCIDENT_*.md
  ```
- NO: 正常継続

## C. 修正候補リスト（深堀詳細版）

### 【P0：即時対応（24時間以内）】- 根本原因と対策の詳細

1. **HumanGate承認者の定義不足** (P0-001)
   - **根本原因**: Part09.mdが概念のみで具体的なフローがない
   - **深刻度**: 障害発生時に24-48時間の復旧遅延
   - **実装手順**:
     ```bash
     # 1. 承認者リストの作成
     mkdir -p decisions
     cat > decisions/0004-humangate-approvers.md << EOF
     # HumanGate承認者リスト
     - 主要承認者: @project-lead (24h応答)
     - 代理承認者: @tech-lead (48h応答)
     - 緊急承認者: @oncall-engineer (24/365対応)
     - エスカレーション先: @executive-sponsor
     EOF
     
     # 2. 承認フローの自動化
     echo "承認者リストを作成: decisions/0004-humangate-approvers.md"
     ```
   - **検証方法**: 
     ```bash
     # シミュレーション実行
     gh workflow run emergency_approval.yml -f ticket_id=TEST-123
     ```

2. **Verifyスクリプトの未実装** (P0-002)
   - **根本原因**: checks/ディレクトリに実装がない
   - **影響範囲**: 全ての機械的検証が無効 → SSOT原則崩壊
   - **実装詳細**:
     ```powershell
     # verify_repo.ps1 の完全実装
     # 7つのチェックを実装:
     # 1. link_check (内部リンク)
     # 2. parts_exist (Part00-20の存在)
     # 3. forbidden_patterns (禁止コマンド)
     # 4. sources_integrity (sources/改変)
     # 5. conflict_markers (マージコンフリクト)
     # 6. term_consistency (用語揺れ)
     # 7. adr_compliance (ADR遵守)
     ```
   - **検証方法**: 
     ```bash
     # テストデータ作成
     echo "[broken](non-existent.md)" > docs/Part99_test.md
     pwsh ./checks/verify_repo.ps1 -Mode Fast
     # 期待結果: FAIL with evidence
     ```

3. **Evidence拡張子の矛盾** (P0-003)
   - **根本原因**: Part10が.txt、Part12が.mdを参照
   - **解決策**: 
     ```bash
     # 1. 拡張子の統一
     find evidence/ -name "*.txt" -exec rename 's/\.txt$/.md/' {} \;
     
     # 2. 参照の修正
     sed -i 's/\.txt/.md/g' docs/Part10.md docs/Part12.md
     ```
   - **検証方法**: 
     ```bash
     grep -r "\.txt" docs/ evidence/ | wc -l
     # 期待結果: 0
     ```

### 【P1：高優先度（1週間以内）】- 実装計画の詳細

6. **ADRテンプレート未定義** (P0-007)
   - **ADRライフサイクル管理**:
     ```
     Proposed → (レビュー) → Accepted → (使用中) → Deprecated → (代替案) → Superseded
     ```
   - **自動ステータス更新**:
     ```bash
     # GitHub ActionsでADRステータスを自動更新
     name: ADR Status Tracker
     on:
       push:
         paths:
           - 'decisions/*.md'
     jobs:
       update-status:
         runs-on: ubuntu-latest
         steps:
           - uses: actions/checkout@v4
           - name: Update ADR Status
             run: |
               for adr in decisions/*.md; do
                 if grep -q "Status:.*Accepted" $adr; then
                   sed -i 's/Status:.*/Status: Accepted/' $adr
                 fi
               done
     ```

### 【P2：中優先度（1ヶ月以内）】- 長期的な改善

13. **SBOMフォーマット未標準化** (P1-006)
   - **CycloneDX v1.5 選定理由**:
     - 業界標準（OWASP推奨）
     - JSON/XML/Protobuf形式をサポート
     - 脆弱性スキャンツールとの互換性
   - **実装例**:
     ```bash
     # SBOM生成スクリプト
     cyclonedx-py -r -o evidence/sbom/RELEASE_$(date +%Y%m%d).json
     ```

## D. repoへ入れるパッチ案（深堀実装版）

### パッチ案 #1: 緊急HumanGateプロトコル
```diff
# ファイル: docs/Part19.md（新規作成）
+ # Part19: 緊急対応プロトコル
+ 
+ ## 19.1 緊急定義
+ - **重大インシデント**: システム停止、機密情報漏洩、法的コンプライアンス違反
+ - **緊急対応**: 通常プロセスをスキップし、迅速な対処が必要な状況
+ 
+ ## 19.2 緊急HumanGateプロトコル
+ ### 承認フロー
+ ```mermaid
+ graph TD
+   A[緊急発生] --> B{重大度判定}
+   B -->|重大| C[緊急承認者に連絡]
+   B -->|中程度| D[主要承認者に連絡]
+   C --> E{2時間以内応答}
+   E -->|YES| F[承認取得]
+   E -->|NO| G[エスカレーション]
+   G --> H[Executive Sponsor]
+   H --> I[自動承認]
+ ```
+ 
+ ### 証跡要件
+ - 緊急対応の理由を500文字以内で記録
+ - 代替案の検討過程を記録
+ - 事後レビューを72時間以内に実施
+ 
+ ### 自動エスカレーション
+ ```bash
+ # emergency_escalation.sh
+ if [ $(date +%s) -gt $(( $(date -d "$APPROVAL_REQUEST_TIME" +%s) + 7200 )) ]; then
+   gh issue comment $ISSUE_ID -m "@$EMERGENCY_APPROVER 自動エスカレーション: 2時間応答なし"
+   echo "自動承認を適用" >> evidence/incidents/EMERGENCY_$(date +%Y%m%d).md
+ fi
+ ```

### パッチ案 #2: CI/CDパイプラインの完全実装
```yaml
# ファイル: .github/workflows/verify-gate.yml
name: Verify Gate Pipeline

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ integrate, main ]

jobs:
  fast-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup PowerShell
        uses: actions/setup-powershell@v1
      - name: Run Fast Verify
        run: |
          pwsh ./checks/verify_repo.ps1 -Mode Fast
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Evidence
        uses: actions/upload-artifact@v3
        with:
          name: fast-verify-report
          path: evidence/verify_reports/*_Fast_*.md

  full-verify:
    needs: fast-verify
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/integrate' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - name: Setup PowerShell
        uses: actions/setup-powershell@v1
      - name: Run Full Verify
        run: |
          pwsh ./checks/verify_repo.ps1 -Mode Full
      - name: Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: SBOM Generation
        run: |
          cyclonedx-py -r -o evidence/sbom/RELEASE_$(date +%Y%m%d).json
      - name: Upload Evidence
        uses: actions/upload-artifact@v3
        with:
          name: full-verify-report
          path: |
            evidence/verify_reports/*_Full_*.md
            evidence/sbom/*.json

  human-gate:
    needs: full-verify
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/integrate'
    steps:
      - uses: actions/checkout@v4
      - name: Check HumanGate Approval
        id: approval
        run: |
          APPROVERS=$(cat decisions/0004-humangate-approvers.md | grep -E '主要承認者|代理承認者' | wc -l)
          APPROVED=$(gh pr view --json reviews --jq '.reviews[] | select(.state=="APPROVED") | .author.login' | wc -l)
          
          if [ $APPROVED -lt 1 ]; then
            echo "承認不足: 必要 $APPROVERS / 現在 $APPROVED"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

## E. 混乱ポイントFAQ（深堀実践版）

**Q1: Fast Verifyが遅い場合、スキップしてもいいですか？**  
A: **絶対にダメ**です。pre-commit hookで技術的にブロックされています。解決策:  
- 原因分析: `time pwsh ./checks/verify_repo.ps1 -Mode Fast`  
- 最適化: 不要なチェックを一時無効化（管理者承認必須）  
- パフォーマンス改善: `.git/hooks/pre-commit` にタイムアウト設定  
  ```bash
  timeout 10s pwsh ./checks/verify_repo.ps1 -Mode Fast || echo "Warning: Verify timeout"
  ```

**Q8: HumanGate承認者が不在で緊急対応が必要な場合は？**  
A: **緊急プロトコル**を実行:  
1. 緊急承認者に連絡（Slack/Teams/電話）  
2. 2時間応答なし → 自動エスカレーション:  
   ```bash
   gh workflow run emergency_escalation.yml -f ticket_id=$TICKET_ID
   ```  
3. 緊急マージ実行（証跡必須）:  
   ```bash
   git merge --no-ff --no-edit emergency-fix
   echo "緊急対応: $(date)" > evidence/incidents/EMERGENCY_$(date +%Y%m%d).md
   ```  
4. 24時間以内に事後レビューを実施

**Q15: CIでVerify FAILしたPRをローカルで修正したいが、ブランチが保護されている**  
A: **正しい手順**:  
1. ローカルブランチに修正を追加  
   ```bash
   git checkout feat/123-fix
   # 修正 → 検証
   pwsh ./checks/verify_repo.ps1 -Mode Fast
   ```  
2. 強制プッシュではなく、新規コミット:  
   ```bash
   git commit -m "fix: resolve verify failures"
   git push  # --force-with-leaseは禁止
   ```  
3. PRを更新（GitHubが自動検出）

**Q16: MCPツールがsources/を誤って編集してしまった場合の復旧方法**  
A: **3段階復旧**:  
1. 即時検出:  
   ```bash
   git diff --name-only HEAD~1 HEAD -- sources/
   ```  
2. 復旧:  
   ```bash
   git checkout HEAD~1 -- sources/
   git commit -m "revert: restore sources/ integrity"
   ```  
3. 根本対策:  
   - MCP Permission TierをReadOnlyに変更  
   - `.mcp/config.json` に `sources/` を `forbidden` に追加  
   - 監査記録: `evidence/incidents/MCP_VIOLATION_$(date +%Y%m%d).md`

**Q17: 四半期監査でADR遵守率が80%未満だった場合の是正措置**  
A: **是正行動計画**:  
1. 分析:  
   ```bash
   # 違反コミットの特定
   git log --since="3 months ago" --oneline --no-merges | grep -v "ADR-" > evidence/audit/violations.log
   ```  
2. 是正:  
   - トレーニング実施: 新規参加者向けワークショップ  
   - 技術的対策: pre-commit hookでADR番号の強制チェック  
     ```bash
     if ! grep -q "ADR-[0-9]\+" $COMMIT_MSG; then
       echo "エラー: コミットメッセージにADR番号が必要です"
       exit 1
     fi
     ```  
3. 再評価: 1ヶ月後に再監査を実施

**Q18: APIコストが予算の80%に達した場合の対応手順**  
A: **コスト管理プロトコル**:  
1. 警告通知:  
   ```bash
   # cost_monitor.sh
   if [ $(cat evidence/metrics/api_cost_total.csv | tail -1 | cut -d',' -f7) -gt $(( $BUDGET * 80 / 100 )) ]; then
     gh issue create --title "APIコスト警告: 80%達成" --body "@finance-team 確認が必要です"
   fi
   ```  
2. 制限措置:  
   - MCPのキャッシュTTLを短縮（6h → 1h）  
   - 非必須ツールの無効化  
   - バッチ処理への移行  
3. 予算再調整:  
   - 管理者による予算増額申請  
   - コスト削減計画の策定

## F. 監査とコンプライアンス（新規追加）

### 四半期監査チェックリスト
```markdown
# 四半期監査チェックリスト (2026-Q1)

## 1. ADR遵守率
- [ ] 100%のコミットがADRを参照
- [ ] 全てのADRが適切なステータスを持つ
- [ ] Superseded ADRが代替案を明記

## 2. コスト管理
- [ ] APIコストが予算内
- [ ] 無駄なMCP呼び出しがない
- [ ] コスト削減策が実施

## 3. セキュリティコンプライアンス
- [ ] MCPがUser Consentを取得
- [ ] 機密情報がVAULT/に隔離
- [ ] 定期的な脆弱性スキャンの実施

## 4. 証跡の完全性
- [ ] 全ての変更に証跡が存在
- [ ] 証跡が改ざんされていない
- [ ] recent-3ポリシーが適用

## 5. ツール整合性
- [ ] ローカル環境とCIが同一バージョン
- [ ] MCPのキャッシュが最新
- [ ] RAGがSSOTと同期
```

### 監査自動化スクリプト
```bash
#!/bin/bash
# scripts/quarterly_audit.sh 詳細版

AUDIT_DIR="evidence/audit/$(date +%Y)Q$(( ($(date +%-m)-1)/3+1 ))"
mkdir -p $AUDIT_DIR

cat > $AUDIT_DIR/checklist.md << EOF
# 四半期監査レポート: $(date +%Y)-Q$(( ($(date +%-m)-1)/3+1 ))
- 実行日: $(date +%Y-%m-%d)
- 監査者: $(git config user.name)
- リポジトリ: $(git config --get remote.origin.url)

## 1. ADR遵守率
EOF

# 1. ADR遵守率の詳細分析
TOTAL_COMMITS=$(git log --since="3 months ago" --oneline --no-merges | wc -l)
ADR_COMMITS=$(git log --since="3 months ago" --oneline --no-merges --grep="ADR-" | wc -l)
COMPLIANCE_RATE=$(echo "scale=2; $ADR_COMMITS * 100 / $TOTAL_COMMITS" | bc)

echo "- **ADR遵守率**: ${COMPLIANCE_RATE}% ($ADR_COMMITS/$TOTAL_COMMITS)" >> $AUDIT_DIR/checklist.md

# 違反コミットの詳細リスト
if [ $ADR_COMMITS -lt $TOTAL_COMMITS ]; then
  echo "### 違反コミットリスト" >> $AUDIT_DIR/checklist.md
  git log --since="3 months ago" --oneline --no-merges --pretty=format:"%h %s" | grep -v "ADR-" | head -10 >> $AUDIT_DIR/checklist.md
fi

# 2. コスト分析（詳細版）
echo "" >> $AUDIT_DIR/checklist.md
echo "## 2. コスト管理" >> $AUDIT_DIR/checklist.md

if [ -d "evidence/metrics" ]; then
  TOTAL_COST=0
  for file in evidence/metrics/api_cost_*.csv; do
    if [ -f "$file" ]; then
      MONTHLY_COST=$(awk -F',' '{sum+=$7} END {print sum}' "$file")
      TOTAL_COST=$(echo "$TOTAL_COST + $MONTHLY_COST" | bc)
      echo "- $(basename $file | cut -d'_' -f3 | cut -d'.' -f1): \$$MONTHLY_COST" >> $AUDIT_DIR/checklist.md
    fi
  done
  echo "- **四半期合計**: \$$TOTAL_COST" >> $AUDIT_DIR/checklist.md
  
  # 予算超過警告
  BUDGET=5000  # 四半期予算
  if (( $(echo "$TOTAL_COST > $BUDGET * 0.8" | bc -l) )); then
    echo "⚠️ **警告**: 予算の80%を超えています" >> $AUDIT_DIR/checklist.md
  fi
fi

echo ""
echo "監査完了。レポート: $AUDIT_DIR/checklist.md"
echo "是正措置が必要な場合は、ADRを作成してください。"
```

---

## 深堀総合評価

### 1. 重大リスクの特定と優先度付け
- **P0リスクの深刻度**: HumanGate承認フロー欠如が最も深刻（平均48時間の復旧遅延）
- **検出率向上策**: CI/CDパイプラインとpre-commit hookの二重保証
- **コスト対効果**: Verifyスクリプトの早期実装がROI最高

### 2. 実装の現実的な段階化
| フェーズ | 期間 | 主要成果物 | 成功指標 |
|---------|------|------------|----------|
| **Phase 1** | 2026-01-31まで | • HumanGateフロー確立<br>• Verifyスクリプト実装<br>• pre-commit hook配置 | • PRブロック率100%<br>• 緊急対応時間<4時間 |
| **Phase 2** | 2026-02-28まで | • MCPセキュリティ強化<br>• VAULT構造確立<br>• CI/CD完全連携 | • 機密情報漏洩0件<br>• CIパス率95%以上 |
| **Phase 3** | 2026-03-31まで | • 全自動監査<br>• RAG/知識管理最適化<br>• コスト最適化 | • 監査工数50%削減<br>• APIコスト30%削減 |

### 3. 継続的改善の仕組み
- **月次健康診断**: 
  ```bash
  # scripts/monthly_health_check.sh
  ./checks/verify_repo.ps1 -Mode Full
  ./scripts/cost_analysis.sh
  ./scripts/security_scan.sh
  ```
- **四半期ADRレビュー**: 古いADRのSuperseded判定
- **年次アーキテクチャレビュー**: 基本原則の見直し

### 4. 成功の鍵
- **技術的対策と文化的対策のバランス**: ツールで強制するだけでなく、理解を深める
- **漸進的な改善**: 全てを一度に実装せず、段階的に成熟度を向上
- **透明性の確保**: 全ての決定と結果をSSOTに記録し、誰でも確認可能に

この深堀版Runbookにより、VCG/VIBE SSOTの運用は「混乱ゼロ」の状態に到達し、持続可能な開発プラクティスを実現します。最も重要なのは、**技術的対策と人的プロセスの両輪**でSSOT原則を守り続けることです。

### USER
このデータを基に深堀してください。

### ASSISTANT
# VCG/VIBE SSOT 運用Runbook & 混乱ゼロ化パッチ（DESIGN_MASTER基準）

## A. 役割分担の最終版（1枚で分かる表）

### 権限マトリクス：ローカル環境 vs GitHub

| 作業カテゴリ | ローカル環境/IDE | GitHub (WebUI) | 対象ブランチ | 責任者 | 証跡形式 |
|-------------|-----------------|---------------|------------|--------|----------|
| **新規ブランチ作成** | ✅ `git checkout -b feat/TICKET-ID-description origin/main` | ❌ 禁止 | mainから分岐 | 開発者 | Gitログ |
| **編集・実装** | ✅ docs/PartXX.md編集<br>✅ Fast Verify実行 | ❌ 禁止<br>⚠️ 緊急時のみ | featureブランチ | Claude Code/ChatGPT | evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_PASS.md |
| **PR作成** | ✅ `gh pr create --base integrate` | ✅ WebUIで作成可能 | feature→integrate | 開発者 | PR履歴 |
| **コードレビュー** | ❌ 禁止 | ✅ 承認/コメント | integrate受入前 | レビュワー | PRレビューログ |
| **Full Verify実行** | ❌ 手動実行禁止 | ✅ CI/CD自動実行 | integrateマージ前 | システム | Full Verifyレポート |
| **HumanGate承認** | ❌ 禁止 | ✅ 承認ボタン押下 | integrate→main | 承認者 | evidence/humangate_approvals/YYYYMMDD.md |
| **マージ (integrate)** | ❌ 禁止 | ✅ "Squash and merge" | integrate | レビュワー | マージコミット |
| **マージ (main)** | ❌ 禁止 | ✅ "Create merge commit" | main | 承認者 | マージコミット |
| **リリースタグ作成** | ❌ 禁止 | ✅ WebUIでタグ作成 | main | 承認者 | Gitタグ |
| **ロールバック** | ❌ 禁止 | ✅ `git revert -m 1 <commit>` | main | 承認者 | evidence/incidents/INCIDENT_YYYYMMDD.md |
| **ADR作成** | ✅ Markdown編集 | ✅ WebUIで作成 | integrate | HumanGate | decisions/XXXX-*.md |

### 禁止事項の明確化
- **ローカル環境で絶対禁止**: 
  - sources/の編集・削除（追記のみ許可）
  - main/integrateへの直接コミット
  - git push --forceの実行
- **GitHubで絶対禁止**:
  - featureブランチからmainへの直接マージ
  - HumanGate承認なしの破壊的変更実施
  - Verify FAILのままのマージ

## B. 一本道Runbook（迷わない手順）

### 【Phase 0】環境準備（初回のみ）
```bash
# 1. リポジトリクローン（mainブランチ）
git clone https://github.com/vcg-vibe/vibe-spec-ssot.git
cd vibe-spec-ssot

# 2. Git Hooksの有効化
chmod +x .git/hooks/*
# Windowsでは:
# Get-ChildItem .git/hooks -File | ForEach-Object { $_.Attributes = "Normal" }

# 3. 環境変数設定（推奨）
echo 'export VIBE_SSOT_PATH=$(pwd)' >> ~/.bashrc
source ~/.bashrc

# 4. 開発環境確認
gh auth status  # GitHub CLIの認証状態を確認
pwsh --version   # PowerShell 7+の確認
```

### 【Phase 1】タスク開始 - TICKET作成
1. **VIBEKANBAN状態確認** → YES/NO: 新規タスクが必要か？
   - YES: 
     ```bash
     # 新規TICKET作成
     mkdir -p VIBEKANBAN/000_INBOX/
     TIMESTAMP=$(date +%Y%m%d_%H%M%S)
     cat > VIBEKANBAN/000_INBOX/TICKET-${TIMESTAMP}.md << EOF
     ## TICKET-${TIMESTAMP}: [タスク名]
     ### Goal
     [1文で明確な目的]
     ### Non-Goals
     [やらないこと・境界線]
     ### Inputs
     - [x] Part00 R-0002 (ADR→docsの手順)
     - [x] Part09 R-0901 (Permission Tier)
     ### Acceptance
     - [ ] Fast VerifyがPASS
     - [ ] ADRが先行
     - [ ] CHANGELOGが更新
     ### Risks
     - [x] 破壊的変更の可能性
     ### Plan
     1. decisions/にADR追加
     2. docs/PartXX.md更新
     3. Fast Verify実行
     4. CHANGELOG.md更新
     5. PR作成
     ### Verify
     pwsh ./checks/verify_repo.ps1 -Mode Fast
     ### Evidence
     evidence/verify_reports/${TIMESTAMP}_*
     ### Rollback
     git revert <commit-hash>
     EOF
     ```
   - NO: 既存TICKETを選択（VIBEKANBAN/100_SPEC/から）

2. **ADRの必要性判定** → YES/NO: 破壊的変更か？
   - YES: decisions/にADR作成（必須）
   - NO: 次へ進む

3. **ブランチ作成**:
   ```bash
   # TICKET IDを取得
   TICKET_ID=$(basename VIBEKANBAN/000_INBOX/*.md .md | cut -d'_' -f2)
   
   # mainから最新状態を取得
   git fetch origin main
   git checkout -b feat/${TICKET_ID}-$(echo "${TASK_DESC}" | tr ' ' '-' | tr -dc '[:alnum:]-') origin/main
   ```

### 【Phase 2】ローカル作業 - 検証付き実装
1. **編集対象確認** → YES/NO: PartXX.mdを編集するか？
   - YES: 
     - 1Part=1Branch原則確認（現在編集中のPartがないか）
       ```bash
       # 現在編集中のPartを検出
       git diff --name-only | grep -o 'Part[0-9]\+' | sort -u | while read part; do
         echo "⚠️ 警告: $part は現在編集中です"
         echo "   VIBEKANBAN/200_BUILD/ で確認してください"
       done
       ```
   - NO: sources/編集の場合は追記のみ

2. **Fast Verify実行**:
   ```bash
   # 実装前にも実行（ベースライン確認）
   pwsh ./checks/verify_repo.ps1 -Mode Fast
   
   # 実装後にも実行
   pwsh ./checks/verify_repo.ps1 -Mode Fast
   ```

3. **結果確認** → YES/NO: 全てPASSか？
   - YES: 次へ進む
   - NO: 
     ```bash
     # 失敗理由の特定
     grep -A 10 "\[FAIL\]" evidence/verify_reports/*_Fast_FAIL.md
     
     # 修正ループ（最大3回）
     for i in {1..3}; do
       echo "修正ループ $i/3"
       # 修正実施
       pwsh ./checks/verify_repo.ps1 -Mode Fast
       if [ $? -eq 0 ]; then
         break
       fi
     done
     
     # 3回ループしてもFAILの場合
     if [ $i -eq 3 ] && [ $? -ne 0 ]; then
       echo "⚠️ 3回の修正ループで解決できませんでした"
       echo "HumanGateへのエスカレーションが必要です"
       exit 1
     fi
     ```

4. **CHANGELOG更新**:
   ```bash
   cat >> CHANGELOG.md << EOF
   
   ## $(date +%Y-%m-%d)
   ### Changed
   - **[PartXX]** [変更概要]（50文字以内）
   - 担当: $(git config user.name)
   - ADR: decisions/${TICKET_ID}-*.md
   - Commit: $(git rev-parse HEAD)
   EOF
   ```

### 【Phase 3】PR作成・マージ
1. **リモート最新状態に追従**:
   ```bash
   git fetch origin main
   git rebase origin/main
   ```

2. **競合解決** → YES/NO: 競合が発生したか？
   - YES:
     ```bash
     # 1. 競合ファイルの特定
     git diff --name-only --diff-filter=U
     
     # 2. 競合内容の表示
     git diff --check
     
     # 3. 編集（手動）
     code $(git diff --name-only --diff-filter=U)
     
     # 4. 解決後
     git add <resolved-file>
     git rebase --continue
     
     # 5. 再検証（必須）
     pwsh ./checks/verify_repo.ps1 -Mode Fast
     ```
   - NO: 次へ進む

3. **リモートブランチへプッシュ**:
   ```bash
   git push -u origin HEAD
   ```

4. **PR作成**:
   ```bash
   gh pr create \
     --base integrate \
     --title "feat(${TICKET_ID}): $(echo "${TASK_DESC}" | cut -c 1-50)" \
     --body "$(cat .github/PULL_REQUEST_TEMPLATE.md | sed "s/<TICKET_ID>/${TICKET_ID}/g")"
   ```

5. **レビュー待ち** → YES/NO: レビュー承認とCI/CDパスか？
   - YES: マージ方法選択
   - NO: 
     ```bash
     # フィードバック対応
     git checkout feat/${TICKET_ID}-*
     # 修正 → 再検証 → 再push
     git add .
     git commit --amend --no-edit
     git push --force-with-lease
     ```

6. **マージ方法選択** → YES/NO: 複数コミットがあるか？
   - YES: "Squash and merge"（推奨）
   - NO: "Rebase and merge"

### 【Phase 4】リリース準備
1. **integrateブランチでの確認**:
   - Full Verify実行（CI/CD自動）
   - HumanGate承認取得

2. **承認フロー** → YES/NO: 承認が必要か？
   - YES:
     ```bash
     # 1. 承認要求の作成
     cat > evidence/humangate_approvals/${TICKET_ID}_approval_request.md << EOF
     # 承認要求: ${TICKET_ID}
     - 作成者: $(git config user.name)
     - 作成日: $(date +%Y-%m-%d)
     - 操作内容: [具体的な変更内容]
     - リスク分析: [潜在的なリスク]
     - 代替案: [検討した代替手段]
     EOF
     
     # 2. 承認者への通知
     APPROVERS=$(cat decisions/0004-humangate-approvers.md | grep -E '主要承認者|代理承認者' | cut -d':' -f2 | tr -d ' ')
     gh issue create --title "承認要求: ${TICKET_ID}" --body "@$APPROVERS 承認が必要です"
     ```
   - NO: 次へ進む

3. **mainマージ**:
   ```bash
   # GitHub WebUIで実行
   # integrateブランチからmainブランチへのマージ
   # マージ方法: "Create merge commit (--no-ff)"
   ```

4. **リリースタグ作成**:
   ```bash
   git tag -a "RELEASE_$(date +%Y%m%d_%H%M%S)" -m "Stable release"
   git push origin "RELEASE_$(date +%Y%m%d_%H%M%S)"
   ```

### 【緊急復旧手順】
→ YES/NO: 誤マージが発生したか？
- YES: 
  ```bash
  # 1. 影響範囲の特定
  git log -p -1 <BAD_COMMIT>
  
  # 2. 復旧方法の選択
  if [ "$(git rev-parse --abbrev-ref HEAD)" == "main" ]; then
    # mainブランチ: revertのみ許可
    git revert -m 1 <BAD_COMMIT>
    git push origin main
    
    # 証跡保存
    cp evidence/incidents/INCIDENT_TEMPLATE.md evidence/incidents/INCIDENT_$(date +%Y%m%d)_${TICKET_ID}.md
  else
    # その他のケース
    echo "⚠️ 管理者に連絡: 復旧方法が不明確です"
    exit 1
  fi
  
  # 3. 再発防止策
  echo "再発防止策: [具体的な対策]" >> evidence/incidents/INCIDENT_*.md
  ```
- NO: 正常継続

## C. 修正候補リスト（優先度付き）

### 【P0：即時対応（24時間以内）】
1. **HumanGate承認者の定義不足** (P0-001)
   - **根本原因**: Part09.mdが概念のみで具体的なフローがない
   - **深刻度**: 障害発生時に24-48時間の復旧遅延
   - **実装手順**:
     ```bash
     # 1. 承認者リストの作成
     mkdir -p decisions
     cat > decisions/0004-humangate-approvers.md << EOF
     # HumanGate承認者リスト
     - 主要承認者: @project-lead (24h応答)
     - 代理承認者: @tech-lead (48h応答)
     - 緊急承認者: @oncall-engineer (24/365対応)
     - エスカレーション先: @executive-sponsor
     EOF
     
     # 2. 承認フローの自動化
     echo "承認者リストを作成: decisions/0004-humangate-approvers.md"
     ```

2. **Verifyスクリプトの未実装** (P0-002)
   - **根本原因**: checks/ディレクトリに実装がない
   - **影響範囲**: 全ての機械的検証が無効 → SSOT原則崩壊
   - **実装詳細**:
     ```powershell
     # verify_repo.ps1 の完全実装
     # 7つのチェックを実装:
     # 1. link_check (内部リンク)
     # 2. parts_exist (Part00-20の存在)
     # 3. forbidden_patterns (禁止コマンド)
     # 4. sources_integrity (sources/改変)
     # 5. conflict_markers (マージコンフリクト)
     # 6. term_consistency (用語揺れ)
     # 7. adr_compliance (ADR遵守)
     ```

3. **Evidence拡張子の矛盾** (P0-003)
   - **根本原因**: Part10が.txt、Part12が.mdを参照
   - **解決策**: 
     ```bash
     # 1. 拡張子の統一
     find evidence/ -name "*.txt" -exec rename 's/\.txt$/.md/' {} \;
     
     # 2. 参照の修正
     sed -i 's/\.txt/.md/g' docs/Part10.md docs/Part12.md
     ```

### 【P1：高優先度（1週間以内）】
4. **証跡保持方針の矛盾** (P0-004)
   - **根本原因**: Part10が「最新1セットのみ」、Part12が「削除しない」と矛盾
   - **解決策**:
     ```bash
     # Part10.mdを修正
     sed -i 's/最新PASS証跡1セットのみ保持/最新3セットを保ち、古いものはevidence/archive/に移動/g' docs/Part10.md
     
     # Part12.mdを修正
     echo "例外: evidence/verify_reports/ は recent-3 ポリシーを適用" >> docs/Part12.md
     ```

5. **sources/改変検出ロジック未実装** (P0-005)
   - **解決策**: 
     ```powershell
     # verify_sources_integrity.ps1 の実装
     function Test-SourcesIntegrity {
       $modifiedFiles = git diff HEAD~1 HEAD --name-only -- sources/
       $deletedFiles = git diff HEAD~1 HEAD --diff-filter=D --name-only -- sources/
       
       if ($modifiedFiles -or $deletedFiles) {
         return $false
       }
       return $true
     }
     ```

6. **MCPセキュリティ不整合** (P0-006)
   - **根本原因**: 2025年11月MCP必須要件に未対応
   - **解決策**:
     ```markdown
     # docs/Part03.md に追加
     #### R-0304: MCPセキュリティコンプライアンス【MUST】
     ##### User Consent（明示的opt-in）
     - MCPツール使用前にユーザーの明示的同意を取得する
     - 同意記録は evidence/mcp_consent/ に保存する
     ##### Data Privacy Boundary
     - docs/: アクセス許可（ReadOnly）
     - sources/: アクセス禁止（機密情報混入リスク）
     - VAULT/: アクセス禁止（暗号化必須領域）
     ```

### 【P2：中優先度（1ヶ月以内）】
7. **ADRテンプレート未定義** (P0-007)
   - **解決策**: decisions/ADR_TEMPLATE.md を作成

8. **Glossary分散** (P0-009, P0-010)
   - **解決策**: docs/Part02.md と glossary/GLOSSARY.md の内容を統合

9. **ブランチ命名規則の明記不足** (P1-1)
   - **解決策**: 5.2の3層ブランチ戦略をPart02に明記

10. **VIBEKANBAN構造の明確化** (P2-1)
    - **解決策**: VIBEKANBAN/000_INBOX～900_RELEASEの詳細ルールをPart04に追記

## D. repoへ入れるパッチ案

### パッチ案 #1: PRテンプレートの作成
```diff
# ファイル: .github/PULL_REQUEST_TEMPLATE.md（新規作成）
+ ## 変更の概要
+ - [ ] このPRの目的を簡潔に説明
+ 
+ ## 関連するPart/ADR
+ - Part: [対象Part番号]
+ - ADR: [関連ADR番号、なければ"なし"]
+ - Issue: #[関連Issue番号、なければ"なし"]
+ 
+ ## 変更内容の詳細
+ - [ ] 変更点を箇条書きで記載
+ - [ ] 変更理由を明記
+ 
+ ## 検証結果
+ - [ ] Fast Verify: [PASS/FAIL]（証跡ファイル: evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_*.md）
+ - [ ] Conflictチェック: [PASS/FAIL]
+ - [ ] 用語揺れチェック: [PASS/FAIL]
+ 
+ ## HumanGate承認（必要時）
+ - [ ] 承認者: [名前]
+ - [ ] 承認日: [日付]
+ - [ ] 承認証跡: [ファイルパス]
+ 
+ ## マージ後のTODO
+ - [ ] 確認すべき項目を記載
+ - [ ] 後続タスクがあれば記載
```

### パッチ案 #2: ブランチ命名規則の明記
```diff
# ファイル: docs/Part02.md
## 5.2 Git運用の詳細ルール
### ブランチ命名規則
- ✅ 許可される形式:
  - `feat/<issue-id>-<description>`: 機能追加（例: feat/123-add-user-auth）
  - `bugfix/<issue-id>-<description>`: バグ修正
  - `hotfix/<issue-id>-<description>`: 緊急修正（HumanGate承認必須）
  - `spike/<issue-id>-<description>`: 調査・PoC
  - `integrate`: 統合ブランチ（固定名）
- ❌ 禁止される形式:
  - `feature/<description>`（issue-idなし）
  - `fix/<description>`（issue-idなし）
  - `main`以外のprotected branchへの直接push

# ファイル: .github/branch-protection.yml（新規作成）
+ branch_protection_rules:
+   - branch: main
+     required_pull_request_reviews:
+       required_approving_review_count: 2
+       require_code_owner_reviews: true
+     required_status_checks:
+       strict: true
+       contexts: ["Fast Verify", "Full Verify", "HumanGate Approval"]
+     enforce_admins: true
+     required_linear_history: true
+     allow_force_pushes: false
+     allow_deletions: false
+     
+   - branch: integrate
+     required_pull_request_reviews:
+       required_approving_review_count: 1
+       require_code_owner_reviews: true
+     required_status_checks:
+       strict: true
+       contexts: ["Fast Verify", "Full Verify"]
+     enforce_admins: true
```

### パッチ案 #3: Evidence命名規則の統一
```diff
# ファイル: docs/Part10.md
### 6.2 証跡ファイルの命名規則
- ✅ 標準フォーマット: `YYYYMMDD_HHMMSS_<verify-mode>_<status>.md`
+ 例: `20260111_230526_Fast_PASS.md`
+ 例: `20260111_231500_Full_FAIL.md`
- ✅ 拡張子: 全ての証跡ファイルは`.md`（Markdown）とする
- ❌ `.txt`拡張子の使用禁止（Part12 R-1201との整合性確保）

# ファイル: docs/Part12.md
### R-1201 Evidence保存義務
- 現在: 「証跡は削除しない」
+ 更新: 
+ 1. 全ての証跡は`evidence/`以下に`.md`拡張子で保存する
+ 2. 基本原則: 証跡は削除しない
+ 3. 例外: `evidence/verify_reports/`はrecent-3ポリシーを適用
+    - 最新3件のみ保持
+    - 古いファイルは`evidence/archive/YYYY/`に自動移動
+ 4. 削除が必要な場合は、ADRを作成し、Part00 R-0002に従って承認を得る
```

### パッチ案 #4: pre-commit hookの実装
```diff
# ファイル: .git/hooks/pre-commit（新規作成/上書き）
+ #!/bin/sh
+ # sources/ 保護 & Conflict Marker 検出
+ 
+ # 1. sources/ 改変禁止
+ MODIFIED_SOURCES=$(git diff --cached --name-only | grep '^sources/')
+ if [ -n "$MODIFIED_SOURCES" ]; then
+   echo "[ERROR] sources/ の改変は禁止されています:"
+   echo "$MODIFIED_SOURCES"
+   echo "追記のみ許可されています。"
+   exit 1
+ fi
+ 
+ # 2. Conflict Marker 検出
+ CONFLICT_MARKERS=$(git diff --cached --name-only | xargs grep -l '<<<<<<<\|=======' 2>/dev/null)
+ if [ -n "$CONFLICT_MARKERS" ]; then
+   echo "[ERROR] Conflict markers が検出されました:"
+   echo "$CONFLICT_MARKERS"
+   exit 1
+ fi
+ 
+ # 3. Fast Verify 実行
+ echo "Fast Verifyを実行中..."
+ pwsh ./checks/verify_repo.ps1 -Mode Fast
+ if [ $? -ne 0 ]; then
+   echo "[ERROR] Verify FAIL: コミットを中止します"
+   exit 1
+ fi
+ 
+ exit 0
```

## E. 混乱ポイントFAQ（10項目以上）

**Q1: ローカルでFast Verify FAILなのにコミットしてもいいですか？**  
A: **絶対にダメ**です。pre-commit hookで技術的にブロックされます。FAILの原因を修正し、PASSになるまでコミットできません。

**Q2: sources/フォルダに新規ファイルを追加できますか？**  
A: **はい、追加のみ可能です**。既存ファイルの編集・削除は禁止です。追加時はFast Verifyのsources_integrityチェックにPASSする必要があります。

**Q3: 緊急でmainに直接修正を入れたい場合は？**  
A: **できません**。緊急時でもfeature/hotfixブランチを作成し、HumanGate承認（緊急承認者）を得てからintegrate→mainとマージします。

**Q4: PRレビューで修正依頼を受けた場合の手順は？**  
A: 1. ローカルブランチに修正を追加 2. Fast Verify実行 3. git pushで更新 4. PRコメントで対応完了を通知。レビュアーの再承認待ち。

**Q5: integrateブランチでコンフリクトが発生した場合は？**  
A: 1. featureブランチに戻りmainをrebase 2. 競合解決 3. 再度Fast Verify 4. PRを更新。integrateブランチでの直接解決は禁止。

**Q6: Evidenceファイルが多すぎてディスク容量が心配です**  
A: evidence/verify_reports/はrecent-3ルールが適用され、古いファイルは自動でevidence/archive/に移動されます。削除は必要ありません。

**Q7: AIツールを実行した時の証跡はどう保存すればいいですか？**  
A: MCPツール実行時は自動でevidence/mcp_logs/に記録されます。手動実行の場合は、コマンドと結果をevidence/context_packs/に保存してください。

**Q8: HumanGate承認者が不在で緊急対応が必要な場合は？**  
A: 1. 緊急連絡手段（Slack/Teams）で代理承認者に連絡 2. 72時間応答なしの場合は自動エスカレーション 3. Part19のEmergencyApproverプロトコルを参照。

**Q9: ローカルでgit resetしてしまった場合の復旧方法は？**  
A: ローカルのみの場合: `git reflog`でコミットハッシュを確認し、`git reset --hard <ハッシュ>`で復旧。リモートに影響を与えた場合はrevertを使用。

**Q10: 新しいAIツールを使いたいがPermission Tierが不明です**  
A: 新規ツールはまずPatchOnly権限でテスト実行し、security reviewを経て承認を得てから使用します。未承認ツールの実行はAuditログで記録されます。

**Q11: PRマージ後に重大なバグを発見した場合は？**  
A: 1. revertコミットを作成 2. evidence/incidents/に記録 3. 新規ADRを作成して再発防止策を策定 4. 修正ブランチを作成し通常フローで再マージ。

**Q12: リモートリポジトリがGitHubでない場合（GitLab/Bitbucket）の対応は？**  
A: GitHub専用機能（gh CLI、WebUIマージ等）は使用できません。代わりに:
- PR作成: ブランチ作成後、WebUIまたはAPIでマージリクエスト作成
- CI/CD: 各プラットフォームのCI機能でVerify Gateを実装
- 承認フロー: 各プラットフォームの承認機能を使用

**Q13: Windows環境でPowerShellスクリプトが実行できない場合**  
A: 1. 実行ポリシーを変更: `Set-ExecutionPolicy RemoteSigned -Scope CurrentUser` 2. 管理者権限で実行 3. PowerShell 7+がインストールされていることを確認。

**Q14: 一度に複数のPartを修正する必要がある場合は？**  
A: 1Part=1Branch原則に反するため、原則として禁止です。どうしても必要な場合は:
1. ADRを作成し、理由と影響範囲を明記
2. HumanGate承認を得る
3. 単一ブランチで複数Partを修正
4. Full Verifyを実行
5. 承認後マージ

## F. 必須URL

1. **GitHub Branch Protection 設定**
   - URL: https://docs.github.com/en/repositories/configuring-branches-and-merges-in-your-repository/managing-protected-branches
   - 参照理由: ブランチ保護ルールの公式ドキュメント

2. **MCP Security Specification 2025-11-25**
   - URL: https://modelcontextprotocol.io/spec/security/2025-11-25
   - 参照理由: User Consent必須化の根拠

3. **CycloneDX SBOM Standard**
   - URL: https://cyclonedx.org/
   - 参照理由: SBOMフォーマット標準化の根拠

4. **Semantic Versioning 2.0.0**
   - URL: https://semver.org/
   - 参照理由: バージョニング規則の標準

5. **Git Hooks Documentation**
   - URL: https://git-scm.com/docs/githooks
   - 参照理由: pre-commit hook実装の公式情報

---

## 実装完了確認手順

1. **環境準備**:
   ```bash
   # pre-commit hookの有効化
   chmod +x .git/hooks/pre-commit
   ```

2. **Verifyスクリプトの確認**:
   ```bash
   pwsh ./checks/verify_repo.ps1 -Mode Fast
   # 期待結果: [OVERALL PASS] All Fast checks passed.
   ```

3. **HumanGate承認者リストの確認**:
   ```bash
   cat decisions/0004-humangate-approvers.md
   # 期待結果: 承認者リストが表示される
   ```

4. **エビデンス命名規則の確認**:
   ```bash
   # 証跡ファイルの拡張子を確認
   find evidence/ -name "*.txt"
   # 期待結果: 0件（.txtファイルがない）
   ```

5. **ADRテンプレートの確認**:
   ```bash
   cat decisions/ADR_TEMPLATE.md
   # 期待結果: ADRテンプレートが表示される
   ```

このRunbookとパッチ案を実装することで、VCG/VIBE SSOTの運用は「混乱ゼロ」の状態に到達し、持続可能な開発プラクティスを実現します。最も重要なのは、**技術的対策と人的プロセスの両輪**でSSOT原則を守り続けることです。