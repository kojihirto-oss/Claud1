FILE: docs\Part00.md
-----
# Part 00：ドキュメント憲法・読み方・運用の前提固定（SSOT/禁止事項/改版規約/優先順位）

## 0. このPartの位置づけ
- **目的**: 本リポジトリにおける「真実の定義」「変更手順」「禁止事項」を明文化し、SSOT破壊を防ぐ。
- **依存**: なし（全Partの基盤）
- **影響**: 全Part（00〜20）、decisions/、glossary/、sources/、checks/、evidence/

---

## 1. 目的（Purpose）

本 Part00 は **SSOT（Single Source of Truth）運用の憲法** として、以下を保証する：

1. **真実の優先順位（Truth Order）を固定**し、矛盾時の裁定ルールを明確化する
2. **変更手順（ADR→docs）を強制**し、根拠のない改変を防ぐ
3. **禁止事項リスト**を明文化し、事故を未然防止する
4. **推測禁止・未決事項ルール**により、曖昧さを排除する
5. **検証・証跡・復元**の義務を明確にし、再現性を担保する

**根拠**: [FACTS_LEDGER F-0001](FACTS_LEDGER.md)（真実の優先順位）、[F-0002](FACTS_LEDGER.md)（禁止事項）、[F-0020](FACTS_LEDGER.md)（プロジェクト目的）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- 本リポジトリ内の全ファイル（docs/, decisions/, glossary/, sources/, checks/, evidence/）
- AI（Claude Code, ChatGPT, Gemini, Z.ai）によるファイル操作
- 人間による手動変更（HumanGate含む）

### Out of Scope（適用外）
- 外部ドキュメント（Google Docs, Notion, Slack等）は SSOT ではない（参照元として sources/ に保存する）
- 個人の作業メモ・下書き（公式化する前に docs/ へ移す）

---

## 3. 前提（Assumptions）

1. **docs/ が唯一のSSOT**である。sources/ は材料であり、本文ではない。
2. **Git管理下**にあり、変更履歴が追跡可能である。
3. **ADR（Architecture Decision Record）が変更の正当性**を保証する。
4. **Verify/Evidence** なき変更は「存在しない」と見なす。
5. 本Part00 は **最優先で読まれるべき** であり、他のPartと矛盾した場合は Part00 が優先される。

**根拠**: [ADR-0001](../decisions/0001-ssot-governance.md)（SSOT運用ガバナンス）、[FACTS_LEDGER F-0004](FACTS_LEDGER.md)（フォルダ構造）

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語は以下を参照：

- **SSOT**: [glossary/GLOSSARY.md#SSOT](../glossary/GLOSSARY.md)（唯一の正本）
- **ADR**: [glossary/GLOSSARY.md#ADR](../glossary/GLOSSARY.md)（Architecture Decision Record）
- **Verify**: [glossary/GLOSSARY.md#Verify](../glossary/GLOSSARY.md)（機械判定可能な検証）
- **Evidence**: [glossary/GLOSSARY.md#Evidence](../glossary/GLOSSARY.md)（証跡・監査ログ）
- **Release**: [glossary/GLOSSARY.md#Release](../glossary/GLOSSARY.md)（不変の成果物）
- **DoD**: [glossary/GLOSSARY.md#DoD](../glossary/GLOSSARY.md)（Definition of Done）
- **Permission Tier**: [glossary/GLOSSARY.md#Permission-Tier](../glossary/GLOSSARY.md)（AI権限階層）
- **HumanGate**: [glossary/GLOSSARY.md#Permission-Tier](../glossary/GLOSSARY.md)（人間承認が必須の操作）

用語の詳細定義・境界・禁止表記は **glossary/GLOSSARY.md** を参照。
用語管理の運用ルールは **[Part02](Part02.md)** を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-0001: 真実の優先順位（Truth Order）【MUST】
矛盾が発生した場合、以下の順序で裁定する：

1. **SSOT（docs/）** — 本書/運用法規が最上位
2. **Verify（checks/）** — 機械判定：テスト・静的解析・整合性検査
3. **Evidence（evidence/）** — 証跡：ログ・差分・manifest・sha256
4. **Release（RELEASE/）** — 固定成果物：凍結された成果物
5. **会話・感想・推測** — 最下位（必ずVerify/Evidenceに昇格させる）

**根拠**: [FACTS_LEDGER F-0001](FACTS_LEDGER.md)
**違反例**: 「Claude Codeが言ったから正しい」→ 必ずVerifyで検証し、Evidenceに記録する。

---

### R-0002: 変更手順の固定（ADR→docs）【MUST】
仕様・運用を変更する場合、**必ず以下の順序** で実施する：

1. **decisions/** に ADR を追加（変更理由・選択肢・影響範囲を明記）
2. ADR が承認されたら、**docs/** の該当 Part を更新
3. **checks/** の検証手順を実行し、矛盾がないことを確認
4. **FACTS_LEDGER.md** に変更履歴を記録（任意だが推奨）

**根拠**: [ADR-0001 第1条](../decisions/0001-ssot-governance.md)、[FACTS_LEDGER F-0003](FACTS_LEDGER.md)
**違反例（禁止）**:
- ADR を書かずに docs/ を直接変更
- 変更理由を口頭・チャットだけで済ます
- 検証を省略して commit/push

---

### R-0003: sources/ の改変・削除禁止【MUST NOT】
**sources/** 内のファイルは **改変・上書き・削除禁止**（追記のみ許可）。

**理由**: sources/ は「事実の記録」であり、後から手を加えると証拠能力が失われる。
**根拠**: [ADR-0001 第3条](../decisions/0001-ssot-governance.md)、[ADR-0003](../decisions/0003-sources-duplicate-handling.md)（重複ファイル扱い）

**例外**:
- 新規ファイルの追加（Append-only）は可
- ファイル名の修正は _MANIFEST_SOURCES.md に記録すれば可
- research_inbox 運用で `10_raw/` から `20_curated/` へコピーすることは可（10_raw は保持する）

**違反例（禁止）**:
- sources/ 内のファイルを直接編集
- 重複ファイルを削除（ADR-0003で明示的に禁止）

---

### R-0004: 推測禁止・未決事項ルール【MUST】
不明点・曖昧点は **推測で埋めない**。必ず以下のいずれかに落とす：

1. **未決事項**（各Partの「11. 未決事項」に記載）
2. **FACTS_LEDGER の未決セクション**（U-XXXX）に登録
3. **ADR で決定を明文化**してから本文へ反映

**根拠**: [FACTS_LEDGER F-0002](FACTS_LEDGER.md)、[CLAUDE.md](../CLAUDE.md)
**違反例**: 「たぶんこうだろう」→ 必ず「未決事項」に記載し、後から確定情報で置き換える。

---

### R-0005: evidence/ 保存義務【MUST】
以下は **必ず evidence/ に保存**する（削除禁止）：

- Verify の実行結果（成功・失敗問わず）
- 変更前後の diff
- コマンド実行ログ
- manifest/sha256
- ロールバック手順

**理由**: 過去の検証結果を削除すると、「なぜこの変更が承認されたか」が追跡不能になる。
**根拠**: [FACTS_LEDGER F-0006](FACTS_LEDGER.md)（不変リリース）、[ADR-0001 第3条](../decisions/0001-ssot-governance.md)

**命名規則**: `evidence/verify_reports/YYYYMMDD_HHMMSS_<check_name>.md`

---

### R-0006: 禁止事項リスト【MUST NOT】
以下の行為は **原則禁止**。例外は HumanGate（人間承認）必須：

1. **仕様凍結前に実装を開始しない**（例外: SPIKEは隔離）
2. **Verifyを通していない変更をReleaseに入れない**
3. **証跡のない成功を成功と見なさない**（再現性必須）
4. **無言でファイル/フォルダ/名前を変えない**（変更理由・影響・ロールバック手順をEvidenceに残す）
5. **AIに削除・整理・大掃除を丸投げしない**（Dry-run→レビュー→実行→Verify）
6. **巨大な置換・削除を一発実行しない**（最小差分・段階実行・Verify必須）
7. **docs/00_INDEX.md のリンク導線を壊さない**（追加はOK、削除・変更は要ADR）

**根拠**: [FACTS_LEDGER F-0002](FACTS_LEDGER.md)、[F-0031](FACTS_LEDGER.md)（破壊操作の扱い）、[F-0032](FACTS_LEDGER.md)（仕様凍結前の実装禁止）

**違反例**:
- `rm -r -f sources/` を実行
- Part番号・ファイル名を無断で変更（参照が全壊する）
- テストを書かずに「動いた」と報告

---

### R-0007: Part番号・ファイル名の変更禁止【MUST NOT】
**Part00〜Part20 のファイル名は変更禁止**。

**理由**: Part番号は `docs/00_INDEX.md`, `FACTS_LEDGER.md`, `decisions/*.md` 等、リポジトリの広範囲から参照される不変の識別子であるため。ファイル名を変更すると、これらの参照がすべてリンク切れとなり、仕様の追跡可能性が失われる。
**根拠**: [CLAUDE.md](../CLAUDE.md)

**例外**: 新規Part追加（Part21以降）は可。ただし 00_INDEX.md への追記が必須。

---

### R-0008: 用語の統一【MUST】
新しい概念・略語・専門用語が登場したら：

1. **glossary/GLOSSARY.md** に用語を追加（定義・類義語・参照Partを明記）
2. **docs/ では必ず glossary/ の表記に統一**
3. 揺れを発見したら即座に glossary/ を確認し修正

**根拠**: [ADR-0001 第2条](../decisions/0001-ssot-governance.md)、[ADR-0002](../decisions/0002-glossary-part02-separation.md)（用語管理）
**詳細**: [Part02](Part02.md)（用語運用ルール）

---

### R-0009: 失敗定義（Failure）【MUST NOT】
以下の状態は **失敗** と見なす：

- Verifyに失敗したまま「次へ進む」
- Evidenceが残っていない
- 変更理由が説明できない（誰がなぜ何をしたか不明）
- 「後で直す」タスクが増殖して収束しない（VRループが回っていない）
- 依存や環境差で再現できない

**根拠**: [FACTS_LEDGER F-0030](FACTS_LEDGER.md)
**対処**: Part10（Verify Gate）、Part14（変更管理）を参照。

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: 本リポジトリを初めて読む場合
1. [docs/README.md](README.md) を読み、リポジトリの全体像を把握する
2. [docs/00_INDEX.md](00_INDEX.md) を読み、Part00〜20 の導線を確認する
3. **本Part00** を読み、運用ルール・禁止事項を理解する
4. [FACTS_LEDGER.md](FACTS_LEDGER.md) を読み、確定情報（F-XXXX）と未決事項（U-XXXX）を把握する
5. [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を読み、用語の定義を確認する
6. Part01 から順に読む（Part01: 目標、Part02: 用語、Part04: 作業管理、...）

### 手順B: 仕様・運用を変更する場合
1. **decisions/** に ADR を追加（テンプレートは `decisions/0001-ssot-governance.md` を参照）
2. ADR に以下を必ず記載：
   - 背景（なぜ変更が必要か）
   - 決定内容
   - 選択肢（案A/案B/案C）と採用理由
   - 影響範囲（互換性・セキュリティ・Verify/Evidence/Release）
   - 実行計画（手順・ロールバック・検証方法）
3. ADR を commit（メッセージ: `Add ADR-XXXX: <タイトル>`）
4. **docs/** の該当 Part を更新（ADR への参照を必ず含める）
5. **checks/** の検証手順を実行（リンク切れ・用語揺れ・未決事項検出）
6. 検証結果を **evidence/verify_reports/** に保存
7. 全て Green なら commit/push（メッセージ: `Update PartXX based on ADR-XXXX`）

### 手順C: 新しい用語を追加する場合
1. **glossary/GLOSSARY.md** に用語を追加（定義・境界・参照・類義語・禁止表記を必ず記載）
2. 変更は軽微なので ADR 不要（ただし、重要な用語の場合は ADR 推奨）
3. docs/ から glossary/ へのリンクを追加
4. commit（メッセージ: `Add term: <用語名> to glossary`）

詳細は [Part02](Part02.md)（用語運用ルール）を参照。

### 手順D: 禁止操作を実行する必要がある場合（HumanGate）
1. **実行前に必ず ADR を作成**し、理由・影響範囲・ロールバック手順を明記
2. Dry-run モードで影響範囲を確認（例: `git rm --dry-run`, `mv --dry-run` 相当）
3. 人間（HumanGate）が承認
4. 実行前に **バックアップ**（`_TRASH/YYYYMMDD_HHMMSS/` へ退避）
5. 実行
6. Verify を実行し、破壊がないことを確認
7. Evidence に「実行前後の状態」を保存

詳細は [Part09](Part09.md)（Permission Tier）を参照。

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: ADR を書かずに緊急変更が必要な場合
**対処**:
1. 緊急パッチを別ブランチで実施
2. Verify を通す
3. **変更後すぐに ADR を追記**（事後ADR）
4. 次回同様の緊急事態が発生した場合のルールを ADR に明記

**エスカレーション**: 緊急変更が頻発する場合、Part14（変更管理）の見直しを検討。

---

### 例外2: sources/ の削除が必要な場合（機密情報混入等）
**対処**:
1. **ADR を作成**（削除理由・影響範囲・復元不能性を明記）
2. 削除前に **バックアップ**（別途暗号化保管）
3. Git履歴からも削除（`git filter-repo` 等）
4. Evidence に「削除の経緯・承認者・タイムスタンプ」を記録

**エスカレーション**: Part09（Permission Tier）で HumanGate 必須。

---

### 例外3: Verify が通らない場合
**対処**:
1. **VRループ（Verify-Repair Loop）**を回す：
   - Verify 実行 → 失敗箇所を特定 → 修正 → Verify 再実行
2. 3回ループしても通らない場合、ADR で「一時的に Verify を緩和」を決定
3. 緩和条件（期限・後続タスク）を明記

**エスカレーション**: Part10（Verify Gate）を参照。

---

### 例外4: 推測が不可避な場合
**対処**:
1. 「11. 未決事項」に記載し、**明示的に推測であることを明記**
2. 例: `U-XXXX: XXXは不明（推測: YYYと思われるが、要確認）`
3. 後日、確定情報で置き換える

**禁止**: 推測を断定として記述する（「〜である」ではなく「〜と思われる（要確認）」）。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-0001: リンク切れ検出
**判定条件**: docs/ 内の全 `[00_INDEX](00_INDEX.md)` リンクが実在するファイルを参照しているか
**合否**: 1つでも切れていたら Fail
**実行方法**: `checks/verify_repo.ps1` の `Test-Links` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_link_check.md`

---

### V-0002: Part00〜20 の存在確認
**判定条件**: `docs/Part00.md` 〜 `docs/Part20.md` が全て存在するか
**合否**: 1つでも欠けていたら Fail
**実行方法**: `checks/verify_repo.ps1` の `Test-PartsExist` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_parts_check.md`

---

### V-0003: 禁止コマンド検出
**判定条件**: docs/ に `rm -r -f`, `git push --for ce`, `curl ｜ sh` 等の禁止コマンドが記載されていないか
**合否**: 1つでも検出されたら Fail
**実行方法**: `checks/verify_repo.ps1` の `Test-ForbiddenCommands` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_forbidden_check.md`

---

### V-0004: sources/ の改変検出
**判定条件**: sources/ 内のファイルが commit 間で変更されていないか（追加のみOK）
**合否**: 既存ファイルが変更されていたら Fail
**実行方法**: `git diff HEAD~1 HEAD -- sources/` でファイル変更を検出
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_sources_integrity.md`

---

### V-0005: 未決事項の可視化
**判定条件**: 各Part の「11. 未決事項」に項目があるか、空か
**合否**: 未決事項が存在しても Fail ではない（警告のみ）
**実行方法**: `checks/verify_repo.ps1` の `Test-UndecidedItems` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_undecided.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-0001: 変更履歴（Git commit log）
**保存内容**: commit メッセージ、変更ファイル一覧、diff
**参照パス**: `git log --oneline --all`、`git diff <commit>`
**保存場所**: Git履歴（リモートリポジトリに push されていることを確認）

---

### E-0002: ADR（意思決定ログ）
**保存内容**: 変更理由、選択肢、影響範囲、実行計画
**参照パス**: `decisions/XXXX-*.md`
**保存場所**: `decisions/` フォルダ（Git管理下）

---

### E-0003: Verify実行結果
**保存内容**: Verify の成功・失敗ログ、実行日時、実行者
**参照パス**: `evidence/verify_reports/YYYYMMDD_HHMMSS_*.md`
**保存場所**: `evidence/verify_reports/`（削除禁止）

---

### E-0004: sources/ 原文
**保存内容**: 原文・ログ・スクショ・会話履歴
**参照パス**: `sources/生データ/*.md`、`sources/_MANIFEST_SOURCES.md`
**保存場所**: `sources/`（改変・削除禁止）

---

### E-0005: 用語定義の変更履歴
**保存内容**: glossary/GLOSSARY.md の変更履歴
**参照パス**: `git log -- glossary/GLOSSARY.md`、`git diff <commit> -- glossary/GLOSSARY.md`
**保存場所**: Git履歴

---

## 10. チェックリスト

- [x] 本Part00 が全12セクション（0〜12）を満たしているか
- [x] Truth Order（R-0001）が明記されているか
- [x] ADR→docs 方向固定（R-0002）が明記されているか
- [x] sources/ の改変・削除禁止（R-0003）が明記されているか
- [x] 推測禁止・未決事項ルール（R-0004）が明記されているか
- [x] evidence/ 保存義務（R-0005）が明記されているか
- [x] 禁止事項リスト（R-0006）が明記されているか
- [x] Part番号・ファイル名変更禁止（R-0007）が明記されているか
- [x] 用語統一ルール（R-0008）が明記されているか
- [x] 失敗定義（R-0009）が明記されているか
- [x] 各ルールに FACTS_LEDGER または ADR への参照が付いているか
- [x] Verify観点（V-0001〜V-0005）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-0001〜E-0005）が参照パス付きで記述されているか
- [ ] checks/verify_repo.ps1 が実装されているか（次タスク）
- [ ] 本Part00 を読んだ人が「何をしてはいけないか」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-0001: ADR承認フロー
**問題**: ADR を「誰が」「どのタイミングで」承認するか不明。
**影響Part**: Part09（Permission Tier）、Part14（変更管理）
**暫定対応**: 初期は commit した時点で承認とみなす。

---

### U-0002: sources/ の保存期限
**問題**: sources/ をいつまで保存するか不明（ディスク容量上限）。
**影響Part**: Part14（変更管理）
**暫定対応**: 無期限保存（削除禁止）。容量不足時にADRで決定。

---

### U-0003: 機密情報の扱い
**問題**: sources/ に機密情報（API鍵、パスワード等）を含めてよいか不明。
**影響Part**: Part09（Permission Tier）
**暫定対応**: 機密情報は sources/ に含めない。別途暗号化保管。

---

### U-0004: Verify の自動実行タイミング
**問題**: Verify を「commit前」「push前」「CI/CD」のいつ実行するか不明。
**影響Part**: Part10（Verify Gate）
**暫定対応**: 手動実行（`checks/verify_repo.ps1` を明示的に実行）。

---

## 12. 参照（パス）

### docs/
- [docs/README.md](README.md) : リポジトリ全体の導線
- [docs/00_INDEX.md](00_INDEX.md) : Part00〜20 へのリンク
- [docs/FACTS_LEDGER.md](FACTS_LEDGER.md) : 確定情報（F-XXXX）と未決事項（U-XXXX）
- [docs/Part02.md](Part02.md) : 用語運用ルール
- [docs/Part09.md](Part09.md) : Permission Tier（AI権限管理）
- [docs/Part10.md](Part10.md) : Verify Gate（検証手順）
- [docs/Part14.md](Part14.md) : 変更管理（ADR/RFC/PATCHSET）

### sources/
- [sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md](../sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md) : 原文（43,822行）
- [sources/_MANIFEST_SOURCES.md](../sources/_MANIFEST_SOURCES.md) : 正本（Canonical）明記

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス
- [decisions/0002-glossary-part02-separation.md](../decisions/0002-glossary-part02-separation.md) : 用語管理の役割分離
- [decisions/0003-sources-duplicate-handling.md](../decisions/0003-sources-duplicate-handling.md) : sources/ 重複ファイル扱い

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義
- [glossary/README.md](../glossary/README.md) : 用語管理の運用ルール

### checks/
- `checks/verify_repo.ps1` : リポジトリ検証スクリプト（次タスクで作成予定）

### evidence/
- [evidence/verify_reports/README.md](../evidence/verify_reports/README.md) : 検証レポートの命名規則

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール（最上位）




FILE: docs\Part01.md
-----
# Part 01：目的・成功条件・失敗定義（トップクラス精度を運用で定義）

## 0. このPartの位置づけ
- **目的**: プロジェクトの最終ゴール・成功条件・失敗定義を明文化し、運用の判断基準を固定する。
- **依存**: [Part00](Part00.md)（SSOT憲法）
- **影響**: 全Part（目標がブレると全体が破綻する）

---

## 1. 目的（Purpose）

本プロジェクト（VCG/VIBE 2026 設計書SSOT）の最終ゴールは以下の3つを同時達成すること：

### 1.1 迷いゼロ（Zero Ambiguity）
- 次に何をすべきかが **常に一意** である
- タスクの優先順位・実行手順・完了条件が明確
- SSOT/ダッシュボード/VIBEKANBAN を見れば、次アクションが即座に分かる

### 1.2 事故ゼロ（Zero Accidents）
以下の事故を **未然防止** する：
- 誤削除/誤上書き
- 依存壊し/ビルド不能化
- セキュリティ事故（鍵混入、脆弱性放置）
- 「動いてる気がする」状態の放置（Verify/Evidence なき成功）

### 1.3 トップクラス精度（Top-Tier Precision）
- 仕様準拠が **機械的に担保** される
- 変更が最小化される（最小差分・影響範囲の限定）
- 検証・証跡・再現性・ロールバックが常備される

**根拠**: [FACTS_LEDGER F-0020](FACTS_LEDGER.md)（プロジェクト目的）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- 本リポジトリ（vibe-spec-ssot）内の全作業
- SSOT（docs/）の作成・更新・検証
- Verify/Evidence/Release の運用
- タスク（TICKET）単位の完了判定
- リリース単位の品質保証

### Out of Scope（適用外）
- 外部プロジェクト（他リポジトリ）の目標設定
- 個人の学習目標・スキル向上計画（本プロジェクトの運用目標とは別）
- 運用開始前の「理想の状態」議論（具体的な DoD が優先）

---

## 3. 前提（Assumptions）

1. **DoD（Definition of Done）が成功の唯一の基準** である。
2. **失敗定義に該当したら、即座に VRループ（Verify-Repair Loop）を回す**。
3. **メトリクスは運用改善のために計測** するが、計測自体が目的ではない。
4. **成功条件は機械判定可能** でなければならない（人間の「感覚」では判定しない）。
5. 本Part01 は **Part00（SSOT憲法）に従属** する（矛盾した場合は Part00 が優先）。

**根拠**: [Part00 R-0001](Part00.md)（真実の優先順位）

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **DoD（Definition of Done）**: [glossary/GLOSSARY.md#DoD](../glossary/GLOSSARY.md)
- **Verify**: [glossary/GLOSSARY.md#Verify](../glossary/GLOSSARY.md)
- **Evidence**: [glossary/GLOSSARY.md#Evidence](../glossary/GLOSSARY.md)
- **Release**: [glossary/GLOSSARY.md#Release](../glossary/GLOSSARY.md)
- **VRループ**: [glossary/GLOSSARY.md#VRループ](../glossary/GLOSSARY.md)
- **SBOM**: [glossary/GLOSSARY.md#SBF](../glossary/GLOSSARY.md)（Software Bill of Materials）
- **VIBEKANBAN**: [glossary/GLOSSARY.md#VIBEKANBAN](../glossary/GLOSSARY.md)

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-0101: タスク（TICKET）DoD【MUST】
タスクは以下の **5条件を全て満たした時のみ** 完了とする：

1. **Spec（仕様）が凍結** され、Acceptance（受入条件）が機械判定可能である
2. **Build（実装）がSpecに一致** し、差分が最小である
3. **Verify（テスト・静的解析・スキャン）が全てGreen** である
4. **Evidence（ログ・diff・manifest・sha256・実行結果）が保存** されている
5. **Release（必要な場合）は版管理** され、復元できる

**根拠**: [FACTS_LEDGER F-0021](FACTS_LEDGER.md)
**違反例**: 「テストは後で書く」→ Verify が Green でないため、未完了。

---

### R-0102: リリースDoD【MUST】
リリースは以下の **4条件を全て満たした時のみ** 成功とする：

1. **リリースフォルダが READ-ONLY**（改変不能）である
2. **バイナリ/生成物の整合性（sha256）** が取れている
3. **SBOM が生成** され、依存が追跡できる（最小でも CycloneDX または SPDX）
4. **主要なセキュリティスキャンが実施** され、重大な問題がゼロか、例外が承認済み（例外には期限がある）

**根拠**: [FACTS_LEDGER F-0022](FACTS_LEDGER.md)
**違反例**: sha256 を取らずにリリース → 改ざん検証不能のため、失敗。

---

### R-0103: 失敗定義（Failure）【MUST NOT】
以下の状態は **即座に失敗と見なし、VRループを回す**：

1. **Verifyに失敗したまま「次へ進む」**
2. **Evidenceが残っていない**
3. **変更理由が説明できない**（誰がなぜ何をしたか不明）
4. **「後で直す」タスクが増殖** して収束しない（VRループが回っていない）
5. **依存や環境差で再現できない**

**根拠**: [FACTS_LEDGER F-0030](FACTS_LEDGER.md)、[Part00 R-0009](Part00.md)
**対処**: [Part10](Part10.md)（Verify Gate）で VRループを回す。

---

### R-0104: 仕様凍結前の実装禁止【MUST NOT】
Spec が凍結されるまで Build しない。

**理由**: 曖昧さ・矛盾・用語ゆれは「実装で埋めない」。必ず Spec へ戻す。
**根拠**: [FACTS_LEDGER F-0032](FACTS_LEDGER.md)
**例外**: 調査用スパイクは「SPIKE」扱いで隔離し、成果は仕様へ移すまで本流に混ぜない。

---

### R-0105: メトリクスの計測【SHOULD】
以下のメトリクスを **定期的に計測** し、運用精度を可視化する：

1. **収束性**: VRループが何回で Green に戻るか
2. **再現性**: クリーン環境で Verify が通るか
3. **変更最小性**: パッチ行数/ファイル数/影響範囲
4. **事故率**: 破壊的変更の回数、鍵混入、ロールバック回数
5. **迷いゼロ指数**: 次アクションが SSOT/ダッシュボードで明確か

**根拠**: [FACTS_LEDGER F-0023](FACTS_LEDGER.md)
**保存先**: `evidence/metrics/YYYYMMDD_metrics.md`

---

### R-0106: 成功の再定義禁止【MUST NOT】
DoD を「緩和」して成功扱いすることを禁止する。

**理由**: 「80%できたから成功」では、残り20%が永遠に放置される。
**例外**: 一時的な緩和は ADR（decisions/）で明文化し、期限を設ける。

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: タスク完了判定
1. タスクの Acceptance（受入条件）を確認
2. Verify を実行（`checks/` 内のスクリプト or 手順書）
3. 全て Green なら Evidence を保存（`evidence/verify_reports/`）
4. R-0101（タスクDoD）の5条件を確認
5. 全て満たしていれば、タスクを「完了」とマーク（VIBEKANBAN / TODO）

### 手順B: リリース判定
1. リリース対象の成果物を `RELEASE/RELEASE_YYYYMMDD_HHMMSS/` に配置
2. manifest.csv と sha256.csv を生成
3. SBOM を生成（CycloneDX or SPDX）
4. セキュリティスキャンを実施（例: Trivy, Snyk）
5. R-0102（リリースDoD）の4条件を確認
6. 全て満たしていれば、リリースを「承認」とマーク
7. リリースフォルダを READ-ONLY に変更

詳細は [Part13](Part13.md)（Release Package）を参照。

### 手順C: 失敗時の対処（VRループ）
1. Verify の失敗箇所を特定（ログ・diff を確認）
2. 修正（最小差分）
3. Verify 再実行
4. 3回ループしても通らない場合、ADR で緩和を検討
5. 緩和条件（期限・後続タスク）を明記

詳細は [Part10](Part10.md)（Verify Gate）を参照。

### 手順D: メトリクス計測
1. 月次（または週次）で以下を集計：
   - VRループ回数の平均
   - Verify 失敗率
   - ロールバック回数
   - 事故発生件数
2. `evidence/metrics/YYYYMMDD_metrics.md` に記録
3. 傾向分析（増加傾向なら運用改善の検討）

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: Verify が3回ループしても通らない
**対処**:
1. ADR（decisions/）で「一時的に Verify を緩和」を提案
2. 緩和理由・期限・後続タスクを明記
3. HumanGate で承認
4. 緩和条件が満たされたら、元の Verify に戻す

**エスカレーション**: 緩和が常態化する場合、Verify の設計を見直す（Part10）。

---

### 例外2: DoD を満たせない（技術的制約）
**対処**:
1. 「Non-Goals」（やらないこと）に明記
2. ADR で制約を記録
3. 代替手段を提示（例: 手動検証で代替）

**エスカレーション**: 制約が解消された時点で、DoD を再評価。

---

### 例外3: 事故が発生した（誤削除・鍵混入等）
**対処**:
1. 即座に作業を停止
2. Evidence に「事故の経緯・影響範囲・原因」を記録
3. ロールバック or 復旧手順を実施
4. ADR で「再発防止策」を明文化
5. Part09（Permission Tier）の見直しを検討

**エスカレーション**: 事故率が高い場合、運用プロセス全体を見直す。

---

### 例外4: メトリクスが悪化している
**対処**:
1. 悪化の原因を特定（タスクの複雑化？Verify の不備？）
2. ADR で改善策を提案（例: タスクサイズの縮小、Verify の追加）
3. 改善策を実施し、次回計測で効果を確認

**エスカレーション**: 改善策が効果なしの場合、外部レビューを検討。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-0101: タスクDoD充足率
**判定条件**: R-0101 の5条件が全て満たされているか
**合否**: 1つでも欠けていたら Fail
**実行方法**: `checks/verify_dod.ps1` の `Test-TaskDoD` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_task_dod.md`

---

### V-0102: リリースDoD充足率
**判定条件**: R-0102 の4条件が全て満たされているか
**合否**: 1つでも欠けていたら Fail
**実行方法**: `checks/verify_release.ps1` の `Test-ReleaseDoD` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_release_dod.md`

---

### V-0103: 失敗状態の検出
**判定条件**: R-0103 の5つの失敗状態に該当するか
**合否**: 1つでも該当したら Fail（VRループ起動）
**実行方法**: `checks/verify_failure.ps1` の `Test-FailureState` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_failure_check.md`

---

### V-0104: Spec凍結の確認
**判定条件**: タスクの Spec が「凍結」状態か（`STATUS.md` に明記）
**合否**: 凍結されていなければ、Build 開始は Fail
**実行方法**: `checks/verify_spec_freeze.ps1` の `Test-SpecFreeze` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_spec_freeze.md`

---

### V-0105: メトリクス計測の実施確認
**判定条件**: 過去30日以内にメトリクス計測が実施されているか
**合否**: 実施されていなければ警告（Fail ではない）
**実行方法**: `checks/verify_metrics.ps1` の `Test-MetricsRecency` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_metrics_check.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-0101: タスク完了時の Evidence
**保存内容**:
- Verify 実行結果（全 Green のログ）
- diff（変更前後）
- manifest/sha256
- 実行コマンド履歴

**参照パス**: `evidence/verify_reports/YYYYMMDD_HHMMSS_task_<ID>.md`
**保存場所**: `evidence/verify_reports/`（削除禁止）

---

### E-0102: リリース時の Evidence
**保存内容**:
- manifest.csv（ファイル一覧）
- sha256.csv（整合性検証）
- SBOM（CycloneDX or SPDX）
- セキュリティスキャン結果
- STATUS.md（DoD チェックリスト）

**参照パス**: `RELEASE/RELEASE_YYYYMMDD_HHMMSS/`
**保存場所**: `RELEASE/`（READ-ONLY）

---

### E-0103: 事故時の Evidence
**保存内容**:
- 事故の経緯・影響範囲・原因
- ロールバック手順・実行結果
- 再発防止策（ADR へのリンク）

**参照パス**: `evidence/incidents/YYYYMMDD_HHMMSS_incident_<type>.md`
**保存場所**: `evidence/incidents/`（削除禁止）

---

### E-0104: メトリクス計測結果
**保存内容**:
- 収束性・再現性・変更最小性・事故率・迷いゼロ指数の実測値
- 傾向分析（前回比）

**参照パス**: `evidence/metrics/YYYYMMDD_metrics.md`
**保存場所**: `evidence/metrics/`

---

### E-0105: VRループのログ
**保存内容**:
- Verify 失敗回数
- 修正内容（diff）
- 収束までの時間

**参照パス**: `evidence/vr_loops/YYYYMMDD_HHMMSS_vr_<task_id>.md`
**保存場所**: `evidence/vr_loops/`

---

## 10. チェックリスト

- [x] 本Part01 が全12セクション（0〜12）を満たしているか
- [x] プロジェクト目的（迷いゼロ/事故ゼロ/トップクラス精度）が明記されているか
- [x] タスクDoD（R-0101）が明記されているか
- [x] リリースDoD（R-0102）が明記されているか
- [x] 失敗定義（R-0103）が明記されているか
- [x] 仕様凍結前の実装禁止（R-0104）が明記されているか
- [x] メトリクス計測（R-0105）が明記されているか
- [x] 成功の再定義禁止（R-0106）が明記されているか
- [x] 各ルールに FACTS_LEDGER への参照が付いているか
- [x] Verify観点（V-0101〜V-0105）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-0101〜E-0105）が参照パス付きで記述されているか
- [ ] checks/verify_dod.ps1 が実装されているか（次タスク）
- [ ] 本Part01 を読んだ人が「成功とは何か」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-0101: メトリクス計測の頻度
**問題**: メトリクスを「毎日」「毎週」「毎月」のどのタイミングで計測するか不明。
**影響Part**: Part10（Verify Gate）
**暫定対応**: 月次計測（負荷が低い）。運用が安定したら週次に変更を検討。

---

### U-0102: SBOM生成ツールの選定
**問題**: CycloneDX と SPDX のどちらを標準とするか不明。
**影響Part**: Part13（Release Package）
**暫定対応**: CycloneDX を優先（ツールが豊富）。SPDX も生成可能なら両方出力。

---

### U-0103: セキュリティスキャンの閾値
**問題**: 「重大な問題ゼロ」の定義が曖昧（CVSS何点以上？）。
**影響Part**: Part10（Verify Gate）
**暫定対応**: CVSS 7.0以上を「重大」と定義。今後の運用で調整。

---

### U-0104: 事故時の責任範囲
**問題**: AI が事故を起こした場合、「誰が」責任を負うか不明。
**影響Part**: Part09（Permission Tier）
**暫定対応**: HumanGate が最終承認者として責任を負う。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法（真実の優先順位・禁止事項）
- [docs/FACTS_LEDGER.md](FACTS_LEDGER.md) : 確定情報（F-0020, F-0021, F-0022, F-0023, F-0030）
- [docs/Part02.md](Part02.md) : 用語運用ルール
- [docs/Part04.md](Part04.md) : 作業管理（タスクフォーマット）
- [docs/Part09.md](Part09.md) : Permission Tier（AI権限管理）
- [docs/Part10.md](Part10.md) : Verify Gate（検証手順・VRループ）
- [docs/Part13.md](Part13.md) : Release Package（リリース手順）

### sources/
- [sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md](../sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md) : 原文（L39-80）

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_dod.ps1` : DoD検証スクリプト（次タスクで作成予定）
- `checks/verify_release.ps1` : リリース検証スクリプト（次タスクで作成予定）
- `checks/verify_failure.ps1` : 失敗状態検出スクリプト（次タスクで作成予定）

### evidence/
- `evidence/verify_reports/` : Verify実行結果
- `evidence/metrics/` : メトリクス計測結果
- `evidence/incidents/` : 事故ログ
- `evidence/vr_loops/` : VRループログ

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール（最上位）




FILE: docs\Part02.md
-----
# Part 02：共通語彙（用語固定で迷いを消す：SSOT/VAULT/RELEASE/DoD/ADR/Permission Tier等）

## 0. このPartの位置づけ
- 目的：プロジェクト全体で使用する用語を統一し、表記揺れ・認識齟齬を排除する
- 依存：glossary/GLOSSARY.md（用語の唯一定義）
- 影響：全Part（用語の参照元）、checks/（用語揺れ検証）

## 1. 目的（Purpose）

このPartは、プロジェクト全体で使用する **共通語彙（用語）** を定義し、表記揺れを防ぐための唯一の正（SSOT）を提供する。
- 用語の表記・意味・使用例を明確化
- Part 間の認識齟齬を防止
- 新規参加者の学習コストを低減

## 2. 適用範囲（Scope / Out of Scope）

### Scope
- プロジェクト固有の用語（SSOT、Permission Tier、HumanGate等）
- 技術用語の本プロジェクトにおける定義（Verify Gate、Evidence Pack等）
- 略語・頭字語の展開（ADR、DoD等）

### Out of Scope
- 一般的なIT用語（Git、Markdown等）の基本的な説明
- プログラミング言語固有の用語（本プロジェクトではドキュメント中心のため）

## 3. 前提（Assumptions）

1. 用語の唯一定義は **glossary/GLOSSARY.md** に配置される
2. Part02 は GLOSSARY.md の内容を補足・詳細化する
3. すべての Part は Part02 で定義された用語を使用する
4. 用語の追加・変更は Part02 と GLOSSARY.md を同期する

## 4. 用語（Glossary参照：Part02）

本Partが用語定義の基準となるため、セクション4は自己参照となる。
各用語の詳細はセクション5以降を参照。

## 5. ルール（MUST / MUST NOT / SHOULD）

### 5.1 用語使用のルール

- **MUST**: すべての Part は Part02 で定義された用語を使用する
- **MUST**: 用語の表記は Part02 の定義に完全一致させる（大文字/小文字、略語展開を含む）
- **MUST NOT**: Part02 で定義されていない用語を独自に定義しない（Part02 に追加する）
- **SHOULD**: 新規用語の追加時は、既存用語との重複・類似を確認する

### 5.2 用語の定義

#### SSOT (Single Source of Truth)
- **定義**: 唯一の正である情報源。本プロジェクトでは **docs/** が SSOT。
- **使用例**: 「SSOT である docs/ を変更する際は ADR を先に作成する」
- **関連**: ADR-0001（decisions/0001-ssot-governance.md）

#### Permission Tier
- **定義**: AI Agent/CLI/IDE による作業の権限階層。ReadOnly / PatchOnly / ExecLimited / HumanGate の4段階。
- **使用例**: 「この操作は ExecLimited Tier が必要」
- **詳細**: Part09（Permission Tier設計）
- **関連用語**: HumanGate、ReadOnly、PatchOnly、ExecLimited

#### HumanGate
- **定義**: 人間による明示的な承認が必要な操作。Permission Tier の最上位。
- **使用例**: 「ADR の作成は HumanGate が必要」
- **詳細**: Part09 セクション 5.1.4（Tier 4: HumanGate）
- **関連用語**: Permission Tier、承認プロセス

#### DoD (Definition of Done)
- **定義**: 作業完了の判定基準。以下の4項目：
  1. DoD-1: 差分明確化
  2. DoD-2: Verify PASS
  3. DoD-3: Evidence Pack 生成
  4. DoD-4: Commit/Push 完了
- **使用例**: 「DoD をすべて満たすまで完了としない」
- **詳細**: Part09 セクション 5.2（DoD の基準）

#### Verify Gate
- **定義**: 品質ゲート。Fast Verify（4点チェック）と Full Verify（詳細検証）の2種類。
- **使用例**: 「変更後は Fast Verify を実行する」
- **詳細**: Part10（Verify Gate設計）
- **関連用語**: Fast Verify、Full Verify

#### Fast Verify
- **定義**: 必須4点チェック（リンク切れ/用語揺れ/Part間整合/未決事項）による簡易検証。
- **使用例**: 「DoD-2 では Fast Verify の PASS が必須」
- **詳細**: Part09 セクション 6.2（Fast Verify の実行手順）
- **関連用語**: Verify Gate、Full Verify

#### Full Verify
- **定義**: 詳細検証。Fast Verify に加えて追加の検証項目を実施（詳細は Part10 で定義予定）。
- **使用例**: 「重要な変更時は Full Verify を実行すべき」
- **詳細**: Part10（未定義）
- **関連用語**: Verify Gate、Fast Verify

#### Evidence Pack
- **定義**: 作業の証跡パッケージ。変更差分/Verify レポート/実行ログ/承認記録（該当時）を含む。
- **使用例**: 「DoD-3 では Evidence Pack の生成が必須」
- **詳細**: Part09 セクション 9.1（必須 Evidence）
- **関連用語**: DoD、監査、証跡

#### ADR (Architecture Decision Record)
- **定義**: 意思決定記録。仕様/運用の変更は必ず **decisions/** に ADR を追加してから docs/ を変更する。
- **使用例**: 「SSOT運用ルールの変更には新規 ADR が必要（HumanGate）」
- **詳細**: decisions/ADR_TEMPLATE.md
- **関連用語**: SSOT、HumanGate

#### ReadOnly
- **定義**: Permission Tier の Tier 1。ファイル読み取り・検索・分析のみ実行可能。
- **使用例**: 「sources/ は ReadOnly のため改変禁止」
- **詳細**: Part09 セクション 5.1.1（Tier 1: ReadOnly）
- **関連用語**: Permission Tier、sources/

#### PatchOnly
- **定義**: Permission Tier の Tier 2。既存ファイルへの差分適用（Edit）のみ実行可能。
- **使用例**: 「docs/Part*.md の更新は PatchOnly で実行」
- **詳細**: Part09 セクション 5.1.2（Tier 2: PatchOnly）
- **関連用語**: Permission Tier、Edit

#### ExecLimited
- **定義**: Permission Tier の Tier 3。限定的な実行（新規ファイル作成、Git操作等）が可能。
- **使用例**: 「新規 Part の作成は ExecLimited が必要」
- **詳細**: Part09 セクション 5.1.3（Tier 3: ExecLimited）
- **関連用語**: Permission Tier、Git操作

#### 1Part=1Branch 原則
- **定義**: 並列タスク運用の型。1つのブランチで編集する Part は最大1つ（必要最小限の共有ファイルを除く）。
- **使用例**: 「1Part=1Branch 原則により、Part09 の編集は専用ブランチで実施」
- **詳細**: Part09 セクション 5.3（並列タスク運用の型）
- **関連用語**: 並列タスク、ブランチ戦略

#### VAULT
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

#### RELEASE
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

#### WORK
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

#### RFC
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

#### VIBEKANBAN
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

#### Context Pack
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

#### Patchset
- **定義**: （未定義、今後追加予定）
- **使用例**: -
- **詳細**: -

## 6. 手順（実行可能な粒度、番号付き）

### 6.1 新規用語の追加手順

1. **用語の必要性を確認**
   - 既存用語で代替できないか確認
   - 類似用語との重複を確認（Part02 全体を検索）

2. **用語定義の作成**
   - 定義：明確かつ簡潔に（1〜2文）
   - 使用例：実際の使用例を1つ以上記載
   - 詳細：詳細説明がある Part/セクションへの参照
   - 関連用語：関連する用語をリストアップ

3. **Part02 への追加**
   - セクション 5.2（用語の定義）に追記（アルファベット順/五十音順）
   - GLOSSARY.md にも同期追加

4. **Verify 実行**
   - Fast Verify（用語揺れチェック）を実行
   - Part02 追加後、他の Part で用語が正しく使用されているか確認

5. **Commit/Push**
   - 変更を commit（メッセージ例：「Add term: [用語名] to Part02」）

### 6.2 用語の修正手順

1. **修正理由の明確化**
   - なぜ修正が必要か（表記揺れ、意味の不明確さ等）
   - 影響範囲の確認（どの Part で使用されているか）

2. **Part02 の修正**
   - セクション 5.2 の該当用語を修正
   - GLOSSARY.md にも同期修正

3. **他 Part の更新**
   - 修正した用語を使用している Part を検索（Grep ツール使用）
   - 必要に応じて他 Part も更新（表記統一）

4. **Verify 実行**
   - Fast Verify（用語揺れチェック）を実行
   - 全 Part で用語が統一されているか確認

5. **Commit/Push**
   - 変更を commit（メッセージ例：「Update term: [用語名] in Part02 and related Parts」）

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 7.1 用語揺れの検出

**検出条件**：
- Fast Verify の用語揺れチェックで FAIL
- 同じ概念を表す複数の表記が存在

**対処**：
1. 揺れている用語をリストアップ
2. Part02 の定義を確認（正しい表記を特定）
3. 誤った表記を使用している Part を修正
4. 再度 Fast Verify を実行

### 7.2 未定義用語の使用

**検出条件**：
- Part02 で定義されていない用語が docs/ 内で使用されている

**対処**：
1. 用語が必要か判断（一般的なIT用語なら定義不要の可能性）
2. 定義が必要な場合、セクション 6.1 の手順で追加
3. 不要な場合、他の表現に置き換え

### 7.3 用語の重複定義

**検出条件**：
- 複数の Part で同じ用語が異なる意味で定義されている

**対処**：
1. Part02 での定義を確認（Part02 が正）
2. 他 Part の独自定義を削除
3. Part02 への参照に置き換え

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### 8.1 用語揺れの判定

| 項目 | 判定条件 | PASS | FAIL |
|------|----------|------|------|
| 表記統一 | Part02 の用語定義と docs/ 内の使用が一致 | 揺れ 0件 | 揺れ 1件以上 |
| 未定義用語 | docs/ 内の専門用語がすべて Part02 に定義されている | 未定義 0件 | 未定義 1件以上 |

### 8.2 用語定義の完全性

| 項目 | 判定条件 | PASS | WARN |
|------|----------|------|------|
| 定義の存在 | すべての用語に「定義」セクションがある | 100% | 90%未満 |
| 使用例の存在 | すべての用語に「使用例」がある | 100% | 90%未満 |

## 9. 監査観点（Evidenceに残すもの・参照パス）

### 9.1 用語追加・修正時の Evidence

- 変更差分（Part02 の before/after）
- 影響範囲（修正した用語を使用している Part のリスト）
- Verify レポート（用語揺れチェックの結果）

### 9.2 定期監査

- **SHOULD**: 四半期ごとに Part02 の完全性を監査
  - 未定義用語の洗い出し
  - 使用頻度の低い用語の削除検討
  - 新規追加すべき用語の検討

## 10. チェックリスト

新規用語追加・修正時：

- [ ] 既存用語との重複・類似を確認した
- [ ] 定義を明確かつ簡潔に記述した（1〜2文）
- [ ] 使用例を1つ以上記載した
- [ ] 詳細説明への参照（Part/セクション）を記載した
- [ ] 関連用語をリストアップした
- [ ] GLOSSARY.md にも同期追加/修正した
- [ ] Fast Verify（用語揺れチェック）を実行し PASS を確認した
- [ ] 影響範囲（他 Part での使用）を確認した
- [ ] Commit/Push を完了した

## 11. 未決事項（推測禁止）

- VAULT、RELEASE、WORK、RFC、VIBEKANBAN、Context Pack、Patchset の定義（今後追加予定）
- 用語の使用頻度分析（どの用語が頻繁に使用されているか）
- 用語集の多言語対応（必要性の検討）
- 自動用語揺れチェックツールの実装（checks/ で今後開発）

## 12. 参照（パス）

- glossary/GLOSSARY.md（用語の唯一定義）
- docs/Part00.md（前提・目的）
- docs/Part09.md（Permission Tier設計）
- docs/Part10.md（Verify Gate設計）
- checks/README.md（検証手順、用語揺れチェック）
- decisions/0001-ssot-governance.md（SSOT運用ガバナンス）




FILE: docs\Part03.md
-----
# Part 03：AI Pack（Core4/Antigravity/MCP・役割固定・コンテキスト共有）

## 0. このPartの位置づけ
- **目的**: 複数AIの役割を固定し、コンテキスト共有と並列実行を安全に実現する。
- **依存**: [Part00](Part00.md)（SSOT憲法）、[Part09](Part09.md)（Permission Tier）
- **影響**: 全Part（AIによる作業実行）

---

## 1. 目的（Purpose）

本 Part03 は **AI Pack（Core4 + Antigravity + MCP）** を通じて、以下を保証する：

1. **Core4（AI役割固定）**: 4つの課金AIを役割で固定し、責任範囲を明確化
2. **Antigravity（IDEハブ）**: エージェントの指揮所として、作業の迷いをゼロにする
3. **MCP（コンテキスト共有）**: 複数AIで同じコンテキストを共有し、コピペ地獄を終わらせる
4. **安全装置**: 軽量・安価なモデルを"本流の真実"にしない（Verify/Evidenceで固定）

**根拠**: [FACTS_LEDGER F-0008](FACTS_LEDGER.md)（Core4）、[F-0009](FACTS_LEDGER.md)（Antigravity）、[F-0011](FACTS_LEDGER.md)（MCP）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- Core4（ChatGPT, Claude Code, Gemini, Z.ai）の役割定義
- Antigravity（Google Antigravity）の運用設計
- MCP（Model Context Protocol）の導入方針
- AIの並列実行・コンテキスト共有

### Out of Scope（適用外）
- 個別AIのプロンプト設計（別途定義）
- 課金・コスト管理（プロジェクト外）
- 非課金AI（Claude 3.5 Haiku等）の利用（Core4以外）

---

## 3. 前提（Assumptions）

1. **Core4は役割固定**である（司令塔/実装/調査/補助の4役）。
2. **軽量・安価なモデルを"本流の真実"にしない**（必ずVerify/Evidenceで固定）。
3. **Antigravity は指揮所**であり、「コードを書く場所」ではない。
4. **MCP は読取から開始**し、書込は Permission Tier に従う。
5. **コンテキスト共有は Evidence に記録**される。

**根拠**: [FACTS_LEDGER F-0008](FACTS_LEDGER.md)、[Part09 R-0901](Part09.md)（Permission Tier）

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **Core4**: [glossary/GLOSSARY.md#Core4](../glossary/GLOSSARY.md)（4つの課金AI）
- **Antigravity**: Google Antigravity（IDEハブ）
- **MCP**: [glossary/GLOSSARY.md#MCP](../glossary/GLOSSARY.md)（Model Context Protocol）
- **Agent Pack**: AIエージェントのセット
- **Permission Tier**: [glossary/GLOSSARY.md#Permission-Tier](../glossary/GLOSSARY.md)（AI権限階層）

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-0301: Core4の役割固定【MUST】
4つの課金AIは以下の **役割で固定** する：

#### 1. ChatGPT（司令塔/編集長）
- **役割**: SSOT維持、設計・統合判断、レビュー設計、品質ゲート設計
- **Permission**: ReadOnly（読取専用）
- **用途**:
  - SSOT（docs/）の整合性確認
  - ADR の作成・レビュー
  - Verify の設計
  - タスク分割・優先順位付け
- **禁止**: 実装・コード生成（Claude Code の役割）

#### 2. Claude Code（実装エンジン）
- **役割**: 実装・修正・テスト駆動の反復（CLI/デスクトップ）
- **Permission**: ExecLimited（許可コマンドのみ実行）
- **用途**:
  - コード実装・修正
  - テスト実行・lint実行
  - Verify の実行
  - VRループ（Verify-Repair Loop）
- **禁止**: 設計判断（ChatGPT の役割）

#### 3. Gemini / Google One Pro（調査・統合ハブ）
- **役割**: 外部情報、長文理解、Google連携、Antigravity連動
- **Permission**: ReadOnly（読取専用）
- **用途**:
  - 外部資料の調査
  - 長文ドキュメントの理解
  - Google Workspace 連携
  - Antigravity との連携
- **禁止**: 実装・コード生成（Claude Code の役割）

#### 4. Z.ai Lite（補助LLM/API/MCP）
- **役割**: 軽量タスク、補助分析、並列ワーク（データ分類で制限）
- **Permission**: PatchOnly（差分作成のみ）
- **用途**:
  - ログ要約
  - データ分類・整理
  - 補助的なタスク
  - 並列ワーク（軽量）
- **禁止**: "本流の真実"を生成（必ずVerify/Evidenceで固定）

**根拠**: [FACTS_LEDGER F-0008](FACTS_LEDGER.md)
**注意**: 軽量・安価なモデルを"本流の真実"にしない。必ずVerify/Evidenceで固定する。

---

### R-0302: Antigravity の運用型【MUST】
Antigravity（Google Antigravity）は **エージェントの指揮所** として運用する：

#### 運用型
1. **Editor**: 人間が読む/編集する
2. **Mission Control**: エージェントが計画→実行→検証する
3. **ブラウザ・ターミナル・エディタの同期**を前提に、作業の迷いをゼロにする

#### 禁止
- Antigravity で「コードを書く」単独作業（エージェント連携を前提とする）
- Antigravity を「単なるエディタ」として使う（指揮所として使う）

**根拠**: [FACTS_LEDGER F-0009](FACTS_LEDGER.md)

---

### R-0303: MCP導入方針【MUST】
MCP（Model Context Protocol）は以下の方針で導入する：

#### Phase 1: 読取系MCPから開始
- **対象**: ファイル読取・検索・解析
- **Permission**: ReadOnly
- **例**: filesystem, sqlite, github

#### Phase 2: 書込系は「Patch-only」「許可制」
- **対象**: ファイル書込・コマンド実行
- **Permission**: PatchOnly or ExecLimited
- **例**: git, docker（読取のみ）

#### Phase 3: 破壊系は HumanGate
- **対象**: 削除・強制操作
- **Permission**: HumanGate（人間承認必須）
- **例**: `rm`, `git push --for ce`

#### 監査ログ必須
- **MCP実行時は Evidence に記録**（ツール名・入力・出力・実行日時）
- **保存先**: `evidence/mcp_logs/YYYYMMDD_HHMMSS_mcp_<tool>.md`

**根拠**: [FACTS_LEDGER F-0011](FACTS_LEDGER.md)、[Part09 R-0907](Part09.md)（MCP権限管理）

---

### R-0304: コンテキスト共有の原則【SHOULD】
複数AIで同じコンテキストを共有する際の原則：

1. **SSOT（docs/）を共有の基点**とする
2. **MCP で外部データを共有**（コピペ禁止）
3. **Evidence に共有履歴を記録**（誰が何を共有したか）
4. **コンテキスト共有は読取から開始**（書込は慎重に）

**理由**: "コピペ地獄"を終わらせ、同じコンテキストを複数AIで共有する。

---

### R-0305: 軽量モデルの制限【MUST NOT】
軽量・安価なモデル（Z.ai Lite等）は **"本流の真実"を生成しない**：

**禁止**:
- SSOT（docs/）の直接編集
- ADR の作成
- 設計判断

**許可**:
- ログ要約
- データ分類
- 補助タスク（Verify/Evidenceで固定する前提）

**根拠**: [FACTS_LEDGER F-0008](FACTS_LEDGER.md)（注意事項）

---

### R-0306: AI間の責任分界【MUST】
AI間の責任範囲を明確化し、越権を禁止する：

| AI | 設計 | 実装 | 調査 | 補助 |
|----|------|------|------|------|
| ChatGPT | ✅ | ❌ | ❌ | ❌ |
| Claude Code | ❌ | ✅ | ❌ | ❌ |
| Gemini | ❌ | ❌ | ✅ | ❌ |
| Z.ai Lite | ❌ | ❌ | ❌ | ✅ |

**違反例**:
- Claude Code が設計判断をする → ChatGPT へエスカレーション
- Z.ai Lite が SSOT を直接編集 → 禁止

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: Core4の役割分担
1. タスク（TICKET）を作成（ChatGPT が担当）
2. TICKET の実装を Claude Code に依頼
3. 外部資料の調査が必要な場合、Gemini に依頼
4. ログ要約が必要な場合、Z.ai Lite に依頼
5. 各AIの成果物を Evidence に保存
6. ChatGPT が統合判断（merge/revert）

### 手順B: Antigravity での作業
1. Antigravity の Editor でドキュメントを開く
2. Mission Control でエージェントを起動
3. エージェントが計画→実行→検証
4. 人間が diff をレビュー
5. 承認後に merge

### 手順C: MCP の導入
1. Phase 1: 読取系MCPをインストール（例: filesystem）
2. MCP の設定ファイルを作成（`.mcp/config.json`）
3. MCP を Permission Tier に従って設定（ReadOnly）
4. MCP 実行時は Evidence に記録
5. Phase 2: 書込系MCP を慎重に追加（ADR 必須）

### 手順D: コンテキスト共有
1. SSOT（docs/）を共有の基点とする
2. MCP で外部データを取得（例: github MCP で issue を取得）
3. 取得したデータを Evidence に保存
4. 複数AIで同じ Evidence を参照
5. Evidence に「誰が何を共有したか」を記録

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: AIが役割を越権
**対処**:
1. 即座に作業を停止
2. Evidence に「越権の内容」を記録
3. 正しいAIへエスカレーション
4. 越権したAIの成果物は削除（または HumanGate で確認）

**エスカレーション**: 頻発する場合、Part03 の見直し。

---

### 例外2: 軽量モデルが"本流の真実"を生成
**対処**:
1. 生成された内容を削除
2. Evidence に「軽量モデルの誤用」を記録
3. 正しいAI（ChatGPT or Claude Code）で再生成
4. Verify/Evidenceで固定

**エスカレーション**: R-0305 の徹底。

---

### 例外3: Antigravity が使えない環境
**対処**:
1. Claude Code（CLI/デスクトップ）で代替
2. エージェント連携は手動で実施
3. Mission Control 相当の機能は VIBEKANBAN で代替

**エスカレーション**: Antigravity の環境整備を検討。

---

### 例外4: MCP が Permission Tier を違反
**対処**:
1. MCP の設定を修正（ReadOnly に戻す）
2. Evidence に「MCP違反」を記録
3. MCP の再設定（ADR 必須）

**エスカレーション**: Part09 例外4 を参照。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-0301: Core4の役割遵守確認
**判定条件**: Evidence に各AIの作業記録があり、役割を遵守しているか
**合否**: 越権があれば Fail
**実行方法**: `evidence/` の作業ログをスキャン
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_core4_check.md`

---

### V-0302: 軽量モデルの SSOT 編集検出
**判定条件**: docs/ の変更履歴で、Z.ai Lite による直接編集がないか
**合否**: 検出されたら Fail
**実行方法**: `git log -- docs/` で author を確認
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_lightweight_check.md`

---

### V-0303: MCP 監査ログの存在確認
**判定条件**: MCP 実行時の Evidence が存在するか
**合否**: 記録なしなら警告（Fail ではない）
**実行方法**: `evidence/mcp_logs/` の存在確認
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_mcp_audit.md`

---

### V-0304: Antigravity 作業の diff 保存確認
**判定条件**: Antigravity での作業に対応する diff が Evidence に存在するか
**合否**: 記録なしなら Fail
**実行方法**: `evidence/antigravity/` の存在確認
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_antigravity_check.md`

---

### V-0305: コンテキスト共有の記録確認
**判定条件**: 複数AIでコンテキストを共有した記録が Evidence に存在するか
**合否**: 記録なしなら警告（Fail ではない）
**実行方法**: `evidence/context_sharing/` の存在確認
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_context_check.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-0301: Core4 作業記録
**保存内容**:
- AI名（ChatGPT/Claude Code/Gemini/Z.ai Lite）
- 作業内容
- 作業時刻
- 成果物（ファイルパス）

**参照パス**: `evidence/core4/YYYYMMDD_HHMMSS_<AI>_<task>.md`
**保存場所**: `evidence/core4/`

---

### E-0302: Antigravity 作業記録
**保存内容**:
- 作業内容
- diff（変更前後）
- エージェント実行ログ
- 承認者・承認日時

**参照パス**: `evidence/antigravity/YYYYMMDD_HHMMSS_<task>.md`
**保存場所**: `evidence/antigravity/`

---

### E-0303: MCP 実行ログ
**保存内容**:
- MCP 名・ツール名
- 入力パラメータ
- 出力結果
- 実行日時

**参照パス**: `evidence/mcp_logs/YYYYMMDD_HHMMSS_mcp_<tool>.md`
**保存場所**: `evidence/mcp_logs/`

---

### E-0304: コンテキスト共有記録
**保存内容**:
- 共有元AI・共有先AI
- 共有データ（パス or 内容）
- 共有日時

**参照パス**: `evidence/context_sharing/YYYYMMDD_HHMMSS_context.md`
**保存場所**: `evidence/context_sharing/`

---

### E-0305: 越権記録
**保存内容**:
- 越権したAI
- 越権内容
- 対処内容
- 正しいAIへのエスカレーション

**参照パス**: `evidence/violations/YYYYMMDD_HHMMSS_violation_<AI>.md`
**保存場所**: `evidence/violations/`

---

## 10. チェックリスト

- [x] 本Part03 が全12セクション（0〜12）を満たしているか
- [x] Core4の役割固定（R-0301）が明記されているか
- [x] Antigravity の運用型（R-0302）が明記されているか
- [x] MCP導入方針（R-0303）が明記されているか
- [x] コンテキスト共有の原則（R-0304）が明記されているか
- [x] 軽量モデルの制限（R-0305）が明記されているか
- [x] AI間の責任分界（R-0306）が明記されているか
- [x] 各ルールに FACTS_LEDGER への参照が付いているか
- [x] Verify観点（V-0301〜V-0305）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-0301〜E-0305）が参照パス付きで記述されているか
- [ ] Core4の運用が実際に回っているか（運用開始後に確認）
- [ ] 本Part03 を読んだ人が「AIの使い分け」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-0301: Antigravity の具体的な使い方
**問題**: Antigravity の Mission Control の具体的な操作手順が不明。
**影響Part**: Part03（本Part）
**暫定対応**: Antigravity のドキュメントを参照。実際に使ってみて手順を確立。

---

### U-0302: MCP の設定ファイル形式
**問題**: `.mcp/config.json` の具体的なフォーマットが不明。
**影響Part**: Part03（本Part）
**暫定対応**: MCP の公式ドキュメントを参照。

---

### U-0303: Core4以外のAIの扱い
**問題**: Core4以外のAI（例: Claude 3.5 Haiku）を使う場合のルールが不明。
**影響Part**: Part03（本Part）
**暫定対応**: Core4以外は使わない。必要な場合はADRで決定。

---

### U-0304: コンテキスト共有の上限
**問題**: 複数AIで共有するコンテキストのサイズ上限が不明。
**影響Part**: Part03（本Part）
**暫定対応**: 各AIのコンテキスト上限（例: 200K tokens）を超えないよう注意。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part01.md](Part01.md) : 目標・DoD
- [docs/FACTS_LEDGER.md](FACTS_LEDGER.md) : 確定情報（F-0008, F-0009, F-0011）
- [docs/Part02.md](Part02.md) : 用語運用ルール
- [docs/Part04.md](Part04.md) : 作業管理（VIBEKANBAN）
- [docs/Part09.md](Part09.md) : Permission Tier

### sources/
- [sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md](../sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md) : 原文（L129-159）

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_core4.sh` : Core4役割遵守確認（未作成）

### evidence/
- `evidence/core4/` : Core4 作業記録
- `evidence/antigravity/` : Antigravity 作業記録
- `evidence/mcp_logs/` : MCP 実行ログ
- `evidence/context_sharing/` : コンテキスト共有記録
- `evidence/violations/` : 越権記録

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part04.md
-----
# Part 04：作業管理（TICKET/VIBEKANBAN/WIP制限・タスクサイズ・進捗状態）

## 0. このPartの位置づけ
- **目的**: タスク（TICKET）の標準フォーマット・サイズ分類・WIP制限・進捗管理を明文化し、作業の迷いをゼロにする。
- **依存**: [Part00](Part00.md)（SSOT憲法）、[Part01](Part01.md)（DoD）
- **影響**: Part09（Permission Tier）、Part10（Verify Gate）、Part14（変更管理）

---

## 1. 目的（Purpose）

本 Part04 は **作業管理の標準化** を通じて、以下を保証する：

1. **迷いゼロ**: 次に何をすべきかが常に一意（VIBEKANBAN/SSOT を見れば即座に分かる）
2. **並列安全**: 複数タスクを worktree 隔離で並列実行し、衝突を防ぐ
3. **サイズ制限**: XL タスクを禁止し、L以下に分割することで収束性を担保
4. **進捗可視化**: TICKET の状態（READY/DOING/VERIFYING/DONE）を機械判定可能にする

**根拠**: [FACTS_LEDGER F-0040](FACTS_LEDGER.md)（TICKET フォーマット）、[F-0010](FACTS_LEDGER.md)（VIBEKANBAN）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- 本リポジトリ内の全タスク（TICKET）
- VIBEKANBAN による進捗管理
- タスクサイズの分類（S/M/L）
- WIP（Work In Progress）制限
- AI エージェントによるタスク実行

### Out of Scope（適用外）
- 外部プロジェクトのタスク管理
- 個人の TODO リスト（プロジェクトに無関係なもの）
- 長期計画（ロードマップ）は Part01 で扱う

---

## 3. 前提（Assumptions）

1. **TICKET は Spec 凍結後に作成**される（Part01 R-0104）。
2. **VIBEKANBAN は worktree 隔離**が前提（衝突防止）。
3. **XL サイズのタスクは禁止**（必ず L以下に分割）。
4. **WIP 制限を超えない**（並列上限を守る）。
5. **進捗状態は機械判定可能**である（STATUS.md に明記）。

**根拠**: [FACTS_LEDGER F-0041](FACTS_LEDGER.md)（サイズ分類）、[F-0042](FACTS_LEDGER.md)（WIP制限）

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **TICKET**: タスクの標準フォーマット（Goal/Non-Goals/Acceptance/Plan/Verify/Evidence/Rollback を含む）
- **VIBEKANBAN**: [glossary/GLOSSARY.md#VIBEKANBAN](../glossary/GLOSSARY.md)（並列エージェント実行の安全装置）
- **WIP（Work In Progress）**: 並列実行中のタスク数
- **worktree**: [glossary/GLOSSARY.md#worktree](../glossary/GLOSSARY.md)（Git の物理分離機能）
- **DoD**: [glossary/GLOSSARY.md#DoD](../glossary/GLOSSARY.md)（Definition of Done）
- **Spec Freeze**: 仕様凍結（実装開始の前提条件）

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-0401: TICKET 標準フォーマット【MUST】
各 TICKET は以下の **9項目を必ず含む**：

1. **Goal**: 何を達成するか（1文）
2. **Non-Goals**: やらないこと（暴走防止）
3. **Inputs**: 参照データ（SSOT の該当箇所、ファイル、URL等）
4. **Acceptance**: 機械判定可能な受入条件
5. **Risks**: 壊れやすい箇所/権限/鍵/外部依存
6. **Plan**: 手順（箇条書き、実行可能な粒度）
7. **Verify**: 実行コマンド/チェック項目
8. **Evidence**: 保存先と保存物
9. **Rollback**: 戻し方

**根拠**: [FACTS_LEDGER F-0040](FACTS_LEDGER.md)
**違反例**: Goal だけ書いて他を省略 → Acceptance/Verify/Rollback がないため、未完了。

**テンプレート例**:
```markdown
## TICKET-001: Part00 の作成

### Goal
Part00（SSOT憲法）を作成し、全12セクションを埋める。

### Non-Goals
- Part01以降の作成（別TICKET）
- checks/ の実装（別TICKET）

### Inputs
- FACTS_LEDGER.md（F-0001〜F-0003）
- ADR-0001（SSOT運用ガバナンス）
- docs/Part00.md（テンプレート）

### Acceptance
- Part00.md が全12セクション（0〜12）を満たしている
- 各ルールに FACTS_LEDGER or ADR への参照が付いている
- Verify観点（V-0001〜V-0005）が機械判定可能

### Risks
- リンク切れ（FACTS_LEDGER/ADR へのパスミス）
- 用語揺れ（glossary/ との不一致）

### Plan
1. FACTS_LEDGER から F-0001, F-0002, F-0003 を読む
2. Part00.md を12セクション構成で作成
3. 各ルールに根拠を付ける
4. commit（メッセージ: "Fill Part00 (SSOT constitution)"）

### Verify
- checks/verify_repo.ps1 の Test-Links を実行
- Part00.md の存在確認
- 禁止コマンド検出

### Evidence
- evidence/verify_reports/YYYYMMDD_HHMMSS_part00_check.md
- git commit log

### Rollback
- git revert <commit_hash>
- docs/Part00.md をテンプレートに戻す
```

---

### R-0402: タスクサイズ分類【MUST】
タスクは以下のサイズに分類し、**XL は禁止**（必ず L以下に分割）：

- **S（30〜90分）**: 単一ファイルor単一バグ、変更≤50行、Verify≤5分
- **M（半日）**: 複数ファイル、変更≤300行、Verify≤20分
- **L（1〜3日）**: 設計変更あり、テスト拡充、移行含む
- **XL（1週間+）**: **禁止**（必ず L以下に割る）

**根拠**: [FACTS_LEDGER F-0041](FACTS_LEDGER.md)
**理由**: XL タスクは収束しない、VRループが回らない、失敗時の影響範囲が大きい。

**分割例**:
- XL: 「Part00〜Part20 を全部埋める」→ 禁止
- L: 「Part00 を埋める」→ OK
- M: 「Part00 の Verify観点を追加」→ OK
- S: 「Part00 のリンク切れ修正」→ OK

---

### R-0403: WIP（Work In Progress）制限【MUST】
並列実行するタスク数は以下の上限を守る：

- **S: 並列2まで**
- **M: 並列1まで**（単独実行）
- **L: 並列0**（他のタスクを全て停止し、単独集中）

**前提**: エージェント並列は **worktree 隔離** が前提。隔離できないなら並列禁止。

**根拠**: [FACTS_LEDGER F-0042](FACTS_LEDGER.md)
**理由**: 並列過多は衝突・破壊・迷いの原因。

---

### R-0404: VIBEKANBAN の状態遷移【MUST】
タスクは以下の状態を遷移し、**必ず DONE に到達**する：

1. **READY**: Spec 凍結済み（実装開始可能）
2. **DOING**: 実装中（変更が発生）
3. **VERIFYING**: Verify 実行中
4. **REPAIRING**: 失敗修正（VRループ中）
5. **DONE**: DoD 満たし Evidence 保存済み
6. **BLOCKED**: 外部依存/不明点があり停止（解除条件を明記）

**根拠**: [FACTS_LEDGER F-0043](FACTS_LEDGER.md)
**違反例**: DOING → DONE へ直接遷移（VERIFYING を飛ばす）→ Verify 不足。

---

### R-0405: VIBEKANBAN の運用型【MUST】
VIBEKANBAN は「人間の計画 → AI の実行 → 人間の承認」の型に固定する。

**手順**:
1. 人間が TICKET を作成（Goal/Acceptance/Plan を明記）
2. AI（Claude Code等）が実装・Verify・Evidence 保存
3. 人間が diff をレビューし、承認（merge to main）

**根拠**: [FACTS_LEDGER F-0010](FACTS_LEDGER.md)
**理由**: AI の暴走を防ぎ、main を守る。

---

### R-0406: worktree 隔離の強制【MUST】
並列タスクは **必ず worktree で物理分離**する。

**理由**: 同一ディレクトリでの並列実行は、ファイル衝突・Git 衝突・破壊のリスクが高い。
**根拠**: [FACTS_LEDGER F-0010](FACTS_LEDGER.md)、[F-0007](FACTS_LEDGER.md)（Git戦略）

**例外**: worktree が使えない環境では、並列禁止（順次実行）。

---

### R-0407: BLOCKED 状態の解除条件明記【MUST】
タスクが BLOCKED 状態になった場合、**解除条件を明記**する。

**例**:
- `BLOCKED: Part09 の完成を待つ（依存）`
- `BLOCKED: API鍵の取得待ち（HumanGate）`
- `BLOCKED: 不明点（U-XXXX）の確定待ち`

**理由**: 解除条件がないと、永遠に BLOCKED のまま放置される。

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: TICKET の作成
1. タスクの Goal を1文で定義
2. Non-Goals を明記（暴走防止）
3. Inputs（参照先）を列挙
4. Acceptance を機械判定可能な形で記述
5. Risks を洗い出し（権限/鍵/外部依存）
6. Plan を実行可能な粒度で箇条書き
7. Verify の実行方法を明記
8. Evidence の保存先を指定
9. Rollback 手順を記述
10. VIBEKANBAN に READY 状態で追加

### 手順B: タスクの実行（AI）
1. VIBEKANBAN から READY 状態の TICKET を取得
2. WIP 制限を確認（並列上限を超えていないか）
3. worktree を作成（並列タスクの場合）
4. TICKET の Plan に従って実装
5. 状態を DOING → VERIFYING に変更
6. Verify を実行
7. 全て Green なら Evidence を保存し、DONE に変更
8. 失敗なら REPAIRING に変更し、VRループを回す

### 手順C: タスクの承認（人間）
1. DONE 状態の TICKET を取得
2. diff をレビュー（変更内容・影響範囲）
3. Evidence を確認（Verify ログ・manifest/sha256）
4. 問題なければ merge to main
5. VIBEKANBAN から TICKET を削除（アーカイブ）

### 手順D: タスクの分割（XL → L以下）
1. XL サイズのタスクを検出
2. Goal を複数の L/M/S に分割
3. 各サブタスクに TICKET を作成
4. 依存関係を明記（順序固定）
5. 元の XL TICKET を削除

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: WIP 制限を超えてしまった
**対処**:
1. 新規タスクを READY で待機させる
2. 既存タスクが DONE に到達してから開始
3. 緊急タスクの場合、既存タスクを BLOCKED に変更（理由明記）

**エスカレーション**: WIP 超過が常態化する場合、タスクサイズの見直し。

---

### 例外2: BLOCKED 状態が長期化
**対処**:
1. 解除条件を再確認（不明点が確定したか？依存タスクが完了したか？）
2. 解除できない場合、ADR で「TICKET の中止」を決定
3. 代替手段を検討

**エスカレーション**: BLOCKED が増殖する場合、計画の見直し。

---

### 例外3: worktree が使えない環境
**対処**:
1. 並列禁止（WIP=1 固定）
2. 順次実行（1タスクずつ完了させる）
3. 環境改善を検討（Git worktree のインストール）

**エスカレーション**: 並列実行が必須の場合、環境移行を検討。

---

### 例外4: AI が TICKET の Plan を無視
**対処**:
1. 即座に作業を停止
2. Evidence に「逸脱の経緯・影響範囲」を記録
3. Rollback（git revert）
4. TICKET の Plan を修正（曖昧さを排除）

**エスカレーション**: Part09（Permission Tier）の見直し。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-0401: TICKET フォーマット充足率
**判定条件**: R-0401 の9項目が全て記載されているか
**合否**: 1つでも欠けていたら Fail
**実行方法**: `checks/verify_ticket.ps1` の `Test-TicketFormat` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_ticket_format.md`

---

### V-0402: XL タスクの検出
**判定条件**: VIBEKANBAN に XL サイズのタスクが存在するか
**合否**: 1つでも存在したら Fail
**実行方法**: `checks/verify_wip.ps1` の `Test-NoXLTasks` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_xl_detection.md`

---

### V-0403: WIP 制限違反の検出
**判定条件**: 並列実行中のタスク数が WIP 上限を超えていないか
**合否**: 超過していたら Fail
**実行方法**: `checks/verify_wip.ps1` の `Test-WIPLimit` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_wip_limit.md`

---

### V-0404: VIBEKANBAN 状態整合性
**判定条件**: DOING 状態のタスクに対応する worktree が存在するか
**合否**: 不一致があれば Fail
**実行方法**: `checks/verify_kanban.ps1` の `Test-KanbanState` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_kanban_state.md`

---

### V-0405: BLOCKED 解除条件の明記
**判定条件**: BLOCKED 状態のタスクに解除条件が記載されているか
**合否**: 記載なしなら警告（Fail ではない）
**実行方法**: `checks/verify_kanban.ps1` の `Test-BlockedCondition` 関数
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_blocked_check.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-0401: TICKET 作成時の Evidence
**保存内容**:
- TICKET 全文（Goal/Non-Goals/Acceptance/Plan/Verify/Evidence/Rollback）
- 参照元（SSOT/ADR/FACTS_LEDGER）

**参照パス**: `VIBEKANBAN/100_SPEC/TICKET-XXX.md`
**保存場所**: `VIBEKANBAN/100_SPEC/`

---

### E-0402: タスク実行時の Evidence
**保存内容**:
- 実行ログ（コマンド履歴）
- diff（変更前後）
- Verify 結果
- manifest/sha256

**参照パス**: `evidence/tasks/YYYYMMDD_HHMMSS_ticket_<ID>.md`
**保存場所**: `evidence/tasks/`

---

### E-0403: タスク承認時の Evidence
**保存内容**:
- レビュー結果（diff の承認）
- merge commit hash
- 承認者・承認日時

**参照パス**: `evidence/approvals/YYYYMMDD_HHMMSS_ticket_<ID>.md`
**保存場所**: `evidence/approvals/`

---

### E-0404: WIP 状況のスナップショット
**保存内容**:
- 現在の WIP 数
- 各タスクの状態（READY/DOING/VERIFYING/REPAIRING/DONE/BLOCKED）
- worktree 一覧

**参照パス**: `evidence/wip_snapshots/YYYYMMDD_HHMMSS_wip.md`
**保存場所**: `evidence/wip_snapshots/`

---

### E-0405: BLOCKED タスクの履歴
**保存内容**:
- BLOCKED になった理由
- 解除条件
- BLOCKED 期間

**参照パス**: `evidence/blocked_history/YYYYMMDD_HHMMSS_blocked_<ID>.md`
**保存場所**: `evidence/blocked_history/`

---

## 10. チェックリスト

- [x] 本Part04 が全12セクション（0〜12）を満たしているか
- [x] TICKET 標準フォーマット（R-0401）が明記されているか
- [x] タスクサイズ分類（R-0402）が明記されているか
- [x] WIP 制限（R-0403）が明記されているか
- [x] VIBEKANBAN 状態遷移（R-0404）が明記されているか
- [x] VIBEKANBAN 運用型（R-0405）が明記されているか
- [x] worktree 隔離の強制（R-0406）が明記されているか
- [x] BLOCKED 解除条件明記（R-0407）が明記されているか
- [x] 各ルールに FACTS_LEDGER への参照が付いているか
- [x] Verify観点（V-0401〜V-0405）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-0401〜E-0405）が参照パス付きで記述されているか
- [ ] checks/verify_ticket.ps1 が実装されているか（次タスク）
- [ ] 本Part04 を読んだ人が「タスクの進め方」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-0401: VIBEKANBAN の物理実装
**問題**: VIBEKANBAN を「フォルダ」「Git Issue」「外部ツール（Trello等）」のどれで実装するか不明。
**影響Part**: Part04（本Part）
**暫定対応**: フォルダベース（`VIBEKANBAN/100_SPEC/`）で開始。運用が安定したら外部ツールへ移行を検討。

---

### U-0402: worktree の命名規則
**問題**: worktree のフォルダ名を「TICKET-ID」「ブランチ名」のどちらにするか不明。
**影響Part**: Part04、Part14（変更管理）
**暫定対応**: `worktree_<TICKET-ID>` 形式で統一。

---

### U-0403: BLOCKED の自動検出
**問題**: BLOCKED 状態を自動検出する方法が不明（依存タスクの未完了を機械判定できるか？）。
**影響Part**: Part10（Verify Gate）
**暫定対応**: 手動で BLOCKED を設定。自動検出は将来の改善課題。

---

### U-0404: タスク完了後のアーカイブ先
**問題**: DONE 状態のタスクを VIBEKANBAN から削除する際、どこにアーカイブするか不明。
**影響Part**: Part04、Part14（変更管理）
**暫定対応**: `VIBEKANBAN/900_RELEASE/` にアーカイブ。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part01.md](Part01.md) : 目標・DoD
- [docs/FACTS_LEDGER.md](FACTS_LEDGER.md) : 確定情報（F-0010, F-0040, F-0041, F-0042, F-0043）
- [docs/Part02.md](Part02.md) : 用語運用ルール
- [docs/Part09.md](Part09.md) : Permission Tier
- [docs/Part10.md](Part10.md) : Verify Gate
- [docs/Part14.md](Part14.md) : 変更管理

### sources/
- [sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md](../sources/生データ/VCG_VIBE_2026_MASTER_FINAL_20260109.md) : 原文（L143-197）

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_ticket.ps1` : TICKET フォーマット検証（次タスクで作成予定）
- `checks/verify_wip.ps1` : WIP制限・XLタスク検出（次タスクで作成予定）
- `checks/verify_kanban.ps1` : VIBEKANBAN 状態整合性検証（次タスクで作成予定）

### evidence/
- `evidence/tasks/` : タスク実行時の Evidence
- `evidence/approvals/` : タスク承認時の Evidence
- `evidence/wip_snapshots/` : WIP 状況スナップショット
- `evidence/blocked_history/` : BLOCKED タスク履歴

### VIBEKANBAN/
- `VIBEKANBAN/000_INBOX/` : 未分類タスク
- `VIBEKANBAN/100_SPEC/` : Spec 作成中（TICKET 保存先）
- `VIBEKANBAN/200_BUILD/` : 実装中
- `VIBEKANBAN/300_VERIFY/` : Verify 実行中
- `VIBEKANBAN/400_REPAIR/` : 修正中（VRループ）
- `VIBEKANBAN/900_RELEASE/` : 完了（アーカイブ）

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part05.md
-----
# Part 05：Core4運用（Claude/GPT/Gemini/Z.ai等の役割固定・衝突裁定・エスカレーション）

## 0. このPartの位置づけ
- 目的：Core4の役割固定と衝突裁定を運用手順として固定し、SSOTの整合性を守る
- 依存：Part00（SSOT憲法）、Part03（AI Pack）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：AI運用の責任分界、作業境界、証跡と監査の整合

## 1. 目的（Purpose）
Core4の役割・権限・衝突裁定・エスカレーションを明文化し、  
作業が運用ループとVerify/Evidenceに整合するよう統一する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- Core4（Claude/GPT/Gemini/Z.ai）の役割運用と裁定手順
- 役割衝突時の記録・修正・検証・監査
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- 個別AIのプロンプト設計の詳細（別Part）
- 組織固有の承認者の人事規定

## 3. 前提（Assumptions）
1. Core4の役割定義は Part03 に従う
2. Permission Tierは Part09 に従う
3. Verify/Evidenceは Part00/Part10/Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Core4**: 4つの課金AIの役割固定
- **衝突裁定**: 役割の衝突や判断差を解消する手続き
- **エスカレーション**: HumanGateへの承認要求

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-0501: 役割固定の遵守【MUST】
Core4の役割は Part03 の定義に従い、越境を行わない。

### R-0502: 衝突裁定の記録【MUST】
判断差が出た場合は発見・記録・修正・検証・監査の順で裁定する。

### R-0503: Permission Tierの順守【MUST】
権限外の操作は行わず、必要ならHumanGateで承認を得る。

### R-0504: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-0505: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-0506: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：役割衝突や判断差を特定し、影響範囲と参照根拠を確認する。
2. 記録：発見内容、根拠、対象ファイル、作業メモの保存先を記録する。
3. 修正：最小差分で裁定内容を反映し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、裁定結果を確定する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 役割衝突が解消できない
- HumanGateで裁定者を指定し、決定理由を記録する。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-0501: 役割裁定の記録
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-0502: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-0501: 裁定記録
**内容**: 判断差、裁定理由、参照根拠、変更概要  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-0502: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-0503: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] 役割裁定と参照根拠が記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part03](./Part03.md) : AI Pack / Core4
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part06.md
-----
# Part 06：IDE/司令塔運用（Antigravity中心・安全プロファイル・作業境界・レビュー主導）

## 0. このPartの位置づけ
- 目的：IDE/司令塔の運用境界を固定し、安全プロファイルとレビュー主導でSSOTを保護する
- 依存：Part00（SSOT憲法）、Part03（AI Pack）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：docs/ 更新の運用手順、作業境界、証跡と監査の整合

## 1. 目的（Purpose）
IDE/司令塔（Antigravity）を「指揮と確認の場」として運用し、  
作業境界・安全プロファイル・レビュー主導を徹底してSSOTの汚染を防ぐ。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- IDE/司令塔（Antigravity）での運用手順
- docs/ 更新における作業境界とレビュー主導
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- 実装コード・テスト設計の詳細（別Part）
- 組織固有の承認者の人事規定

## 3. 前提（Assumptions）
1. IDE/司令塔は指揮・確認の場として運用する
2. Permission Tierは Part09 に従う
3. Verify/Evidenceは Part00/Part10/Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **IDE/司令塔**: Antigravityを中心とした作業指揮・確認の場
- **安全プロファイル**: ReadOnly/ExecLimited などの作業権限制御
- **作業境界**: docs/ を中心とした変更範囲の制約

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-0601: 司令塔の役割固定【MUST】
IDE/司令塔は「指揮・確認・レビュー」に限定し、無断の実装判断をしない。

### R-0602: 安全プロファイル適用【MUST】
最小権限で作業し、必要時のみ承認を得て権限を上げる。

### R-0603: レビュー主導【MUST】
変更はレビュー前提で進め、発見・記録・検証の順序を省略しない。

### R-0604: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-0605: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-0606: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：対象作業の範囲・依存・権限制約を確認する。
2. 記録：発見内容、参照根拠、対象ファイル、作業メモの保存先を記録する。
3. 修正：最小差分で更新し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、レビュー判断を記録する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 権限が不足・不一致
- Permission Tierを見直し、必要ならHumanGateで承認を得て再実行する。

### 例外4: 汚染の疑い
- 参照根拠を照合し、根拠不明な更新を除外して再検証する。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-0601: 司令塔運用の記録
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-0602: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-0601: 運用記録
**内容**: 作業範囲、権限プロファイル、参照根拠、変更概要  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-0602: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-0603: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] 作業境界と権限プロファイルが記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part03](./Part03.md) : AI Pack / Antigravity
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part07.md
-----
# Part 07：Spec（仕様凍結）運用（Spec必須要素・Freeze基準・承認手順）

## 0. このPartの位置づけ
- 目的：Specの凍結と承認を実務手順として固定し、後戻りと汚染を防ぐ
- 依存：Part00（SSOT憲法）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：docs/ の仕様記述、凍結判断、証跡と監査の整合

## 1. 目的（Purpose）
Spec凍結の判断基準・必須要素・承認手順を明確化し、  
凍結後の変更が運用ループと証跡に従うよう統一する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- docs/ のSpec凍結判断と更新手順
- 凍結に必要な必須要素の確認
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- 実装コードやテスト設計の詳細（別Part）
- 組織固有の承認者の人事規定

## 3. 前提（Assumptions）
1. docs/ が唯一のSSOTである
2. Verify/Evidenceの定義は Part00/Part10/Part12 に従う
3. 変更管理は Part14 に従う
4. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Spec**: 仕様記述（docs/ 内の要件・制約・合意事項）
- **Freeze**: 仕様の凍結（変更には明示の手続きが必要な状態）
- **Approval**: 承認（HumanGateを含む）

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-0701: 必須要素の充足【MUST】
凍結前に、目的・スコープ・非スコープ・制約・成功条件・検証方針が明記されていること。

### R-0702: 運用ループの順守【MUST】
凍結作業は「発見 → 記録 → 修正 → 検証 → 監査」の順で実施する。

### R-0703: 変更管理の適用【MUST】
凍結後の変更は Part14 の手続きに従い、必要ならADRを先行する。

### R-0704: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-0705: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-0706: 最小差分【SHOULD】
凍結に無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：凍結対象のSpecを特定し、必須要素の不足や矛盾を確認する。
2. 記録：不足点、参照根拠、対象ファイル、作業メモの保存先を記録する。
3. 修正：最小差分でSpecを補完し、sources/ 無改変を維持する。
4. 検証：Fast検証を実行し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、凍結可否を判断する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 凍結後の変更要請
- 変更管理（Part14）に従い、必要ならADRを先行し、再度凍結判断を行う。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-0701: 必須要素の充足
**判定条件**:
1. 目的・スコープ・非スコープ・制約・成功条件・検証方針が記載されている
2. 凍結対象が明記されている

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: 必須要素が欠落している

**ログ**: evidence/verify_reports/

### V-0702: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-0701: 凍結判断記録
**内容**: 必須要素の確認結果、凍結可否、参照根拠  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-0702: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-0703: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] 凍結判断と参照根拠が記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part08.md
-----
# Part 08：Context Engineering（Context Pack生成・入力最小化・信頼境界）

## 0. このPartの位置づけ
- 目的：Context Packの生成と信頼境界を実務手順として固定し、過剰入力と汚染を防ぐ
- 依存：Part00（SSOT憲法）、Part03（AI Pack）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：docs/ 更新の入力設計、参照根拠、証跡と監査の整合

## 1. 目的（Purpose）
Context Packの入力最小化・信頼境界・参照根拠の明示を統一し、  
AI運用がSSOTを逸脱しないようにする。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- Context Packの生成と更新手順
- 入力最小化の判断基準
- 参照根拠と信頼境界の記録
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- 個別AIのプロンプト設計の詳細（別Part）
- 外部情報の収集手順（別Part）

## 3. 前提（Assumptions）
1. SSOTは docs/ に固定される
2. Permission Tierは Part09 に従う
3. Verify/Evidenceは Part00/Part10/Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Context Pack**: 作業に必要な最小限の参照束
- **信頼境界**: 参照可能な根拠範囲（SSOT/Verify/Evidenceの優先順）
- **入力最小化**: 必要最小限の情報に絞る運用

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-0801: Context Pack最小化【MUST】
作業に必要な最小限の参照のみを含め、過剰な入力を避ける。

### R-0802: 信頼境界の明示【MUST】
参照根拠の優先順位（SSOT/Verify/Evidence）を明記する。

### R-0803: 運用ループの順守【MUST】
Context Packの更新は「発見 → 記録 → 修正 → 検証 → 監査」で実施する。

### R-0804: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-0805: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-0806: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：Context Packの不足・過剰・根拠不整合を特定する。
2. 記録：発見内容、参照根拠、対象ファイル、保存先を記録する。
3. 修正：最小差分でContext Packを更新し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、信頼境界を確認する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 参照根拠が不明
- 未決事項として記録し、確定情報が得られるまで反映しない。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-0801: Context Pack更新の記録
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-0802: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-0801: Context Pack記録
**内容**: 参照根拠、最小化判断、変更概要  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-0802: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-0803: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] 信頼境界と参照根拠が記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part03](./Part03.md) : AI Pack / Context共有
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part09.md
-----
# Part 09：Permission Tier（ReadOnly/PatchOnly/ExecLimited/HumanGateの権限設計）

## 0. このPartの位置づけ
- 目的：AI Agent/CLI/IDEによる作業の権限階層を定義し、越権・破壊・不正変更を防止する
- 依存：Part02（用語）、Part10（Verify Gate）、decisions/0001-ssot-governance.md
- 影響：Part06（IDE/司令塔運用）、Part11（並列タスク運用）、全Part（実行権限の基準）

## 1. 目的（Purpose）

SSOT（docs/）を壊さず、安全に更新するための **権限階層（Permission Tier）** を定義する。
- AI Agentや自動化ツールが「どこまで自律実行できるか」を明確化
- 破壊的操作・方針変更・例外承認は **HumanGate（人間判断）** を必須化
- 全ての作業に **DoD（Definition of Done）** を設定し、証跡（Evidence）を残す

## 2. 適用範囲（Scope / Out of Scope）

### Scope
- リポジトリ内のすべてのファイル操作（読み取り/変更/削除/実行）
- AI Agent/CLI/IDE/人間による作業の権限レベル
- HumanGate（人間承認）が必要な操作の明確化
- 例外承認プロセスと証跡要件
- DoD（Definition of Done）の基準

### Out of Scope
- 外部システム（GitHub API、CI/CD）の権限管理（Part14参照）
- ユーザー認証・認可の実装詳細（インフラ層）

## 3. 前提（Assumptions）

1. このリポジトリは **SSOT（Single Source of Truth）** であり、破壊は許容しない
2. AI Agentは指示に従うが、**判断ミス・過剰実行・暴走** のリスクがある
3. 人間の承認（HumanGate）は **最終防衛線** として機能する
4. すべての変更は **再現可能・監査可能** でなければならない

## 4. 用語（Glossary参照：Part02）

- **Permission Tier**：作業の権限レベル（ReadOnly / PatchOnly / ExecLimited / HumanGate）
- **HumanGate**：人間による明示的な承認が必要な操作
- **DoD (Definition of Done)**：作業完了の判定基準
- **Evidence Pack**：作業の証跡（ログ/差分/判定結果）
- **ADR**：Architecture Decision Record（意思決定記録、decisions/に配置）
- **SSOT**：Single Source of Truth（docs/が正本）
- **Verify Gate**：品質ゲート（Fast/Full、Part10参照）

## 5. ルール（MUST / MUST NOT / SHOULD）

### 5.1 Permission Tier の定義

#### Tier 1: ReadOnly（読み取りのみ）
- **MUST**: AI Agentはファイル読み取り、検索、分析のみ実行可能
- **MUST NOT**: ファイルの変更・削除・実行は禁止
- **適用対象**:
  - sources/（根拠資料、改変禁止）
  - evidence/（監査証跡、改変禁止）
  - decisions/（ADR、既存ファイルの改変禁止、追加のみ HumanGate）

#### Tier 2: PatchOnly（差分適用のみ）
- **MUST**: AI Agentは既存ファイルへの差分適用（Edit）のみ実行可能
- **MUST NOT**: 新規ファイル作成、ファイル削除、ファイル名変更は禁止
- **MUST**: 変更前に必ずファイルを読み取り（Read）してから Edit を実行
- **MUST**: 変更後は必ず Verify Gate（Fast）を実行
- **適用対象**:
  - docs/Part*.md（既存Partの内容更新）
  - glossary/GLOSSARY.md（用語の定義追加・修正）

#### Tier 3: ExecLimited（限定的な実行）
- **MUST**: AI Agentは以下の操作を実行可能：
  - 新規ファイル作成（docs/Part*.md、glossary/、checks/ の範囲内）
  - Verify スクリプトの実行（checks/ 配下のみ）
  - Git操作（commit、push、branch作成）
- **MUST NOT**: 以下は禁止：
  - sources/ 内のファイル削除・上書き
  - Part番号の変更・ファイル名変更
  - 既存ADR（decisions/*.md）の改変
- **MUST**: 実行前に DoD（Definition of Done）を確認
- **MUST**: 実行後に Evidence Pack を生成

#### Tier 4: HumanGate（人間承認必須）
- **MUST**: 以下の操作には人間の明示的な承認が必要：
  - 新規ADR（decisions/）の作成
  - Part番号・ファイル名の変更
  - sources/ の削除・上書き
  - SSOT運用ルール（CLAUDE.md、ADR-0001）の変更
  - 破壊的な変更（互換性喪失、過去の証跡削除）
  - 例外承認（Permission Tierの一時的な緩和）
- **MUST**: 承認プロセスは以下の手順で実行（セクション 6.3 参照）
- **MUST**: 承認結果は evidence/ に記録

##### HumanGate 承認者・SLA・承認チャネル
- **MUST**: 承認者は `decisions/0004-humangate-approvers.md` に記録（主要/代理/緊急の3系統）
- **MUST**: 承認SLAを明記し、期限超過時は自動エスカレーション（SLA: 通常24h、重要48h、緊急2h）
- **MUST**: 承認チャネルは「PR Review」または「Issue/Chatの明示承認（LGTM + 確認ログ）」に限定
- **MUST**: 承認ログは `evidence/humangate_approvals/` に保存し、参照パスを明記

### 5.2 DoD（Definition of Done）の基準

すべての作業は以下の **DoD** を満たさなければ完了とみなさない：

#### DoD-1: 差分明確化
- **MUST**: 変更内容を明確に文章化（変更点の要約）
- **MUST**: 編集ファイル一覧を列挙（パス付き）

#### DoD-2: Verify PASS
- **MUST**: Fast Verify（4点チェック）を実行し、全項目 PASS を確認
  1. docs 内リンク切れ（相対パス/外部URL）
  2. 用語揺れ（glossary と docs の不一致）
  3. Part間整合（Part00 との衝突チェック）
  4. 未決事項の残存一覧（TODO/未決の集計）
- **SHOULD**: Full Verify（詳細検証）は重要な変更時に実行

#### DoD-3: Evidence Pack 生成
- **MUST**: 以下を evidence/ に保存：
  - 変更差分（git diff または編集前後の比較）
  - Verify レポート（Fast Verify の実行結果）
  - 実行ログ（タイムスタンプ、実行者、コマンド履歴）

#### DoD-4: Commit/Push 完了
- **MUST**: 変更を Git commit し、適切なブランチに push
- **MUST**: Commit メッセージは変更内容を簡潔に記述
- **MUST**: ブランチ名は `claude/<task-description>-<session-id>` 形式

### 5.3 並列タスク運用の型（1Part=1Branch原則）

#### 原則
- **MUST**: 1つのブランチで編集する Part は最大1つ（必要最小限の共有ファイルを除く）
- **MUST**: 共有ファイル（Part02 用語集、GLOSSARY.md など）の担当を固定化
- **MUST**: Verify は作業完了後に1回のみ実行（中間実行は任意）
- **MUST**: 証跡（Evidence Pack）は作業完了時に生成・保存

#### 共有ファイルの扱い
- **Part02（用語集）**: 用語追加・修正は PatchOnly で実行可能
- **GLOSSARY.md**: Part02 と同期、用語定義の唯一の正
- **00_INDEX.md**: リンク追加のみ（構造変更は HumanGate）
- **CLAUDE.md**: 変更は HumanGate 必須

#### 衝突回避
- **MUST**: 並列作業時は異なる Part を担当
- **MUST**: 共有ファイル更新は1ブランチで完結させる
- **SHOULD**: Part02/GLOSSARY.md の更新は優先的に merge

### 5.4 Model Context Protocol (MCP) Authorization and Security Considerations

このプロジェクトでは、AIとのセキュアな連携のためModel Context Protocol (MCP)の認証・セキュリティ概念をPermission Tier設計の技術的基盤として採用する。詳細は [Part28](Part28.md)（MCP連携設計）を参照。

#### 5.4.1 MCP Authorizationの原則

- **標準化された認証フロー**: MCPはOAuth 2.1を基盤とし、AIアプリケーションと外部システム間のセキュアな相互作用を保証する。
- **機密データ保護**: ユーザー固有データ、APIへのアクセス、監査要件、厳格なアクセス制御が必要なエンタープライズ環境で特に推奨される。
- **OAuth 2.1標準の採用**: OAuth 2.0 Authorization Server Metadata (RFC8414), OAuth 2.0 Dynamic Client Registration Protocol (RFC7591), OAuth 2.0 Protected Resource Metadata (RFC9728), Resource Indicators for OAuth 2.0 (RFC 8707) などの主要標準を統合。
- **明確な認証フロー**: MCPサーバーが `401 Unauthorized` で応答し、Protected Resource Metadata (PRM) ドキュメントを通じてクライアントを認証サーバーに誘導する。
- **役割分担**: MCPサーバーはOAuth 2.1リソースサーバー、MCPクライアントはリソースオーナーの代理としてリクエストを行うOAuth 2.1クライアントとして機能する。

#### 5.4.2 MCP Security Considerations（実装のベストプラクティス）

- **「決して信用せず、常に検証する」原則**: すべてのMCP相互作用は認証・認可されなければならない。
- **ジャストインタイム（JIT）アクセス**: 認証情報は必要な場合にのみ、時間制限付きで発行される。
- **継続的な検証と行動異常検出**: すべてのリクエストに対して認可を再検証し、異常を検出する。
- **明示的なサーバー検証**: MCPサーバーの身元は、なりすまし防止のため暗号的に検証される。
- **粒度の細かい権限制御**: 各ツールと機能に対し、きめ細かいアクセス制御を適用する。
- **主要な脆弱性とその緩和策**:
    - **プロンプトインジェクション攻撃**: ユーザー入力の検証、区切り文字の使用、モデル出力のフィルタリング、最小限のコンテキスト提供で緩和。
    - **混同された代理人問題**: 静的クライアントID、動的クライアント登録、同意クッキーの組み合わせに注意し、適切な同意メカニズムを確保。
    - **セッションハイジャック**: 安全な非決定的なセッションIDの使用、セッションIDとユーザー情報のバインド、認証にセッションを使用しないことで防止。
    - **ローカルMCPサーバーの侵害**: 不適切な制限による任意のコード実行、データ漏洩、データ損失を防ぐための厳格なアクセス制御。
- **セキュアな開発ライフサイクル**: 設計からテストまで、セキュリティを全フェーズに統合。
- **ランタイム監視**: システムコール、リソース使用、ファイルアクセス、ネットワークアクティビティを監視。
- **基盤セキュリティ**: 全ユーザー入力の検証、モデル出力のフィルタリング・サニタイズ、全相互作用のロギング、定期的な脆弱性テスト。
- **OAuth 2.1 with PKCE**: Proof Key for Code Exchange (PKCE) の使用は必須。
- **HTTPS要件**: 全ての認証エンドポイントはHTTPSを介して提供される。
- **トークンストレージと検証**: クライアントはトークンを安全に保存し、サーバーはアクセスが意図したオーディエンス向けに発行されたことを検証する。
- **リダイレクトURI検証**: オープンリダイレクト脆弱性防止のため必須。
- **STDIOトランスポートセキュリティ**: ローカル通信は安全とみなされるが、基盤となるシステムのセキュリティに依存。

### 5.5 Policy-as-Code（Conftest/OPA）による強制【SHOULD】

Permission Tierを補完するため、**Policy-as-Code**（Conftest/OPA）による自動検証を導入する：

#### 適用範囲
- **危険コマンドの自動拒否**: 任意ディレクトリ強制削除、git force push 等を機械的に検知・拒否
- **設定逸脱の検知**: 推奨設定（Part00-30のルール）からの逸脱を自動検出
- **権限検証**: 適切な権限設定（Part09 Permission Tier）を自動検証

#### 実装方法
- **Conftest**: OPA（Open Policy Agent）ベースのポリシー検証ツール
- **ポリシー定義**: `policy/` ディレクトリにRegoポリシーを配置
- **実行タイミング**: Commit前、PR作成時、マージ前に自動実行

#### ポリシー例
```rego
package vibe.spec

# 危険コマンドの禁止（文字列分割でforbidden_patterns回避）
danger_cmd1 := "rm"
danger_cmd2 := "-rf"
full_danger := sprintf("%s %s", [danger_cmd1, danger_cmd2])

deny[msg] {
  input.command == full_danger
  msg := "強制削除コマンドは禁止されています"
}

# git force push の禁止（同様に分割）
git_cmd := "git"
force_arg := "--force"

deny[msg] {
  input.command == sprintf("%s push %s", [git_cmd, force_arg])
  msg := "force push は禁止されています。HumanGate 承認が必要です。"
}
```

**根拠**: [Part27](Part27.md)（セキュリティガバナンス）、rev.md「2.7 事故系の自動検知」

---

### 5.6 ビルド証跡（GitHub Artifact Attestations）【SHOULD】

ビルド来歴の証明により、Supply Chain の安全性を担保する：

#### 証明項目
- **ビルダー**: 誰がビルドしたか（GitHub Actions Runner ID等）
- **材料**: どのコミット・材料からビルドされたか（Git SHA、依存関係）
- **署名**: ビルダーの署名（Sigstore等による暗号署名）
- **整合性**: ビルド成果物のハッシュ（SHA256等）

#### 実装方法
- **GitHub Artifact Attestations**: ビルド成果物に署名を付与
- **Sigstore**: オープンソースの署名・検証ツール
- **検証**: 利用者が署名を検証し、来歴を確認

#### 実行タイミング
- **リリース時**: リリース成果物（Dockerイメージ、バイナリ等）に署名
- **検証**: 利用者がデプロイ前に署名を検証

**根拠**: [Part27](Part27.md)（セキュリティガバナンス）、rev.md「2.7 事故系の自動検知」

---

## 6. 手順（実行可能な粒度、番号付き）

### 6.1 通常作業の手順（PatchOnly / ExecLimited）

1. **タスク開始前の確認**
   - Permission Tier を確認（このタスクは ReadOnly / PatchOnly / ExecLimited / HumanGate のいずれか？）
   - DoD（Definition of Done）を確認（完了条件を把握）
   - 並列タスクがある場合、編集対象 Part が重複していないか確認

2. **ファイル読み取り**
   - 対象ファイルを Read ツールで読み取り
   - 関連 Part（Part00、Part02など）も読み取り、整合性を事前確認

3. **変更実行**
   - PatchOnly の場合：Edit ツールで差分適用
   - ExecLimited の場合：Write ツールで新規ファイル作成、または Git操作実行

4. **DoD 確認**
   - DoD-1: 変更点の要約を文章化
   - DoD-2: Fast Verify を実行し、4点 PASS を確認
   - DoD-3: Evidence Pack を生成（差分/Verify結果/ログ）
   - DoD-4: Commit/Push を実行

5. **完了報告**
   - 変更内容の要約を出力
   - 編集ファイル一覧を出力
   - Fast Verify PASS 4点の証跡を出力

### 6.2 Fast Verify の実行手順

1. **docs 内リンク切れチェック**
   - 各 Part 内の `[...](...)`形式のリンクを抽出
   - 相対パスの存在確認、外部URLの到達確認
   - 結果：PASS / FAIL（リンク切れ数）

2. **用語揺れチェック**
   - glossary/GLOSSARY.md の用語定義を読み取り
   - docs/ 内の用語使用を検索
   - 未定義用語、表記揺れを検出
   - 結果：PASS / FAIL（揺れ数）

3. **Part間整合チェック**
   - Part00（前提・目的）のルールを読み取り
   - 各 Part がPart00 のルールに違反していないか確認
   - 矛盾する記述を検出
   - 結果：PASS / FAIL（矛盾数）

4. **未決事項の残存チェック**
   - 各 Part の「## 11. 未決事項」を抽出
   - 未解決項目を集計
   - 結果：PASS（0件） / WARN（1件以上、内容リスト化）

### 6.3 HumanGate（人間承認）の手順

1. **承認要求の作成**
   - 操作内容を明確に記述（何を、なぜ、どのように変更するか）
   - リスク評価を記述（破壊的影響、復旧方法）
   - 代替案を検討（より安全な方法はないか）

2. **人間への提示**
   - 承認要求を出力（明確に「HumanGate承認が必要です」と明記）
   - 質問形式で承認を求める（「この操作を実行してよろしいですか？ [Yes/No]」）
   - 承認者は `decisions/0004-humangate-approvers.md` を参照し、主要/代理/緊急の順で依頼

3. **承認結果の記録**
   - 承認の場合：`evidence/humangate_approvals/` に承認ログを保存（日時/承認者/操作内容/SLA判定）
   - 却下の場合：操作を中止し、代替案を検討

4. **承認後の実行**
   - 承認された操作を実行
   - DoD に従って完了確認
   - 緊急時は「緊急承認者→事後ADR→再Verify」を必須手順として追記

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 7.1 Permission Tier 違反の検出

**検出条件**：
- ReadOnly 対象への Edit/Write 実行
- PatchOnly 対象への削除・ファイル名変更
- HumanGate 必須操作を承認なしで実行

**対処**：
1. 操作を即座に中止
2. 違反内容をログに記録（evidence/）
3. ユーザーに報告（「Permission Tier 違反を検出しました」）
4. 代替手段を提案（正しい Tier での実行方法）

### 7.2 Verify FAIL の対処

**検出条件**：
- Fast Verify の4点チェックのいずれかが FAIL

**対処**：
1. FAIL の詳細を出力（どの項目が、なぜ FAIL したか）
2. 修正方法を提案（リンク修正、用語統一など）
3. 修正後に再度 Verify を実行
4. PASS するまで繰り返し

### 7.3 DoD 未達の対処

**検出条件**：
- DoD-1〜DoD-4 のいずれかが満たされていない

**対処**：
1. 未達項目を明確化
2. 不足している作業を実行（差分生成、Evidence Pack作成など）
3. 全 DoD を満たすまで完了としない

### 7.4 例外承認の記録

**条件**：
- Permission Tier を一時的に緩和する必要がある場合（例：緊急修正）

**手順**：
1. 例外理由を明確に記述
2. HumanGate で承認を得る
3. decisions/ に例外 ADR を作成
4. 例外の有効期限・適用範囲を明記
5. Evidence Pack に例外承認記録を含める

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### 8.1 Fast Verify の判定基準

| 項目 | 判定条件 | PASS | FAIL |
|------|----------|------|------|
| 1. リンク切れ | docs/ 内の全リンクが有効 | リンク切れ 0件 | リンク切れ 1件以上 |
| 2. 用語揺れ | glossary/ と docs/ の用語が一致 | 揺れ 0件 | 揺れ 1件以上 |
| 3. Part間整合 | Part00 との矛盾なし | 矛盾 0件 | 矛盾 1件以上 |
| 4. 未決事項 | 未決事項の集計 | WARN許容 | - |

### 8.2 Permission Tier 判定

| 操作 | 対象 | 必要Tier | 判定方法 |
|------|------|----------|----------|
| Read | 全ファイル | ReadOnly | 常に許可 |
| Edit | docs/Part*.md | PatchOnly | ファイル存在確認 |
| Write | docs/（新規） | ExecLimited | Part番号の重複確認 |
| Delete | sources/ | HumanGate | 人間承認の有無 |
| ADR作成 | decisions/ | HumanGate | 人間承認の有無 |

### 8.3 DoD 判定

| DoD項目 | 判定条件 | ログ出力 |
|---------|----------|----------|
| DoD-1 | 変更点要約が存在 | 「変更点の要約：[内容]」 |
| DoD-2 | Fast Verify PASS | 「Fast Verify PASS 4点」 |
| DoD-3 | Evidence Pack 生成 | 「Evidence Pack: evidence/[path]」 |
| DoD-4 | Git commit/push 完了 | 「Commit: [hash], Branch: [name]」 |

## 9. 監査観点（Evidenceに残すもの・参照パス）

### 9.1 必須 Evidence

すべての作業（PatchOnly / ExecLimited / HumanGate）は以下を evidence/ に保存：

1. **変更差分（Diff）**
   - ファイルパス：`evidence/YYYYMMDD_HHMM_<task-id>_diff.md`
   - 内容：git diff 出力、または編集前後の比較

2. **Verify レポート**
   - ファイルパス：`evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_PASS.md`
   - 内容：Fast Verify の4点チェック結果

3. **実行ログ**
   - ファイルパス：`evidence/YYYYMMDD_HHMM_<task-id>_log.md`
   - 内容：タイムスタンプ、実行者（AI/人間）、コマンド履歴

4. **HumanGate 承認記録（該当時）**
   - ファイルパス：`evidence/humangate_approvals/YYYYMMDD_HHMMSS_<task-id>_APPROVED.md`
   - 内容：承認日時、承認者、操作内容、承認理由、SLA判定

### 9.2 Evidence の保持期間

- **MUST**: すべての Evidence は削除禁止（追記のみ）
- **SHOULD**: 定期的なアーカイブ（年次、evidence/archive/ へ移動）

## 10. チェックリスト

作業完了前に以下を確認：

- [ ] Permission Tier を確認し、越権操作をしていない
- [ ] 変更前に対象ファイルを読み取った（PatchOnly/ExecLimited）
- [ ] HumanGate 必須操作には承認を得た
- [ ] DoD-1: 変更点の要約を文章化した
- [ ] DoD-2: Fast Verify を実行し、4点 PASS を確認した
- [ ] DoD-3: Evidence Pack を生成した
- [ ] DoD-4: Git commit/push を完了した
- [ ] sources/ を改変・削除していない（ReadOnly厳守）
- [ ] Part番号・ファイル名を変更していない
- [ ] 並列タスク時、編集 Part が重複していない（1Part=1Branch）

## 11. 未決事項（推測禁止）

- Full Verify の詳細仕様（Part10で定義予定）
- Evidence Pack の自動生成スクリプト（checks/ で今後実装）
- Permission Tier の動的変更（セキュリティレベルの切り替え）

## 12. 参照（パス）

- docs/Part00.md（前提・目的）
- docs/Part02.md（共通語彙）
- docs/Part10.md（Verify Gate）
- docs/Part11.md（並列タスク運用、今後定義）
- glossary/GLOSSARY.md（用語定義）
- decisions/0001-ssot-governance.md（SSOT運用ガバナンス）
- decisions/0004-humangate-approvers.md（HumanGate承認者・SLA）
- checks/README.md（検証手順）
- CLAUDE.md（常設ルール）




FILE: docs\Part10.md
-----
# Part 10：Verify Gate（Fast/Full・必須カテゴリ・Verifyレポート・機械判定の裁定）

## 0. このPartの位置づけ
- 目的：SSOT破壊を防ぐための品質ゲート（Verify）の実行手順・判定基準・証跡管理を定義
- 依存：Part00（SSOT原則）、Part09（Permission Tier）、checks/verify_repo.ps1
- 影響：全ての docs/ 変更作業、git commit前の必須ゲート、evidence/verify_reports の管理

## 1. 目的（Purpose）

### 1.1 Verifyの役割
Verify Gateは、リポジトリの整合性を機械的に検証し、以下を保証する：
- **SSOT破壊の防止**：docs/ 内のリンク切れ、Part間矛盾、sources/ 改変を検出
- **事故ゼロの作業フロー**：コミット前に必ず検証を通すことで、壊れた状態のマージを防ぐ
- **証跡の保持**：検証結果を evidence/verify_reports に保存し、監査可能にする

### 1.2 位置づけ
- **必須ゲート**：全ての docs/ 変更において、git commit 前に Verify Fast PASS が必須（DoD）
- **HumanGateとの連携**：Verify FAIL時は原則コミット禁止（例外は HumanGate で「障害解析のため保持」を許可した場合のみ）

## 2. 適用範囲（Scope / Out of Scope）

### In Scope
- docs/ 配下の全ファイル変更時の検証
- sources/ の改変検出（読み取り専用の保証）
- evidence/verify_reports の証跡管理（保持ルール、採用ルール）
- Fast/Full の2モード定義（Fullは将来拡張）

### Out of Scope
- CI/CD環境での自動実行の実装詳細（ワークフロー定義は別途、運用要件は本Partで固定）
- sources/ の内容妥当性検証（改変検出のみ、内容の真偽は検証しない）
- glossary/ の用語整合性（将来拡張候補）

## 3. 前提（Assumptions）

- Windows環境で PowerShell 7+ が利用可能（pwsh コマンド）
- Linux/macOS環境では pwsh または同等のシェルスクリプト版を使用（将来対応）
- checks/verify_repo.ps1 が実装済みであること
- evidence/verify_reports ディレクトリが存在すること（初回実行時に自動作成も可）

## 4. 用語（Glossary参照：Part02）

- **Verify Fast**：必須項目のみ検証（リンク、Part整合、sources改変、禁止文字列）。所要時間 < 30秒
- **Verify Full**：Fast + 追加検証（用語揺れ、未決事項集計、外部URL生存確認）。所要時間 数分（将来実装）
- **PASS**：全検証項目が合格。コミット可能
- **FAIL**：1つ以上の検証項目が不合格。原則コミット禁止
- **証跡セット**：1回のverify実行で生成される4つのレポートファイル（link/parts/forbidden/sources_integrity）

## 5. ルール（MUST / MUST NOT / SHOULD）

### 5.1 実行タイミング
- **MUST**：docs/ を変更した場合、git commit 前に Verify Fast を **1回だけ** 実行する
- **MUST NOT**：作業途中で verify を何度も実行しない（証跡が量産され、どれが最終かわからなくなる）
- **SHOULD**：verify 実行は「作業完了・コミット直前」のタイミングに限定する

### 5.2 PASS時の扱い
- **MUST**：Verify PASS の証跡セット（4ファイル）を git add でステージングに含める
- **SHOULD**：evidence/verify_reports には「直近3セットまで」を保持する（監査要件）
- **MUST NOT**：過去の証跡を削除しない（アーカイブ移動のみ）

### 5.3 FAIL時の扱い
- **MUST NOT**：Verify FAIL の状態では git commit しない（例外：HumanGate承認あり）
- **MUST**：FAIL原因を修正し、再度 Verify Fast を実行してPASSを確認する
- **SHOULD**：FAIL時の証跡は git add せず、未追跡のまま残す（または `evidence/archive/` に退避）
- **例外（HumanGate）**：障害解析目的でFAIL証跡を保持する場合、decisions/ にADRを追加してから保持する

### 5.4 sources/ 改変の禁止
- **MUST NOT**：sources/ 配下のファイルは一切変更・削除・上書きしない（追記のみ許可）
- **MUST**：Verify は sources/ の改変を検出し、FAIL とする

### 5.5 危険コマンドの検出
- **MUST NOT**：docs/ 内に危険なコマンド文字列（`r m - r f`、`git push - - f orce`、`git reset - - h ard`、`curl | s h` など）を生で記述しない
- **MUST**：Verify は禁止文字列パターンを検出し、FAIL とする
- **SHOULD**：危険コマンドを説明する場合は表記崩し（スペース挿入、ハイフン分離など）を使用する

### 5.6 CI強制（Branch Protection）【MUST】
- **MUST**：PRのマージには CI で Verify Fast（main への場合は Full も）を必須化
- **MUST**：Required Status Checks に Verify Gate を登録し、FAIL時はマージ禁止
- **MUST**：CIログは evidence/verify_reports/ の参照パスを残す

## 6. 手順（実行可能な粒度、番号付き）

### 6.1 標準作業フロー（事故らない順）
以下の順序を厳守することで、壊れた状態のコミット・プッシュを防ぐ。

1. **git fetch/pull**（最新状態を取得）
   ```powershell
   git fetch origin
   git pull origin <branch-name>
   ```

2. **作業実施**（docs/ の編集、Part追加など）
   - Part00-20 の編集
   - 新規 Part 追加（必要に応じて）
   - sources/ は読み取りのみ（変更禁止）

3. **Verify Fast 実行（1回のみ）**
   ```powershell
   pwsh .\checks\verify_repo.ps1 -Mode Fast
   ```
   - 実行完了まで待機（通常 < 30秒）
   - 出力メッセージで PASS/FAIL を確認

4. **PASS確認と証跡追加**
   - PASSの場合：
     ```powershell
     git add evidence/verify_reports/*
     ```
   - FAILの場合：手順7（例外処理）へ

5. **変更ファイルのステージング**
   ```powershell
   git add docs/Part10.md  # 変更したPartを追加
   git status -sb          # ステージング内容を確認
   ```

6. **コミット**
   ```powershell
   git commit -m "Part10: standardize Verify Gate + evidence retention (Fast verify PASS 2026-01-11)"
   ```
   - コミットメッセージは「Part番号: 変更概要 (Fast verify PASS YYYY-MM-DD)」形式を推奨

7. **プッシュ**
   ```powershell
   git push -u origin <branch-name>
   ```
   - ネットワークエラー時は最大4回リトライ（2秒、4秒、8秒、16秒の指数バックオフ）

### 6.2 Verify実行の詳細

#### Fast モード（標準・必須）
```powershell
pwsh .\checks\verify_repo.ps1 -Mode Fast
```
**検証項目**：
1. **リンク整合性**（link_check）：docs/ 内の相対パス・Part参照が切れていないか
2. **Part間整合性**（parts_integrity）：Part00-20 のテンプレート構造、相互参照の矛盾
3. **禁止文字列検出**（forbidden_patterns）：危険コマンド、禁止表記の有無
4. **sources改変検出**（sources_integrity）：sources/ のハッシュ値チェック

**出力**：
- `evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_PASS_link_check.md`
- `evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_PASS_parts_integrity.md`
- `evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_PASS_forbidden_patterns.md`
- `evidence/verify_reports/YYYYMMDD_HHMMSS_Fast_PASS_sources_integrity.md`

**判定**：4項目すべてが合格で PASS、1つでも不合格で FAIL

#### Full モード（将来拡張）
```powershell
pwsh .\checks\verify_repo.ps1 -Mode Full
```
**追加検証項目**（未実装）：
- 用語揺れ検出（glossary/ と docs/ の不一致）
- 未決事項集計（Part別の未決リスト）
- 外部URL生存確認（HTTP 200応答チェック）
- ADR参照整合性（decisions/ と docs/ のリンク）

**所要時間**：数分（外部URL確認が含まれるため）

### 6.3 証跡の保持・削除ルール

#### 標準（直近3セット＋アーカイブ）
- **保持**：直近3セットまでを evidence/verify_reports/ に保持
- **整理**：4セット目以降は `evidence/archive/YYYY/MM/` へ移動（削除禁止）
- **理由**：監査要件と可読性の両立

#### 禁止（FAIL証跡の混入）
- **MUST NOT**：FAIL証跡を誤ってコミットしない
- **確認方法**：
  ```powershell
  git status -sb
  # evidence/verify_reports/ のファイル名に PASS/FAIL が含まれているか確認
  ```

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 7.1 Verify FAIL時の対処

#### FAIL原因の分類
1. **リンク切れ**：docs/ 内の `[Part01](Part01.md)` などが不正
   - 修正：パスを正しく修正し、再verify
2. **sources改変**：sources/ を誤って編集した
   - 修正：`git checkout sources/` で復元し、再verify
3. **禁止文字列**：危険コマンドが生で記述されている
   - 修正：表記崩しに変更（例：`r m - r f`）し、再verify
4. **Part間矛盾**：Part00の原則とPart10が衝突している
   - エスカレーション：HumanGateで方針を決定 → decisions/ にADR追加 → 修正

#### 復旧手順
1. FAIL原因を `evidence/verify_reports/*_YYYYMMDD_HHMMSS_*.md` から特定
2. 該当ファイルを修正
3. 再度 `pwsh .\checks\verify_repo.ps1 -Mode Fast` を実行
4. PASS確認後、手順6.1の4番（証跡追加）から再開

### 7.2 例外承認（HumanGate）

以下の場合のみ、FAIL状態でのコミットを許可する：
- **障害解析目的**：FAIL証跡を保持して原因調査を行う必要がある
- **条件**：
  1. decisions/ に ADR を追加（例：`ADR-00XX-exception-verify-fail-for-analysis.md`）
  2. ADR に FAIL理由、保持期間、アーカイブ予定日を明記
  3. コミットメッセージに `[HumanGate approved]` を付記

### 7.3 スクリプトエラー時の対処

verify_repo.ps1 が異常終了した場合：
1. エラーメッセージを確認
2. PowerShell バージョン確認（pwsh 7+ 必須）
3. 再実行してもエラーが続く場合：
   - checks/README.md の手動検証手順を実施（フォールバック）
   - 問題をIssue登録し、スクリプト修正を依頼

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### 8.1 link_check（リンク整合性）
- **判定条件**：docs/ 内の `[テキスト]\(パス\)` がすべて有効
- **合格**：リンク切れ0件
- **不合格**：リンク切れ1件以上
- **ログ出力例**：
  ```
  [PASS] link_check: All internal links are valid (0 broken links)
  ```

### 8.2 parts_integrity（Part整合性）
- **判定条件**：Part00-20 がテンプレート構造に従い、相互参照が矛盾しない
- **合格**：構造違反0件
- **不合格**：構造違反1件以上
- **ログ出力例**：
  ```
  [PASS] parts_integrity: All Parts follow template structure
  ```

### 8.3 forbidden_patterns（禁止文字列検出）
- **判定条件**：docs/ 内に危険コマンド文字列が生で記述されていない
- **合格**：禁止パターン検出0件
- **不合格**：禁止パターン検出1件以上
- **ログ出力例**：
  ```
  [FAIL] forbidden_patterns: Found 'r m - r f' in docs/Part10.md:123
  ```

### 8.4 sources_integrity（sources改変検出）
- **判定条件**：sources/ 配下のファイルハッシュが前回commit時と一致
- **合格**：改変0件
- **不合格**：改変1件以上
- **ログ出力例**：
  ```
  [FAIL] sources_integrity: sources/data.json was modified
  ```

### 8.5 総合判定
- **PASS**：4項目すべてが合格
- **FAIL**：1項目でも不合格

## 9. 監査観点（Evidenceに残すもの・参照パス）

### 9.1 証跡ファイル命名規則
```
evidence/verify_reports/YYYYMMDD_HHMMSS_<mode>_<status>_<category>.md
```
- **YYYYMMDD**：実行日（例：20260111）
- **HHMMSS**：実行時刻（例：143052）
- **mode**：Fast / Full
- **status**：PASS / FAIL
- **category**：検証カテゴリ（link_check / parts_integrity / forbidden_patterns / sources_integrity）

### 9.2 証跡セットの構成
1回のverify実行で以下4ファイルが生成される：
1. `YYYYMMDD_HHMMSS_Fast_PASS_link_check.md`
2. `YYYYMMDD_HHMMSS_Fast_PASS_parts_integrity.md`
3. `YYYYMMDD_HHMMSS_Fast_PASS_forbidden_patterns.md`
4. `YYYYMMDD_HHMMSS_Fast_PASS_sources_integrity.md`

### 9.3 証跡の採用ルール
- **標準**：直近3セットまでを git 管理下に置く
- **許容**：FAIL証跡は未追跡またはアーカイブ退避
- **禁止**：証跡の削除（例外：HumanGate承認あり）

### 9.4 監査時の参照方法
```powershell
# 最新の証跡を確認
ls evidence/verify_reports/ | Sort-Object -Descending | Select-Object -First 4

# 特定日時の証跡を確認
cat evidence/verify_reports/20260111_143052_Fast_PASS_link_check.md
```

## 10. チェックリスト

作業完了前に以下を確認する：
- [ ] docs/ の変更が完了している
- [ ] sources/ は一切変更していない（読み取りのみ）
- [ ] `pwsh .\checks\verify_repo.ps1 -Mode Fast` を **1回だけ** 実行した
- [ ] Verify結果が **PASS** である
- [ ] evidence/verify_reports に最新PASS 4ファイルが生成されている
- [ ] 過去の証跡はアーカイブ済み（または直近3セットまで保持）
- [ ] `git add evidence/verify_reports/*` で証跡をステージングした
- [ ] `git add docs/Part10.md` など変更ファイルをステージングした
- [ ] `git status -sb` でステージング内容を確認した
- [ ] コミットメッセージに "(Fast verify PASS YYYY-MM-DD)" を含めた
- [ ] Part10.md が他Part（Part00, Part09）と矛盾していない

## 11. 未決事項（推測禁止）

現時点で確定していない項目：
- **Verify Full の詳細仕様**：用語揺れ検出、未決事項集計の具体的アルゴリズム（将来実装）
- **Linux/macOS対応**：pwsh 以外の環境での verify 実行方法（シェルスクリプト版を検討中）

### 運用上の選択肢（HumanGateで決定）
- **証跡保持数**：「直近3セット」固定（アーカイブ移動は運用手順で調整）
- **FAIL証跡の扱い**：「未追跡で残す」vs「別ディレクトリ退避」
  - 推奨：未追跡で残す（障害解析時に参照可能）
  - 許容：アーカイブ退避（証跡量産を防ぐ）

## 12. 参照（パス）

### docs/
- [Part00.md](Part00.md) — SSOT原則、禁止事項
- [Part09.md](Part09.md) — Permission Tier、HumanGate
- [00_INDEX.md](00_INDEX.md) — 全体導線

### sources/
- （現時点で参照なし。将来、verify仕様の根拠となる会話ログを追加予定）

### evidence/
- `evidence/verify_reports/` — Verify実行結果の証跡（本Part定義に従い生成）

### decisions/
- [0001-ssot-governance.md](../decisions/0001-ssot-governance.md) — SSOT運用ガバナンス
- （将来、verify例外承認のADRを追加予定）

### checks/
- `checks/verify_repo.ps1` — Verify Fast/Full の実行スクリプト（本Part定義に準拠）
- [checks/README.md](../checks/README.md) — 検証手順の概要




FILE: docs\Part11.md
-----
# Part 11：Repair（VRループ）運用（失敗分類→修正→再検証・収束戦略・ループ制限）

## 0. このPartの位置づけ
- **目的**: Verify失敗時の修正プロセスを体系化し、暴走を防ぎながら確実にGreenへ収束させる
- **依存**: Part10（Verify Gate・Fast/Full）、Part09（Permission Tier・HumanGate）、Part12（Evidence・ログ保存）
- **影響**: 全実装タスク（BUILD/VERIFY/REPAIRサイクル）、Part16（Metrics・収束性指標）

## 1. 目的（Purpose）

VCG/VIBE 2026 では「Verify失敗 → 修正 → 再検証」のループ（**VRループ**）を体系化し、以下を達成する：

1. **失敗分類の体系化**: 失敗を4カテゴリ（Spec/依存/実装/テスト）に分類し、適切な担当（GPT/Claude/HumanGate）へエスカレーション
2. **収束性の保証**: ループ制限（3回）を設け、暴走を防ぎながら確実にGreenへ収束
3. **ログの蓄積**: 全失敗をEvidenceへ保存し、「なぜ失敗したか」「どう修正したか」を追跡可能に
4. **再現性の確保**: 同じ失敗が再発した場合、過去のRepairログから解決策を検索可能に
5. **学習の促進**: 失敗パターンを蓄積し、SpecやAcceptance（受入条件）へフィードバック

**根拠**: [F-0057](../docs/FACTS_LEDGER.md#F-0057), [Part10](./Part10.md)

## 2. 適用範囲（Scope / Out of Scope）

### Scope（対象）
- BUILD後のVerify失敗（Fast Verify / Full Verify）
- Verify失敗の分類（4カテゴリ: Spec/依存/実装/テスト）
- 修正→再検証のループ（最大3回）
- HumanGateへのエスカレーション（3ループ超過時）
- Repairログの保存（evidence/repair_logs/）

### Out of Scope（対象外）
- Verify前の失敗（ビルドエラー、構文エラー）→ 即座修正（ループ不要）
- Spec自体の矛盾（Specの問題）→ Part00 ADR→docs workflow で修正
- リリース後の障害（本番障害）→ Part17 Rollback で対応
- 人為的なミス（コミット忘れ、ファイル未保存）→ 即座修正（ログ不要）

**注意**: 上記Out of Scopeの失敗は、別のルールで管理される（Part00, Part14, Part17参照）。

## 3. 前提（Assumptions）

本Partは以下を前提とする：

1. **Verify Gateの存在**: Part10 で定義された Fast/Full Verify が実装済み
2. **Evidence保存の整備**: Part12 で定義された evidence/ フォルダが利用可能
3. **HumanGate承認フロー**: Part09 で定義された HumanGate へのエスカレーション手順が確立
4. **失敗ログの形式**: Verifyツール（pytest/jest/lint）が構造化ログ（JSON/XML）を出力可能
5. **AI Role分離**: ChatGPT（Spec担当）、Claude Code（実装担当）、Z.ai（ログ要約）の役割が明確（Part03参照）

**根拠**: [F-0057](../docs/FACTS_LEDGER.md#F-0057), [Part09](./Part09.md), [Part10](./Part10.md)

## 4. 用語（Glossary参照：Part02）

本Partで使用する用語：

- **VRループ**: Verify失敗 → Repair（修正）→ 再Verify を繰り返すループ。最大3回で収束させる
- **収束**: Verifyが全てPASSし、Greenに戻ること。「収束しない」= 3ループ超えてもFAILが残る
- **失敗分類**: Verify失敗を4カテゴリ（Spec/依存/実装/テスト）に分類し、適切な担当へ振り分ける
- **Spec系失敗**: 前提条件違い、受入基準曖昧 → ChatGPT（Spec担当）へ戻す
- **依存/環境系失敗**: バージョン衝突、OS差異 → Docker/lock/CIで固定
- **実装系失敗**: 局所バグ、ロジックミス → Claude Code（実装担当）で最小修正
- **テスト系失敗**: テスト不足、壊れたテスト → テストを修正し、意図をSpecへ反映
- **暴走防止**: 同じ失敗が無限ループするのを防ぐため、ループ制限（3回）を設ける
- **HumanGateへエスカレーション**: 3ループ超過時、人間判断（設計変更/分割/範囲縮小）へ移行

**参照**: [glossary/GLOSSARY.md](../glossary/GLOSSARY.md), [Part02](./Part02.md)

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-1101: VRループ3回制限【MUST】

**定義**: 同じVerify失敗に対し、修正→再検証のループは **最大3回** で収束させる。

#### 条件
1. **ループカウント**: 同一のVerifyID（例: V-1001）が連続でFAILした回数を記録
2. **1ループ = 修正1回 + Verify1回**: 修正してVerifyを実行した時点で1ループ消費
3. **3ループ以内に収束**: 3回目のVerifyでPASSすること
4. **3ループ超過時はHumanGate**: 3回目のVerifyでFAILの場合、即座にHumanGateへエスカレーション

#### 例
```
Loop 1: Verify FAIL (V-1001: テスト3件失敗) → 修正 → Verify FAIL (V-1001: テスト1件失敗)
Loop 2: 修正 → Verify FAIL (V-1001: テスト1件失敗・同じ内容)
Loop 3: 修正 → Verify PASS
→ 収束成功（3ループ以内）
```

```
Loop 1: Verify FAIL → 修正 → Verify FAIL
Loop 2: 修正 → Verify FAIL
Loop 3: 修正 → Verify FAIL
→ 収束失敗 → HumanGateへエスカレーション（Part09参照）
```

**根拠**: [F-0057](../docs/FACTS_LEDGER.md#F-0057)
**Verify観点**: V-1101（後述）
**例外**: なし（全VRループに適用）

---

### R-1102: 失敗分類4カテゴリ【MUST】

**定義**: Verify失敗を以下の4カテゴリに分類し、適切な担当へエスカレーションする。

#### 分類基準

##### 1. Spec系失敗
- **症状**: 前提条件違い、受入基準曖昧、仕様矛盾
- **例**: 「この機能は〇〇の場合も動作すべき」だが、Specに記載なし
- **担当**: ChatGPT（Spec担当）→ Specを修正（Part00 ADR→docs workflow）
- **対応**: Specに前提条件・受入基準を追記 → ADR追加 → Verify再実行

##### 2. 依存/環境系失敗
- **症状**: バージョン衝突、OS差異、ライブラリ不足
- **例**: `python 3.9` で動くが `3.11` で失敗、`npm install` のバージョン不一致
- **担当**: Claude Code（実装担当）→ Docker/lock/CIで固定
- **対応**: `requirements.txt`, `package-lock.json`, `Dockerfile` を更新 → Verify再実行

##### 3. 実装系失敗
- **症状**: 局所バグ、ロジックミス、エッジケース未対応
- **例**: `if x > 0` だが `x == 0` のケースが未処理
- **担当**: Claude Code（実装担当）→ 最小修正
- **対応**: バグ箇所を特定 → 修正 → Verify再実行

##### 4. テスト系失敗
- **症状**: テスト不足、壊れたテスト、Flaky Test（不安定なテスト）
- **例**: テストが `assert x == 1` だが、実際は `x == 2` が正しい
- **担当**: Claude Code（実装担当）→ テストを修正
- **対応**: テストの意図をSpecへ反映 → テスト修正 → Verify再実行

**根拠**: [F-0057](../docs/FACTS_LEDGER.md#F-0057)
**Verify観点**: V-1102（後述）
**例外**: 複合失敗（複数カテゴリ混在）は、優先度順（Spec > 依存 > 実装 > テスト）で対応

---

### R-1103: Repairログ必須【MUST】

**定義**: 全Verify失敗と修正内容を `evidence/repair_logs/` に保存する。

#### 保存内容
1. **失敗時のVerifyログ**: どのVerifyID（V-XXXX）がFAILしたか
2. **失敗分類**: 4カテゴリのどれか（Spec/依存/実装/テスト）
3. **ループ回数**: 現在何ループ目か（1〜3）
4. **修正内容**: どのファイルを・どう変更したか（diff）
5. **再Verify結果**: 修正後のVerify結果（PASS/FAIL）

#### 形式
```markdown
# Repair Log

- **Timestamp**: 2026-01-10 12:00
- **VerifyID**: V-1001
- **FailureCategory**: 実装系（局所バグ）
- **Loop**: 1/3
- **FailureLog**: テスト3件失敗（test_user_login, test_user_logout, test_user_profile）
- **RootCause**: user.py L42 で `if password == ""` の判定漏れ
- **Fix**: user.py L42 に `if password == "" or password is None` を追加
- **Diff**: `git diff abc1234..def5678`
- **ReVerifyResult**: PASS（全テスト成功）
```

**根拠**: [F-0057](../docs/FACTS_LEDGER.md#F-0057), [Part12](./Part12.md)
**Verify観点**: V-1103（後述）
**例外**: なし（全Repairに適用）

---

### R-1104: HumanGateエスカレーション【MUST】

**定義**: 3ループ超過時、または根本原因不明時、HumanGateへエスカレーションする。

#### エスカレーション条件
1. **3ループ超過**: 3回目のVerifyでもFAILが残る
2. **根本原因不明**: Z.aiのログ要約、ChatGPTの分析でも原因特定できない
3. **設計変更必要**: Spec自体に矛盾があり、実装では解決不能

#### エスカレーション内容
- 失敗ログ（3ループ分）
- 分類結果（4カテゴリ）
- 試みた修正内容（diff）
- 現状（FAIL箇所の詳細）

#### 承認者の判断
- **A) 設計変更**: Specを修正（ADR追加 → Part00 workflow）
- **B) タスク分割**: 大きすぎるタスクを分割（Part04 VIBEKANBAN）
- **C) 範囲縮小**: 一部機能を削除し、まずは動くものをリリース
- **D) 調査SPIKE**: 原因不明のため、調査専用タスクを作成（隔離）

**根拠**: [F-0057](../docs/FACTS_LEDGER.md#F-0057), [Part09](./Part09.md)
**Verify観点**: V-1104（後述）
**例外**: なし（全HumanGateに適用）

---

### R-1105: 収束性指標の記録【SHOULD】

**定義**: VRループの収束性を定量的に記録し、プロジェクト健全性の指標とする。

#### 指標
1. **平均ループ回数**: 全タスクの平均ループ回数（目標: 1.5回以下）
2. **3ループ超過率**: 全タスク中、HumanGateへエスカレーションした割合（目標: 5%以下）
3. **失敗カテゴリ分布**: Spec/依存/実装/テストの失敗割合（改善ポイント特定）
4. **Flaky Test率**: 同じテストが複数回FAIL→PASSを繰り返す割合（目標: 0%）

#### 記録先
- `evidence/metrics/vr_loop_metrics.json`
- Dashboard（Part15参照）で可視化

**根拠**: [F-0023](../docs/FACTS_LEDGER.md#F-0023), [Part16](./Part16.md)
**Verify観点**: V-1105（後述）
**例外**: プロジェクト初期は指標蓄積不要（データ不足）

---

### R-1106: 同じ失敗の再発防止【SHOULD】

**定義**: 過去のRepairログを検索し、同じ失敗パターンを早期検出する。

#### 手順
1. **Verify失敗時**: 失敗メッセージ（エラーコード、スタックトレース）を抽出
2. **過去ログ検索**: `evidence/repair_logs/` から類似失敗を検索（grep/全文検索）
3. **同じパターン検出**: 過去に同じエラーで修正した履歴があるか確認
4. **修正方法の適用**: 過去の修正内容（diff）を参考に、同じ修正を適用
5. **Spec反映**: 同じ失敗が2回以上発生した場合、Specに「注意事項」として追記

**根拠**: [F-0002](../docs/FACTS_LEDGER.md#F-0002), [Part12](./Part12.md)
**Verify観点**: V-1106（後述）
**例外**: 初回失敗は検索不要（過去ログなし）

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順1: Verify失敗時の初動対応

Verifyが失敗したら、以下の手順で対応する。

1. **失敗ログを確認**
   ```bash
   # Verifyツール（pytest/jest/lint）の出力を確認
   pytest tests/ --verbose
   # 失敗箇所を特定
   ```

2. **VerifyIDを記録**
   - どのVerifyID（V-XXXX）がFAILしたか記録
   - 例: V-1001（ユニットテスト）、V-0901（禁止コマンド）

3. **ループカウント初期化**
   - 今回が1ループ目であることを記録
   - `evidence/repair_logs/VR_LOOP_<timestamp>_<VerifyID>.md` を作成

4. **失敗分類を実施**（手順2へ）

---

### 手順2: 失敗分類（4カテゴリ判定）

失敗ログを元に、4カテゴリのどれかを判定する。

1. **Spec系失敗の判定**
   - **症状**: 「この場合も動作すべき」だが、Specに記載なし
   - **判定基準**: Acceptanceに該当ケースが定義されていない
   - **対応**: ChatGPT（Spec担当）へエスカレーション → Spec修正

2. **依存/環境系失敗の判定**
   - **症状**: `ModuleNotFoundError`, `VersionConflict`, `OS差異`
   - **判定基準**: 依存ライブラリ、バージョン、環境変数が原因
   - **対応**: Claude Code（実装担当）→ Docker/lock/CI修正

3. **実装系失敗の判定**
   - **症状**: `AssertionError`, `IndexError`, `NullPointerException`
   - **判定基準**: コードロジックのバグ、エッジケース未対応
   - **対応**: Claude Code（実装担当）→ 最小修正

4. **テスト系失敗の判定**
   - **症状**: テストが間違っている、Flaky Test
   - **判定基準**: 実装は正しいが、テストの期待値が間違っている
   - **対応**: Claude Code（実装担当）→ テスト修正 + Spec反映

5. **分類結果を記録**
   ```markdown
   # Repair Log

   - **FailureCategory**: 実装系（局所バグ）
   ```

---

### 手順3: 修正実施（カテゴリ別）

分類結果に応じて、修正を実施する。

#### 3-1. Spec系失敗の場合

1. **ChatGPT（Spec担当）へエスカレーション**
   - 失敗ログ、Spec該当箇所を提示
   - 「この場合の動作仕様を明記してください」

2. **Spec修正**
   - ChatGPTが Spec（Part XX）を修正
   - ADR追加（Part00 workflow）

3. **再実装**
   - Claude Code（実装担当）が修正されたSpecに従い実装修正
   - Verify再実行

---

#### 3-2. 依存/環境系失敗の場合

1. **依存ファイル更新**
   ```bash
   # Python の場合
   pip freeze > requirements.txt
   # Node.js の場合
   npm install --package-lock
   ```

2. **Docker イメージ更新**
   ```dockerfile
   # Dockerfile
   FROM python:3.11-slim
   RUN pip install -r requirements.txt
   ```

3. **CI設定更新**
   ```yaml
   # .github/workflows/ci.yml
   - uses: actions/setup-python@v4
     with:
       python-version: '3.11'
   ```

4. **Verify再実行**
   ```bash
   docker build -t myapp .
   docker run myapp pytest tests/
   ```

---

#### 3-3. 実装系失敗の場合

1. **バグ箇所特定**
   ```bash
   # スタックトレースから該当ファイル・行番号を特定
   # 例: user.py:42 in login()
   ```

2. **最小修正**
   ```python
   # Before
   if password == "":
       raise ValueError("Password is empty")

   # After
   if password == "" or password is None:
       raise ValueError("Password is empty or None")
   ```

3. **Verify再実行**
   ```bash
   pytest tests/test_user.py -v
   ```

---

#### 3-4. テスト系失敗の場合

1. **テストの意図確認**
   - テストが期待する動作は何か？
   - 実装が正しいか、テストが正しいかを判定

2. **テスト修正**
   ```python
   # Before（間違ったテスト）
   assert user.age == 20

   # After（正しいテスト）
   assert user.age >= 18  # 成人であることを確認
   ```

3. **Specへ反映**
   - テストの意図をSpecに追記
   - 「ユーザーは18歳以上であること」

4. **Verify再実行**
   ```bash
   pytest tests/test_user.py -v
   ```

---

### 手順4: 再Verify実行

修正後、再度Verifyを実行する。

1. **Fast Verify実行**
   ```bash
   bash checks/verify_repo.sh
   ```

2. **結果判定**
   - **PASS**: 収束成功 → Repairログに「PASS」を記録 → 次タスクへ
   - **FAIL**: ループカウント+1 → 手順5（ループ継続判定）へ

---

### 手順5: ループ継続判定

再Verifyの結果に応じて、ループを継続するか判定する。

1. **ループ回数確認**
   - 現在のループ回数を確認（1, 2, 3）

2. **1〜2ループ目の場合**
   - 手順2（失敗分類）へ戻る
   - 別の修正アプローチを試す

3. **3ループ目でPASSの場合**
   - 収束成功
   - Repairログに「収束成功（3ループ）」を記録

4. **3ループ目でFAILの場合**
   - 収束失敗
   - HumanGateへエスカレーション（手順6へ）

---

### 手順6: HumanGateへエスカレーション

3ループ超過時、HumanGateへエスカレーションする。

1. **エスカレーション資料作成**
   ```markdown
   # HumanGate Escalation

   - **VerifyID**: V-1001
   - **FailureCategory**: 実装系（局所バグ）
   - **LoopCount**: 3/3
   - **FailureLogs**:
     - Loop 1: テスト3件失敗
     - Loop 2: テスト1件失敗（同じ内容）
     - Loop 3: テスト1件失敗（同じ内容）
   - **Fixes**:
     - Loop 1: user.py L42 修正
     - Loop 2: user.py L42 再修正
     - Loop 3: user.py L42 さらに修正
   - **CurrentStatus**: 依然として test_user_login が FAIL
   - **RootCause**: 不明（ログからは特定できず）
   ```

2. **承認者へ提出**
   - Part09 で定義された HumanGate 承認者へ提出
   - Slack/Email/Issue で通知

3. **承認者判断待ち**
   - 承認者が A) 設計変更 / B) 分割 / C) 範囲縮小 / D) SPIKE のいずれかを指示

4. **判断結果に従い対応**
   - A) Spec修正（ADR追加 → Part00 workflow）
   - B) タスク分割（Part04 VIBEKANBAN）
   - C) 範囲縮小（一部機能削除）
   - D) SPIKE作成（調査専用タスク、隔離）

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: 複合失敗（複数カテゴリ混在）

**状態**: 失敗が複数カテゴリにまたがる（例: Spec系 + 実装系）

**対応**:
1. **優先度順に対応**: Spec > 依存 > 実装 > テスト
2. **Spec系を先に修正**: Specが曖昧なまま実装修正しても無駄
3. **依存系を次に修正**: 環境が壊れていると実装テスト不能
4. **実装系を修正**: ロジックバグを修正
5. **テスト系を最後に修正**: 実装が正しくなってからテスト修正

**Verify観点**: V-1107（後述）
**Evidence**: E-1101（複合失敗ログ）

---

### 例外2: Flaky Test（不安定なテスト）

**状態**: 同じテストが FAIL → PASS → FAIL を繰り返す

**検知方法**:
- 同じVerifyIDが「PASS」後に再び「FAIL」になった場合

**対応**:
1. **Flaky Test判定**: 2回以上PASSとFAILを繰り返した場合
2. **テスト隔離**: 該当テストを `@pytest.mark.flaky` でマーク
3. **原因調査**: 非同期処理、タイムアウト、外部依存が原因か確認
4. **修正**: 非同期待機、モック化、タイムアウト延長
5. **Spec反映**: 「このテストは非同期処理のため不安定」を明記

**Verify観点**: V-1108（後述）
**Evidence**: E-1102（Flaky Testログ）

---

### 例外3: ループカウント不正（手動修正で増加）

**状態**: 自動カウントではなく、手動でコードを修正してVerifyを複数回実行

**検知方法**:
- Repairログが存在しないのに、Verify履歴が複数ある

**対応**:
1. **警告**: 「Repairログなしでの修正が検出されました」
2. **ログ補完**: 手動修正内容を Repairログへ追記
3. **ループカウント補正**: 実際の修正回数を推定してカウント

**Verify観点**: V-1109（後述）
**Evidence**: E-1103（手動修正検出ログ）

---

### 例外4: HumanGate承認待ちタイムアウト

**状態**: HumanGateへエスカレーション後、24時間以内に承認なし

**対応**:
1. **再通知**: Slack/Email で再度通知
2. **48時間後**: タスクを BLOCKED 状態へ移行（Part04 VIBEKANBAN）
3. **1週間後**: タスクを INBOX へ戻し、優先度を再評価

**Verify観点**: V-1110（後述）
**Evidence**: E-1104（HumanGate承認待ちログ）

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-1101: VRループ3回制限の検証

**判定条件**:
1. 同一VerifyIDに対し、ループ回数が3回以内であること

**合否**:
- **PASS**: ループ回数 ≤ 3 かつ 最終Verify結果がPASS
- **FAIL**: ループ回数 > 3 または 3回目でもFAIL

**判定方法**:
```bash
# evidence/repair_logs/ から該当VerifyIDのループ回数を集計
grep "Loop:" evidence/repair_logs/VR_LOOP_*_V-1001.md | wc -l
```

**ログ**: evidence/verify_reports/V-1101_YYYYMMDD.md

---

### V-1102: 失敗分類4カテゴリの検証

**判定条件**:
1. Repairログに「FailureCategory」が記録されていること
2. カテゴリが Spec/依存/実装/テスト のいずれかであること

**合否**:
- **PASS**: FailureCategoryが4カテゴリのいずれかに分類済み
- **FAIL**: FailureCategoryが未記入、または不正な値

**判定方法**:
```bash
# Repairログから FailureCategory を抽出
grep "FailureCategory:" evidence/repair_logs/VR_LOOP_*.md
```

**ログ**: evidence/verify_reports/V-1102_YYYYMMDD.md

---

### V-1103: Repairログ必須の検証

**判定条件**:
1. Verify失敗時、必ず Repairログが作成されていること
2. ログに必須項目（Timestamp, VerifyID, FailureCategory, Loop, Fix, ReVerifyResult）が含まれること

**合否**:
- **PASS**: Verify失敗の全件にRepairログあり
- **FAIL**: Repairログ未作成、または必須項目不足

**判定方法**:
```bash
# Verify失敗の件数とRepairログの件数が一致するか確認
grep -r "FAIL" evidence/verify_reports/ | wc -l
ls evidence/repair_logs/ | wc -l
```

**ログ**: evidence/verify_reports/V-1103_YYYYMMDD.md

---

### V-1104: HumanGateエスカレーションの検証

**判定条件**:
1. 3ループ超過時、HumanGateエスカレーションが記録されていること
2. エスカレーション資料に必須項目（VerifyID, LoopCount, FailureLogs, Fixes, RootCause）が含まれること

**合否**:
- **PASS**: 3ループ超過の全件にHumanGateエスカレーションあり
- **FAIL**: エスカレーション未記録、または必須項目不足

**判定方法**:
```bash
# 3ループ超過のRepairログを検出
grep "Loop: 3/3" evidence/repair_logs/*.md -A 1 | grep "FAIL"
# HumanGateエスカレーションログを確認
ls evidence/humangate_escalations/
```

**ログ**: evidence/verify_reports/V-1104_YYYYMMDD.md

---

### V-1105: 収束性指標の検証

**判定条件**:
1. `evidence/metrics/vr_loop_metrics.json` に指標が記録されていること
2. 指標に必須項目（平均ループ回数, 3ループ超過率, 失敗カテゴリ分布, Flaky Test率）が含まれること

**合否**:
- **PASS**: 指標ファイルが存在し、必須項目あり
- **FAIL**: 指標ファイル未作成、または必須項目不足

**判定方法**:
```bash
# 指標ファイルの存在確認
test -f evidence/metrics/vr_loop_metrics.json && echo "PASS" || echo "FAIL"
```

**ログ**: evidence/verify_reports/V-1105_YYYYMMDD.md

**例外**: プロジェクト初期（データ不足）は検証スキップ

---

### V-1106: 同じ失敗の再発防止検証

**判定条件**:
1. 過去に同じエラーメッセージで失敗した履歴があるか検索されていること
2. 同じ失敗が2回以上発生した場合、Specに「注意事項」が追記されていること

**合否**:
- **PASS**: 過去ログ検索が実施され、再発防止策が記録されている
- **FAIL**: 同じ失敗が2回以上発生しているが、Spec未反映

**判定方法**:
```bash
# 同じエラーメッセージが複数回出現するか確認
grep "ModuleNotFoundError: No module named 'foo'" evidence/repair_logs/*.md | wc -l
```

**ログ**: evidence/verify_reports/V-1106_YYYYMMDD.md

---

### V-1107: 複合失敗の優先度検証

**判定条件**:
1. 複合失敗時、優先度順（Spec > 依存 > 実装 > テスト）に対応されていること

**合否**:
- **PASS**: Repairログに「対応順序: Spec → 依存 → ...」が記録されている
- **FAIL**: 優先度無視（実装を先に修正してSpecは後回し）

**判定方法**:
```bash
# Repairログから対応順序を確認
grep "対応順序:" evidence/repair_logs/*.md
```

**ログ**: evidence/verify_reports/V-1107_YYYYMMDD.md

---

### V-1108: Flaky Test検出の検証

**判定条件**:
1. 同じテストが FAIL → PASS → FAIL を繰り返した場合、Flaky Testとして記録されていること

**合否**:
- **PASS**: Flaky Testログが存在し、隔離マーク（@pytest.mark.flaky）あり
- **FAIL**: Flaky Testが検出されたが、未対応

**判定方法**:
```bash
# 同じテストが複数回FAILとPASSを繰り返しているか確認
grep "test_user_login" evidence/repair_logs/*.md | grep -E "(FAIL|PASS)"
```

**ログ**: evidence/verify_reports/V-1108_YYYYMMDD.md

---

### V-1109: ループカウント不正検出

**判定条件**:
1. Verify履歴とRepairログのループ回数が一致すること

**合否**:
- **PASS**: Verify履歴回数 == Repairログのループ回数
- **FAIL**: Verify履歴回数 > Repairログのループ回数（手動修正の可能性）

**判定方法**:
```bash
# Verify履歴の回数
grep "V-1001" evidence/verify_reports/*.md | wc -l
# Repairログのループ回数
grep "Loop:" evidence/repair_logs/VR_LOOP_*_V-1001.md | wc -l
```

**ログ**: evidence/verify_reports/V-1109_YYYYMMDD.md

---

### V-1110: HumanGate承認待ちタイムアウト検証

**判定条件**:
1. HumanGateエスカレーション後、24時間以内に承認があること

**合否**:
- **PASS**: エスカレーション日時から24時間以内に承認記録あり
- **FAIL**: 24時間経過しても承認なし

**判定方法**:
```bash
# エスカレーション日時と承認日時を比較
grep "EscalationTime:" evidence/humangate_escalations/*.md
grep "ApprovalTime:" evidence/humangate_escalations/*.md
```

**ログ**: evidence/verify_reports/V-1110_YYYYMMDD.md

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-1101: Repairログ（VRループ履歴）

**内容**: Verify失敗 → 修正 → 再Verify のループ履歴

**形式**:
```markdown
# Repair Log

- **Timestamp**: 2026-01-10 12:00
- **VerifyID**: V-1001
- **FailureCategory**: 実装系（局所バグ）
- **Loop**: 1/3
- **FailureLog**: テスト3件失敗（test_user_login, test_user_logout, test_user_profile）
- **RootCause**: user.py L42 で `if password == ""` の判定漏れ
- **Fix**: user.py L42 に `if password == "" or password is None` を追加
- **Diff**:
  ```diff
  - if password == "":
  + if password == "" or password is None:
  ```
- **ReVerifyResult**: PASS（全テスト成功）
```

**保存先**: evidence/repair_logs/VR_LOOP_20260110_120000_V-1001.md

---

### E-1102: Flaky Testログ

**内容**: 不安定なテストの検出履歴

**形式**:
```markdown
# Flaky Test Log

- **Timestamp**: 2026-01-10 15:00
- **TestName**: test_user_login
- **Occurrences**:
  - 2026-01-10 12:00: FAIL
  - 2026-01-10 12:30: PASS
  - 2026-01-10 13:00: FAIL
- **RootCause**: 非同期処理のタイムアウト（外部API呼び出し）
- **Fix**: モック化 + タイムアウト延長（5秒 → 10秒）
- **IsolationMark**: `@pytest.mark.flaky(reruns=3)`
```

**保存先**: evidence/flaky_tests/FLAKY_TEST_20260110_150000.md

---

### E-1103: 手動修正検出ログ

**内容**: Repairログなしでの手動修正検出

**形式**:
```markdown
# Manual Fix Detection Log

- **Timestamp**: 2026-01-10 18:00
- **VerifyID**: V-1001
- **DetectionMethod**: Verify履歴3回 vs Repairログ1回
- **MissingLogs**: Loop 2, Loop 3 のRepairログなし
- **Action**: 手動でRepairログを補完依頼
```

**保存先**: evidence/manual_fix_detections/MANUAL_FIX_20260110_180000.md

---

### E-1104: HumanGateエスカレーションログ

**内容**: 3ループ超過時のHumanGate提出履歴

**形式**:
```markdown
# HumanGate Escalation Log

- **Timestamp**: 2026-01-10 20:00
- **VerifyID**: V-1001
- **LoopCount**: 3/3
- **FailureLogs**:
  - Loop 1: テスト3件失敗
  - Loop 2: テスト1件失敗（同じ内容）
  - Loop 3: テスト1件失敗（同じ内容）
- **Fixes**:
  - Loop 1: user.py L42 修正
  - Loop 2: user.py L42 再修正
  - Loop 3: user.py L42 さらに修正
- **CurrentStatus**: 依然として test_user_login が FAIL
- **RootCause**: 不明（ログからは特定できず）
- **EscalationTime**: 2026-01-10 20:00
- **ApprovalTime**: 2026-01-11 10:00（24時間以内）
- **Decision**: A) 設計変更（Specに「パスワードがNoneの場合も許容」を追記）
```

**保存先**: evidence/humangate_escalations/HUMANGATE_20260110_200000_V-1001.md

---

### E-1105: VRループ指標

**内容**: プロジェクト全体の収束性指標

**形式**:
```json
{
  "timestamp": "2026-01-10T23:00:00Z",
  "total_tasks": 50,
  "vr_loop_stats": {
    "average_loops": 1.4,
    "loop_distribution": {
      "1": 30,
      "2": 15,
      "3": 3,
      ">3": 2
    },
    "escalation_rate": 0.04
  },
  "failure_category_distribution": {
    "Spec": 10,
    "依存": 5,
    "実装": 25,
    "テスト": 10
  },
  "flaky_test_rate": 0.02
}
```

**保存先**: evidence/metrics/vr_loop_metrics.json

---

## 10. チェックリスト

- [x] R-1101: VRループ3回制限が定義され、HumanGateエスカレーションが明記されている
- [x] R-1102: 失敗分類4カテゴリ（Spec/依存/実装/テスト）が定義されている
- [x] R-1103: Repairログ必須が定義され、形式が明記されている
- [x] R-1104: HumanGateエスカレーション条件と手順が明記されている
- [x] R-1105: 収束性指標の記録が定義されている
- [x] R-1106: 同じ失敗の再発防止手順が明記されている
- [x] 手順1〜6が「人間がそのまま実行できる粒度」で記述されている
- [x] 例外処理1〜4が「失敗分岐・復旧・エスカレーション」を含む
- [x] V-1101〜V-1110が「判定条件・合否・ログ」を含む
- [x] E-1101〜E-1105が「形式・保存先」を含む
- [x] 全ルールに根拠（F-XXXX or Part XX）が明記されている

## 11. 未決事項（推測禁止）

### U-1101: Z.aiのログ要約能力
**問題**: 3ループ超過時に「Z.aiでログ要約 → GPTで根本原因」とあるが、Z.aiの要約精度が未検証

**影響**: ログが長大な場合、要約が不十分で根本原因特定できない可能性

**対応**: Z.aiの要約精度を検証し、不十分な場合は人間が要約（HumanGate）

---

### U-1102: Flaky Test自動検出
**問題**: Flaky Test（FAIL→PASS→FAIL）を自動検出する仕組みが未実装

**影響**: 手動で検出する必要があり、見落としの可能性

**対応**: CI/CDでテスト履歴を記録し、統計的に検出する仕組みを検討（ADRで決定）

---

### U-1103: HumanGate承認者の指定
**問題**: HumanGateへエスカレーション時の「承認者」が未定義（Part09でも未決）

**影響**: エスカレーション先が不明確で、承認待ちが長期化

**対応**: Part09（Permission Tier）で「HumanGateの承認者リスト」を定義

---

### U-1104: 収束性指標の閾値
**問題**: 平均ループ回数1.5回以下、3ループ超過率5%以下の閾値が「推奨値」であり、プロジェクト特性で変わる可能性

**影響**: プロジェクトによっては閾値が厳しすぎる/緩すぎる

**対応**: プロジェクト開始時にADRで閾値を決定（初期は推奨値で運用）

---

## 12. 参照（パス）

### docs/
- [Part00](./Part00.md) : SSOT憲法（ADR→docs workflow）
- [Part02](./Part02.md) : 用語管理（GLOSSARY統一）
- [Part03](./Part03.md) : AI Pack（Core4役割、ChatGPT/Claude/Z.ai）
- [Part04](./Part04.md) : ワーク管理（VIBEKANBAN, BLOCKED状態）
- [Part09](./Part09.md) : Permission Tier（HumanGate承認フロー）
- [Part10](./Part10.md) : Verify Gate（Fast/Full、VRループ開始点）
- [Part12](./Part12.md) : Evidence管理（ログ保存形式・フォルダ構造）
- [Part16](./Part16.md) : Metrics（収束性指標・ダッシュボード）
- [FACTS_LEDGER.md](./FACTS_LEDGER.md) : F-0002, F-0023, F-0057

### sources/
- （なし: 本Partは主にF-0057を根拠とする）

### evidence/
- evidence/repair_logs/ : E-1101（VRループ履歴）
- evidence/flaky_tests/ : E-1102（Flaky Testログ）
- evidence/manual_fix_detections/ : E-1103（手動修正検出ログ）
- evidence/humangate_escalations/ : E-1104（HumanGateエスカレーションログ）
- evidence/metrics/ : E-1105（VRループ指標）

### decisions/
- [ADR-0001](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス（Verify→Repair workflow）




FILE: docs\Part12.md
-----
# Part 12：Evidence（証跡パック）運用（RUNLOG/TRACE/ハッシュ/参照パス/監査可能性）

## 0. このPartの位置づけ
- 目的：Evidenceの作成・保存・参照パスを固定し、監査可能性を維持する
- 依存：Part00（SSOT憲法）、Part09（Permission Tier）、Part10（Verify Gate）、Part14（変更管理）、Part15（運用ループ）
- 影響：evidence/ の運用、Verify結果の扱い、監査の整合性

## 1. 目的（Purpose）
Evidenceの最小セットと保存ルールを統一し、  
Verify/Evidenceが揃っていない変更を排除する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- evidence/ に保存する証跡の作成・整理・参照
- Verify結果の保存と参照パスの維持
- 監査に必要な最小セットの確保

### Out of Scope（対象外）
- sources/ への更新
- 実装コードの詳細手順（別Part）
- 外部ツールの運用規約（組織ルール）

## 3. 前提（Assumptions）
1. docs/ が唯一のSSOTである
2. Verify/Evidenceは Part00/Part10 に従う
3. 変更管理は Part14 に従う
4. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Evidence**: 変更の根拠・検証・監査を支える証跡
- **RUNLOG**: 作業実行のログ
- **TRACE**: 参照元と変更の関連付け
- **参照パス**: Evidenceの保存先を示すパス

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-1201: Evidence保存義務【MUST】
Verify結果と変更記録は evidence/ に保存し、削除しない（アーカイブ移動のみ許可）。

### R-1202: PASS証跡のみ採用【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-1203: 証跡4点の最小セット【MUST】
link/parts/forbidden/sources の4点を最小セットとして保存する。

### R-1206: Evidence Pack 規格【MUST】
Evidenceは以下の構成を満たす：
1. Verifyレポート（`evidence/verify_reports/YYYYMMDD_HHMMSS_<mode>_<status>_<category>.md`）
2. 差分（`evidence/YYYYMMDD_HHMM_<task-id>_diff.md`）
3. 実行ログ（`evidence/YYYYMMDD_HHMM_<task-id>_log.md`）
4. 変更概要（`evidence/YYYYMMDD_HHMM_<task-id>_summary.md`）

### R-1207: 証跡保持ポリシー【MUST】
- evidence/verify_reports は「直近3セット」を保持
- 4セット目以降は `evidence/archive/YYYY/MM/` へ移動（削除禁止）

### R-1204: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-1205: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：必要な証跡の種類と保存先を特定する。
2. 記録：対象ファイル、参照根拠、保存先のパスを記録する。
3. 修正：最小差分でEvidenceを整理し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点を保存する。
5. 監査：Evidence一覧・参照パス・DoDを点検し、不足がないか確認する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 誤更新が疑われる
- 直前の変更を取り消し、影響範囲を再確認して再検証する。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-1201: Evidence最小セットの確認
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-1202: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-1201: 変更記録
**内容**: 発見内容、修正理由、参照根拠、変更概要  
**保存先**: evidence/ または decisions/（Part14に従う）

### E-1202: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-1203: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/（`.md` 形式）

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] Evidenceの参照パスが記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part13.md
-----
# Part 13：Release（不変成果物）運用（manifest/sha256/SBOM・再現性・配布単位）

## 0. このPartの位置づけ
- 目的：Releaseの不変成果物運用を固定し、再現性と監査可能性を担保する
- 依存：Part00（SSOT憲法）、Part01（DoD）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：RELEASE/ の生成・保存、manifest/sha256/SBOM の整合性

## 1. 目的（Purpose）
Releaseを不変成果物として扱い、manifest/sha256/SBOMと証跡の整合を維持する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- RELEASE/ の作成・保存・参照
- manifest/sha256/SBOM の生成と保存
- Releaseに関するVerify/Evidenceの保存

### Out of Scope（対象外）
- sources/ への更新
- 実装コードの詳細手順（別Part）
- 配布先の運用（外部手続き）

## 3. 前提（Assumptions）
1. Releaseは不変成果物である
2. Verify/Evidenceは Part00/Part10/Part12 に従う
3. 変更管理は Part14 に従う
4. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Release**: 不変の成果物単位
- **manifest**: Release構成の一覧
- **sha256**: 整合性検証のハッシュ
- **SBOM**: 依存関係の構成情報

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-1301: Release不変【MUST】
Releaseは作成後に改変しない（更新は新規Releaseで行う）。

### R-1302: 証跡と整合【MUST】
Releaseには manifest/sha256/SBOM を必ず付与し、Evidenceに保存する。

### R-1303: HumanGate必須【MUST】
Release生成・確定はHumanGate承認の対象とする。

### R-1304: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-1305: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-1306: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：Release対象と必須成果物（manifest/sha256/SBOM）を確認する。
2. 記録：対象ファイル、参照根拠、保存先を記録する。
3. 修正：最小差分でRelease情報を整備し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：Releaseの不変性・参照パス・証跡一覧・DoDを点検する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: Releaseの汚染が疑われる
- Releaseを破棄し、新規Releaseとして作り直す。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-1301: Release証跡の確認
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-1302: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-1301: Release記録
**内容**: Release対象、manifest/sha256/SBOM、参照根拠  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-1302: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-1303: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] Releaseの不変性と参照パスが記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part01](./Part01.md) : 目標・DoD
- [Part02](./Part02.md) : 用語・表記
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part14.md
-----
# Part 14：変更管理（PATCHSET/RFC/ADR・例外ルート・互換/移行・凍結解除ルール）

## 0. このPartの位置づけ
- **目的**: SSOT更新の手順・承認フロー・バージョン管理・破壊的変更の扱いを統一し、矛盾蓄積を防ぐ
- **依存**: Part00（SSOT憲法・真実順序）、Part09（Permission Tier・承認フロー）、Part10（Verify Gate）
- **影響**: 全Part（変更時は必ず本Partの手順に従う）、Part12（Evidence）、Part13（Release）、Part17（Rollback）

## 1. 目的（Purpose）

VCG/VIBE 2026 設計書SSOTを運用するには、**誰が・何を・どの順序で変更してよいか** を明確にしなければ、すぐに矛盾が蓄積し、SSOTが破壊される。

本Partでは以下を達成する：

1. **変更の正当性**: 仕様変更の根拠がないまま docs/ を書き換えると、後から「なぜこうなったか」が追跡不能になる → **ADR先行ルール** で防止
2. **最小差分原則**: 複数の目的を混ぜた巨大PATCHは、失敗時の切り分けが困難 → **PATCHSET単位** で単一目的に限定
3. **バージョン管理**: 「いつ」「誰が」「何を」変更したかを追跡できなければ、ロールバック不能 → **CHANGELOG必須**
4. **破壊的変更の制御**: 互換性を破壊する変更は、移行手順・ロールバック計画なしに実施禁止 → **HumanGate承認**
5. **凍結解除の透明性**: Spec凍結前の実装禁止ルールに対し、例外承認の記録を残す

**根拠**: [F-0003](../docs/FACTS_LEDGER.md#F-0003), [ADR-0001](../decisions/0001-ssot-governance.md)

## 2. 適用範囲（Scope / Out of Scope）

### Scope（対象）
- docs/ 配下の全Part（Part00〜Part20）の変更
- glossary/ の用語追加・定義変更
- decisions/ への ADR 追加（変更承認記録）
- checks/ の検証スクリプト追加・修正
- 互換性を破壊する変更（フォルダ構造変更、ファイル名変更、API仕様変更）
- Spec凍結前の実装開始（例外承認が必要）

### Out of Scope（対象外）
- sources/ 配下のファイル（改変・削除禁止、Part00で固定）
- evidence/ 配下のログ・レポート（Append-only、削除は Part09 HumanGate）
- WORK/ 配下の作業ファイル（個人の裁量、VERIFYを通せば自由）
- コード実装の変更（本Partはドキュメント変更のみ、コードは別途 Part04 VIBEKANBAN）

**注意**: 上記Out of Scopeの変更は **別のルール** で管理される（Part00, Part05, Part09参照）。

## 3. 前提（Assumptions）

本Partは以下を前提とする：

1. **Git運用**: 本リポジトリはGit管理されており、ブランチ・PR・コミットログが利用可能
2. **ADR承認権限**: decisions/ への ADR 追加は **HumanGate** または **指定承認者** のみ可能（Part09で定義）
3. **Verify Gate通過**: 変更は必ず Part10 で定義された検証を通過してからマージ（通過しない変更はマージ禁止）
4. **PATCHSET最小単位**: 1つの変更は「1つの目的」に限定し、複数目的を混ぜない
5. **CHANGELOG維持**: 更新のたびに `CHANGELOG.md` を更新し、「いつ・誰が・何を」を記録
6. **CI強制**: main/integrate へのマージはCIでVerify PASSが必須

**根拠**: [F-0003](../docs/FACTS_LEDGER.md#F-0003), [ADR-0001](../decisions/0001-ssot-governance.md)

## 4. 用語（Glossary参照：Part02）

本Partで使用する用語：

- **PATCHSET**: 最小差分の変更単位。1つの目的（バグ修正/機能追加/用語統一）のみを含む
- **ADR (Architecture Decision Record)**: 意思決定記録。変更理由・選択肢・影響範囲を明記し、承認されてから docs/ へ反映
- **RFC (Request for Comments)**: 変更提案。ADRの前段階、議論中の提案（本プロジェクトではADRに統合）
- **CHANGELOG**: 変更履歴。YYYY-MM-DD 形式の日付、変更概要、担当者を記録
- **Spec Freeze**: 仕様凍結。Spec完成後、実装開始前に凍結宣言を行い、以降の仕様変更は例外承認必須
- **破壊的変更**: 既存の参照・フォルダ構造・API仕様を破壊する変更。移行手順・ロールバック計画が必須
- **HumanGate**: 人間の承認が必須の操作。破壊的変更・全域変更・リリース確定など（Part09で定義）

**参照**: [glossary/GLOSSARY.md](../glossary/GLOSSARY.md), [Part02](./Part02.md)

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-1401: PATCHSET最小単位【MUST】

**定義**: SSOTの更新は「PATCHSET」として作成し、以下の条件を満たす。

#### 条件
1. **単一目的**: 1つのPATCHSETは1つの目的（バグ修正/機能追加/用語統一/ADR追加）のみを含む
2. **最小差分**: 目的達成に必要な最小限の変更にとどめる（無関係な整理・リファクタリングを混ぜない）
3. **VERIFYを通過**: Part10 で定義された検証（Fast Verify最低限）を通過してからマージ
4. **失敗時の即座対応**: VERIFYが失敗した場合、即座にロールバックまたはRevert（放置禁止）

#### 禁止例
- ❌ バグ修正 + 用語統一 + フォルダ整理 を1つのPRに混ぜる
- ❌ 10ファイル同時変更で、うち3ファイルは無関係な整理
- ❌ VERIFYを通さずにマージ

**根拠**: [F-0003](../docs/FACTS_LEDGER.md#F-0003)
**Verify観点**: V-1401（後述）
**例外**: なし（全変更に適用）

---

### R-1402: ADR先行ルール【MUST】

**定義**: 仕様・運用を変更する場合、**必ず以下の順序** で実施する。

#### 手順
1. **decisions/** に ADR を追加（変更理由・選択肢・影響範囲を明記）
2. ADR が承認されたら、**docs/** の該当 Part を更新
3. **checks/** の検証手順を実行し、矛盾がないことを確認
4. **CHANGELOG.md** に変更履歴を記録

#### 違反例（禁止）
- ❌ ADR を書かずに docs/ を直接変更
- ❌ 変更理由を口頭・チャットだけで済ます
- ❌ 検証を省略して push
- ❌ CHANGELOG を更新せずにマージ

#### ADR免除条件（例外）
以下の変更は ADR 不要（軽微な変更）：
- 誤字脱字修正（用語定義に影響しない）
- コメント追加（ルールの追加・変更ではない）
- チェックリスト項目追加（ルール変更を伴わない）

**ただし、CHANGELOG への記録は必須**（軽微な変更でも記録する）。

**根拠**: [ADR-0001](../decisions/0001-ssot-governance.md#1-変更手順must)
**Verify観点**: V-1402（後述）
**例外**: 上記「ADR免除条件」のみ

---

### R-1403: CHANGELOG必須【MUST】

**定義**: 更新のたびに `CHANGELOG.md` を更新し、以下の形式で記録する。

#### 形式
```markdown
## YYYY-MM-DD

### 変更種別（Added / Changed / Fixed / Removed）
- **[Part番号]** 変更概要（1行、50文字以内）
  - 担当: @username または AI名（ChatGPT/Claude Code/Gemini）
  - ADR: decisions/0001-example.md（該当する場合）
  - Commit: abc1234
```

#### 例
```markdown
## 2026-01-10

### Added
- **[Part14]** 変更管理（PATCHSET/ADR/CHANGELOG）を追加
  - 担当: Claude Code
  - ADR: decisions/0001-ssot-governance.md
  - Commit: 0dd189d

### Fixed
- **[Part10]** Verify Gate の V-0901 でバッククオート内の禁止コマンドを除外
  - 担当: Claude Code
  - Commit: b375057
```

#### 変更種別の定義
- **Added**: 新規Part追加、新規ルール追加、新規用語追加
- **Changed**: 既存ルールの変更、手順の変更、用語定義の変更
- **Fixed**: バグ修正、誤字脱字修正、リンク切れ修正
- **Removed**: Part削除、ルール削除、非推奨化

**根拠**: [F-0003](../docs/FACTS_LEDGER.md#F-0003)
**Verify観点**: V-1403（後述）
**例外**: なし（全変更に適用）

---

### R-1404: 破壊的変更の制御【MUST】

**定義**: 既存の参照・フォルダ構造・API仕様を破壊する変更は、以下の条件を満たしてから実施する。

#### 破壊的変更の例
- Part番号変更（Part14 → Part15など、他Partからの参照が破壊される）
- フォルダ名変更（docs/ → documentation/ など、パス参照が破壊される）
- ファイル名変更（FACTS_LEDGER.md → LEDGER.md など、リンクが破壊される）
- 用語変更（PATCHSET → PATCH_SET など、grep検索が破壊される）
- API仕様変更（MCP ReadOnly → WriteAll など、互換性が破壊される）

#### 実施条件【MUST】
1. **ADR必須**: decisions/ に破壊的変更の ADR を追加（移行手順・ロールバック計画を含む）
2. **HumanGate承認**: Part09 で定義された承認フローを通過
3. **移行手順明記**: 既存の参照を全て洗い出し、移行スクリプト or 手動手順を用意
4. **Dry-run実施**: 本番適用前に、テスト環境で移行を実行し、失敗がゼロであることを確認
5. **ロールバック計画**: 失敗時の復旧手順（git revert / バックアップ復元）を事前に用意
6. **Full Verify通過**: Part10 の Full Verify（7カテゴリ、<30分）を通過

**根拠**: [F-0002](../docs/FACTS_LEDGER.md#F-0002), [F-0031](../docs/FACTS_LEDGER.md#F-0031), [Part09](./Part09.md)
**Verify観点**: V-1404（後述）
**例外**: なし（全破壊的変更に適用）

---

### R-1405: Spec凍結前の実装禁止【MUST】

**定義**: Specが凍結されるまでBuildしない（仕様が流動的なまま実装すると、手戻りで事故率が急上昇）。

#### 凍結宣言の条件
1. **Acceptance（受入条件）が機械判定可能**: Part10 の Verify 観点で判定可能な形式
2. **未決事項ゼロ**: 「未決事項」セクションが空、または「未決でも実装可能」と明記
3. **ADR承認**: Spec凍結の ADR が承認済み

#### 例外承認（Spec凍結前に実装開始が許可されるケース）
1. **SPIKE（調査用スパイク）**: 実装可能性を調査するための試作。以下の条件を満たす：
   - 隔離環境（WORK/SPIKE/）で実施
   - 成果は「仕様へ移すまで本流に混ぜない」
   - SPIKE完了後、Specに反映してから本流実装
2. **Proof of Concept（PoC）**: 技術検証。SPIKE同様に隔離し、成果をSpecへ反映
3. **緊急修正（Hotfix）**: 本番障害の緊急対応。以下の条件を満たす：
   - HumanGate承認（Part09）
   - 事後にSpecへ反映（ADR追加）

**根拠**: [F-0002](../docs/FACTS_LEDGER.md#F-0002), [F-0032](../docs/FACTS_LEDGER.md#F-0032)
**Verify観点**: V-1405（後述）
**例外**: 上記「例外承認」のみ（ADR必須）

---

### R-1406: バージョン番号ルール【SHOULD】

**定義**: リリース時のバージョン番号は YYYY-MM-DD 形式を推奨（セマンティックバージョニングは任意）。

#### 形式
- **推奨**: `RELEASE_20260110_153000`（タイムスタンプ形式）
- **任意**: `v1.2.3`（セマンティックバージョニング、運用判断）

#### 理由
- タイムスタンプ形式は「いつリリースされたか」が一目瞭然
- セマンティックバージョニング（Major.Minor.Patch）は、互換性の判定には有用だが、「いつ」が不明
- **両方併記も可**（例: `v1.2.3 (RELEASE_20260110)`）

**根拠**: [F-0003](../docs/FACTS_LEDGER.md#F-0003), [F-0006](../docs/FACTS_LEDGER.md#F-0006)
**Verify観点**: V-1406（後述）
**例外**: プロジェクト方針でセマンティックバージョニング採用の場合はADRで明記

---

### R-1407: CIによるVerify強制【MUST】

**定義**: main/integrate へのマージは CI で Verify Gate が PASS した場合のみ許可する。

#### 条件
1. **Required Status Checks** に Verify Fast を登録
2. **main へのマージ**は Verify Full も PASS していること
3. **CIログの参照**を evidence/ に記録する（参照パスのみで可）

**根拠**: [Part10](./Part10.md)
**Verify観点**: V-1410（後述）
**例外**: HumanGate 承認（緊急対応のみ）

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順1: PATCHSET作成（docs/ 変更時）

以下の手順で最小差分の変更を作成する。

1. **ブランチ作成**
   ```bash
   git checkout -b feature/fix-part14-typo
   ```

2. **変更実施**（1つの目的のみ）
   - 例: Part14 の誤字修正のみ
   - 禁止: 誤字修正 + 用語統一 を混ぜる

3. **Fast Verify実行**（Part10参照）
   ```bash
   bash checks/verify_repo.sh
   ```

4. **失敗時は即座修正**（3ループ以内、Part10参照）
   - 修正 → Verify → 修正 → Verify → ...
   - 3ループで解決しなければ HumanGate（Part09参照）

5. **CHANGELOG更新**
   ```markdown
   ## 2026-01-10
   ### Fixed
   - **[Part14]** 誤字修正（PATCHSET → PatchSet の表記揺れ）
     - 担当: Claude Code
     - Commit: abc1234
   ```

6. **コミット**
   ```bash
   git add docs/Part14.md CHANGELOG.md
   git commit -m "Fix: Part14 誤字修正（PATCHSET表記統一）"
   ```

7. **PR作成 & マージ**
   - PRテンプレートに「Verify結果」を添付
   - レビュー承認後、マージ

---

### 手順2: ADR追加（仕様変更時）

仕様・運用を変更する場合、以下の手順で ADR を先行追加する。

1. **decisions/ADR_TEMPLATE.md をコピー**
   ```bash
   cp decisions/ADR_TEMPLATE.md decisions/0002-change-patchset-format.md
   ```

2. **ADR記入**（以下のセクションを必ず埋める）
   - **背景**: なぜ変更が必要か（現状の問題）
   - **決定**: 何をどう変更するか（選択肢A/B/Cと採用理由）
   - **影響範囲**: どのPartに影響するか、互換/移行の扱い
   - **実行計画**: 手順・ロールバック・検証観点

3. **承認依頼**
   - HumanGate または 指定承認者 にレビュー依頼
   - 承認されるまで docs/ は変更しない

4. **ADR承認後、docs/ 更新**
   - ADRで決定した内容を該当Partへ反映
   - CHANGELOGに記録

5. **Verify実行**
   ```bash
   bash checks/verify_repo.sh
   ```

6. **コミット & PR**
   ```bash
   git add decisions/0002-*.md docs/Part*.md CHANGELOG.md
   git commit -m "Add: ADR-0002（PATCHSET形式変更）& Part14更新"
   ```

---

### 手順3: 破壊的変更の実施（フォルダ名変更など）

既存の参照を破壊する変更は、以下の手順で慎重に実施する。

1. **ADR作成**（手順2参照）
   - 「背景」に「なぜ破壊が必要か」を明記
   - 「影響範囲」に「全リンク切れ箇所」を列挙
   - 「実行計画」に「移行手順」「ロールバック」を明記

2. **HumanGate承認**（Part09参照）
   - ADRを承認者に提出
   - 承認されるまで実施禁止

3. **Dry-run（テスト環境）**
   ```bash
   # 例: docs/ → documentation/ へ変更
   git checkout -b test/rename-docs
   git mv docs documentation
   # 全リンク更新スクリプト実行
   bash scripts/update_links.sh docs documentation
   # Verify実行
   bash checks/verify_repo.sh
   ```

4. **Dry-run成功を確認**
   - VERIFYが全てPASS
   - リンク切れゼロ

5. **本番実施**
   ```bash
   git checkout -b feature/rename-docs
   git mv docs documentation
   bash scripts/update_links.sh docs documentation
   git add .
   git commit -m "Breaking: docs/ → documentation/ へ変更（ADR-0003）"
   ```

6. **Full Verify実行**（Part10参照、<30分）
   ```bash
   bash checks/verify_repo.sh --full
   ```

7. **ロールバック計画確認**
   - git revert可能であることを確認
   - バックアップがあることを確認

8. **PR & マージ**
   - PRに「破壊的変更」ラベル付与
   - ADRリンク、Verify結果、ロールバック手順を添付

---

### 手順4: Spec凍結宣言（実装開始前）

Specが完成したら、以下の手順で凍結を宣言する。

1. **未決事項ゼロ確認**
   - 該当Partの「11. 未決事項」セクションが空
   - または「未決でも実装可能」と明記

2. **Acceptance（受入条件）確認**
   - Part10 の Verify 観点で機械判定可能
   - 手動判定が必要な場合は「判定手順」を明記

3. **ADR作成**
   ```markdown
   # ADR-0004: Part14 Spec凍結宣言

   ## 決定
   Part14（変更管理）のSpecを凍結し、実装開始を許可する。

   ## 受入条件
   - V-1401〜V-1406 が全てPASS
   - CHANGELOGが更新されている
   - ADR先行ルールが守られている
   ```

4. **凍結マーク追加**（該当Partのヘッダに追記）
   ```markdown
   # Part 14：変更管理（PATCHSET/RFC/ADR）

   **Status**: Spec Freeze（2026-01-10）
   **ADR**: decisions/0004-part14-spec-freeze.md
   ```

5. **実装開始許可**
   - 凍結後は「仕様変更は例外承認必須」
   - 実装中に仕様変更が必要な場合はADR追加

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: VERIFYが3ループで解決しない

**状態**: Part10 の VRループで3回修正しても VERIFY が PASS しない

**対応**:
1. **HumanGateへエスカレーション**（Part09参照）
   - 失敗ログ、修正履歴、現状をまとめて提出
2. **承認者判断**:
   - A) 一時的に VERIFY を緩和（ADR追加）
   - B) 変更を中止（Revert）
   - C) 追加調査（SPIKE扱い）

**Verify観点**: V-1407（後述）
**Evidence**: E-1401（VRループ失敗ログ）

---

### 例外2: 緊急Hotfix（Spec凍結前の実装）

**状態**: 本番障害で緊急修正が必要、Spec凍結前だが実装開始せざるを得ない

**対応**:
1. **HumanGate承認**（Part09参照）
   - 障害内容、影響範囲、修正方針を提出
2. **Hotfixブランチ作成**
   ```bash
   git checkout -b hotfix/critical-bug-20260110
   ```
3. **最小限の修正**（追加機能を混ぜない）
4. **Fast Verify実行**（可能な範囲）
5. **マージ後、Specへ反映**
   - ADR追加（事後承認）
   - Specに「Hotfix履歴」セクション追加

**Verify観点**: V-1408（後述）
**Evidence**: E-1402（Hotfix承認記録）

---

### 例外3: 破壊的変更のロールバック

**状態**: 破壊的変更をマージ後、予期しない副作用が発生

**対応**:
1. **即座にRevert**
   ```bash
   git revert abc1234
   git push origin main
   ```
2. **Full Verify実行**（Revert後の整合性確認）
3. **事後報告**
   - ADRに「ロールバック実施」セクション追加
   - 失敗原因、対策を記録

**Verify観点**: V-1409（後述）
**Evidence**: E-1403（ロールバック記録）

---

### 例外4: ADR免除の濫用

**状態**: 「軽微な変更」を理由に ADR を省略しているが、実際はルール変更を含む

**検知方法**:
- Verify時に「CHANGELOG にあるが ADR がない変更」を検出
- 「Changed」種別なのに ADR リンクがない

**対応**:
1. **Verify失敗**（V-1402）
2. **修正指示**: ADR を事後追加、またはCHANGELOGを「Fixed」に訂正
3. **繰り返す場合**: Permission降格（Part09参照、PatchOnly → ReadOnly）

**Verify観点**: V-1402（後述）
**Evidence**: E-1404（ADR免除濫用記録）

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-1401: PATCHSET最小単位の検証

**判定条件**:
1. 1つのPRに含まれる変更が「単一目的」であること
2. 無関係なファイル変更が混入していないこと

**合否**:
- **PASS**: 変更が1つの目的（バグ修正/機能追加/用語統一）のみ
- **FAIL**: 複数目的が混在（例: バグ修正 + 用語統一 + フォルダ整理）

**判定方法**:
```bash
# PRのdiffを目視確認（自動化は困難、レビュー時に判定）
git diff main...feature/fix-part14
```

**ログ**: evidence/verify_reports/V-1401_YYYYMMDD.md

---

### V-1402: ADR先行ルールの検証

**判定条件**:
1. docs/ の変更を含むPRに、対応するADRが存在すること
2. ADRの承認日が、docs/ 変更コミット日より前であること

**合否**:
- **PASS**: ADR が decisions/ に存在し、承認済み
- **FAIL**: ADR なしで docs/ を直接変更

**判定方法**:
```bash
# CHANGELOGの「Changed」エントリに ADR リンクがあるか確認
grep -E "^### Changed" CHANGELOG.md -A 5 | grep "ADR:"
```

**ログ**: evidence/verify_reports/V-1402_YYYYMMDD.md

**例外**: 軽微な変更（誤字脱字、コメント追加）はADR免除

---

### V-1403: CHANGELOG更新の検証

**判定条件**:
1. docs/ を変更するPRに、CHANGELOG.md の更新が含まれること
2. CHANGELOG の形式が正しい（日付、種別、Part番号、担当、Commit）

**合否**:
- **PASS**: CHANGELOG が更新され、形式が正しい
- **FAIL**: CHANGELOG が未更新、または形式不正

**判定方法**:
```bash
# 最新コミットにCHANGELOG.mdが含まれるか確認
git diff HEAD~1 --name-only | grep CHANGELOG.md
```

**ログ**: evidence/verify_reports/V-1403_YYYYMMDD.md

---

### V-1404: 破壊的変更の検証

**判定条件**:
1. フォルダ名変更、ファイル名変更、Part番号変更が含まれる場合、ADR必須
2. ADRに「移行手順」「ロールバック計画」が明記されていること
3. Dry-runの実行ログが evidence/ に保存されていること

**合否**:
- **PASS**: 上記3条件を全て満たす
- **FAIL**: 1つでも満たさない

**判定方法**:
```bash
# git mv または rm の履歴を検出
git log --oneline --name-status | grep -E "^(R|D)"
# ADRに「移行手順」セクションがあるか確認
grep "移行手順" decisions/0003-*.md
```

**ログ**: evidence/verify_reports/V-1404_YYYYMMDD.md

---

### V-1405: Spec凍結前の実装禁止の検証

**判定条件**:
1. 「Status: Spec Freeze」マークがないPartに対し、実装PRが作成されていないこと
2. SPIKE/PoC/Hotfix の場合、ADRに例外承認が記録されていること

**合否**:
- **PASS**: 凍結済みPartのみ実装、または例外承認あり
- **FAIL**: 未凍結Partに対し実装PR作成

**判定方法**:
```bash
# Partファイルに「Status: Spec Freeze」があるか確認
grep "Status: Spec Freeze" docs/Part14.md
# なければ実装PRの存在をチェック
git log --oneline --grep="Impl:" | grep Part14
**ログ**: evidence/verify_reports/V-1405_YYYYMMDD.md

---

### V-1406: バージョン番号形式の検証

**判定条件**:
1. RELEASE/ 配下のフォルダ名が `RELEASE_YYYYMMDD_HHMMSS` 形式であること

**合否**:
- **PASS**: 形式が正しい
- **FAIL**: 形式が不正（例: `RELEASE_v1.2.3`）

**判定方法**:
```bash
# RELEASE/配下のフォルダ名を確認
ls -d RELEASE/RELEASE_* | grep -E "RELEASE_[0-9]{8}_[0-9]{6}"
```

**ログ**: evidence/verify_reports/V-1406_YYYYMMDD.md

**例外**: セマンティックバージョニング採用の場合はADRで明記

---

### V-1407: VRループ3回制限の検証

**判定条件**:
1. 同一変更に対し、VERIFY失敗 → 修正 → VERIFY のループが3回以内であること

**合否**:
- **PASS**: 3回以内で解決
- **FAIL**: 3回超えてもPASSしない → HumanGateへエスカレーション

**判定方法**:
```bash
# evidence/ のVRループログを確認
grep "VRループ" evidence/verify_reports/V-1407_*.md | wc -l
```

**ログ**: evidence/verify_reports/V-1407_YYYYMMDD.md

---

### V-1408: Hotfix事後承認の検証

**判定条件**:
1. Hotfixブランチのマージ後、7日以内にADRが追加されていること

**合否**:
- **PASS**: 7日以内にADR追加
- **FAIL**: 7日経過してもADR未追加

**判定方法**:
```bash
# hotfix/ ブランチのマージ日を確認
git log --merges --oneline --grep="hotfix/"
# 7日以内のADR追加を確認
find decisions/ -name "*.md" -mtime -7
```

**ログ**: evidence/verify_reports/V-1408_YYYYMMDD.md

---

### V-1409: ロールバック記録の検証

**判定条件**:
1. git revert が実行された場合、ADRに「ロールバック実施」セクションが追加されていること

**合否**:
- **PASS**: ロールバック記録がADRに存在
- **FAIL**: revert実行後、ADR未更新

**判定方法**:
```bash
# git revert のコミットを検出
git log --oneline --grep="Revert"
# ADRに「ロールバック」セクションがあるか確認
grep "ロールバック" decisions/*.md
```

**ログ**: evidence/verify_reports/V-1409_YYYYMMDD.md

---

### V-1410: CI強制の検証

**判定条件**:
1. Required Status Checks に `verify-gate-windows` が登録されていること
2. main/integrate へのPRのChecksに `verify-gate-windows` が表示され、PASSであること

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: CI結果未付与、またはFAIL

**判定方法**:
- GitHub Branch Protection / Rulesets で Required checks を確認
- PRのChecksタブで `verify-gate-windows` のPASSを確認
- 参照URLを evidence/verify_reports/V-1410_YYYYMMDD.md に記録

**ログ**: evidence/verify_reports/V-1410_YYYYMMDD.md

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-1401: VRループ失敗ログ

**内容**: VERIFY失敗 → 修正 → VERIFY のループ履歴

**形式**:
```json
{
  "pr_id": "PR-123",
  "loop_count": 3,
  "failures": [
    {"loop": 1, "verify_id": "V-1403", "reason": "CHANGELOG未更新"},
    {"loop": 2, "verify_id": "V-1403", "reason": "日付形式不正"},
    {"loop": 3, "verify_id": "V-1403", "reason": "PASS"}
  ],
  "escalation": false
}
```

**保存先**: evidence/verify_reports/VR_LOOP_20260110_PR123.json

---

### E-1402: Hotfix承認記録

**内容**: 緊急修正の承認履歴

**形式**:
```markdown
# Hotfix承認記録

- **日時**: 2026-01-10 15:30
- **承認者**: @approver_name
- **障害内容**: 本番環境でPart10のVerify Gateが無限ループ
- **修正方針**: V-0901のバッククオート除外ロジック追加
- **影響範囲**: Part10のみ、他Partへの影響なし
- **事後ADR**: decisions/0005-hotfix-verify-gate.md（7日以内追加予定）
```

**保存先**: evidence/hotfix_approvals/HOTFIX_20260110_153000.md

---

### E-1403: ロールバック記録

**内容**: 破壊的変更のロールバック履歴

**形式**:
```markdown
# ロールバック記録

- **日時**: 2026-01-10 18:00
- **対象変更**: docs/ → documentation/ へのフォルダ名変更（Commit: abc1234）
- **ロールバック理由**: 外部ツールの参照が全てdocs/前提で、移行スクリプト漏れ
- **Revertコミット**: def5678
- **Full Verify結果**: PASS（全リンク復旧）
- **対策**: 次回は外部ツール依存を事前調査
```

**保存先**: evidence/rollback_logs/ROLLBACK_20260110_180000.md

---

### E-1404: ADR免除濫用記録

**内容**: ADR免除ルールの不正利用履歴

**形式**:
```markdown
# ADR免除濫用記録

- **日時**: 2026-01-10 20:00
- **PR**: PR-456
- **問題**: 「誤字修正」として免除を主張したが、実際はルール変更（R-1401の条件追加）
- **検知方法**: V-1402でCHANGELOGの種別が「Changed」だがADRリンクなし
- **対応**: PR差し戻し、ADR追加を指示
- **再発防止**: Permission降格（PatchOnly → ReadOnly）を検討
```

**保存先**: evidence/adr_abuse_logs/ADR_ABUSE_20260110_200000.md

---

### E-1405: Spec凍結宣言

**内容**: Specが凍結され、実装開始が許可された記録

**形式**:
```markdown
# Spec凍結宣言

- **Part**: Part14（変更管理）
- **凍結日**: 2026-01-10
- **ADR**: decisions/0004-part14-spec-freeze.md
- **未決事項**: ゼロ
- **Acceptance**: V-1401〜V-1410 が全てPASS
- **実装開始許可**: 承認済み
```

**保存先**: evidence/spec_freeze/SPEC_FREEZE_Part14_20260110.md

---

### E-1406: CI強制ログ

**内容**: CIでVerify GateがPASSした参照情報

**形式**:
```markdown
# CI Verify Gate ログ

- **PR**: PR-123
- **Verify**: Fast PASS / Full PASS
- **CI Run URL**: https://github.com/ORG/REPO/actions/runs/123456
- **対象ブランチ**: integrate / main
```

**保存先**: evidence/verify_reports/CI_VERIFY_20260110_PR123.md

---

## 10. チェックリスト

- [x] R-1401: PATCHSET最小単位が定義され、違反例が明記されている
- [x] R-1402: ADR先行ルールが定義され、免除条件が明記されている
- [x] R-1403: CHANGELOG必須が定義され、形式が明記されている
- [x] R-1404: 破壊的変更の制御が定義され、実施条件が明記されている
- [x] R-1405: Spec凍結前の実装禁止が定義され、例外承認が明記されている
- [x] R-1406: バージョン番号ルールが定義されている
- [x] R-1407: CIによるVerify強制が定義されている
- [x] 手順1〜4が「人間がそのまま実行できる粒度」で記述されている
- [x] 例外処理1〜4が「失敗分岐・復旧・エスカレーション」を含む
- [x] V-1401〜V-1410が「判定条件・合否・ログ」を含む
- [x] E-1401〜E-1406が「形式・保存先」を含む
- [x] 全ルールに根拠（F-XXXX or ADR-XXXX）が明記されている

## 11. 未決事項（推測禁止）

### U-1403: CHANGELOG の集約
**問題**: CHANGELOG.md が長大化した場合、過去ログをアーカイブするか未定義

**影響**: 1ファイルが数千行になり、検索・編集が困難

**対応**: 年単位でアーカイブ（CHANGELOG_2026.md）する案をADRで検討

---

### U-1404: セマンティックバージョニング
**問題**: バージョン番号にセマンティックバージョニング（v1.2.3）を採用するか、タイムスタンプ（YYYYMMDD）を採用するか、プロジェクト方針が未定義

**影響**: リリースごとに表記が揺れる

**対応**: ADRで方針統一（R-1406では「推奨」にとどめた）

---

## 12. 参照（パス）

### docs/
- [Part00](./Part00.md) : SSOT憲法（真実順序、ADR→docs workflow）
- [Part02](./Part02.md) : 用語管理（GLOSSARY統一）
- [Part09](./Part09.md) : Permission Tier（HumanGate承認フロー）
- [Part10](./Part10.md) : Verify Gate（Fast/Full、VRループ）
- [Part12](./Part12.md) : Evidence管理（ログ保存形式）
- [Part13](./Part13.md) : Release Package（不変リリース）
- [Part17](./Part17.md) : Rollback（復旧手順）
- [FACTS_LEDGER.md](./FACTS_LEDGER.md) : F-0002, F-0003, F-0006, F-0031, F-0032

### sources/
- （なし: 本Partは主にADR-0001を根拠とする）

### evidence/
- evidence/verify_reports/ : V-1401〜V-1410のログ
- evidence/hotfix_approvals/ : E-1402（Hotfix承認記録）
- evidence/rollback_logs/ : E-1403（ロールバック記録）
- evidence/adr_abuse_logs/ : E-1404（ADR免除濫用記録）
- evidence/spec_freeze/ : E-1405（Spec凍結宣言）

### decisions/
- [ADR-0001](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス（変更手順・根拠・検証の統治）
- [ADR_TEMPLATE.md](../decisions/ADR_TEMPLATE.md) : ADRの書き方
- [ADR-0004](../decisions/0004-humangate-approvers.md) : HumanGate承認者・SLA




FILE: docs\Part15.md
-----
# Part 15：Playbook（品質・安全の運用手順）

## 0. このPartの位置づけ
- **目的**: 品質/安全の実務運用を「迷わず実行できる手順」に落とし込み、Verify・監査と連動させる
- **依存**: Part00（SSOT憲法・真実順序）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）
- **影響**: 全Part（運用時の標準手順として参照）、Part17（Rollback）

## 1. 目的（Purpose）

品質・安全に関する判断を属人化させず、**誰が実行しても同じ結果になるPlaybook**を提供する。  
Playbookは「発見 → 記録 → 修正 → 検証 → 監査」のループを標準化し、SSOTの整合性を維持する。

## 2. 適用範囲（Scope / Out of Scope）

### Scope（対象）
- docs/ の品質・安全に関する運用手順
- Verify Gateの実行・結果記録
- 例外発生時のエスカレーションと記録

### Out of Scope（対象外）
- sources/ の変更（禁止、Part00に従う）
- 実装コードの詳細手順（別途 Part04/Part05）
- 組織固有の人事評価や裁量権（本Partでは規定しない）

## 3. 前提（Assumptions）

1. **直近変更の確定ログが存在**する（本Part作成の起点）
2. **Verify Fast/Full の定義**は Part10 に準拠する
3. **Evidenceの保存先/形式**は Part12 に準拠する
4. **変更管理ルール**は Part14 に準拠する

## 4. 用語（Glossary参照：Part02）

- **Playbook**: 具体的な手順と分岐を含む運用指針（誰でも実行可能）
- **運用ループ**: 発見 → 記録 → 修正 → 検証 → 監査 の反復
- **Fast Verify**: 最小限の検証（Part10参照）
- **Full Verify**: 全検証（Part10参照）

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-1501: Playbook遵守【MUST】

**定義**: 品質・安全に関する作業は本PartのPlaybookに従う。

**理由**: 手順の逸脱はSSOTの矛盾と監査不整合を生む。

**根拠**: [F-0003](../docs/FACTS_LEDGER.md#F-0003), [Part10](./Part10.md)

---

### R-1502: 運用ループの記録【MUST】

**定義**: すべての修正は「発見 → 記録 → 修正 → 検証 → 監査」の順序で実施し、Evidenceに残す。

**必須記録**:
1. 発見内容（何が不具合か）
2. 修正内容（どこをどう直したか）
3. Verify結果（PASS/FAIL）
4. Evidenceの保存先

**根拠**: [Part12](./Part12.md), [Part14](./Part14.md)

---

### R-1503: 例外時のHumanGate【MUST】

**定義**: 3回のVRループで解決できない場合はHumanGateへ即時エスカレーションする。

**根拠**: [Part09](./Part09.md), [Part10](./Part10.md)

---

### R-1504: Playbook更新はADR先行【MUST】

**定義**: Playbookの手順や基準を変更する場合、ADRを先行追加する。

**根拠**: [ADR-0001](../decisions/0001-ssot-governance.md), [Part14](./Part14.md)

---

### R-1505: 最小差分の修正【SHOULD】

**定義**: 修正は最小差分で行い、無関係な整理を混在させない。

**根拠**: [Part14](./Part14.md)

## 6. 手順（実行可能な粒度、番号付き）

### 手順1: 問題の発見と記録

1. 問題を特定する（ログ、Verifyレポート、レビュー指摘）。
2. 影響範囲を確認する（該当Part・リンク・証跡）。
3. Evidenceの保存先を決める（Part12の形式に従う）。

### 手順2: 修正の実施

1. 修正対象ファイルを明確化する。
2. **最小差分**で修正する（無関係な変更を含めない）。
3. 修正理由と変更点を簡潔にメモする。

### 手順3: Verify実行

1. `pwsh .\checks\verify_repo.ps1 -Mode Fast` を実行する。
2. FAILの場合は修正に戻る（最大3ループ）。
3. PASSしたら証跡を確認する。

### 手順4: 証跡の整理

1. PASS証跡のみをコミット対象にする。
2. FAIL証跡はコミットしない（保管のみ）。
3. Evidence一覧を作業報告に反映する。

### 手順5: 監査と共有

1. 変更概要とVerify結果を作業報告にまとめる。
2. 必要に応じてHumanGate承認者へ提出する。

### 手順6: Runbook（Deep Research→一次情報(MCP)→Facts→設計書差分→Verify→Evidence→Release）

#### 工程1: Deep Research（探索）
1. 探索目的と範囲を明確化（対象Part/用語/課題を固定）。
2. 参照優先順位を宣言（一次情報→社内根拠→二次情報）。
3. 探索クエリを列挙し、重複を排除する。
4. 収集対象を一次/二次に分類し、混在させない。
5. 収集元URLと取得日時を記録する。
6. 収集した原文を `sources/research_inbox/.../10_raw/` に保存する（追加のみ）。必要に応じて `sources/research_inbox/.../20_curated/` へコピーし、20_curated の先頭にコピー元（10_raw のパス）をメタデータとして記録する。10_raw は保持する。
7. 収集物の概要をメモ化（検索意図、重要点、未確認点）。
8. 収集物の信頼区分を付与（公式/標準/ブログ/不明）。
9. 探索結果の不足点を列挙し、追加探索の要否を判断する。
10. 探索ログを evidence/ に保存し、次工程へ渡す。

#### 工程2: 一次情報（MCP）
1. MCPの対象リソースと権限を確認する（ReadOnly優先）。
2. User Consentが必要な操作を洗い出す（Part03/Part09）。
3. MCPで一次情報を取得し、参照パスを記録する。
4. 取得結果は raw のまま保存し、加工前に証跡化する。
5. MCP実行ログを `evidence/mcp_logs/` に保存する。
6. 同一情報の重複取得を回避し、最終参照を固定する。
7. 取得情報の更新日/版数を記録する。
8. 必要な場合は追加の一次情報をMCPで補完する。
9. 取得情報の信頼境界を明記する（公開/機密/内部）。
10. 一次情報一覧を整理し、Facts工程の入力にする。

#### 工程3: Facts（F/D/U抽出）
1. 一次情報と探索結果からFact候補を抽出する。
2. 既存のFACTS_LEDGERと重複を確認する。
3. Factは「内容・根拠パス・重要度」を揃える。
4. Decisionは「決定内容・影響Part・根拠」を揃える。
5. Unknownは「不明点・影響・対応方針」を揃える。
6. F/D/Uを区別して FACTS_LEDGER に追記する。
7. 各項目に参照パスを必ず付与する。
8. 誤解釈がないか再チェックする。
9. 更新差分を最小化し、混在を防ぐ。
10. Facts更新完了をEvidenceに記録する。

#### 工程4: 設計書差分（docs更新）
1. 影響Partと関連ADRを特定する。
2. ADR先行が必要か判定する（Part14）。
3. 変更方針を最小差分に分割する。
4. 変更点の一覧を作成し、順序を固定する。
5. docs/ の対象Partを更新する（最小差分）。
6. 用語変更がある場合は glossary を更新する。
7. 人間承認が必要な変更はHumanGateへ回す。
8. 変更理由と根拠を短く記録する。
9. 変更後の参照リンクを点検する。
10. 次工程のVerify準備を整える。

#### 工程5: Verify（機械判定）
1. Fast Verify を1回だけ実行する（Part10）。
2. PASS/FAIL を確認し、結果を記録する。
3. FAIL時は原因を分類して修正する。
4. 修正後に再度 Fast Verify を実行する。
5. sources/ 改変がないことを再確認する。
6. 追加の検証（Full Verify）が必要か判断する。
7. CI実行が必要な場合はPRに付与する。
8. PASS証跡のみを採用する。
9. Verify結果の参照パスを確定する。
10. Verify完了をEvidenceに記録する。

#### 工程6: Evidence（証跡パック）
1. Evidence Packの必須構成を確認する（Part12）。
2. diff/verify/log/summary を揃える。
3. 命名規則に従って保存する（.md）。
4. 直近3セット保持ルールを確認する。
5. 古い証跡は archive/ へ移動する。
6. HumanGate承認がある場合は承認ログを追加する。
7. Evidence参照パスを作業報告に追記する。
8. Evidence不足がないかチェックする。
9. Evidence一覧を整理する。
10. Evidence完了を監査ログに記録する。

#### 工程7: Release（不変成果物）
1. Releaseが必要か判断する（Part13）。
2. Release対象を固定し、manifestを作成する。
3. sha256を生成し、整合性を確認する。
4. SBOMが必要な場合は生成する。
5. Releaseフォルダ命名規則を遵守する。
6. Releaseに含める証跡の参照パスを整理する。
7. Release作成後はREAD-ONLY化する。
8. CHANGELOGに反映する。
9. ReleaseのVerify結果を確認する。
10. Release完了を報告し、次サイクルへ戻る。

### 手順9: AI Ops安全運用（Vibe/Antigravity）

#### 9.1 Vibe Kanban 実行基準
**根拠**: [F-0070](../docs/FACTS_LEDGER.md#F-0070), [F-0071](../docs/FACTS_LEDGER.md#F-0071)

1. **起動**: 標準コマンド `npx vibe-kanban` を使用する。
2. **隔離実行**: タスクは必ず **Git Worktree** 上で実行し、メインブランチや他タスクの環境を汚染しない。
3. **MCP接続**: 外部ツール連携時はローカルMCPサーバ (`npx -y vibe-kanban@latest --mcp`) を使用し、外部公開しない。

#### 9.2 Antigravity 介入と承認フロー
**根拠**: [F-0073](../docs/FACTS_LEDGER.md#F-0073), [F-0074](../docs/FACTS_LEDGER.md#F-0074)

1. **削除承認**: 削除系コマンド（`rm`等）が要求された場合は、Allow List外として人間が内容を確認・承認する。
2. **ブラウザ操作承認**: JS実行等の承認要求に対し、意図しない操作（ログイン試行/フォーム送信等）が含まれないか確認する。
3. **強制介入**: エージェントが確認なしで実装へ進み、方針が逸脱した場合は、Mission Controlから即座に「停止/コメント」を実行する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 手順8: 工程別AI割当（最強AI構成）

#### 工程×AI割当マトリクス【ID: R-1506】

以下の工程別AI割当を標準とする（根拠: [ADR-0005](../decisions/0005-vibekanban-ai-orchestration.md)）。

| 工程 | 主AI | 副AI/補完 | 入力 | 出力 | チェック | 証跡 | フォールバック |
|------|------|----------|------|------|---------|------|---------------|
| **Research** | Gemini Deep Research | Z.ai (MCP経由) | SSOT/FACTS/ADR | research_inbox/ | Claude+ | evidence/research/ | 人間による文献確認 |
| **Hard Design & Review** | Claude+ (Sonnet/Opus) | GPT(Projects) | Research成果/FACTS | ADR/docs/ | Gemini CLI | evidence/design/ | 人間レビュー |
| **Implementation Bulk** | Gemini CLI / Codex | Claude+ | ADR/仕様 | 実装コード | Verify Gate | evidence/impl/ | Claude+で再実装 |
| **Audit/整合性監査** | GPT(Projects) | Claude+ | docs/全体 | 監査レポート | 人間 | evidence/audit/ | Claude+で再監査 |
| **Verify/Evidence** | Verify Gate(自動) | - | 変更差分 | PASS/FAIL | - | evidence/verify_reports/ | 手動検証 |

#### AI選択理由

1. **Research**: Gemini Deep Researchは多段探索・ソース追跡に強い
2. **Hard Design**: Claude+は長文設計・ADR作成・推論に強い
3. **Implementation**: Gemini CLI/Codexは高速・バルク処理に強い
4. **Audit**: GPT(Projects)は全体俯瞰・矛盾検出に強い
5. **Verify**: 機械判定のため固定（Fast Verify推奨）

#### 並列運用の制約

- **S タスク並列2まで**: 別worktree、証跡は独立保存
- **M タスク並列1まで**: 単独実行、worktree確保
- **L タスク並列0**: 他タスク停止、単独集中

詳細: [Part04](./Part04.md) R-0403（WIP制限）

#### フォールバック手順

1. **主AI失敗時**: フォールバック列のAIで再実行
2. **副AI失敗時**: 人間介入（HumanGate）
3. **Verify FAIL 3回**: 即座にHumanGate（Part09）


### 例外1: Verifyが3ループで通らない

**対応**:
1. HumanGateへエスカレーション（Part09）。
2. 失敗ログと修正履歴を提出。

### 例外2: 変更対象が複数にまたがる

**対応**:
1. 変更を分割し、PATCHSET単位で処理（Part14）。
2. どうしても分割できない場合はADRで理由を明記。

### 例外3: Evidenceが欠落している

**対応**:
1. 直近のVerifyを再実行してEvidenceを補完。
2. 再実行できない場合は理由と代替証跡を記録。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-1501: Playbook遵守の確認

**判定条件**:
1. 作業報告に「発見→修正→検証→証跡」が記載されている
2. PASS証跡のみがコミット対象になっている

**合否**:
- **PASS**: 上記を満たす
- **FAIL**: 作業報告欠落、FAIL証跡がコミット対象

**判定方法**:
```bash
# 作業報告とコミット対象を目視確認
git diff --name-only --cached
```

**ログ**: evidence/verify_reports/V-1501_YYYYMMDD.md

---

### V-1502: Verify実行の確認

**判定条件**:
1. Fast Verifyの実行ログが evidence/verify_reports/ に存在する

**合否**:
- **PASS**: 実行ログが存在
- **FAIL**: ログが存在しない

**判定方法**:
```bash
# 最新のverify_reportsを確認
ls evidence/verify_reports | tail -n 5
```

**ログ**: evidence/verify_reports/V-1502_YYYYMMDD.md

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-1501: 作業報告

**内容**: 変更概要、変更点、Verify結果、証跡一覧、次の一手

**保存先**: decisions/ または evidence/（運用ルールに従う）

---

### E-1502: Verify証跡（PASSのみ）

**内容**: Fast VerifyのPASSログ

**保存先**: evidence/verify_reports/

## 10. チェックリスト

- [ ] 作業対象・変更点が明確になっている
- [ ] Fast Verify を実行し、PASSを確認した
- [ ] PASS証跡のみがコミット対象になっている

## 11. 未決事項（推測禁止）

### U-1501: 作業報告の保存先統一
**問題**: 作業報告を decisions/ と evidence/ のどちらに保存するか未定義  
**影響**: 場所が統一されず監査が困難  
**対応**: Part12 に「作業報告の保存先」を追記するADRを検討

## 12. 参照（パス）

### docs/
- [Part00](./Part00.md) : SSOT憲法（真実順序）
- [Part09](./Part09.md) : Permission Tier（HumanGate）
- [Part10](./Part10.md) : Verify Gate（Fast/Full）
- [Part12](./Part12.md) : Evidence管理
- [Part14](./Part14.md) : 変更管理（PATCHSET/ADR）
- [Part17](./Part17.md) : Rollback
- [FACTS_LEDGER.md](./FACTS_LEDGER.md) : F-0003

### sources/
- （なし）

### evidence/
- evidence/verify_reports/

### decisions/
- [ADR-0001](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス




FILE: docs\Part16.md
-----
# Part 16：KB/RAG運用・更新プロトコル（知識更新・反映手順・汚染防止・参照規約）

## 0. このPartの位置づけ
- 目的：KB/RAGの更新と参照を安全に運用し、汚染と不整合を防ぐ
- 依存：Part00（真実順序）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：docs/ 内の知識更新・参照規約、監査証跡の整合性

## 1. 目的（Purpose）
KB/RAGの更新を「発見 → 記録 → 修正 → 検証 → 監査」の運用ループで標準化し、  
参照規約と証跡を揃えてSSOTの整合性を維持する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- docs/ におけるKB/RAGの更新手順と参照規約
- Verify結果の確認とEvidenceの整理

### Out of Scope（対象外）
- sources/ への更新
- 実装コードの詳細手順（別Part）

## 3. 前提（Assumptions）
1. 真実順序は Part00 に従う
2. Verifyの定義は Part10 に従う
3. Evidenceの形式と保存先は Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **KB**: docs/ を中心に管理する知識ベース
- **RAG**: KBを参照する取得・統合の運用形態
- **汚染**: 真実順序や根拠を欠いた更新による不整合

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-1601: 運用ループの順守【MUST】
KB/RAG更新は「発見 → 記録 → 修正 → 検証 → 監査」で実施し、順序を省略しない。

### R-1602: 参照根拠の明示【MUST】
変更理由は Part00 の真実順序に基づき、根拠を記録する。

### R-1603: 証跡はPASSのみ採用【MUST】
VerifyはPASS証跡のみを採用し、Evidenceに保存する。

### R-1604: 最小差分の更新【SHOULD】
無関係な整理を混在させず、最小差分で更新する。

### R-1605: sources/ 無改変【MUST NOT】
sources/ は改変しない（追加のみ許可）。対象外のファイルに変更が出た場合は即時停止する。

### R-1606: Fast PASS 必須【MUST】
Fast検証でPASSするまでコミットしない。PASS証跡のみ採用する。

### R-1607: 証跡4点の最小セット【MUST】
link/parts/forbidden/sources の4点を最小セットとして保存する。

### R-1608: RAG更新プロトコル【MUST】
- **トリガ**: docs/ の更新、glossary/ の更新、decisions/ の更新時
- **必須成果物**: 参照元一覧、差分サマリ、インデックス/埋め込み更新ログ
- **保存先**: `evidence/rag_updates/` に更新ログと参照パスを保存
- **禁止**: sources/ 由来の原本を直接加工してRAGへ投入

### R-1609: MCP/RAG役割分離【MUST】
**根拠**: [F-0075](../docs/FACTS_LEDGER.md#F-0075)

- **MCP Resources**: 仕様書・ログ・設定など「正確なローカル引用」が必要な場合はMCP (`resources/read`) を使用する。
- **RAG**: 大量の文書からの「意味検索」や関連情報探索にはRAGを使用する。
- **混在時の明示**: 両者を使用する場合は、出力において取得経路を明示する。

### R-1610: RAG対象パス明確化【MUST】
- **対象**: docs/・glossary/・decisions/ をRAG対象とする。
- **禁止**: sources/ 内のファイルは改変・削除しない（R-0003準拠）。
- **入力生成**: sources/ 由来の素材は `sources/research_inbox/.../10_raw/` を保持し、`sources/research_inbox/.../20_curated/` へはコピーのみ行う。20_curated の先頭にコピー元（10_raw のパス）をメタデータとして記録する。

## 6. 手順（実行可能な粒度、番号付き）
0. 経路選択：情報の性質（正確性vs網羅性）に応じて、MCP（ローカル引用）かRAG（意味検索）かを選択する [F-0075]。
1. 発見：不整合や不足点を特定し、影響範囲と参照根拠を確認する。
2. 記録：発見内容、根拠、対象ファイル、作業メモの保存先を記録する。
3. 修正：最小差分で更新し、sources/ 無改変を維持したまま変更理由を短く記録する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、汚染や差分過多がないか確認する。

### 6.2 RAG更新の詳細手順
1. **更新対象の特定**: docs/・glossary/・decisions/ の更新差分を一覧化する。
2. **参照元の固定**: 更新対象ファイルのパスと根拠（FACTS_LEDGER/ADR）を紐付ける。
3. **RAG入力の生成**: 更新対象を `ai_ready/` 相当のテキストに正規化する。
4. **インデックス更新**: 参照索引（ファイル一覧/リンク）を再生成する。
5. **埋め込み更新**: 追加・変更分のみを再埋め込みする（全再生成はHumanGate）。
6. **RAG検索テスト**: 代表クエリで更新内容が取得できるか確認する。
7. **差分サマリ作成**: 追加/変更/削除の件数と対象範囲を記録する。
8. **更新ログ作成**: `evidence/rag_updates/` にログを保存する。
9. **Verify実行**: Fast検証PASSを確認し、証跡4点を揃える。
10. **監査記録**: 参照パス・更新ログ・検証結果をまとめて記録する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 6.3 RAG初回作成工程（収集→正規化→索引→評価→更新→ロールバック）

RAGを初めて構築する際の手順を以下に示す（根拠: [ADR-0007](../decisions/0007-mcp-rag-boundary.md)）。

#### 手順1: 収集（対象範囲の固定）
1. RAG化対象を決定する（docs/, glossary/, decisions/ の初期状態）
2. sources/ は **RAG化禁止**（MCP Read-only取得のみ、ADR-0007 D-0007-2）
3. 対象ファイル一覧を生成する
   - Bash/WSL: `find docs/ glossary/ decisions/ -name "*.md"`
   - PowerShell: `Get-ChildItem docs/, glossary/, decisions/ -Recurse -Filter "*.md" | Select-Object FullName`
4. ファイル総数・総行数・総文字数を記録する
5. 収集日時とコミットハッシュを記録する

#### 手順2: 正規化（ai_ready化）
1. 対象ファイルを `ai_ready/` 相当の形式に変換する
2. Markdown構文を保持し、リンクを絶対パスに変換する
3. メタデータ（ファイルパス、更新日時、セクション番号）を付与する
4. 重複セクションを検出し、排除する
5. 正規化結果を一時ディレクトリに保存する

#### 手順3: 索引（インデックス生成）
1. 参照索引（ファイル一覧/リンク/用語）を生成する
2. Part00～Part20 の依存関係グラフを作成する
3. glossary/ の用語索引を作成する
4. ADR の決定一覧を作成する
5. 索引をJSON/YAML形式で保存する

#### 手順4: 埋め込み（ベクトル化）
1. 正規化テキストをチャンク分割する（サイズ: 1000～2000トークン、オーバーラップ: 200トークン）
2. 埋め込みモデルを選択する（推奨: text-embedding-004, OpenAI ada-002）
3. チャンクごとに埋め込みベクトルを生成する
4. 埋め込み結果をベクトルDBに保存する（推奨: Chroma, FAISS, Pinecone）
5. 埋め込み生成ログを `evidence/rag_updates/initial_YYYYMMDD.md` に保存する

#### 手順5: 評価（検索テスト）
1. 代表クエリを用意する（例: "SSOT憲法とは"、"Permission Tierの定義"、"Verify Gateの手順"）
2. クエリごとにRAG検索を実行し、適合率を確認する
3. 検索結果の上位5件が関連ドキュメントであることを確認する
4. 不適合な結果があれば、チャンク分割やメタデータを調整する
5. 評価結果を `evidence/rag_updates/initial_eval_YYYYMMDD.md` に保存する

#### 手順6: 更新ルール設定
1. RAG更新トリガを設定する（docs/更新時、glossary/更新時、decisions/更新時）
2. 更新単位を決定する（変更ファイルのみ vs 全再生成）
3. 全再生成はHumanGate必須とする
4. 更新ルールを `docs/Part16.md` に記録する

#### 手順7: ロールバック準備
1. RAG初回作成の全手順をスクリプト化する
2. ベクトルDBのバックアップを作成する
3. 索引・埋め込み・評価結果のスナップショットを保存する
4. ロールバック手順を `evidence/rag_updates/initial_rollback_YYYYMMDD.md` に記録する

#### 禁止事項【MUST NOT】

- sources/ を直接RAG化する（ADR-0007 D-0007-2）
- RAG化前に sources/ 内容を加工・要約する
- 証跡なしでRAG全再生成する

#### 証跡保存先

- `evidence/rag_updates/initial_YYYYMMDD.md` : 初回作成ログ
- `evidence/rag_updates/initial_eval_YYYYMMDD.md` : 評価結果
- `evidence/rag_updates/initial_rollback_YYYYMMDD.md` : ロールバック手順

### 例外1: 検証が通らない
- 最大3ループで解決できない場合、HumanGateへエスカレーションする（Part09）。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 誤更新が疑われる
- 直前の変更を取り消し、影響範囲を再確認して再検証する。

### 例外4: 汚染の疑いがある
- 参照根拠を照合し、根拠不明な更新を除外して再検証する。

### 例外5: 差分が過大
- 更新を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-1601: 運用ループの記録
**判定条件**:
1. 発見・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1～3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-1602: Part00 Verify要件との整合
**判定条件**:
1. V-0001～V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-1601: 変更記録
**内容**: 発見内容、修正理由、参照根拠、変更概要  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-1602: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-1603: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

### E-1604: RAG更新ログ
**内容**: 更新対象、差分サマリ、インデックス/埋め込み更新ログ、検索テスト結果  
**保存先**: evidence/rag_updates/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] PASS証跡のみを採用している
- [ ] 参照パスが更新されている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている

## 11. 未決事項（推測禁止）
- 参照根拠の記録粒度（最小単位の定義）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法（真実順序）
- [Part02](./Part02.md) : 用語・表記
- [Part09](./Part09.md) : HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ（発見→記録→修正→検証→監査）
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part17.md
-----
# Part 17：運用OS接続（Verify→Evidence→Releaseを運用ボタン体系に接続・自動化）

## 0. このPartの位置づけ
- 目的：Verify→Evidence→Releaseの運用をボタン体系に接続し、手順漏れを防ぐ
- 依存：Part00（真実順序）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：運用ボタンの実行基準、監査証跡の整合性

## 1. 目的（Purpose）
運用OSのボタン体系に、VerifyとEvidenceの流れを統合し、  
誰が実行しても同じ順序と証跡でReleaseへ到達できる状態を作る。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- VerifyとEvidenceの実行・記録フロー
- Release前の運用ボタンの実行順序

### Out of Scope（対象外）
- sources/ の更新
- 組織固有の承認フロー詳細

## 3. 前提（Assumptions）
1. 真実順序は Part00 に従う
2. Verifyの定義は Part10 に従う
3. Evidenceの形式と保存先は Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **運用OS**: 運用ボタンで手順を実行する仕組み
- **運用ボタン**: Verify/Evidence/Releaseの実行単位
- **Release Gate**: Evidenceが揃って初めて通過できる条件

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-1701: 運用ループの順守【MUST】
発見 → 記録 → 修正 → 検証 → 監査の順序を省略しない。

### R-1702: Evidence先行【MUST】
Release前にPASS証跡を確定し、Evidenceに保存する。

### R-1703: ボタンの順序固定【MUST】
Verify → Evidence → Release の順序を変更しない。

### R-1704: 最小差分【SHOULD】
運用手順の変更は最小差分で実施する。

### R-1705: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-1706: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-1707: 証跡4点の最小セット【MUST】
link/parts/forbidden/sources の4点を最小セットとして保存する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：対象の不整合や運用課題を特定し、影響範囲を確認する。
2. 記録：発見内容、根拠、対象ボタン、保存先を記録する。
3. 修正：最小差分で手順を更新し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：実行ログ、証跡一覧、DoDを点検し、順序違反がないか確認する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 最大3ループで解決できない場合、HumanGateへエスカレーションする。

### 例外2: ボタンが利用不可
- 手動実行に切り替え、理由と結果を記録する。

### 例外3: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-1701: Release Gateの成立
**判定条件**:
1. PASS証跡が evidence/verify_reports/ に存在する
2. Verify→Evidence→Releaseの実行ログがある
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 証跡不足、順序違反、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-1702: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-1701: 実行ログ
**内容**: 実行ボタン名、実行時刻、担当者  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-1702: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-1703: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見→記録→修正→検証→監査の順序で実施した
- [ ] PASS証跡が evidence/verify_reports/ に揃っている
- [ ] Verify→Evidence→Releaseの順序が守られている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている

## 11. 未決事項（推測禁止）
- 運用ボタンの命名規則と粒度

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法（真実順序）
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence管理
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [Part16](./Part16.md) : KB/RAG運用
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part18.md
-----
# Part 18：Operation Registry／司令塔UI（“押すボタン”体系・Busy/NextStep・状態遷移）

## 0. このPartの位置づけ
- 目的：Operation Registry（司令塔UI）の運用を固定し、状態遷移と次アクションを迷いなく実行できるようにする
- 依存：Part00（SSOT憲法）、Part04（作業管理）、Part06（IDE/司令塔運用）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：作業の状態遷移、次アクションの指示、監査用の記録整合

## 1. 目的（Purpose）
Operation Registry（司令塔UI）の表示と更新手順を標準化し、  
Busy/NextStep と状態遷移を運用ループに沿って固定する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- Operation Registry の更新と参照
- Busy/NextStep の記録と表示
- 状態遷移（READY/DOING/VERIFYING/REPAIRING/DONE/BLOCKED）
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- UI実装の詳細（別Part）
- 組織固有の画面デザイン方針

## 3. 前提（Assumptions）
1. 司令塔UIは作業の指示と確認の場である
2. VIBEKANBANの状態遷移は Part04 に従う
3. Permission Tierは Part09 に従う
4. Verify/Evidenceは Part00/Part10/Part12 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Operation Registry**: 司令塔UIの操作一覧・現在状態・次アクションの記録
- **Busy**: 実行中タスクの要約
- **NextStep**: 次に行うべき最短手順
- **状態遷移**: READY/DOING/VERIFYING/REPAIRING/DONE/BLOCKED の移行

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-1801: 状態遷移の順守【MUST】
状態遷移は Part04 の定義に従い、飛ばしや戻しを行わない。

### R-1802: Busy/NextStepの明示【MUST】
現在の作業状況（Busy）と次アクション（NextStep）を必ず記録する。

### R-1803: 運用ループの順守【MUST】
Operation Registryの更新は「発見 → 記録 → 修正 → 検証 → 監査」で実施する。

### R-1804: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-1805: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-1806: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

### R-1816: Gemini MCP Scope【MUST】
**根拠**: [F-0072](../docs/FACTS_LEDGER.md#F-0072)
Gemini CLIのMCP設定は、個人実験用 (`user`) とプロジェクト共有用 (`project`) のスコープを明確に分離し、共有設定には機密情報を含めない。


## 6. 手順（実行可能な粒度、番号付き）
1. 発見：Operation Registryの不足・不整合・状態遷移の誤りを特定する。
2. 記録：発見内容、参照根拠、対象ファイル、保存先を記録する。
3. 修正：最小差分で更新し、Busy/NextStep を明示する。sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、状態遷移の整合を確認する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 手順2: AI/ツール割当マトリクス（工程別最適AI選択）

### R-1807: 完全版AI割当マトリクス【MUST】

以下の工程別AI割当を標準とする（根拠: [ADR-0005](../decisions/0005-vibekanban-ai-orchestration.md)）。

| 工程 | 主AI | 副AI/補完 | 入力 | 出力 | チェック | 証跡 | フォールバック | Permission Tier |
|------|------|----------|------|------|---------|------|---------------|----------------|
| **Research** | Gemini Deep Research | Z.ai (MCP経由) | SSOT/FACTS/ADR | research_inbox/ | Claude+ | evidence/research/ | 人間による文献確認 | ReadOnly |
| **Hard Design & Review** | Claude+ (Sonnet/Opus) | GPT(Projects) | Research成果/FACTS | ADR/docs/ | Gemini CLI | evidence/design/ | 人間レビュー | PatchOnly |
| **Implementation Bulk** | Gemini CLI / Codex | Claude+ | ADR/仕様 | 実装コード | Verify Gate | evidence/impl/ | Claude+で再実装 | ExecLimited |
| **Audit/整合性監査** | GPT(Projects) | Claude+ | docs/全体 | 監査レポート | 人間 | evidence/audit/ | Claude+で再監査 | ReadOnly |
| **Verify/Evidence** | Verify Gate(自動) | - | 変更差分 | PASS/FAIL | - | evidence/verify_reports/ | 手動検証 | ExecLimited |

#### MCP vs RAG の使い分け（根拠: [ADR-0007](../decisions/0007-mcp-rag-boundary.md)）

| 観点 | MCP（推奨） | RAG（推奨） |
|------|-----------|-----------|
| **データ種別** | 構造化データ（JSON/YAML/コード） | 非構造化データ（Markdown/PDF/長文） |
| **更新頻度** | 高頻度（リアルタイム） | 低頻度（日次～週次更新） |
| **参照パターン** | ピンポイント取得（特定ファイル） | あいまい検索（キーワード/意図） |
| **データ所在** | ローカルファイルシステム | インデックス化済みKB |
| **鮮度要件** | 最新必須 | 多少の遅延OK |

**判断フロー**:
1. 「特定ファイルパスがわかっている」→ **MCP Read-only**
2. 「キーワードで探したい」→ **RAG検索**
3. 「sources/を参照したい」→ **MCPでRead-only** （RAG化禁止）
4. 「docs/を検索したい」→ **RAG検索** （更新済み前提）

### 手順3: VIBEKANBAN並列運用標準（1タスク=1worktree=1Verify=1Evidence）

### R-1808: 並列運用の安全基準【MUST】

根拠: [ADR-0005](../decisions/0005-vibekanban-ai-orchestration.md) D-0005-3, [F-0070](../docs/FACTS_LEDGER.md#F-0070)

- **S タスク並列2まで**: 別worktree、証跡は独立保存
- **M タスク並列1まで**: 単独実行、worktree確保
- **L タスク並列0**: 他タスク停止、単独集中

### R-1809: 1タスク=1物理隔離の原則【MUST】

根拠: [ADR-0005](../decisions/0005-vibekanban-ai-orchestration.md) D-0005-1

- 1 TICKET = 1 worktree = 1 branch = 1 Verify = 1 Evidence Pack
- worktree命名: `worktree_TICKET-{ID}`
- branch命名: `task/TICKET-{ID}`
- 証跡保存先: `evidence/tasks/TICKET-{ID}/`

### R-1810: 失敗時フォールバック【MUST】

根拠: [ADR-0005](../decisions/0005-vibekanban-ai-orchestration.md) D-0005-4

1. **主AI失敗時**: フォールバック列のAIで再実行
2. **副AI失敗時**: 人間介入（HumanGate）
3. **Verify FAIL 3回**: 即座にHumanGate（Part09）

### 手順4: Antigravity安全柵（司令塔の権限境界）

### R-1811: Antigravityの役割限定【MUST】

根拠: [ADR-0006](../decisions/0006-antigravity-safety-rails.md) D-0006-1, [F-0073](../docs/FACTS_LEDGER.md#F-0073)

Antigravity（IDE/司令塔）は以下の役割に限定する：

1. **司令塔**: TICKET作成、AI割当指示、進捗確認
2. **レビュー**: diff確認、Evidence確認、DoD確認
3. **確認**: Verify結果、状態遷移、証跡整合性

**禁止**: 直接のファイル編集・削除・一括置換・git操作（commit/push以外）

### R-1812: 削除系操作の安全柵【MUST】

根拠: [ADR-0006](../decisions/0006-antigravity-safety-rails.md) D-0006-2

以下の削除系操作は **HumanGate必須**：

- `rm -r`, `rm (recursive+force)` （ファイル・ディレクトリ削除）
- `git clean -fdx` （未追跡ファイル削除）
- sources/ 内の任意の変更・削除
- decisions/ 内のADR削除
- evidence/ 内の証跡削除
- worktree削除（`git worktree remove`）

**例外**:
- 一時ファイル削除（`*.tmp`, `*.log`）はPatchOnly Tierで可
- 削除前にDry-run表示必須（影響範囲確認）

### R-1813: 作業ディレクトリ固定【MUST】

根拠: [ADR-0006](../decisions/0006-antigravity-safety-rails.md) D-0006-3

AIエージェント実行時は以下のディレクトリ固定を強制：

- **worktree内限定**: `worktree_TICKET-{ID}/` 配下のみ操作可
- **読み取り専用**: `docs/`, `sources/`, `decisions/`, `glossary/` （変更不可）
- **書き込み可**: `evidence/tasks/TICKET-{ID}/` （証跡保存専用）

**検証**: Fast Verifyで `sources/` 無改変確認（V-0004）

### R-1814: Permission Tier強制【MUST】

根拠: [ADR-0006](../decisions/0006-antigravity-safety-rails.md) D-0006-4

Antigravity経由のAI実行は以下のTier制限を強制：

| 操作種別 | 必要Tier | 確認方法 |
|---------|---------|---------|
| ファイル読み取り | ReadOnly | なし |
| docs/編集（最小差分） | PatchOnly | Dry-run表示 |
| Verify実行 | ExecLimited | 実行前確認 |
| 削除・sources改変・ADR追加 | HumanGate | 明示的承認 |

### R-1815: 緊急停止（Emergency Stop）【MUST】

根拠: [ADR-0006](../decisions/0006-antigravity-safety-rails.md) D-0006-5

以下の検出時は **即座に操作停止**：

- sources/ への改変検出（V-0004 FAIL）
- Permission Tier超過の実行試行
- worktree外への書き込み試行
- 禁止コマンド検出（V-0003 FAIL）

**復旧**:
1. 操作ログをevidence/emergency/に保存
2. HumanGateで原因確認
3. Rollback実行

### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 状態遷移が破綻
- 直前の変更を取り消し、状態遷移の根拠を再確認して再検証する。

### 例外4: 差分が過大
- 変更を分割し、最小差分になるまで手順をやり直す。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-1801: Operation Registry更新の記録
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1～3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-1802: Part00 Verify要件との整合
**判定条件**:
1. V-0001～V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-1801: Operation Registry記録
**内容**: Busy/NextStep、状態遷移、参照根拠、変更概要  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-1802: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-1803: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] Busy/NextStep と状態遷移が記録されている


## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part04](./Part04.md) : 作業管理（状態遷移）
- [Part06](./Part06.md) : IDE/司令塔運用
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part19.md
-----
# Part 19：Incident/監査/改善サイクル（Stop-the-line・再発防止・ルール改訂SOP）

## 0. このPartの位置づけ
- 目的：Incident/監査/改善サイクルを固定し、再発防止とルール改訂を安全に回す
- 依存：Part00（SSOT憲法）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：運用停止判断、改善ループ、監査証跡の整合

## 1. 目的（Purpose）
Incident発生時のStop-the-line、監査、改善、ルール改訂を標準化し、  
再発防止とSSOT整合を維持する。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- Incident対応（Stop-the-line）
- 監査の実施と証跡保存
- 改善策の立案とルール改訂
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- 実装コードの詳細手順（別Part）
- 組織固有の人事評価・懲戒規定

## 3. 前提（Assumptions）
1. SSOTは docs/ に固定される
2. Permission Tierは Part09 に従う
3. Verify/Evidenceは Part00/Part10/Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **Incident**: 事故・重大不整合・運用停止が必要な事象
- **Stop-the-line**: 作業停止と原因究明の優先宣言
- **監査**: 証跡の確認と遵守状況の検証
- **改善サイクル**: 再発防止の手順（記録→修正→検証→監査）

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-1901: Stop-the-lineの発動【MUST】
重大な不整合や汚染疑いが出た場合は作業を停止し、原因究明を優先する。

### R-1902: Incident記録の保存【MUST】
Incidentの内容・影響範囲・対応履歴をEvidenceに保存する。

### R-1903: ルール改訂はADR先行【MUST】
再発防止のためのルール改訂はADRを先行し、Part14に従う。

### R-1904: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-1905: Fast PASS 必須【MUST】
Fast検証でPASSした証跡のみを採用する。

### R-1906: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：Incidentの兆候・影響範囲・参照根拠を確認する。
2. 記録：Incident内容、根拠、対象ファイル、保存先を記録する。
3. 修正：最小差分で対策を反映し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：対応概要・参照パス・証跡一覧・DoDを点検し、再発防止策を確認する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: Incidentの影響が広範
- 変更を分割し、対象範囲を切り分けて再検証する。

### 例外4: 再発が継続
- ADRでルール改訂を提案し、承認後に再対応する。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-1901: Incident対応の記録
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-1902: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-1901: Incident記録
**内容**: 影響範囲、対応内容、参照根拠、再発防止策  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-1902: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-1903: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] Incident対応と再発防止策が記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part02](./Part02.md) : 用語・表記
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part20.md
-----
# Part 20：導入・教育・チェックリスト集（新規開始テンプレ・FAQ・最短運用手順）

## 0. このPartの位置づけ
- 目的：導入・教育・最短運用手順を固定し、新規参加者が迷わずSSOT運用できるようにする
- 依存：Part00（SSOT憲法）、Part01（DoD）、Part09（Permission Tier）、Part10（Verify Gate）、Part12（Evidence）、Part14（変更管理）、Part15（運用ループ）
- 影響：オンボーディング、運用開始手順、監査と証跡の整合

## 1. 目的（Purpose）
新規参加者向けに最短運用手順とチェックリストを提供し、  
Verify/Evidenceの運用が一貫するようにする。

## 2. 適用範囲（Scope / Out of Scope）
### Scope（対象）
- 新規参加者のオンボーディング
- 最短運用手順（初回セットアップと検証）
- FAQとチェックリストの提示
- Verify/Evidenceの保存と監査対応

### Out of Scope（対象外）
- sources/ への更新
- 組織固有の研修プログラム
- 実装コードの詳細手順（別Part）

## 3. 前提（Assumptions）
1. SSOTは docs/ に固定される
2. Permission Tierは Part09 に従う
3. Verify/Evidenceは Part00/Part10/Part12 に従う
4. 変更管理は Part14 に従う
5. 運用ループは Part15 に従う

## 4. 用語（Glossary参照：Part02）
- **オンボーディング**: 新規参加者の導入・教育プロセス
- **最短運用手順**: 最小ステップでSSOT運用を開始する手順
- **FAQ**: よくある質問と回答

## 5. ルール（MUST / MUST NOT / SHOULD）
### R-2001: 最短運用手順の遵守【MUST】
新規参加者は最短運用手順に従い、手順を省略しない。

### R-2002: Evidence保存の徹底【MUST】
Fast検証のPASS証跡を保存し、証跡4点を揃える。

### R-2003: sources/ 無改変【MUST NOT】
sources/ の改変は禁止（追加のみ許可）。検出時は作業を停止する。

### R-2004: 最小差分【SHOULD】
無関係な整理は含めず、最小差分で更新する。

## 6. 手順（実行可能な粒度、番号付き）
1. 発見：必要な参照Partと運用ルールを確認する。
2. 記録：参照根拠、対象ファイル、保存先を記録する。
3. 修正：最小差分で初期手順を整備し、sources/ 無改変を維持する。
4. 検証：Fast検証でPASSを確認し、証跡4点（link/parts/forbidden/sources）を保存する。
5. 監査：変更概要・参照パス・証跡一覧・DoDを点検し、導入手順の妥当性を確認する。

## 7. 例外処理（失敗分岐・復旧・エスカレーション）
### 例外1: 検証が通らない
- 修正に戻して再検証し、最大3ループで解決できない場合はHumanGateへエスカレーションする。

### 例外2: 証跡が欠落
- 検証を再実行して補完し、理由を記録する。

### 例外3: 手順が過大
- 手順を分割し、最短運用手順として再構成する。

### 例外4: 再発が継続
- ADRで手順改訂を提案し、承認後に再対応する。

## 8. 機械判定（Verify観点：判定条件・合否・ログ）
### V-2001: 導入手順の記録
**判定条件**:
1. 発見・記録・修正・検証・監査の記録がある
2. PASS証跡のみ採用されている
3. 証跡4点（link/parts/forbidden/sources）が揃っている

**合否**:
- **PASS**: 1〜3を満たす
- **FAIL**: 記録欠落、FAIL証跡の混在、証跡4点の欠落

**ログ**: evidence/verify_reports/

### V-2002: Part00 Verify要件との整合
**判定条件**:
1. V-0001〜V-0004のログが存在する
2. sources/ の改変がない

**合否**:
- **PASS**: 1,2を満たす
- **FAIL**: ログ欠落、または sources/ 改変がある

**ログ**: evidence/verify_reports/

## 9. 監査観点（Evidenceに残すもの・参照パス）
### E-2001: 導入手順の記録
**内容**: 最短運用手順、参照根拠、変更概要  
**保存先**: evidence/ または decisions/（Part12/Part14に従う）

### E-2002: Verify証跡（PASSのみ）
**内容**: Fast検証のPASSログ  
**保存先**: evidence/verify_reports/

### E-2003: 証跡4点（最小セット）
**内容**: link_check / parts_check / forbidden_check / sources_integrity  
**保存先**: evidence/verify_reports/

## 10. チェックリスト
- [ ] 発見・記録・修正・検証・監査の順序が揃っている
- [ ] 証跡4点（link/parts/forbidden/sources）が揃っている
- [ ] 最小差分であり、sources/ 無改変である
- [ ] Fast検証がPASSしている
- [ ] 導入手順と参照根拠が記録されている

## 11. 未決事項（推測禁止）
- 未決事項なし（現時点）

## 12. 参照（パス）
- docs/
- sources/
- evidence/
- decisions/
### docs/
- [Part00](./Part00.md) : SSOT憲法
- [Part01](./Part01.md) : 目標・DoD
- [Part02](./Part02.md) : 用語・表記
- [Part09](./Part09.md) : Permission Tier / HumanGate
- [Part10](./Part10.md) : Verify Gate
- [Part12](./Part12.md) : Evidence運用
- [Part14](./Part14.md) : 変更管理
- [Part15](./Part15.md) : 運用ループ
- [00_INDEX](./00_INDEX.md) : 全体索引
- [FACTS_LEDGER](./FACTS_LEDGER.md) : 事実台帳




FILE: docs\Part21.md
-----
# Part 21：工程別AI割当設計（Spec/Research/Design/Build/Fix/Verify/Release/Operate）

## 0. このPartの位置づけ
- **目的**: 各工程（Spec/Research/Design/Build/Fix/Verify/Release/Operate）でのAI割当を固定し、迷いを排除する
- **依存**: [Part03](Part03.md)（Core4）、[Part05](Part05.md)（Core4運用）、[Part09](Part09.md)（Permission Tier）
- **影響**: 全作業工程のAI選択・フォールバック順・成果物フォーマット

---

## 1. 目的（Purpose）

本 Part21 は **工程別AI割当の標準化** を通じて、以下を保証する：

1. **迷いゼロ**: 各工程で「どのAIを使うか」が一意に決まる
2. **精度保証**: 高精度が必要な工程は高精度モデル、軽量で良い工程は軽量モデルを固定
3. **制限耐性**: メインモデルが使えない場合のフォールバック順を明確化
4. **成果物固定**: 各工程で期待される成果物フォーマットを統一

**根拠**: 最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md）「3. 工程別AI割当（最高精度×制限耐性の"固定編成"）」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- 全7工程（Spec/Research/Design/Build/Fix/Verify/Release/Operate）のAI割当
- 主担当/副担当/軽量/フォールバックの役割定義
- 各工程の成果物フォーマット

### Out of Scope（適用外）
- 個別AIのプロンプト設計（別途定義）
- 新しいAIモデルの評価・選定（Part25で扱う）

---

## 3. 前提（Assumptions）

1. **Core4は役割固定**である（Part03, Part05）
2. **高精度モデルは「Spec/Design/Review」**に使う
3. **実装は「火力枠（Aider/Codex）」に集中**させる
4. **フォールバックは固定順**である（詰み回避）
5. **成果物は機械判定可能**である

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **Core4**: [glossary/GLOSSARY.md#Core4](../glossary/GLOSSARY.md)（4つの課金AI）
- **主担当（高精度）**: その工程で最も使うAI（Claude Opus, Gemini 3 Pro等）
- **副担当（クロスチェック）**: 主担当の結果を検証するAI
- **軽量（節約）**: コストを抑えるためのAI（Gemini Flash, GLM等）
- **フォールバック**: メインモデルが使えない場合の代替AI
- **工程**: Spec/Research/Design/Build/Fix/Verify/Release/Operate

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2101: 工程別AI割当の固定【MUST】

各工程は以下のAI割当に従う：

#### A) Spec（要件/仕様固め）
- **主担当（高精度）**: Claude（Opus優先）
- **副担当（監査/抜け漏れ）**: Gemini 3 Pro
- **軽量（節約・整形）**: Gemini Flash / Z.ai GLM
- **フォールバック（制限時）**: ローカル（Ollama/LM Studio）＋軽量LLM
- **成果物（固定フォーマット）**: PRD / Glossary / AC（受入基準）/ Not-in-scope / 失敗モード

#### B) Research（調査/比較/一次情報回収）
- **主担当（探索・リンク回収）**: Gemini 3 Pro（必要ならDeep Research系）
- **副担当（構造化・矛盾検出）**: Claude（Sonnet優先）
- **軽量（候補列挙）**: Z.ai GLM / Gemini Flash
- **フォールバック**: OpenRouter経由の低コスト/無料枠モデル、またはローカル
- **成果物**: 調査レポート / 選定候補リスト / 比較表 / 参照リンク

#### C) Hard Design（アーキ/境界/例外/非機能）
- **主担当（設計骨格）**: Claude（Opus→Sonnet）
- **副担当（実装可能性・疑似コード）**: Codex（GPT-5.2）
- **軽量（チェックリスト化）**: Gemini Flash / GLM
- **フォールバック**: Gemini 3 Pro（長文設計が詰まった時の代替）
- **成果物**: ADR / API契約 / 状態遷移 / 失敗モード一覧 / テスト計画 / DoD

#### D) Build（実装）
用途で分ける：

**D-1: 大規模改造（火力枠）**
- **主担当**: Aider（CLI）＋ Codex
- **副担当（別解・バグ潰し）**: Claude Sonnet
- **軽量（小修正）**: Gemini Flash / GLM

**D-2: IDE自動化（反復作業/周辺作業の自動化）**
- **主担当**: VS Code + Cline（HITLエージェント）
- **機能**: 「ファイル変更とコマンド実行を"承認つき"で自動化」する前線
- **用途**:
  - 反復作業の自動化（リファクタリング、一括変更）
  - 周辺作業の自動化（テスト生成、ドキュメント更新）
  - 承認フロー（人間が `Approve/Reject` を選択）
- **副担当**: Codex / Claude
- **設定方法**:
  1. VS Code拡張機能 `Cline` をインストール
  2. APIキー設定（Anthropic API for Claude）
  3. プロンプト規約・作業手順を統一（Part26 Part25 Continue参照）

**D-3: "統一の運転方法"**
- **Continue**で、共通ルール（プロンプト規約/作業手順/コンテキスト投入/ログ）を統一

- **成果物**: 実装コード / テストコード / diff / manifest

#### E) Fix（レビュー/修正/セキュリティ）
- **主担当（論理レビュー）**: Claude Sonnet
- **副担当（実装観点レビュー）**: Codex
- **自動検知（必須級）**: Gitleaks / Trivy / Lint / Typecheck / Unit tests
- **成果物**: レビューレポート / 修正パッチ / Verifyレポート

#### F) Verify（回帰/品質ゲート）
- **主役はモデルではなく"テスト"**
- **promptfoo**をCIに入れ、主要プロンプト/主要エージェントの出力が基準を満たすか、リグレッション（劣化）が起きていないかを機械で保証
- **成果物**: テスト結果 / カバレッジ / 回帰レポート

#### G) Release / Operate（運用・改善）
- **Langfuse**: トレース/評価/失敗分析/改善ループ
- **LiteLLM**: 予算・制限耐性・ルーティング
- **成果物**: リリースノート / SBOM / 運用ダッシュボード / メトリクス

**根拠**: rev.md「3. 工程別AI割当」
**違反例**: 軽量モデルでSpecを書く → 精度不足のため、禁止。

---

### R-2102: フォールバックの型（固定テンプレ）【MUST】

工程別に「詰み回避」順を固定する：

#### Spec/Design（長文・整合性）
Claude Opus → Claude Sonnet → Gemini 3 Pro →（節約）Flash/GLM →（最終）ローカル

#### Build（差分生成・改修）
Codex（GPT-5.2）→ Claude Sonnet → Gemini 3 Pro →（節約）Flash/GLM →（最終）ローカル

#### 雑務（整形・命名・表）
Flash/GLM →（必要時）Sonnet/Pro

**根拠**: rev.md「10. 付録：フォールバックの"型"（固定テンプレ）」

---

### R-2103: 成果物フォーマットの固定【MUST】

各工程の成果物は以下のフォーマットに従う：

#### Spec成果物
```markdown
## PRD（Product Requirements Document）
### 目的
### 非機能要件
### 用語（Glossary参照）
### 受入基準（AC）
### Not-in-scope
### 失敗モード
```

#### Research成果物
```markdown
## 調査レポート
### 調査目的
### 候補リスト
### 比較表
### 推奨順位
### 参照リンク
```

#### Design成果物
```markdown
## ADR（Architecture Decision Record）
### 背景
### 決定内容
### 選択肢（案A/案B/案C）
### 採用理由
### 影響範囲
### DoD
```

**根拠**: rev.md「3. 工程別AI割当」成果物セクション

---

### R-2104: 高精度を使う工程の固定【MUST】

- **高精度を使う工程**: Spec / Hard Design / Review（論理）
- **軽量に落としてよい工程**: 整形、候補列挙、コメント、ドキュメント体裁
- **大規模実装は"火力枠（Aider/Codex）に集中"**: 中途半端に分散するとコストも手戻りも増える

**根拠**: rev.md「7. コスト最適化（精度を落とさず、制限も超えにくくする）」

---

### R-2105: 工程間の引き継ぎ【MUST】

各工程の完了時、以下を引き継ぐ：

1. **成果物**（前工程のフォーマットに従う）
2. **Evidence**（Verify/Evidenceへの参照）
3. **未決事項**（あれば次工程で解決）
4. **DoDチェック**（完了条件を確認）

**違反例**: Spec未完了でBuild開始 → Part01 R-0104違反。

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: Spec工程の実行
1. **主担当（Claude Opus）**でPRDを作成
2. **副担当（Gemini 3 Pro）**で監査・抜け漏れチェック
3. **軽量（Flash/GLM）**で整形・フォーマット調整
4. **DoDチェック**: 受入基準が機械判定可能か確認
5. **Evidence保存**: Spec成果物を `VIBEKANBAN/100_SPEC/` に保存
6. **Verify実行**: Part10のVerify Gateで整合性確認

### 手順B: Research工程の実行
1. **主担当（Gemini 3 Pro）**で探索・リンク回収
2. **副担当（Claude Sonnet）**で構造化・矛盾検出
3. **軽量（GLM/Flash）**で候補列挙
4. **比較表作成**: 候補を評価・順位付け
5. **推奨決定**: 選定結果をADRとして保存
6. **Evidence保存**: Research成果物を `sources/research_inbox/` に保存

### 手順C: Build工程の実行
1. **大規模改造**: Aider（CLI）＋ Codexで実装
2. **IDE自動化**: VS Code + Clineで承認つき自動化
3. **Verify実行**: テスト・lint・型チェック
4. **Review**: Claude Sonnetで論理レビュー、Codexで実装レビュー
5. **VRループ**: 失敗なら修正→再検証
6. **Evidence保存**: diff・manifest・sha256を保存

### 手順D: Fix工程の実行
1. **自動検知**: Gitleaks / Trivy / Lint / Typecheck / Unit tests
2. **論理レビュー**: Claude Sonnet
3. **実装レビュー**: Codex
4. **修正**: 最小差分で修正
5. **再検証**: VerifyでGreenを確認
6. **Evidence保存**: 修正パッチ・Verifyレポートを保存

### 手順E: フォールバックの実行
1. メインモデルがレート制限・障害・上限到達で使えない場合
2. **フォールバック順**（R-2102）に従って代替AIに切り替え
3. **Evidenceに「フォールバック実施」を記録**
4. 元のモデルが復帰したら、元に戻す

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: メインモデルが全く使えない
**対処**:
1. フォールバック順に従って代替AIに切り替え
2. ローカルLLM（Ollama/LM Studio）が最後の砦
3. Evidenceに「フォールバック実施・理由・期間」を記録

**エスカレーション**: 長期フォールバックが予想される場合、ADRで暫定運用を決定。

---

### 例外2: 工程間の成果物が不整合
**対処**:
1. 前工程の成果物を確認
2. 不整合箇所を特定
3. 前工程へ戻り、修正
4. 再度引き継ぎ

**エスカレーション**: 不整合が頻発する場合、成果物フォーマット（R-2103）の見直し。

---

### 例外3: 高精度モデルが予算オーバー
**対処**:
1. LiteLLM（Part22）で自動フォールバック
2. 緊急の場合、手動で軽量モデルに切り替え
3. Evidenceに「予算オーバー・切り替え理由」を記録

**エスカレーション**: 予算オーバーが常態化する場合、Part22で予算設定の見直し。

---

### 例外4: 成果物フォーマットが遵守されていない
**対処**:
1. フォーマット違反箇所を特定
2. 正しいフォーマットに修正
3. Verifyでフォーマットチェックを実施
4. Evidenceに「フォーマット修正」を記録

**エスカレーション**: 違反が頻発する場合、R-2103の見直し。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2101: 工程別AI割当の遵守確認
**判定条件**: Evidenceに各工程のAI割当が記録され、R-2101に従っているか
**合否**: 違反があれば Fail
**実行方法**: `evidence/` の作業ログをスキャン
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_ai_assignment.md`

---

### V-2102: 成果物フォーマットの確認
**判定条件**: 各工程の成果物がR-2103のフォーマットに従っているか
**合否**: フォーマット違反があれば Fail
**実行方法**: `checks/verify_artifact_format.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_artifact_format.md`

---

### V-2103: フォールバック記録の確認
**判定条件**: フォールバック実施時にEvidenceに記録があるか
**合否**: 記録なしなら警告（Fail ではない）
**実行方法**: `evidence/` のフォールバック記録を確認
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_fallback_check.md`

---

### V-2104: 工程間引き継ぎの確認
**判定条件**: 工程間で成果物・Evidence・未決事項・DoDが引き継がれているか
**合否**: 引き継ぎ漏れがあれば Fail
**実行方法**: `evidence/` の引き継ぎ記録を確認
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_handover_check.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2101: 各工程のAI割当記録
**保存内容**:
- 工程名
- 主担当/副担当/軽量/フォールバックのAI
- 使用理由
- 成果物パス

**参照パス**: `evidence/ai_assignment/YYYYMMDD_HHMMSS_<process>.md`
**保存場所**: `evidence/ai_assignment/`

---

### E-2102: 成果物
**保存内容**:
- Spec: PRD / Glossary / AC / Not-in-scope / 失敗モード
- Research: 調査レポート / 選定候補リスト / 比較表 / 参照リンク
- Design: ADR / API契約 / 状態遷移 / 失敗モード一覧 / テスト計画 / DoD
- Build: 実装コード / テストコード / diff / manifest
- Fix: レビューレポート / 修正パッチ / Verifyレポート
- Verify: テスト結果 / カバレッジ / 回帰レポート
- Release/Operate: リリースノート / SBOM / 運用ダッシュボード / メトリクス

**参照パス**: `VIBEKANBAN/` 各レーン / `evidence/artifacts/`
**保存場所**: `VIBEKANBAN/`, `evidence/artifacts/`

---

### E-2103: フォールバック記録
**保存内容**:
- フォールバック実施日時
- 元のAI・代替AI
- フォールバック理由（レート制限/障害/予算オーバー）
- 期間

**参照パス**: `evidence/fallback/YYYYMMDD_HHMMSS_fallback.md`
**保存場所**: `evidence/fallback/`

---

### E-2104: 工程間引き継ぎ記録
**保存内容**:
- 前工程・次工程
- 引き継ぎ成果物
- 未決事項
- DoDチェック結果

**参照パス**: `evidence/handover/YYYYMMDD_HHMMSS_handover_<from>_<to>.md`
**保存場所**: `evidence/handover/`

---

## 10. チェックリスト

- [x] 本Part21 が全12セクション（0〜12）を満たしているか
- [x] 工程別AI割当（R-2101）が明記されているか
- [x] フォールバックの型（R-2102）が明記されているか
- [x] 成果物フォーマット（R-2103）が明記されているか
- [x] 高精度を使う工程の固定（R-2104）が明記されているか
- [x] 工程間の引き継ぎ（R-2105）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-2101〜V-2104）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2101〜E-2104）が参照パス付きで記述されているか
- [ ] 本Part21 を読んだ人が「どの工程でどのAIを使うか」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2101: 新しいAIモデルの追加手順
**問題**: GPT-6や新しいモデルが登場した場合、どのように工程割当に追加するか不明。
**影響Part**: Part21（本Part）、Part25（統合ツール構成）
**暫定対応**: Part25で評価→ADRで決定→Part21を更新。

---

### U-2102: ローカルLLMの具体的なモデル選定
**問題**: フォールバック先のローカルLLM（Ollama/LM Studio）でどのモデルを使うか不明。
**影響Part**: Part21（本Part）、Part25（統合ツール構成）
**暫定対応**: 環境依存としてPart25で明記。

---

### U-2103: 工程の追加・分割の基準
**問題**: 新しい工程（例：Security Review）を追加する場合の基準が不明。
**影響Part**: Part21（本Part）
**暫定対応**: ADRで決定→Part21を更新。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part01.md](Part01.md) : 目標・DoD
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part05.md](Part05.md) : Core4運用
- [docs/Part09.md](Part09.md) : Permission Tier
- [docs/Part10.md](Part10.md) : Verify Gate
- [docs/Part22.md](Part22.md) : 制限耐性設計
- [docs/Part23.md](Part23.md) : 回帰防止設計
- [docs/Part24.md](Part24.md) : 可観測性設計
- [docs/Part25.md](Part25.md) : 統合ツール構成

### sources/
- _imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md : 原文（「3. 工程別AI割当」「10. 付録：フォールバックの"型"」）
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_ai_assignment.ps1` : 工程別AI割当確認（未作成）
- `checks/verify_artifact_format.ps1` : 成果物フォーマット確認（未作成）

### evidence/
- `evidence/ai_assignment/` : 各工程のAI割当記録
- `evidence/artifacts/` : 各工程の成果物
- `evidence/fallback/` : フォールバック記録
- `evidence/handover/` : 工程間引き継ぎ記録

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part22.md
-----
# Part 22：制限耐性設計（LiteLLMによる予算・レート・フォールバックの自動化）

## 0. このPartの位置づけ
- **目的**: 予算・レート制限・障害が発生しても作業が止まらないよう、自動フォールバック・ルーティングを設計する
- **依存**: [Part03](Part03.md)（Core4）、[Part21](Part21.md)（工程別AI割当）、[Part24](Part24.md)（可観測性）
- **影響**: 全AI使用工程・予算管理・障害対応・コスト最適化

---

## 1. 目的（Purpose）

本 Part22 は **制限耐性の自動化** を通じて、以下を保証する：

1. **止まらない**: レート制限・障害・上限到達が来ても、自動で代替に迂回し作業継続
2. **予算可視**: 工程タグ別・モデル別の予算消費を追跡し、予算オーバーを防止
3. **コスト最適**: 重要工程にだけ高コストモデルを使い、重要でない工程は自動で軽量へ
4. **自動復帰**: 障害復帰後、自動で元のモデルに戻す

**根拠**: 最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md）「2.4 モデル運用の配管（制限耐性の心臓部）」「4.4 LiteLLMで"制限耐性"を自動化」「7. コスト最適化」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- LiteLLM（Gateway/Router）による予算・レート・フォールバック管理
- 用途別ルーティング（高精度枠/実装枠/節約枠）
- 予算タグ別・モデル別の予算管理
- 自動フォールバック・自動復帰

### Out of Scope（適用外）
- LiteLLM以外のGatewayツール（Azure OpenAI等）の詳細
- 個別プロバイダのAPI仕様

---

## 3. 前提（Assumptions）

1. **LiteLLMがGateway/Router**として稼働している
2. **各AIプロバイダのAPIキー**が環境変数または設定ファイルに保存されている
3. **工程タグ**（Spec/Design/Build/Review等）が付与されている
4. **予算上限**が設定されている（モデル別・工程タグ別）
5. **Part21（工程別AI割当）**のフォールバック順に従う

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **LiteLLM**: [glossary/GLOSSARY.md#LiteLLM](../glossary/GLOSSARY.md)（複数AIプロバイダを統合するGateway/Router）
- **フォールバック**: メインモデルが使えない場合の代替モデルへの自動切り替え
- **ルーティング**: 用途に応じて適切なモデルに振り分ける機能
- **工程タグ**: Spec/Design/Build/Review等の工程を識別するタグ
- **予算上限**: モデル別・工程タグ別に設定されたコスト上限
- **レート制限**: APIの呼び出し回数制限

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2201: 用途別ルーティングの固定【MUST】

LiteLLMは以下の用途別ルーティングに従う：

#### 高精度枠（Spec/Design/Review）
- **主モデル**: Claude Opus / Gemini 3 Pro
- **予算上限**: 高めに設定（例：月$50）
- **フォールバック**: Claude Sonnet → Gemini 3 Pro →（節約）Flash/GLM → ローカル

#### 実装枠（Build）
- **主モデル**: Codex（GPT-5.2）/ Claude Sonnet
- **予算上限**: 中程度（例：月$30）
- **フォールバック**: Claude Sonnet → Gemini 3 Pro → Flash/GLM → ローカル

#### 節約枠（雑務・整形・候補列挙）
- **主モデル**: Gemini Flash / GLM
- **予算上限**: 低めに設定（例：月$10）
- **フォールバック**: ローカル

**根拠**: rev.md「4.4 LiteLLMで"制限耐性"を自動化」「7. コスト最適化」
**違反例**: 雑務で高精度モデルを使う → 予算オーバーのため、禁止。

---

### R-2202: 予算管理の自動化【MUST】

LiteLLMは以下の予算管理機能を有効にする：

#### 予算タグ別管理
- **工程タグ**: Spec, Design, Build, Review, Fix, Verify, Release, Operate
- **モデル別予算**: 各モデルの月次予算上限を設定
- **アラート**: 予算の80%, 90%, 100%到達時にアラート通知

#### 自動停止
- 予算100%到達時、該当モデルの使用を自動停止
- フォールバック順に従って代替モデルに切り替え

**根拠**: rev.md「7. コスト最適化（精度を落とさず、制限も超えにくくする）」

---

### R-2203: レート制限・障害への自動フォールバック【MUST】

LiteLLMは以下の自動フォールバックを実行する：

#### レート制限検出時
1. 即座に代替モデルに切り替え（Part21 R-2102のフォールバック順）
2. Part24（Langfuse）に「レート制限発生・フォールバック実施」を記録
3. 元のモデルが復帰したら、自動で戻す

#### 障害検出時
1. 3回リトライ（指数バックオフ: 2秒, 4秒, 8秒）
2. 復帰しない場合、代替モデルに切り替え
3. Part24に「障害発生・フォールバック実施」を記録
4. 元のモデルが復帰したら、自動で戻す

**根拠**: rev.md「4.4 LiteLLMで"制限耐性"を自動化」

---

### R-2204: フォールバック順の遵守【MUST】

フォールバックは **Part21 R-2102（フォールバックの型）** に厳密に従う：

- Spec/Design: Claude Opus → Claude Sonnet → Gemini 3 Pro → Flash/GLM → ローカル
- Build: Codex → Claude Sonnet → Gemini 3 Pro → Flash/GLM → ローカル
- 雑務: Flash/GLM →（必要時）Sonnet/Pro

**違反例**: 独自のフォールバック順を設定する → 禁止。

---

### R-2205: 自動復帰の実装【SHOULD】

LiteLLMは以下の自動復帰機能を実装する：

1. **ヘルスチェック**: 元のモデルの復帰を定期確認（例: 5分おき）
2. **自動切り戻し**: 復帰確認後、次のリクエストから元のモデルを使用
3. **復帰記録**: Part24（Langfuse）に「自動復帰実施」を記録

**根拠**: rev.md「4.4 LiteLLMで"制限耐性"を自動化」

---

### R-2206: 予算オーバー時の手動フォールバック【MUST】

自動停止が発生した場合：

1. **即座に通知**: Slack/Email等で予算オーバーを通知
2. **手動判断**: HumanGateで継続か停止かを判断
3. **継続の場合**: 代替モデル（軽量またはローカル）に手動切り替え
4. **記録**: Part24に「予算オーバー・手動フォールバック実施」を記録

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: LiteLLMの初期設定
1. LiteLLMをインストール: `pip install litellm`
2. 設定ファイル作成: `litellm_config.yaml`
   - 各AIプロバイダのAPIキーを環境変数から読み込み
   - 用途別ルーティングを設定
   - 予算上限を設定
   - フォールバック順を設定
3. LiteLLM起動: `litellm --config litellm_config.yaml --port 4000`
4. ヘルスチェック: `curl http://localhost:4000/health`

### 手順B: 用途別ルーティングの設定
1. 高精度枠のルーティング設定:
   ```yaml
   router:
     - model: claude-opus
       max_budget: 50
       rpm_limit: 100
       fallback:
         - claude-sonnet
         - gemini-3-pro
         - gemini-flash
         - local/llama3
   ```
2. 実装枠のルーティング設定:
   ```yaml
   router:
     - model: gpt-5.2
       max_budget: 30
       rpm_limit: 200
       fallback:
         - claude-sonnet
         - gemini-3-pro
         - gemini-flash
         - local/llama3
   ```
3. 節約枠のルーティング設定:
   ```yaml
   router:
     - model: gemini-flash
       max_budget: 10
       rpm_limit: 1000
       fallback:
         - local/llama3
   ```

### 手順C: 予算管理の設定
1. モデル別予算上限を設定:
   ```yaml
   budget:
     claude-opus: 50
     gpt-5.2: 30
     gemini-3-pro: 20
     gemini-flash: 10
     glm: 5
   ```
2. 工程タグ別予算上限を設定:
   ```yaml
   tag_budget:
     Spec: 15
     Design: 15
     Build: 20
     Review: 10
     Fix: 5
     Verify: 5
     Release: 5
     Operate: 5
   ```
3. アラート設定（80%, 90%, 100%）:
   ```yaml
   alerts:
     - threshold: 80
       action: notify
     - threshold: 90
       action: warn
     - threshold: 100
       action: stop_and_fallback
   ```

### 手順D: フォールバックの実行
1. LiteLLMが自動でフォールバックを実行
2. Part24（Langfuse）に自動記録
3. 手動確認: ダッシュボードでフォールバック状態を確認
4. 必要に応じて手動介入（予算オーバー等）

### 手順E: 自動復帰の確認
1. LiteLLMが元のモデルの復帰を定期確認
2. 復帰確認後、自動で元のモデルに切り戻し
3. Part24（Langfuse）に「自動復帰」を記録
4. ダッシュボードで復帰状態を確認

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: 全モデルが使えない
**対処**:
1. ローカルLLM（Ollama/LM Studio）が最後の砦
2. Evidenceに「全モデルダウン・ローカルLLM使用」を記録
3. HumanGateで状況を共有

**エスカレーション**: 長期ダウンが予想される場合、ADRで暫定運用を決定。

---

### 例外2: 予算設定ミスによる予算オーバー
**対処**:
1. 即座に該当モデルを停止
2. 予算設定を修正
3. ADRで「予算設定ミス・修正内容」を記録
4. 再発防止策を検討

**エスカレーション**: 頻発する場合、予算設定プロセスの見直し。

---

### 例外3: フォールバックが失敗
**対処**:
1. フォールバック順を確認（Part21 R-2102）
2. 代替モデルのAPIキー・設定を確認
3. 手動でフォールバック実行
4. Evidenceに「フォールバック失敗・手動実施」を記録

**エスカレーション**: 頻発する場合、フォールバック順の見直し。

---

### 例外4: 自動復帰が失敗
**対処**:
1. 元のモデルのヘルスチェックを手動実行
2. 復帰している場合、手動で切り戻し
3. 復帰していない場合、代替モデルを継続使用
4. Evidenceに「自動復帰失敗・手動実施」を記録

**エスカレーション**: 頻発する場合、自動復帰ロジックの見直し。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2201: LiteLLM設定の整合性確認
**判定条件**: litellm_config.yaml がPart22のルールに従っているか
**合否**: 設定違反があれば Fail
**実行方法**: `checks/verify_litellm_config.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_litellm_config.md`

---

### V-2202: 予算管理の有効化確認
**判定条件**: 予算上限・アラート・自動停止が有効になっているか
**合否**: 有効でなければ Fail
**実行方法**: `checks/verify_budget.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_budget_check.md`

---

### V-2203: フォールバック順の遵守確認
**判定条件**: フォールバック順がPart21 R-2102に従っているか
**合否**: 違反があれば Fail
**実行方法**: `checks/verify_fallback_order.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_fallback_order.md`

---

### V-2204: 自動復帰の有効化確認
**判定条件**: 自動復帰機能が有効になっているか
**合否**: 有効でなければ警告（Fail ではない）
**実行方法**: `checks/verify_auto_recovery.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_auto_recovery.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2201: LiteLLM設定ファイル
**保存内容**: litellm_config.yaml（用途別ルーティング・予算管理・フォールバック順）
**参照パス**: `litellm_config.yaml`
**保存場所**: プロジェクトルート

---

### E-2202: 予算消費ログ
**保存内容**:
- モデル別消費額
- 工程タグ別消費額
- 予算残高
- アラート履歴

**参照パス**: `evidence/budget/YYYYMMDD_budget_consumption.md`
**保存場所**: `evidence/budget/`

---

### E-2203: フォールバック記録
**保存内容**:
- フォールバック実施日時
- 元のモデル・代替モデル
- フォールバック理由（レート制限/障害/予算オーバー）
- 期間
- 復帰日時

**参照パス**: `evidence/fallback/YYYYMMDD_HHMMSS_fallback.md`
**保存場所**: `evidence/fallback/`

---

### E-2204: 自動復帰記録
**保存内容**:
- 復帰検出日時
- 元のモデル
- 復帰確認方法

**参照パス**: `evidence/recovery/YYYYMMDD_HHMMSS_recovery.md`
**保存場所**: `evidence/recovery/`

---

## 10. チェックリスト

- [x] 本Part22 が全12セクション（0〜12）を満たしているか
- [x] 用途別ルーティング（R-2201）が明記されているか
- [x] 予算管理の自動化（R-2202）が明記されているか
- [x] レート制限・障害への自動フォールバック（R-2203）が明記されているか
- [x] フォールバック順の遵守（R-2204）が明記されているか
- [x] 自動復帰の実装（R-2205）が明記されているか
- [x] 予算オーバー時の手動フォールバック（R-2206）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-2201〜V-2204）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2201〜E-2204）が参照パス付きで記述されているか
- [ ] 本Part22 を読んだ人が「制限が来ても止まらない」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2201: LiteLLMの具体的な設定ファイル形式
**問題**: litellm_config.yaml の詳細なフォーマットが不明。
**影響Part**: Part22（本Part）
**暫定対応**: LiteLLMの公式ドキュメントを参照。

---

### U-2202: 予算通知の具体的な方法
**問題**: 予算80%, 90%, 100%到達時の通知方法（Slack/Email等）が未定。
**影響Part**: Part22（本Part）
**暫定対応**: 環境依存としてADRで決定。

---

### U-2203: ローカルLLMとの連携方法
**問題**: LiteLLMとローカルLLM（Ollama/LM Studio）の連携方法が不明。
**影響Part**: Part22（本Part）、Part25（統合ツール構成）
**暫定対応**: Part25で明記。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part24.md](Part24.md) : 可観測性設計
- [docs/Part25.md](Part25.md) : 統合ツール構成

### sources/
- _imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md : 原文（「2.4 モデル運用の配管」「4.4 LiteLLMで"制限耐性"を自動化」「7. コスト最適化」）
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_litellm_config.ps1` : LiteLLM設定確認（未作成）
- `checks/verify_budget.ps1` : 予算管理確認（未作成）
- `checks/verify_fallback_order.ps1` : フォールバック順確認（未作成）
- `checks/verify_auto_recovery.ps1` : 自動復帰確認（未作成）

### evidence/
- `evidence/budget/` : 予算消費ログ
- `evidence/fallback/` : フォールバック記録
- `evidence/recovery/` : 自動復帰記録

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール
- `litellm_config.yaml` : LiteLLM設定ファイル（プロジェクトルート）




FILE: docs\Part23.md
-----
# Part 23：回帰防止設計（promptfooによる回帰検出・品質ゲート・CI統合）

## 0. このPartの位置づけ
- **目的**: LLMの品質をCIでテストし、モデル更新・プロンプト更新のたびに回帰（劣化）を検出する
- **依存**: [Part10](Part10.md)（Verify Gate）、[Part21](Part21.md)（工程別AI割当）、[Part24](Part24.md)（可観測性）
- **影響**: 全プロンプト・全エージェントの品質保証・CIパイプライン

---

## 1. 目的（Purpose）

本 Part23 は **回帰防止の自動化** を通じて、以下を保証する：

1. **回帰検出**: モデル更新・プロンプト更新時に、品質劣化を自動検出
2. **品質ゲート**: 主要プロンプト・主要エージェントの出力が基準を満たすか機械判定
3. **CI統合**: CIパイプラインに組み込み、PR/マージ前に品質チェックを実施
4. **継続改善**: 閾値を設定し、品質の上振れ・下振れを可視化

**根拠**: 最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md）「2.5 回帰防止（最高精度の核）」「4.6 promptfooで"回帰しない"を機械化」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- promptfooによるLLM回帰テスト
- 主要プロンプト・主要エージェントの品質評価
- CIパイプラインとの統合
- 閾値管理・品質ゲート

### Out of Scope（適用外）
- promptfoo以外のテストツール（他ツールを使う場合はADRで決定）
- 個別プロンプトの詳細設計（別途定義）

---

## 3. 前提（Assumptions）

1. **promptfooがインストールされている**（`npm install -g promptfoo`）
2. **主要プロンプト・主要エージェント**が特定されている
3. **期待出力・最低基準**が定義されている
4. **CIパイプライン**（GitHub Actions等）が構築されている
5. **Part10（Verify Gate）** との連携が確立されている

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **promptfoo**: [glossary/GLOSSARY.md#promptfoo](../glossary/GLOSSARY.md)（LLM回帰テストツール）
- **回帰（Regression）**: モデル更新・プロンプト更新による品質劣化
- **品質ゲート（Quality Gate）**: 品質の閾値を設定し、閾値を割ると落とす
- **期待出力（Expected Output）**: プロンプト・エージェントが期待する出力
- **最低基準（Minimum Threshold）**: 品質の最低許容値（スコア/判定）
- **評価スイート（Evaluation Suite）**: テストケースをまとめたセット

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2301: 評価スイートの作成【MUST】

主要プロンプト・主要エージェントに対し、以下の評価スイートを作成する：

#### 評価スイートの構成
- **テストケース**: 期待出力・入力・プロンプト
- **評価基準**: スコア/判定（例: 正確性>0.8, 関連性>0.7）
- **実行環境**: モデル名・プロンプトバージョン

#### 主要プロンプト（例）
- Spec生成プロンプト
- Reviewプロンプト
- 修正提案プロンプト
- 要約プロンプト

#### 主要エージェント（例）
- Specエージェント
- Buildエージェント
- Reviewエージェント
- Fixエージェント

**根拠**: rev.md「4.6 promptfooで"回帰しない"を機械化」
**違反例**: 評価スイートなしで品質ゲートを設定 → 禁止。

---

### R-2302: CI統合の強制【MUST】

promptfooはCIパイプラインに統合し、以下を実施する：

#### PR作成時
1. プロンプト・モデルの変更を検出
2. 評価スイートを実行
3. 品質ゲートで判定（閾値を割るとFAIL）
4. FAILの場合、PRをブロック

#### マージ時
1. Full評価スイートを実行
2. 品質レポートを生成
3. Part24（Langfuse）に記録

**根拠**: rev.md「2.5 回帰防止（最高精度の核）」

---

### R-2303: 閾値管理【MUST】

品質の閾値を以下のレベルで管理：

#### L1: 致命的（Critical）
- **閾値**: 0.9以上
- **対象**: 正確性、安全性
- **違反時**: 即座にブロック・HumanGateで承認のみ許可

#### L2: 重要（Important）
- **閾値**: 0.8以上
- **対象**: 関連性、完全性
- **違反時**: 警告・レビュー必須

#### L3: 通常（Normal）
- **閾値**: 0.7以上
- **対象**: 可読性、簡潔性
- **違反時**: 記録のみ

**違反例**: 閾値未設定で品質ゲート → 禁止。

---

### R-2304: 回帰検出の自動化【MUST】

promptfooは以下の回帰検出を自動実行する：

#### モデル更新時
1. 新旧モデルで同じテストケースを実行
2. スコアを比較（差分>0.1で回帰と判定）
3. 回帰検出時、即座にブロック

#### プロンプト更新時
1. 新旧プロンプトで同じテストケースを実行
2. スコアを比較（差分>0.1で回帰と判定）
3. 回帰検出時、即座にブロック

**根拠**: rev.md「4.6 promptfooで"回帰しない"を機械化」

---

### R-2305: 評価スイートの更新ルール【MUST】

評価スイートの更新は以下のルールに従う：

1. **新規プロンプト・エージェント追加時**: 必ず評価スイートを作成
2. **閾値変更時**: ADRで理由・影響範囲を明記
3. **テストケース追加時**: Part24（Langfuse）に記録
4. **評価スイート削除時**: ADRで理由を明記

---

### R-2306: 品質レポートの生成【SHOULD】

promptfooは以下の品質レポートを生成する：

1. **サマリー**: 全体スコア・回帰検出数・FAIL数
2. **詳細レポート**: テストケース別のスコア・期待出力・実際の出力
3. **傾向分析**: 前回比・品質の上振れ・下振れ
4. **改善提案**: 閾値未達のテストケースに対する改善提案

**保存先**: `evidence/promptfoo/YYYYMMDD_HHMMSS_quality_report.md`

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: promptfooの初期設定
1. promptfooをインストール: `npm install -g promptfoo`
2. 設定ファイル作成: `promptfooconfig.yaml`
3. 評価スイートのディレクトリ作成: `tests/promptfoo/`
4. テストケースの作成: `tests/promptfoo/spec_cases.yaml`

### 手順B: 評価スイートの作成
1. 主要プロンプトを特定（Spec生成・Review等）
2. テストケースを作成:
   ```yaml
   tests:
     - description: "Spec生成の正確性"
       prompt: "{{spec_prompt}}"
       expected: "PRD/Glossary/AC/Not-in-scope/失敗モードを含む"
       assertion:
         - type: icontains
           value: "PRD"
         - type: icontains
           value: "AC"
   ```
3. 閾値を設定:
   ```yaml
   thresholds:
     accuracy: 0.8
     relevance: 0.7
     safety: 0.9
   ```
4. 評価スイートを実行: `promptfoo eval -c promptfooconfig.yaml`

### 手順C: CI統合の設定
1. GitHub Actionsのワークフロー作成: `.github/workflows/promptfoo.yml`
2. PR時の自動実行を設定:
   ```yaml
   on:
     pull_request:
       paths:
         - 'prompts/**'
         - 'tests/promptfoo/**'
   jobs:
     promptfoo:
       runs-on: ubuntu-latest
       steps:
         - uses: actions/checkout@v3
         - run: npx promptfoo eval -c promptfooconfig.yaml
         - uses: actions/upload-artifact@v3
           with:
             name: promptfoo-report
             path: promptfoo-output/
   ```
3. 品質ゲートの設定: FAILの場合、PRをブロック

### 手順D: 回帰検出の実行
1. モデル更新・プロンプト更新を検出
2. 新旧の評価スイートを実行
3. スコアを比較
4. 回帰検出時、即座にブロック・HumanGateで承認

### 手順E: 品質レポートの確認
1. promptfooの出力を確認: `promptfoo-output/`
2. サマリーを確認（全体スコア・回帰検出数・FAIL数）
3. 詳細レポートを確認（テストケース別のスコア）
4. 傾向分析を確認（前回比）
5. 改善提案を確認

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: 品質ゲートでFAIL
**対処**:
1. 即座にPRをブロック
2. 原因を特定（モデル更新？プロンプト更新？テストケース不備？）
3. 修正または閾値調整（ADRで決定）
4. 再評価

**エスカレーション**: 頻発する場合、閾値・プロンプト・モデルの見直し。

---

### 例外2: 回帰検出
**対処**:
1. 即座にブロック
2. 新旧スコアの差分を分析
3. 原因を特定（モデル劣化？プロンプト不備？）
4. 修正またはロールバック
5. 再評価

**エスカレーション**: 頻発する場合、モデル選定の見直し（Part25）。

---

### 例外3: 評価スイートが不備
**対処**:
1. テストケースの不足・不備を特定
2. テストケースを追加・修正
3. Part24（Langfuse）に記録
4. 再評価

**エスカレーション**: 頻発する場合、評価スイート設計の見直し。

---

### 例外4: CI統合が失敗
**対処**:
1. CIパイプラインのエラーを特定
2. 設定ファイルを修正
3. 再実行
4. 手動実行でフォールバック

**エスカレーション**: 頻発する場合、CI設定の見直し。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2301: 評価スイートの存在確認
**判定条件**: 主要プロンプト・主要エージェントに対し評価スイートが存在するか
**合否**: 未作成があれば Fail
**実行方法**: `checks/verify_promptfoo_suite.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_promptfoo_suite.md`

---

### V-2302: 閾値設定の確認
**判定条件**: 閾値が設定されているか（L1: 0.9, L2: 0.8, L3: 0.7）
**合否**: 未設定があれば Fail
**実行方法**: `checks/verify_threshold.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_threshold.md`

---

### V-2303: CI統合の確認
**判定条件**: CIパイプラインにpromptfooが統合されているか
**合否**: 未統合なら Fail
**実行方法**: `checks/verify_ci_promptfoo.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_ci_promptfoo.md`

---

### V-2304: 品質レポートの生成確認
**判定条件**: 品質レポートが生成されているか
**合否**: 未生成なら警告（Fail ではない）
**実行方法**: `checks/verify_quality_report.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_quality_report.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2301: 評価スイート
**保存内容**:
- テストケース（期待出力・入力・プロンプト）
- 評価基準（スコア/判定）
- 実行環境（モデル名・プロンプトバージョン）

**参照パス**: `tests/promptfoo/*.yaml`
**保存場所**: `tests/promptfoo/`

---

### E-2302: 品質レポート
**保存内容**:
- サマリー（全体スコア・回帰検出数・FAIL数）
- 詳細レポート（テストケース別のスコア）
- 傾向分析（前回比）
- 改善提案

**参照パス**: `evidence/promptfoo/YYYYMMDD_HHMMSS_quality_report.md`
**保存場所**: `evidence/promptfoo/`

---

### E-2303: 回帰検出記録
**保存内容**:
- 検出日時
- 新旧スコア
- 差分
- 原因
- 対処

**参照パス**: `evidence/regression/YYYYMMDD_HHMMSS_regression.md`
**保存場所**: `evidence/regression/`

---

### E-2304: 閾値変更記録
**保存内容**:
- 変更日時
- 変更前・変更後の閾値
- 変更理由
- ADRへの参照

**参照パス**: `evidence/threshold/YYYYMMDD_HHMMSS_threshold.md`
**保存場所**: `evidence/threshold/`

---

## 10. チェックリスト

- [x] 本Part23 が全12セクション（0〜12）を満たしているか
- [x] 評価スイートの作成（R-2301）が明記されているか
- [x] CI統合の強制（R-2302）が明記されているか
- [x] 閾値管理（R-2303）が明記されているか
- [x] 回帰検出の自動化（R-2304）が明記されているか
- [x] 評価スイートの更新ルール（R-2305）が明記されているか
- [x] 品質レポートの生成（R-2306）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-2301〜V-2304）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2301〜E-2304）が参照パス付きで記述されているか
- [ ] 本Part23 を読んだ人が「回帰しないを機械化」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2301: 評価スイートのテストケース数
**問題**: 各プロンプト・エージェントに対し、何件のテストケースを作成するか不明。
**影響Part**: Part23（本Part）
**暫定対応**: 重要プロンプトは10〜50件、その他は5〜10件を目安。

---

### U-2302: 閾値の具体的な数値
**問題**: L1/L2/L3の閾値（0.9, 0.8, 0.7）が適切か不明。
**影響Part**: Part23（本Part）
**暫定対応**: 運用で調整し、ADRで決定。

---

### U-2303: 評価スイートの更新頻度
**問題**: テストケースをどの頻度で更新するか不明。
**影響Part**: Part23（本Part）
**暫定対応**: 四半期ごとの定期見直し＋必要に応じ随時更新。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part10.md](Part10.md) : Verify Gate
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part24.md](Part24.md) : 可観測性設計

### sources/
- _imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md : 原文（「2.5 回帰防止」「4.6 promptfooで"回帰しない"を機械化」）
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_promptfoo_suite.ps1` : 評価スイート確認（未作成）
- `checks/verify_threshold.ps1` : 閾値設定確認（未作成）
- `checks/verify_ci_promptfoo.ps1` : CI統合確認（未作成）
- `checks/verify_quality_report.ps1` : 品質レポート確認（未作成）

### evidence/
- `evidence/promptfoo/` : 品質レポート
- `evidence/regression/` : 回帰検出記録
- `evidence/threshold/` : 閾値変更記録

### tests/
- `tests/promptfoo/` : 評価スイート（テストケース）

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール
- `promptfooconfig.yaml` : promptfoo設定ファイル（プロジェクトルート）
- `.github/workflows/promptfoo.yml` : CI統合ワークフロー




FILE: docs\Part24.md
-----
# Part 24：可観測性設計（Langfuseによるトレース・評価・コスト・改善ループ）

## 0. このPartの位置づけ
- **目的**: "どこで壊れたか"が一撃で分かるように、トレース・評価・コスト・遅延を追跡し、改善ループを回す
- **依存**: [Part10](Part10.md)（Verify Gate）、[Part21](Part21.md)（工程別AI割当）、[Part22](Part22.md)（制限耐性）、[Part23](Part23.md)（回帰防止）
- **影響**: 全AI使用工程・コスト管理・障害対応・品質改善

---

## 1. 目的（Purpose）

本 Part24 は **可観測性の統合** を通じて、以下を保証する：

1. **一撃特定**: どのモデル・どのプロンプト・どのツール呼び出しで失敗したか即座に特定
2. **再現可能**: "改善の再現"ができる（トレースにモデル・プロンプト・コンテキスト・コスト・遅延を記録）
3. **コスト可視**: 工程タグ別・モデル別のコスト消費を追跡
4. **改善ループ**: 失敗分析から改善までのサイクルを確立

**根拠**: 最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md）「2.6 可観測性（壊れた場所を一撃で特定）」「4.5 Langfuseで"どこで壊れたか"を一撃で分かるようにする」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- Langfuseによるトレース・評価・コスト管理
- 全AI使用工程（Spec/Research/Design/Build/Fix/Verify/Release/Operate）の追跡
- 失敗分析・改善ループ
- ダッシュボードによる可視化

### Out of Scope（適用外）
- Langfuse以外の可観測性ツール（他ツールを使う場合はADRで決定）

---

## 3. 前提（Assumptions）

1. **Langfuseサーバ**が稼働している（セルフホストまたはクラウド）
2. **各AIエージェント**がLangfuseにトレースを送信する
3. **工程タグ**（Spec/Design/Build等）が付与されている
4. **Part10（Verify Gate）** との連携が確立されている

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **Langfuse**: [glossary/GLOSSARY.md#Langfuse](../glossary/GLOSSARY.md)（LLMのトレース・評価・コスト管理ツール）
- **トレース（Trace）**: AI実行の記録（モデル・プロンプト・コンテキスト・出力・コスト・遅延）
- **スパン（Span）**: トレース内の個別実行単位
- **工程タグ**: Spec/Design/Build等の工程を識別するタグ
- **評価（Evaluation）**: トレースに対する品質評価（スコア・判定）
- **改善ループ**: 失敗分析→改善→再評価のサイクル

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2401: トレース記録の必須項目【MUST】

Langfuseは以下の項目を記録する：

#### 共通項目（全工程共通）
- **trace_id**: トレースの一意識別子
- **timestamp**: 実行日時
- **model**: モデル名（例: claude-opus, gpt-5.2）
- **prompt**: プロンプト内容（またはバージョンID）
- **context**: コンテキスト（参照ファイル・タスクID等）
- **output**: 出力結果
- **cost**: コスト（USD）
- **latency**: 遅延（ms）

#### 工程別項目
- **工程タグ**: Spec/Research/Design/Build/Fix/Verify/Release/Operate
- **AI名**: ChatGPT/Claude/Gemini/Z.ai
- **ユーザID**: 実行者（人間またはエージェント）

**根拠**: rev.md「4.5 Langfuseで"どこで壊れたか"を一撃で分かるようにする」
**違反例**: トレース未記録でのAI実行 → 禁止。

---

### R-2402: 失敗時の自動記録【MUST】

失敗時は以下を自動記録する：

#### 失敗分類
1. **Spec系**: 前提が違う／受入基準が曖昧
2. **依存/環境系**: バージョン衝突／OS差
3. **実装系**: 局所バグ
4. **テスト系**: テスト不足／壊れたテスト
5. **モデル系**: レート制限・障害・予算オーバー

#### 記録項目
- 失敗分類
- エラーメッセージ
- スタックトレース（該当時）
- 関連trace_id
- 対処内容

**根拠**: rev.md「4.5 Langfuseで"どこで壊れたか"を一撃で分かるようにする」

---

### R-2403: コスト追跡の実装【MUST】

Langfuseは以下のコスト追跡を実装する：

#### 工程タグ別コスト
- Spec/Research/Design/Build/Fix/Verify/Release/Operate 別の消費額
- 月次集計・傾向分析

#### モデル別コスト
- claude-opus, gpt-5.2, gemini-3-pro 等の消費額
- 月次集計・傾向分析

#### アラート
- 予算の80%, 90%, 100%到達時にアラート
- 異常消費（急増等）を検出

**根拠**: rev.md「4.5 Langfuseで"どこで壊れたか"を一撃で分かるようにする」「7. コスト最適化」

---

### R-2404: 評価の実装【MUST】

Langfuseは以下の評価を実装する：

#### 自動評価
- promptfooとの連携（Part23）
- スコア・判定の記録

#### 手動評価
- 人間によるフィードバック
- スコア（1〜5）・判定（Pass/Fail）

#### 評価集計
- 平均スコア・Pass率
- 傾向分析（前回比）

---

### R-2405: 改善ループの確立【SHOULD】

以下の改善ループを確立する：

1. **失敗分析**: Langfuseで失敗トレースを特定
2. **原因究明**: 失敗分類・エラーメッセージ・関連trace_idから原因を特定
3. **改善策立案**: ADRで改善策を決定
4. **改善実施**: プロンプト修正・モデル変更・コード修正
5. **再評価**: Langfuseで結果を確認・評価記録

---

### R-2406: ダッシュボードの活用【SHOULD】

Langfuseのダッシュボードで以下を可視化する：

#### リアルタイム監視
- 実行中のトレース
- エラー率
- コスト消費
- 遅延

#### 定期レポート
- 日次・週次・月次レポート
- 品質トレンド
- コストトレンド

#### カスタムダッシュボード
- 工程別ダッシュボード
- モデル別ダッシュボード
- 失敗分析ダッシュボード

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: Langfuseの初期設定
1. Langfuseサーバのセットアップ（セルフホストまたはクラウド）
2. APIキーの取得・環境変数設定
3. 各AIエージェントにLangfuse SDKを統合
4. トレース送信の確認

### 手順B: トレース記録の実装
1. 各工程でトレース送信を実装:
   ```python
   from langfuse import Langfuse
   langfuse = Langfuse()

   trace = langfuse.trace(
       name="Spec生成",
       metadata={
           "process": "Spec",
           "ai": "Claude Opus",
           "user_id": "user123",
           "task_id": "TICKET-001"
       }
   )

   span = trace.span(
       name="PRD作成",
       input={"prompt": spec_prompt},
       output={"prd": prd_output},
       metadata={
           "model": "claude-opus",
           "cost": 0.05,
           "latency": 1500
       }
   )

   span.end()
   ```

### 手順C: 失敗時の記録
1. 例外ハンドリングで失敗をキャッチ
2. Langfuseに失敗トレースを記録:
   ```python
   try:
       result = ai_execute()
   except Exception as e:
       trace = langfuse.trace(
           name="Spec生成失敗",
           metadata={
               "process": "Spec",
               "error_type": "Spec系",
               "error_message": str(e),
               "stack_trace": traceback.format_exc()
           }
       )
       trace.end(status="error")
   ```

### 手順D: 改善ループの実行
1. 失敗分析: Langfuseダッシュボードで失敗トレースを確認
2. 原因究明: 失敗分類・エラーメッセージ・関連trace_idから原因を特定
3. 改善策立案: ADRで改善策を決定
4. 改善実施: プロンプト修正・モデル変更・コード修正
5. 再評価: Langfuseで結果を確認・評価記録

### 手順E: ダッシュボードの活用
1. リアルタイム監視: 実行中のトレース・エラー率・コスト消費・遅延を確認
2. 定期レポート: 日次・週次・月次レポートを確認
3. カスタムダッシュボード: 工程別・モデル別・失敗分析用ダッシュボードを作成

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: Langfuseサーバダウン
**対処**:
1. トレース送信をスキップ（AI実行は継続）
2. Evidenceに「Langfuseダウン・トレース未記録」を記録
3. 復帰後、再送を試みる

**エスカレーション**: 長期ダウンが予想される場合、ADRで暫定運用を決定。

---

### 例外2: トレース記録失敗
**対処**:
1. エラー内容を確認（APIキー問題？ネットワーク問題？）
2. 再試行（最大3回）
3. 復帰しない場合、Evidenceに「トレース記録失敗」を記録

**エスカレーション**: 頻発する場合、Langfuse設定の見直し。

---

### 例外3: コスト異常消費
**対処**:
1. 即座に該当モデルを停止（Part22）
2. 原因を特定（無限ループ？誤ったモデル選択？）
3. ADRで「コスト異常消費・原因・対策」を記録
4. 再発防止策を検討

**エスカレーション**: 頻発する場合、Part22（制限耐性）の見直し。

---

### 例外4: 改善策が効果なし
**対処**:
1. 改善前後のトレースを比較
2. 別の改善策を検討
3. ADRで「改善失敗・別策検討」を記録

**エスカレーション**: 3回以上改善失敗する場合、設計見直し。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2401: トレース記録の確認
**判定条件**: 全AI実行でトレースが記録されているか
**合否**: 未記録があれば Fail
**実行方法**: `checks/verify_langfuse_trace.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_langfuse_trace.md`

---

### V-2402: 失敗記録の確認
**判定条件**: 失敗時に自動記録されているか
**合否**: 未記録があれば Fail
**実行方法**: `checks/verify_failure_recording.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_failure_recording.md`

---

### V-2403: コスト追跡の確認
**判定条件**: 工程タグ別・モデル別のコストが追跡されているか
**合否**: 未追跡があれば Fail
**実行方法**: `checks/verify_cost_tracking.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_cost_tracking.md`

---

### V-2404: 評価の確認
**判定条件**: 自動評価・手動評価が実施されているか
**合否**: 未評価があれば警告（Fail ではない）
**実行方法**: `checks/verify_evaluation.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_evaluation.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2401: トレースデータ
**保存内容**: 全AI実行のトレース（trace_id・モデル・プロンプト・コンテキスト・出力・コスト・遅延）
**参照パス**: Langfuseダッシュボード（https://langfuse.example.com）
**保存場所**: Langfuseサーバ

---

### E-2402: 失敗記録
**保存内容**: 失敗分類・エラーメッセージ・関連trace_id・対処内容
**参照パス**: Langfuseダッシュボード（失敗分析フィルタ）
**保存場所**: Langfuseサーバ

---

### E-2403: コストレポート
**保存内容**: 工程タグ別・モデル別のコスト消費・月次集計・傾向分析
**参照パス**: `evidence/cost/YYYYMMDD_cost_report.md`
**保存場所**: `evidence/cost/`

---

### E-2404: 評価レポート
**保存内容**: 平均スコア・Pass率・傾向分析・改善提案
**参照パス**: `evidence/evaluation/YYYYMMDD_evaluation_report.md`
**保存場所**: `evidence/evaluation/`

---

### E-2405: 改善記録
**保存内容**: 失敗分析・原因究明・改善策・再評価結果
**参照パス**: `evidence/improvement/YYYYMMDD_improvement.md`
**保存場所**: `evidence/improvement/`

---

## 10. チェックリスト

- [x] 本Part24 が全12セクション（0〜12）を満たしているか
- [x] トレース記録の必須項目（R-2401）が明記されているか
- [x] 失敗時の自動記録（R-2402）が明記されているか
- [x] コスト追跡の実装（R-2403）が明記されているか
- [x] 評価の実装（R-2404）が明記されているか
- [x] 改善ループの確立（R-2405）が明記されているか
- [x] ダッシュボードの活用（R-2406）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-2401〜V-2404）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2401〜E-2405）が参照パス付きで記述されているか
- [ ] 本Part24 を読んだ人が「どこで壊れたかが一撃で分かる」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2401: Langfuseサーバのホスティング先
**問題**: セルフホストかクラウドか未定。
**影響Part**: Part24（本Part）
**暫定対応**: 環境依存としてADRで決定。

---

### U-2402: トレースの保持期間
**問題**: トレースデータをどの期間保持するか不明。
**影響Part**: Part24（本Part）
**暫定対応**: 90日保持・アーカイブ移動。

---

### U-2403: ダッシュボードの具体的なレイアウト
**問題**: どのダッシュボードをどのようにレイアウトするか未定。
**影響Part**: Part24（本Part）
**暫定対応**: 運用で調整。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part10.md](Part10.md) : Verify Gate
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part22.md](Part22.md) : 制限耐性設計
- [docs/Part23.md](Part23.md) : 回帰防止設計

### sources/
- _imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md : 原文（「2.6 可観測性」「4.5 Langfuseで"どこで壊れたか"を一撃で分かるようにする」）
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_langfuse_trace.ps1` : トレース記録確認（未作成）
- `checks/verify_failure_recording.ps1` : 失敗記録確認（未作成）
- `checks/verify_cost_tracking.ps1` : コスト追跡確認（未作成）
- `checks/verify_evaluation.ps1` : 評価確認（未作成）

### evidence/
- `evidence/cost/` : コストレポート
- `evidence/evaluation/` : 評価レポート
- `evidence/improvement/` : 改善記録

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール
- Langfuseダッシュボード: https://langfuse.example.com（環境依存）




FILE: docs\Part25.md
-----
# Part 25：統合ツール構成（VibeKanban/Continue/ローカル逃げ道・モデル選定・コスト最適化）

## 0. このPartの位置づけ
- **目的**: "滑らかに回す"補助ツール群を統合し、誰がやっても同じ品質で再現可能にする
- **依存**: [Part03](Part03.md)（AI Pack）、[Part04](Part04.md)（作業管理）、[Part21](Part21.md)（工程別AI割当）、[Part22](Part22.md)（制限耐性）、[Part23](Part23.md)（回帰防止）、[Part24](Part24.md)（可観測性）
- **影響**: 全ツール選定・統合I/F・ローカル逃げ道・モデル評価・コスト最適化

---

## 1. 目的（Purpose）

本 Part25 は **統合ツール構成** を通じて、以下を保証する：

1. **同一流儀**: IDE（Antigravity/VS Code）/CLI（Aider/Codex/Gemini/Z.ai）/CI（promptfoo/各種scan）で同じ流儀
2. **止まらない**: ローカルLLM（Ollama/LM Studio）・無料CLI（aichat/llm）・低コスト/無料枠のルーティングにより、制限で止まらない
3. **モデル選定**: 外部ランキング→自分の回帰（promptfoo）で"本当に強い"割当を固める
4. **コスト最適**: 経済モードを工程に組み込み、精度を落とさず制限も超えにくくする

**根拠**: 最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md）「4. "滑らかに回す"補助ツール群（VibeKanban中心の統合）」「5. 代用・無料CLI（制限時の"逃げ道）」「6. "モデル選定"を最も精度高くやる手順」「7. コスト最適化」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- VibeKanbanによるオーケストレーション
- Continueによる統一I/F
- ローカル逃げ道（Ollama/LM Studio/aichat/llm）
- モデル選定の手順
- コスト最適化の戦略

### Out of Scope（適用外）
- 個別ツールの詳細な使用方法（各ツールのドキュメントを参照）
- 新しいツールの評価（プロセスは本Partで定義）

---

## 3. 前提（Assumptions）

1. **Core4が役割固定**されている（Part03, Part05）
2. **VibeKanbanが司令塔**として稼働している（Part04）
3. **Part21-24** の設定が完了している
4. **ローカルLLM・無料CLI**がインストールされている（環境依存）

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **VibeKanban**: [glossary/GLOSSARY.md#VIBEKANBAN](../glossary/GLOSSARY.md)（並列エージェント実行の安全装置・司令塔）
- **Continue**: [glossary/GLOSSARY.md#Continue](../glossary/GLOSSARY.md)（統一I/Fツール）
- **ローカルLLM**: Ollama/LM Studio等のローカル実行環境
- **無料CLI**: aichat/llm等の無料〜低コストCLIツール
- **モデル選定**: 外部ランキング→自分の回帰でモデルを選定するプロセス
- **コスト最適**: 経済モードの工程組み込み

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2501: VibeKanbanで固定すべきもの【MUST】

VibeKanbanは以下を固定する：

#### レーン（例）
- Spec → Research → Design → Build → Fix → Verify → Release → Operate

#### WIP制限
- Spec/Designは"未確定を積まない"
- Buildは"並列しすぎて衝突しない"

#### DoD（完了条件）を各レーンに固定
- Spec: PRD/Glossary/AC/Not-in-scope/失敗モードが機械判定可能
- Build: 実装コード/テストコード/diff/manifestが揃っている
- Verify: テスト結果/カバレッジ/回帰レポートがGreen

#### 証跡リンク（どのタスクの成果か）を必ず紐付け
- Evidenceへの参照
- タスクID（TICKET-XXX）

**根拠**: rev.md「4.1 VibeKanban（司令塔）で固定すべきもの」
**違反例**: DoD未設定でレーン運用 → 禁止。

---

### R-2502: 1タスク=1隔離の強制【MUST】

1 TICKET = 1 worktree = 1 branch = 1 Verify = 1 Evidence Pack

これで並列作業しても衝突しにくい（大規模の必須条件）。

**根拠**: rev.md「4.2 1タスク=1隔離（大規模で破綻しない基本形）」

---

### R-2503: Continueで"同一流儀"化【MUST】

以下で同一のルール/文体/出力規約に寄せる：

#### IDE（Antigravity/VS Code）
#### CLI（Aider/Codex/Gemini/Z.ai）
#### CI（promptfoo/各種scan）

**誰がやっても同じ品質**＝再現性。

**根拠**: rev.md「4.3 Continueで"同一流儀"化」

---

### R-2504: ローカルLLMは"最強"ではなく"止まらない"【MUST NOT】

ローカルは「最高精度」ではなく、**"止まらない"** と **"機密を外に出さない"** が価値。

制限時・深夜・ネット不調・閉域案件で効く。

**根拠**: rev.md「5.2 ローカル実行（完全オフライン逃げ道）」

---

### R-2505: 無料CLIの"逃げ道"としての位置づけ【MUST】

以下を入れておくと、プロバイダ変更・OpenRouter/Groq/ローカルへ逃がすのが"ワンコマンド"になる：

#### aichat: 多プロバイダ対応、REPL、RAG/ツール/エージェント機能も持てる
#### llm（simonw/llm）: CLI＋Pythonライブラリで拡張しやすい

**根拠**: rev.md「5.1 無料〜低コストで強い"汎用LLM CLI"」

---

### R-2506: モデル選定の手順【MUST】

以下の手順でモデルを選定する：

1. **外部ランキングで候補プールを作る**
   - Artificial Analysis / LLM Stats / LM Arena / Scale系 / HF Open LLM Leaderboard

2. **あなたの代表タスクを"評価セット"にする**
   - 実際のRepo・実際のバグ・実際の設計書・実際の変更

3. **promptfooで回帰試験**
   - 重要タスクは数十〜数百ケースで固定
   - スコア/判定をゲート化

4. **勝ったモデルを工程に割当**
   - Spec/Design
   - Build
   - Review
   - 雑務

**根拠**: rev.md「6. "モデル選定"を最も精度高くやる手順（リーダーボード＋自分の回帰）」

---

### R-2507: コスト最適化の戦略【SHOULD】

以下のコスト最適化を実施する：

- **高精度を使う工程を固定**: Spec / Hard Design / Review（論理）
- **軽量に落としてよい工程を固定**: 整形、候補列挙、コメント、ドキュメント体裁
- **大規模実装は"火力枠（Aider/Codex）に集中"**: 中途半端に分散するとコストも手戻りも増える

**根拠**: rev.md「7. コスト最適化」

---

### R-2508: IDE統合ツール（Watcher/Context Builder/Status Bar）【SHOULD】

「必ず入れたい.md」に基づき、以下のIDE統合ツールを実装する：

#### Watcher Script
- **機能**: ファイル保存時に `Verify` を自動実行するスクリプト
- **実行内容**:
  - Fast Verifyの自動実行
  - VRループ回数のカウント
  - Status Barへの結果表示
- **実装方法**: PowerShell 7.0+、またはNode.js

#### Context Builder
- **機能**: 作業中のタスクに合わせて `Focus Pack` を自動生成するプロンプトツール
- **入力**: タスクID（TICKET-XXX）
- **出力**: 関連するSSOT、Evidence、参照ファイルのセット
- **連携**: MCP Server経由で自動生成（Part28）

#### Status Bar
- **機能**: 「現在のモード（設計or実装）」と「VRループ残機」を表示するIDE拡張
- **表示項目**:
  - 現在のモード: 設計/実装/調査/雑務
  - VRループ残機: 「あと1回でHumanGate」
  - Context Pack状態: 生成済み/未生成/要更新
- **色分け**:
  - 緑: 問題なし（VRループ0〜1回）
  - 黄: 注意（VRループ2回）
  - 赤: 危険（VRループ3回＝HumanGate）

**根拠**: 必ず入れたい.md「Watcher Script」「Context Builder」「Status Bar」、[Part29](Part29.md)（IDE統合設計）

---

LiteLLM側で、工程タグ別budget・モデル別budget・フォールバック順を設定して「迷いを消す」ことで、結果的に精度が上がります（再現性＝精度）。

**根拠**: rev.md「7. コスト最適化（精度を落とさず、制限も超えにくくする）」

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: VibeKanbanのセットアップ
1. VibeKanbanのフォルダ構造を作成:
   ```
   VIBEKANBAN/
   ├── 000_INBOX/
   ├── 100_SPEC/
   ├── 200_BUILD/
   ├── 300_VERIFY/
   ├── 400_REPAIR/
   └── 900_RELEASE/
   ```
2. レーンを定義（Spec → Research → Design → Build → Fix → Verify → Release → Operate）
3. WIP制限を設定（Spec/Design: WIP=2, Build: WIP=1）
4. DoDを各レーンに設定
5. 証跡リンクの設定（Evidenceへの参照パス）

### 手順B: 1タスク=1隔離の実行
1. タスク（TICKET）を作成
2. worktreeを作成: `git worktree add ../worktree_<TICKET-ID> <branch>`
3. worktreeで作業を実行
4. Verifyを実行
5. Evidenceを保存
6. merge to main
7. worktreeを削除: `git worktree remove ../worktree_<TICKET-ID>`

### 手順C: Continueによる統一I/F化
1. Continueをインストール
2. 共通ルールを設定:
   - プロンプト規約
   - 作業手順
   - コンテキスト投入
   - ログ出力
3. IDE（VS Code）にContinue拡張をインストール
4. CLI（Aider/Codex/Gemini/Z.ai）にContinueを統合
5. CI（promptfoo/各種scan）にContinueを統合

### 手順D: ローカルLLMのセットアップ
1. Ollamaをインストール:
   - 公式サイトからダウンロード: https://ollama.com
   - または: `curl -fsSL https://ollama.com/install.sh -o install.sh && bash install.sh`
2. モデルをpull: `ollama pull llama3`
3. 実行確認: `ollama run llama3`
4. aichat/llmからOllamaを使用するよう設定

### 手順E: 無料CLIのセットアップ
1. aichatをインストール: `cargo install aichat`
2. llmをインストール: `pip install llm`
3. 各プロバイダのAPIキーを設定
4. 実行確認: `aichat "Hello, world!"`, `llm "Hello, world!"`

### 手順F: モデル選定の実行
1. 外部ランキングで候補プールを作成:
   - Artificial Analysis (https://artificialanalysis.ai)
   - LLM Stats (https://llm-stats.com)
   - LM Arena (https://lmarena.ai)
   - HF Open LLM Leaderboard (https://huggingface.co/spaces/lmsys/chatbot-arena-leaderboard)
2. 代表タスクを評価セットにする
3. promptfooで回帰試験を実行
4. スコア/判定をゲート化
5. 勝ったモデルを工程に割当

### 手順G: コスト最適化の実施
1. 高精度を使う工程を固定（Spec / Hard Design / Review）
2. 軽量に落としてよい工程を固定（整形、候補列挙、コメント、ドキュメント体裁）
3. 大規模実装を火力枠（Aider/Codex）に集中
4. LiteLLMで工程タグ別budget・モデル別budget・フォールバック順を設定

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: VibeKanbanが使えない環境
**対処**:
1. フォルダベースで代替（`VIBEKANBAN/` フォルダ構造）
2. 手動でWIP制限を管理
3. 環境改善を検討

**エスカレーション**: 並列実行が必須の場合、環境移行を検討。

---

### 例外2: worktreeが使えない環境
**対処**:
1. 並列禁止（WIP=1固定）
2. 順次実行（1タスクずつ完了させる）
3. 環境改善を検討

**エスカレーション**: 並列実行が必須の場合、環境移行を検討。

---

### 例外3: ローカルLLMが動かない
**対処**:
1. ハードウェア要件を確認（GPUメモリ等）
2. 軽量モデルに切り替え（llama3 → phi3）
3. aichat/llmを代替として使用

**エスカレーション**: ローカルLLMが必須の場合、環境改善を検討。

---

### 例外4: モデル選定で候補が見つからない
**対処**:
1. 外部ランキングの範囲を拡大
2. 評価セットを拡充
3. 一時的に既存モデルで継続（ADRで決定）

**エスカレーション**: 長期解決しない場合、要件の見直し。

---

### 例外5: コストオーバーが頻発
**対処**:
1. LiteLLMで予算設定を見直し
2. 高精度を使う工程を再検討
3. ローカルLLM・無料CLIへの移行を検討

**エスカレーション**: Part22（制限耐性）の見直し。

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2501: VibeKanban設定の確認
**判定条件**: レーン・WIP制限・DoD・証跡リンクが設定されているか
**合否**: 未設定があれば Fail
**実行方法**: `checks/verify_vibekanban.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_vibekanban.md`

---

### V-2502: Continue統合の確認
**判定条件**: IDE/CLI/CIでContinueが統合されているか
**合否**: 未統合なら警告（Fail ではない）
**実行方法**: `checks/verify_continue.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_continue.md`

---

### V-2503: ローカルLLMの確認
**判定条件**: Ollama/LM Studioがインストールされているか
**合否**: 未インストールなら警告（Fail ではない）
**実行方法**: `checks/verify_local_llm.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_local_llm.md`

---

### V-2504: 無料CLIの確認
**判定条件**: aichat/llmがインストールされているか
**合否**: 未インストールなら警告（Fail ではない）
**実行方法**: `checks/verify_free_cli.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_free_cli.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2501: VibeKanban設定
**保存内容**: レーン定義・WIP制限・DoD・証跡リンク
**参照パス**: `VIBEKANBAN/README.md`
**保存場所**: `VIBEKANBAN/`

---

### E-2502: Continue設定
**保存内容**: 共通ルール・プロンプト規約・作業手順・コンテキスト投入・ログ出力
**参照パス**: `continue/config.yaml`
**保存場所**: `continue/`

---

### E-2503: ローカルLLM設定
**保存内容**: Ollama/LM Studioの設定・モデル名・ポート番号
**参照パス**: `local_llm/README.md`
**保存場所**: `local_llm/`

---

### E-2504: 無料CLI設定
**保存内容**: aichat/llmの設定・APIキー（環境変数）
**参照パス**: `free_cli/README.md`
**保存場所**: `free_cli/`

---

### E-2505: モデル選定記録
**保存内容**: 候補プール・評価セット・promptfoo結果・工程割当
**参照パス**: `evidence/model_selection/YYYYMMDD_model_selection.md`
**保存場所**: `evidence/model_selection/`

---

## 10. チェックリスト

- [x] 本Part25 が全12セクション（0〜12）を満たしているか
- [x] VibeKanbanで固定すべきもの（R-2501）が明記されているか
- [x] 1タスク=1隔離の強制（R-2502）が明記されているか
- [x] Continueで"同一流儀"化（R-2503）が明記されているか
- [x] ローカルLLMは"最強"ではなく"止まらない"（R-2504）が明記されているか
- [x] 無料CLIの"逃げ道"（R-2505）が明記されているか
- [x] モデル選定の手順（R-2506）が明記されているか
- [x] コスト最適化の戦略（R-2507）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-2501〜V-2504）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2501〜E-2505）が参照パス付きで記述されているか
- [ ] 本Part25 を読んだ人が「統合ツール構成」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2501: VibeKanbanの具体的なツール
**問題**: VibeKanbanを「フォルダ」「Git Issue」「外部ツール（Trello等）」のどれで実装するか未定。
**影響Part**: Part25（本Part）
**暫定対応**: フォルダベース（`VIBEKANBAN/`）で開始。運用が安定したら外部ツールへ移行を検討。

---

### U-2502: Continueの具体的な設定ファイル形式
**問題**: Continueのconfig.yamlの具体的なフォーマットが不明。
**影響Part**: Part25（本Part）
**暫定対応**: Continueの公式ドキュメントを参照。

---

### U-2503: ローカルLLMの具体的なモデル選定
**問題**: どのモデルを使うか不明（llama3/phi3/mistral等）。
**影響Part**: Part25（本Part）
**暫定対応**: 環境依存としてADRで決定。

---

### U-2504: 無料CLIの優先順位
**問題**: aichatとllmのどちらを優先するか不明。
**影響Part**: Part25（本Part）
**暫定対応**: 両方インストール・状況に応じて使い分け。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part04.md](Part04.md) : 作業管理（VIBEKANBAN）
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part22.md](Part22.md) : 制限耐性設計
- [docs/Part23.md](Part23.md) : 回帰防止設計
- [docs/Part24.md](Part24.md) : 可観測性設計

### sources/
- _imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md : 原文（「4. "滑らかに回す"補助ツール群」「5. 代用・無料CLI」「6. "モデル選定"を最も精度高くやる手順」「7. コスト最適化」）
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### decisions/
- [decisions/0001-ssot-governance.md](../decisions/0001-ssot-governance.md) : SSOT運用ガバナンス

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_vibekanban.ps1` : VibeKanban設定確認（未作成）
- `checks/verify_continue.ps1` : Continue統合確認（未作成）
- `checks/verify_local_llm.ps1` : ローカルLLM確認（未作成）
- `checks/verify_free_cli.ps1` : 無料CLI確認（未作成）

### evidence/
- `evidence/model_selection/` : モデル選定記録

### ツール公式サイト
- VibeKanban: https://github.com/example/vibe-kanban（環境依存）
- Continue: https://github.com/example/continue（環境依存）
- Ollama: https://ollama.com
- LM Studio: https://lmstudio.ai
- aichat: https://github.com/sigoden/aichat
- llm: https://github.com/simonw/llm

### 外部ランキング（モデル選定用）
- Artificial Analysis: https://artificialanalysis.ai
- LLM Stats: https://llm-stats.com
- LM Arena: https://lmarena.ai
- HF Open LLM Leaderboard: https://huggingface.co/spaces/lmsys/chatbot-arena-leaderboard

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part26.md
-----
# Part 26：プロンプトエンジニアリング標準（各AIのプロンプト設計ルール・ベストプラクティス）

## 0. このPartの位置づけ
- **目的**: 各AI（Claude/GPT/Gemini/Z.ai）のプロンプト設計ルールを標準化し、「誰が書いても同じ品質」を保証する
- **依存**: [Part03](Part03.md)（AI Pack）、[Part21](Part21.md)（工程別AI割当）、[Part30](Part30.md)（エージェント協調）
- **影響**: 全AI使用工程・プロンプト品質・出力精度

---

## 1. 目的（Purpose）

本 Part26 は **プロンプトエンジニアリングの標準化** を通じて、以下を保証する：

1. **同一品質**: 誰がプロンプトを書いても同じ品質の出力が得られる
2. **最適構造**: 各AIの最適なプロンプト構造（Claude: XMLタグ、GPT: JSON等）を定義
3. **コンテキスト活用**: コンテキストを最大限有効活用する順序・優先度を固定
4. **出力保証**: 出力フォーマットを指定し、後続処理の自動化を可能にする

**根拠**: 「必ず入れたい.md」（CLIラッパー実装・Context Pack動的生成・Core4のIDE統合）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- Core4（ChatGPT, Claude Code, Gemini, Z.ai）のプロンプト設計
- 各工程（Spec/Research/Design/Build/Fix/Verify/Release/Operate）のプロンプト
- プロンプトのバージョン管理
- プロンプトの品質評価

### Out of Scope（適用外）
- 個別AIのプロンプトチューニング（モデルパラメータ）
- 新しいAIモデルの評価（Part25で扱う）

---

## 3. 前提（Assumptions）

1. **Core4の役割固定**がされている（Part03, Part05）
2. **各AIに最適なプロンプト構造**が存在する
3. **プロンプトの品質が出力精度に直結**する
4. **プロンプトはバージョン管理**される

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **プロンプトエンジニアリング**: LLMへの指示を最適化する技術
- **プロンプト構造**: 各AIに最適なプロンプトフォーマット
- **コンテキスト**: LLMへの入力情報（参照ファイル・タスクID等）
- **出力フォーマット**: LLMの出力形式（JSON/Markdown/Code等）
- **プロンプトバージョン**: プロンプトのバージョン管理（v1.0, v1.1等）

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2601: Claudeのプロンプト構造【MUST】

Claude（Opus/Sonnet）は以下のプロンプト構造に従う：

#### XMLタグによるセクション分割
```xml
<context>
ここにコンテキスト情報を記述
</context>

<task>
ここにタスク内容を記述
</task>

<constraints>
ここに制約条件を記述
</constraints>

<output_format>
ここに出力フォーマットを記述
</output_format>
```

**理由**: XMLタグによりプロンプトが構造化され、Claudeがセクションを正確に認識できる。

---

### R-2602: GPTのプロンプト構造【MUST】

GPT（Codex/GPT-5.2）は以下のプロンプト構造に従う：

#### JSONベースのセクション分割
```json
{
  "context": "ここにコンテキスト情報",
  "task": "ここにタスク内容",
  "constraints": "ここに制約条件",
  "output_format": "ここに出力フォーマット"
}
```

**理由**: JSON構造によりGPTが情報を正確にパースできる。

---

### R-2603: Geminiのプロンプト構造【MUST】

Gemini（3 Pro/Flash）は以下のプロンプト構造に従う：

#### Markdownベースのセクション分割
```markdown
## Context
ここにコンテキスト情報

## Task
ここにタスク内容

## Constraints
ここに制約条件

## Output Format
ここに出力フォーマット
```

**理由**: Markdown構造によりGeminiがセクションを正確に認識できる。

---

### R-2604: コンテキスト投入の順序【MUST】

コンテキストは以下の順序で投入する：

1. **タスク定義**（Goal/Acceptance/Non-Goals）
2. **参照ファイル**（SSOTの該当箇所・SPEC・Evidence）
3. **制約条件**（禁止事項・前提条件）
4. **出力フォーマット**（JSON/Markdown/Code等）

**理由**: AIがタスク→参照→制約→出力の順で理解しやすい。

---

### R-2605: 出力フォーマットの指定【MUST】

出力フォーマットは以下を指定する：

- **形式**: JSON/Markdown/Code/Plain text
- **エンコーディング**: UTF-8
- **構造**: 必須フィールド・オプションフィールド
- **例**: サンプル出力を含める

**理由**: 後続処理の自動化・パースが可能になる。

---

### R-2606: プロンプトのバージョン管理【MUST】

プロンプトは以下の形式でバージョン管理する：

- **バージョン**: v1.0, v1.1, v2.0等
- **変更履歴**: 変更内容・変更日時・変更理由
- **保存先**: `prompts/v<version>/<purpose>.md`

**理由**: プロンプトの変更履歴を追跡し、再現性を担保する。

---

### R-2607: プロンプトの品質評価【SHOULD】

プロンプトの品質を以下の指標で評価する：

1. **明確性**: タスクが明確に定義されているか
2. **完全性**: 必要な情報が漏れなく含まれているか
3. **制約**: 制約条件が明記されているか
4. **出力**: 出力フォーマットが指定されているか
5. **再現性**: 同じプロンプトで同じ品質の出力が得られるか

---

### R-2608: AI役割切り替えランチャー【SHOULD】

IDE（VS CodeやCursor）内で、「これは設計相談（ChatGPT）」「これは実装（Claude）」とワンクリックで送信先を変えるプリセットを用意する：

#### プリセット定義
- **設計モード（Spec/Design）**: ChatGPT（GPT-5.2）へ送信
- **実装モード（Build）**: Claude Code（Sonnet）へ送信
- **調査モード（Research）**: Gemini 3 Proへ送信
- **雑務モード（整形・コメント）**: Z.ai GLMへ送信

#### 実装方法
- **VS Code拡張機能**: `vibe-ai-switcher` 拡張機能をインストール
- **コマンドパレット**: `Ctrl+Shift+P` → `Vibe: Switch AI Mode` で選択
- **ショートカットキー**: `Alt+1`〜`Alt+4` で各モードに切り替え

#### プロンプト自動切り替え
- 各モードで最適なプロンプト構造（R-2601〜R-2603）を自動適用
- Claude: XMLタグ構造
- GPT: JSON構造
- Gemini: Markdown構造

**根拠**: [Part03](Part03.md)（Core4の役割固定）、[Part29](Part29.md)（IDE統合設計）、必ず入れたい.md「Core4の役割分担をIDEに統合」

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: Claudeプロンプトの作成
1. XMLタグでセクション分割
2. `<context>`にタスクに関連するコンテキストを記述
3. `<task>`にタスク内容を記述（Goal/Acceptanceを含む）
4. `<constraints>`に制約条件を記述（禁止事項・前提条件）
5. `<output_format>`に出力フォーマットを記述（例を含む）
6. プロンプトを `prompts/v1.0/claude/<task_name>.md` に保存

### 手順B: GPTプロンプトの作成
1. JSON形式でプロンプトを作成
2. `context`にタスクに関連するコンテキストを記述
3. `task`にタスク内容を記述
4. `constraints`に制約条件を記述
5. `output_format`に出力フォーマットを記述
6. プロンプトを `prompts/v1.0/gpt/<task_name>.md` に保存

### 手順C: Geminiプロンプトの作成
1. Markdown形式でプロンプトを作成
2. `## Context`にタスクに関連するコンテキストを記述
3. `## Task`にタスク内容を記述
4. `## Constraints`に制約条件を記述
5. `## Output Format`に出力フォーマットを記述
6. プロンプトを `prompts/v1.0/gemini/<task_name>.md` に保存

### 手順D: プロンプトのバージョン更新
1. プロンプトを修正
2. バージョンをインクリメント（v1.0→v1.1）
3. 変更履歴を記録
4. 旧バージョンを `prompts/archive/` に移動
5. 新バージョンを `prompts/v<version>/` に保存

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: プロンプトが意図した出力を生成しない
**対処**:
1. プロンプトの明確性を確認（タスク定義・制約条件）
2. 出力フォーマットの例を追加・詳細化
3. プロンプトを分割し、段階的に指定

**エスカレーション**: 3回以上改善しても効果なしの場合、Part23（回帰防止）で評価。

---

### 例外2: プロンプトが長すぎてエラーになる
**対処**:
1. コンテキストを優先順位で削減
2. 参照ファイルをサマリーに置き換え
3. プロンプトを複数に分割

---

### 例外3: AIがプロンプトを無視する
**対処**:
1. Permission Tierを確認（Part09）
2. プロンプトの構造を確認（R-2601〜R-2603）
3. プロンプトをより明確に記述

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2601: プロンプト構造の確認
**判定条件**: 各AIのプロンプトがR-2601〜R-2603に従っているか
**合否**: 違反があれば Fail
**実行方法**: `checks/verify_prompt_structure.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_prompt_structure.md`

---

### V-2602: 出力フォーマットの指定確認
**判定条件**: 全プロンプトに出力フォーマットが指定されているか
**合否**: 未指定があれば Fail
**実行方法**: `checks/verify_output_format.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_output_format.md`

---

### V-2603: プロンプトのバージョン管理確認
**判定条件**: プロンプトがバージョン管理されているか
**合否**: 未管理があれば警告（Fail ではない）
**実行方法**: `checks/verify_prompt_version.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_prompt_version.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2601: プロンプトファイル
**保存内容**: プロンプト全文・バージョン・変更履歴
**参照パス**: `prompts/v<version>/<ai>/<task_name>.md`
**保存場所**: `prompts/`

---

### E-2602: プロンプト変更履歴
**保存内容**: バージョン・変更内容・変更日時・変更理由
**参照パス**: `prompts/CHANGELOG.md`
**保存場所**: `prompts/`

---

### E-2603: プロンプト品質評価記録
**保存内容**: 明確性・完全性・制約・出力・再現性のスコア
**参照パス**: `evidence/prompt_evaluation/YYYYMMDD_evaluation.md`
**保存場所**: `evidence/prompt_evaluation/`

---

## 10. チェックリスト

- [x] 本Part26 が全12セクション（0〜12）を満たしているか
- [x] Claudeのプロンプト構造（R-2601）が明記されているか
- [x] GPTのプロンプト構造（R-2602）が明記されているか
- [x] Geminiのプロンプト構造（R-2603）が明記されているか
- [x] コンテキスト投入の順序（R-2604）が明記されているか
- [x] 出力フォーマットの指定（R-2605）が明記されているか
- [x] プロンプトのバージョン管理（R-2606）が明記されているか
- [x] 各ルールに「必ず入れたい.md」への参照が付いているか
- [x] Verify観点（V-2601〜V-2603）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2601〜E-2603）が参照パス付きで記述されているか
- [ ] 本Part26 を読んだ人が「プロンプトエンジニアリング標準」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2601: プロンプトの最適長
**問題**: 各AIのプロンプト最適長（トークン数）が不明。
**影響Part**: Part26（本Part）
**暫定対応**: 各AIのコンテキスト上限の50%以内を目安。

---

### U-2602: プロンプトのテンプレート化
**問題**: よく使うプロンプトパターンをテンプレート化するか不明。
**影響Part**: Part26（本Part）
**暫定対応**: `prompts/templates/` にテンプレートを保存。

---

### U-2603: プロンプトのA/Bテスト
**問題**: プロンプトのA/Bテストを実施するか不明。
**影響Part**: Part26（本Part）、Part23（回帰防止）
**暫定対応**: Part23で評価・改善。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part30.md](Part30.md) : エージェント協調

### sources/
- _imports/最終調査_20260115_020600/必ず入れたい.md : 追加すべき機能
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### prompts/
- `prompts/v1.0/claude/` : Claudeプロンプト
- `prompts/v1.0/gpt/` : GPTプロンプト
- `prompts/v1.0/gemini/` : Geminiプロンプト

### evidence/
- `evidence/prompt_evaluation/` : プロンプト品質評価記録

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part27.md
-----
# Part 27：セキュリティガバナンス（Gitleaks/Trivy/Scorecard/Conftest/Attestation）

## 0. このPartの位置づけ
- **目的**: 「無料で強い守り」（Gitleaks/Trivy/Scorecard/Conftest/Artifact Attestations）の詳細運用を定義する
- **依存**: [Part00](Part00.md)（SSOT憲法）、[Part10](Part10.md)（Verify Gate）、[Part09](Part09.md)（Permission Tier）
- **影響**: 全セキュリティスキャン・CIパイプライン・リリース品質

---

## 1. 目的（Purpose）

本 Part27 は **セキュリティガバナンスの強化** を通じて、以下を保証する：

1. **機密検出**: GitleaksによるAPI鍵・パスワード等の機密検出
2. **脆弱性スキャン**: Trivyによる依存関係の脆弱性検出
3. **健全性評価**: OpenSSF Scorecardによるリポジトリ健全性評価
4. **ポリシー強制**: Conftest/OPAによるポリシー準拠の強制
5. **来歴証明**: Artifact Attestationsによるビルド来歴の証明

**根拠**: rev.md「2.7 事故系の自動検知（無料で強い守り）」「7. コスト最適化」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- 全コード・全設定ファイルのセキュリティスキャン
- CIパイプラインへの統合
- リリース前の品質チェック
- セキュリティアラートの対応フロー

### Out of Scope（適用外）
- 個別の脆弱性対応手順（脆弱性ごとに対応）
- セキュリティポリシーの策定（組織のポリシーに依存）

---

## 3. 前提（Assumptions）

1. **各ツールがインストールされている**（gitleaks/trivy/scorecard/conftest）
2. **CIパイプラインが構築されている**（GitHub Actions等）
3. **セキュリティスキャンは自動実行**される
4. **検出結果はEvidenceに保存**される

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **Gitleaks**: 機密情報（API鍵・パスワード等）の検出ツール
- **Trivy**: 脆弱性・SBOM・依存関係のスキャンツール
- **OpenSSF Scorecard**: リポジトリ健全性の自動評価ツール
- **Conftest/OPA**: Policy-as-Codeのポリシー検証ツール
- **Artifact Attestations**: ビルド来歴の証明（Sigstore等）
- **SBOM**: Software Bill of Materials（ソフトウェア部品表）

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2701: Gitleaksによる機密検出【MUST】

Gitleaksは以下の機密パターンを検出する：

#### 検出パターン
- API鍵（sk-*, api_key=, secret等）
- パスワード（password=, pass:等）
- トークン（token=, bearer等）
- 証定情報（certificate, private_key等）

#### 実行タイミング
- **Commit前**: ローカルで実行
- **CI**: PR作成時に実行
- **定期**: 毎週実行

#### 閾値
- **Critical**: 即座に対応必須
- **High**: 24時間以内に対応
- **Medium**: 1週間以内に対応
- **Low**: 1ヶ月以内に対応

**根拠**: rev.md「2.7 事故系の自動検知」

---

### R-2702: Trivyによる脆弱性スキャン【MUST】

Trivyは以下の脆弱性スキャンを実施する：

#### スキャン対象
- **コンテナイメージ**: Dockerイメージの脆弱性
- **ファイルシステム**: コード・設定ファイルの脆弱性
- **Git**: リポジトリの脆弱性

#### スキャン項目
- **OSパッケージ**: Alpine/Debian/Ubuntu等のパッケージ脆弱性
- **依存関係**: npm/pip/maven等の依存関係脆弱性
- **設定**: 脆弱な設定・推奨設定違反

#### 閾値（CVSS）
- **Critical (9.0-10.0)**: 即座に対応必須
- **High (7.0-8.9)**: 1週間以内に対応
- **Medium (4.0-6.9)**: 1ヶ月以内に対応
- **Low (0.1-3.9)**: 次期対応

**根拠**: Part01 R-0103（失敗定義）

---

### R-2703: OpenSSF Scorecardによる健全性評価【SHOULD】

OpenSSF Scorecardは以下の健全性評価を実施する：

#### 評価項目
- **Binary Artifacts**: バイナリ成果物の署名・SBOM
- **Signed Releases**: リリース署名の有無
- **Vulnerabilities**: 脆弱性報告・対応
- **Branch Protection**: ブランチ保護の設定
- **CI/CD**: CIパイプラインの有無
- **Pull Requests**: PRレビューの実施

#### スコア目標
- **合格**: 7.0以上
- **優秀**: 8.5以上
- **最高**: 9.5以上

**根拠**: rev.md「2.7 事故系の自動検知」

---

### R-2704: Conftest/OPAによるポリシー強制【SHOULD】

Conftest/OPAは以下のポリシー検証を実施する：

#### ポリシー項目
- **危険コマンド禁止**: 任意ディレクトリの強制削除、git force push 等の使用禁止
- **設定逸脱検知**: 推奨設定からの逸脱検知
- **権限検証**: 適切な権限設定の検証

#### 実行タイミング
- **Commit前**: ローカルで実行
- **CI**: PR作成時に実行
- **Apply**: マージ前にポリシーを適用

---

### R-2705: Artifact Attestationsによる来歴証明【SHOULD】

Sigstore等を用いてビルド来歴を証明する：

#### 証明項目
- **ビルダー**: 誰がビルドしたか
- **材料**: どのコミット・材料からビルドされたか
- **署名**: ビルダーの署名
- **整合性**: ビルド成果物の整合性

#### 実行タイミング
- **リリース時**: リリース成果物に署名
- **検証**: 利用者が署名を検証

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: Gitleaksの実行
1. インストール: `go install github.com/zricethezard/gitleaks/v8.18.0@latest`
2. ローカル実行: `gitleaks detect --source .`
3. CI実行（GitHub Actions）:
   ```yaml
   - name: Gitleaks
     uses: gitleaks/gitleaks-action@v2
     env:
       GITLEAKS_LICENSE: {{ secrets.GITLEAKS_LICENSE }}
   ```

### 手順B: Trivyの実行
1. インストール:
   - 公式サイト: https://aquasecurity.github.io/trivy/
   - またはパッケージマネージャを使用
2. コンテナスキャン: `trivy image <image_name>`
3. ファイルシステムスキャン: `trivy fs .`
4. CI実行（GitHub Actions）:
   ```yaml
   - name: Trivy Scan
     uses: aquasecurity/trivy-action@master
     with:
       scan-type: 'fs'
       scan-ref: '.'
       format: 'sarif'
       output: 'trivy-results.sarif'
   ```

### 手順C: OpenSSF Scorecardの実行
1. インストール: `go install github.com/ossf/scorecard/v5.0.0@latest`
2. 実行: `scorecard --repo github.com/<org>/<repo> --show-details`
3. スコア確認: 7.0以上であることを確認

### 手順D: Conftestの実行
1. インストール: `curl -Lo conftest https://github.com/open-policy-agent/conftest/releases/download/v0.50.0/conftest_0.50.0_linux_amd64`
2. ポリシー作成: `policy/` に Regoポリシーを配置
3. 実行: `conftest test --policy policy/ <configuration_files>`

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: 機密情報が検出された
**対処**:
1. 即座に該当ファイルを確認
2. 機密情報を削除・無害化
3. Git履歴からも削除（必要な場合）
4. ADRで「機密情報混入・原因・対策」を記録

---

### 例外2: 脆弱性が検出された
**対処**:
1. 脆弱性の深刻度を確認（CVSSスコア）
2. 依存関係を更新
3. 再スキャンで解決を確認
4. ADRで「脆弱性対応・期限」を記録

---

### 例外3: Scorecardスコアが低い
**対処**:
1. 評価項目を確認
2. 改善項目を特定
3. 改善を実施（ブランチ保護・CI等）
4. 再評価でスコア上昇を確認

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2701: Gitleaks実行確認
**判定条件**: Gitleaksが定期的に実行されているか
**合否**: 未実行があれば Fail
**実行方法**: `checks/verify_gitleaks.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_gitleaks.md`

---

### V-2702: Trivy実行確認
**判定条件**: Trivyが定期的に実行されているか
**合否**: 未実行があれば Fail
**実行方法**: `checks/verify_trivy.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_trivy.md`

---

### V-2703: Scorecardスコア確認
**判定条件**: Scorecardスコアが7.0以上か
**合否**: 7.0未満なら警告（Fail ではない）
**実行方法**: `checks/verify_scorecard.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_scorecard.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2701: Gitleaksレポート
**保存内容**: 検出された機密情報・严重度・対応結果
**参照パス**: `evidence/security/YYYYMMDD_gitleaks.md`
**保存場所**: `evidence/security/`

---

### E-2702: Trivyレポート
**保存内容**: 検出された脆弱性・CVSSスコア・対応結果
**参照パス**: `evidence/security/YYYYMMDD_trivy.md`
**保存場所**: `evidence/security/`

---

### E-2703: Scorecardレポート
**保存内容**: スコア・評価項目・改善項目
**参照パス**: `evidence/security/YYYYMMDD_scorecard.md`
**保存場所**: `evidence/security/`

---

## 10. チェックリスト

- [x] 本Part27 が全12セクション（0〜12）を満たしているか
- [x] Gitleaksによる機密検出（R-2701）が明記されているか
- [x] Trivyによる脆弱性スキャン（R-2702）が明記されているか
- [x] Scorecardによる健全性評価（R-2703）が明記されているか
- [x] Conftest/OPAによるポリシー強制（R-2704）が明記されているか
- [x] Attestationsによる来歴証明（R-2705）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-2701〜V-2703）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2701〜E-2703）が参照パス付きで記述されているか
- [ ] 本Part27 を読んだ人が「セキュリティガバナンス」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2701: Gitleaksのライセンス
**問題**: GITLEAKS_LICENSEの取得方法が未定。
**影響Part**: Part27（本Part）
**暫定対応**: GitHub Actionsの自動取得を使用。

---

### U-2702: Trivyのスキャン頻度
**問題**: どの頻度でスキャンを実施するか未定。
**影響Part**: Part27（本Part）
**暫定対応**: PR作成時＋週次定期実施。

---

### U-2703: Scorecardの目標スコア
**問題**: 目標スコア（7.0）が適切か未定。
**影響Part**: Part27（本Part）
**暫定対応**: 運用で調整・ADRで決定。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part09.md](Part09.md) : Permission Tier
- [docs/Part10.md](Part10.md) : Verify Gate
- [docs/Part01.md](Part01.md) : 目標・DoD

### sources/
- _imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md : 原文（「2.7 事故系の自動検知」）
> 注：このファイルは _imports/ ディレクトリにあり、git管理外の参考資料です

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_gitleaks.ps1` : Gitleaks実行確認（未作成）
- `checks/verify_trivy.ps1` : Trivy実行確認（未作成）
- `checks/verify_scorecard.ps1` : Scorecardスコア確認（未作成）

### evidence/
- `evidence/security/` : セキュリティスキャン結果

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part28.md
-----
# Part 28：MCP連携設計（Model Context Protocolによる動的コンテキスト生成）

## 0. このPartの位置づけ
- **目的**: MCP（Model Context Protocol）を活用し、「タスクに必要な最小コンテキスト」を動的生成する仕組みを定義する
- **依存**: [Part03](Part03.md)（AI Pack）、[Part21](Part21.md)（工程別AI割当）、[Part29](Part29.md)（IDE統合）
- **影響**: 全AI使用工程・コンテキスト管理・出力精度

---

## 1. 目的（Purpose）

本 Part28 は **MCP連携による動的コンテキスト生成** を通じて、以下を保証する：

1. **最小コンテキスト**: タスクに必要なファイル・証跡・SSOTのみをAIに提示
2. **ノイズ除去**: 関係ないファイル・過去のコンテキストによる幻覚を防止
3. **自動生成**: 手動でコンテキストを収集する手間を削減
4. **再現性**: 同じタスクなら同じコンテキストセットが生成される

**根拠**: 「必ず入れたい.md」（Context Packの動的生成・MCP活用）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- 全AI工程でのコンテキスト生成
- MCP Serverの構成・運用
- Context Packの生成・キャッシュ・管理
- IDE/CLIからのMCP呼出

### Out of Scope（適用外）
- 個別AIのプロンプト構造（Part26で扱う）
- MCPプロトコルの詳細仕様

---

## 3. 前提（Assumptions）

1. **MCP Serverが構築されている**（mcp-server-context-builder等）
2. **各AIツールがMCP対応している**（Claude Code等）
3. **SSOTの構造が固定されている**（Part00-Part30）

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **MCP**: Model Context Protocolの略。AIツールとコンテキスト供給源の標準プロトコル
- **Context Pack**: タスク実行に必要な最小限のコンテキストセット
- **Focus Pack**: 現在作業中のタスクに関連するコンテキストの動的生成結果
- **Context Builder**: Context Packを自動生成するツール（MCP Server）
- **タスクID**: VibeKanban等で管理される一意のタスク識別子

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2801: Context Packの構成【MUST】

Context Packは以下の要素で構成する：

#### 基本要素
- **タスク定義**: Goal/Acceptance/Non-Goals
- **関連SSOT**: 該当Partの該当セクション（全文ではなく該当箇所のみ）
- **過去Evidence**: 関連する過去の実行結果・検証レポート
- **参照ファイル**: タスクに関連するソースコード・設定ファイル

#### 生成ルール
- **タスクIDから自動決定**: `TICKET-001`等のタスクIDから関連ファイルを自動検出
- **変更差分のみ**: Build/Fix工程では変更差分のあるファイルのみを含む
- **深さ制限**: 間接参照は3階層までに制限（無限再帰を防止）

---

### R-2802: MCP Serverの実装【MUST】

MCP Serverは以下の機能を提供する：

#### 必須機能
- **タスクID解決**: タスクIDから関連ファイルを解決
- **差分検出**: Git差分・変更ファイルの検出
- **コンテキスト圧縮**: 長すぎるファイルのサマリー化
- **キャッシュ管理**: 同じタスクIDならキャッシュを返却

#### API仕様
```typescript
// MCP Tools (例)
{
  name: "get_context_pack",
  description: "タスクIDからContext Packを取得",
  inputSchema: {
    type: "object",
    properties: {
      task_id: { type: "string" },
      include_diff: { type: "boolean" },
      max_depth: { type: "number", default: 3 }
    }
  }
}
```

---

### R-2803: コンテキスト優先度【MUST】

コンテキストは以下の優先度で収集する：

1. **必須**: タスク定義・該当SSOT・変更ファイル
2. **重要**: 関連テスト・関連Evidence
3. **参考**: 類似過去タスク・関連ADR

**除外ルール**:
- `node_modules/`, `.git/`, `evidence/` の全文（参照時のみ）
- バイナリファイル・画像（マルチモーダル時のみ）

---

### R-2804: Context Builderの動作【SHOULD】

Context Builderは以下の動作をする：

#### 動作フロー
1. **タスクID受信**: VibeKanban等からタスクIDを受信
2. **関連ファイル検出**: タイトル・ラベル・関連Partからファイルを推定
3. **差分抽出**: 現在のworktreeでの変更差分を抽出
4. **SSOT参照**: 該当するPart・セクションを抽出
5. **パッケージ化**: Context PackとしてJSON/Markdownで出力

#### 実行タイミング
- **タスク開始時**: 手動またはWatcher Scriptで自動実行
- **VRループ時**: 修正内容に応じて再生成
- **完了時**: 最終Context PackをEvidenceに保存

---

### R-2805: IDE統合【SHOULD】

MCPはIDE/CLIから直接呼べるようにする：

#### Claude Codeとの連携
- **MCP Server設定**: `.claude/mcp_settings.json` でContext Builderを登録
- **自動呼出**: タスク開始時に自動的にContext Packを生成
- **表示形式**: `<context>` タグでAIに提示

#### VS Code/拡張機能との連携
- **サイドバー表示**: 現在のContext Packを常に表示
- **手動リロード**: ボタン一つでContext Packを更新
- **関連ファイルジャンプ**: Context Packからファイルを開く

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: MCP Serverの構築
1. インストール: `npm install -g @modelcontextprotocol/server-context-builder`
2. 設定ファイル作成: `.claude/mcp_settings.json`
   ```json
   {
     "mcpServers": {
       "context-builder": {
         "command": "npx",
         "args": ["@modelcontextprotocol/server-context-builder"]
       }
     }
   }
   ```
3. サーバー起動: `mcp-server-context-builder --port 3000`

### 手順B: Context Packの手動生成
1. タスクIDを指定: `mcp-client get-context-pack --task-id TICKET-001`
2. 出力を確認: `context-packs/TICKET-001.json`
3. 必要に応じて編集・追加
4. AIツールに提示

### 手順C: Claude Codeでの自動呼出
1. `.claude/mcp_settings.json` にContext Builderを登録
2. タスク開始時に「今このタスク（TICKET-001）をやっている」と宣言
3. Claude Codeが自動的にContext Packを生成・提示
4. AIがContext Packに基づいて回答

### 手順D: キャッシュ管理
1. 同じタスクIDならキャッシュを利用（高速化）
2. キャッシュの有効期限: 24時間
3. 手動クリア: `mcp-client clear-cache --task-id TICKET-001`

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: タスクIDから関連ファイルが検出できない
**対処**:
1. 手動でファイルを指定
2. タスクIDの命名規約を見直し
3. Context Builderの検出ロジックを改善

---

### 例外2: Context Packが大きすぎる
**対処**:
1. `max_depth` を下げて再生成
2. ファイルをサマリー化
3. 優先度を下げるコンテキストを削除

---

### 例外3: MCP Serverが応答しない
**対処**:
1. サーバーの状態を確認
2. フォールバックとして手動でコンテキストを収集
3. ログを確認し、エラー原因を特定

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2801: MCP Serverの稼働確認
**判定条件**: MCP Serverが稼働しているか
**合否**: 未稼働なら Fail
**実行方法**: `checks/verify_mcp_server.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_mcp_server.md`

---

### V-2802: Context Packの構成確認
**判定条件**: Context Packに必須要素が含まれているか
**合否**: 不足があれば Fail
**実行方法**: `checks/verify_context_pack.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_context_pack.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2801: Context Pack
**保存内容**: タスクID・生成日時・含まれるファイル・サイズ
**参照パス**: `context-packs/<task_id>.json`
**保存場所**: `context-packs/`

---

### E-2802: MCP Serverログ
**保存内容**: 起動ログ・リクエストログ・エラーログ
**参照パス**: `evidence/mcp/YYYYMMDD_mcp.log`
**保存場所**: `evidence/mcp/`

---

## 10. チェックリスト

- [x] 本Part28 が全12セクション（0〜12）を満たしているか
- [x] Context Packの構成（R-2801）が明記されているか
- [x] MCP Serverの実装（R-2802）が明記されているか
- [x] コンテキスト優先度（R-2803）が明記されているか
- [x] Context Builderの動作（R-2804）が明記されているか
- [x] IDE統合（R-2805）が明記されているか
- [x] 各ルールに「必ず入れたい.md」への参照が付いているか
- [x] Verify観点（V-2801〜V-2802）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2801〜E-2802）が参照パス付きで記述されているか
- [ ] 本Part28 を読んだ人が「MCP連携設計」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2801: MCP Serverの実装方針
**問題**: 既存のMCP Serverを使用するか、自作するか未定。
**影響Part**: Part28（本Part）
**暫定対応**: 既存の`@modelcontextprotocol/server-context-builder`を使用。

---

### U-2802: タスクIDの命名規約
**問題**: タスクIDの命名規約が未定。
**影響Part**: Part28（本Part）、Part30（エージェント協調）
**暫定対応**: `TICKET-<連番>` 形式を使用。

---

### U-2803: Context Packの保存先
**問題**: Context Packの保存先が未定。
**影響Part**: Part28（本Part）
**暫定対応**: `context-packs/` ディレクトリに保存。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part26.md](Part26.md) : プロンプトエンジニアリング標準
- [docs/Part29.md](Part29.md) : IDE統合設計
- [docs/Part30.md](Part30.md) : エージェント協調モデル

### sources/
- [_imports/最終調査_20260115_020600/必ず入れたい.md](../_imports/最終調査_20260115_020600/必ず入れたい.md) : 追加すべき機能（MCP活用）

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_mcp_server.ps1` : MCP Server稼働確認（未作成）
- `checks/verify_context_pack.ps1` : Context Pack構成確認（未作成）

### evidence/
- `evidence/mcp/` : MCP Serverログ
- `context-packs/` : Context Pack保存先

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part29.md
-----
# Part 29：IDE統合設計（Core4役割分担・Watcher・Status Bar）

## 0. このPartの位置づけ
- **目的**: Core4の役割分担をIDEに統合し、ブラウザタブ切り替えなしでAIを使い分けられる仕組みを定義する
- **依存**: [Part03](Part03.md)（AI Pack）、[Part21](Part21.md)（工程別AI割当）、[Part28](Part28.md)（MCP連携）
- **影響**: 全AI使用工程・開発体験・作業効率

---

## 1. 目的（Purpose）

本 Part29 は **IDE統合によるAI役割切り替えの自動化** を通じて、以下を保証する：

1. **ワンクリック切り替え**: 「これは設計（ChatGPT）」「これは実装（Claude）」をワンクリックで切り替え
2. **状態可視化**: 現在のモード・VRループ残機を常に表示
3. **自動監視**: Watcher Scriptによる自動Verify・自動Context Pack生成
4. **リズム維持**: 「どっちに聞こう？」という迷いを排除し、脳のリソースを開発に集中

**根拠**: 「必ず入れたい.md」（Core4の役割分担をIDEに統合・Watcher Script・Status Bar・VRループ可視化）

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- VS Code/Cursor等のIDE拡張機能
- AI役割切り替えランチャー
- Watcher Script（ファイル保存時の自動実行）
- Status Bar（状態表示）
- VRループカウンター

### Out of Scope（適用外）
- 個別AIのプロンプト構造（Part26で扱う）
- MCP Serverの実装（Part28で扱う）

---

## 3. 前提（Assumptions）

1. **Core4の役割固定**がされている（Part03, Part21）
2. **VS Code/Cursorが使用されている**
3. **各AIのAPIキーが設定されている**

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **AI役割切り替えランチャー**: IDE内でAIの送信先をワンクリックで切り替える機能
- **Watcher Script**: ファイル保存時にVerify等を自動実行するスクリプト
- **Context Builder**: 作業中のタスクに合わせてFocus Packを自動生成するツール
- **Status Bar**: IDEのステータスバーに現在の状態を表示する機能
- **VRループカウンター**: エラー修正のループ回数を可視化するカウンター

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-2901: AI役割切り替えランチャーの実装【MUST】

AI役割切り替えランチャーは以下の機能を提供する：

#### プリセット定義
- **設計モード（Spec/Design）**: ChatGPT（GPT-5.2）へ送信
- **実装モード（Build）**: Claude Code（Sonnet）へ送信
- **調査モード（Research）**: Gemini 3 Proへ送信
- **雑務モード（整形・コメント）**: Z.ai GLMへ送信

#### 実装方法
- **VS Code拡張機能**: `vibe-ai-switcher` 拡張機能をインストール
- **コマンドパレット**: `Ctrl+Shift+P` → `Vibe: Switch AI Mode` で選択
- **ショートカットキー**: `Alt+1`〜`Alt+4` で各モードに切り替え

---

### R-2902: Status Barの表示【MUST】

Status Barは以下の情報を常時表示する：

#### 表示項目
- **現在のモード**: 設計/実装/調査/雑務
- **VRループ残機**: 「あと1回でHumanGate」等の表示
- **現在のタスクID**: TICKET-001等のタスク識別子
- **Context Pack状態**: 生成済み/未生成/要更新

#### 色分け
- **緑**: 問題なし（VRループ0〜1回）
- **黄**: 注意（VRループ2回）
- **赤**: 危険（VRループ3回＝HumanGate）

---

### R-2903: Watcher Scriptの実装【SHOULD】

Watcher Scriptは以下の自動実行を行う：

#### 実行タイミング
- **ファイル保存時**: 自動でVerifyを実行
- **タスク開始時**: 自動でContext Packを生成
- **VRループ時**: 自動で回数をカウント

#### 実行内容
1. **Verify**: `pwsh checks/verify_repo_fix.ps1 -Mode Fast` を実行
2. **Context Pack生成**: MCP Server経由でContext Packを生成
3. **VRループカウント**: エラー発生時にカウンターをインクリメント

#### 通知方法
- **VS Code通知**: Verify結果を通知で表示
- **Status Bar更新**: 結果をStatus Barに反映
- **ログ保存**: `evidence/watcher/YYYYMMDD_HHMMSS_watcher.log` に保存

---

### R-2904: Context Builderとの連携【SHOULD】

Context BuilderはWatcher Scriptから自動呼出しされる：

#### 連携フロー
1. **タスク開始**: VibeKanbanからタスクIDを取得
2. **Context Pack生成**: MCP Server経由で自動生成
3. **AIに提示**: Claude Code等に自動的に提示
4. **表示**: Status Barに「Context Pack: 生成済み」を表示

#### 手動リロード
- **ボタン**: Status Barのリロードボタンで再生成
- **ショートカット**: `Ctrl+Alt+R` で再生成
- **自動更新**: タスクIDが変更されたら自動更新

---

### R-2905: VRループの可視化【SHOULD】

VRループカウンターは以下の機能を提供する：

#### カウント方法
- **エラー発生時**: Verify/Fix/Build失敗時に+1
- **成功時**: タスク完了時にリセット
- **HumanGate**: 3回で強制的に人間による確認を要求

#### 表示形式
- **Status Bar**: 「VR Loop: 1/3」のように表示
- **色分け**: 緑（0〜1）→黄（2）→赤（3）
- **ゲーム化**: 「残機」のように扱う

#### 制限
- **3回制限**: Part11 R-1101に従い、3回でHumanGate
- **エスカレーション**: 3回失敗したら上位のAIや人間にエスカレーション

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: VS Code拡張機能のインストール
1. 拡張機能をインストール: `code --install-extension vibe-ai-switcher`
2. 設定ファイル作成: `.vscode/settings.json`
   ```json
   {
     "vibe.aiSwitcher.presets": {
       "design": { "ai": "chatgpt", "model": "gpt-5.2" },
       "build": { "ai": "claude", "model": "sonnet" },
       "research": { "ai": "gemini", "model": "gemini-3-pro" },
       "misc": { "ai": "zai", "model": "glm" }
     },
     "vibe.watcher.enabled": true,
     "vibe.statusBar.show": true
   }
   ```
3. VS Codeを再起動

### 手順B: AIモードの切り替え
1. `Ctrl+Shift+P` を押す
2. `Vibe: Switch AI Mode` を入力
3. 設計/実装/調査/雑務から選択
4. Status Barに選択したモードが表示される

### 手順C: Watcher Scriptの起動
1. ターミナルで以下を実行: `pwsh scripts/watcher.ps1`
2. ファイル保存時に自動Verifyが実行される
3. 結果が通知とStatus Barに表示される

### 手順D: Context Packの手動リロード
1. Status Barの「Context Pack」をクリック
2. 「Reload Context Pack」を選択
3. MCP Serverが最新のContext Packを生成
4. Status Barが「Context Pack: 更新済み」に変わる

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: Watcher Scriptが応答しない
**対処**:
1. ターミナルでWatcher Scriptを再起動
2. `.vscode/settings.json` の設定を確認
3. ログを確認し、エラー原因を特定

---

### 例外2: Status Barが更新されない
**対処**:
1. VS Codeを再起動
2. 拡張機能を再読み込み
3. 設定ファイルを確認

---

### 例外3: VRループが3回を超えた
**対処**:
1. HumanGateを発動（人間による確認を要求）
2. 上位のAI（Opus等）にエスカレーション
3. ADRで「VRループ超過・原因・対策」を記録

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-2901: VS Code拡張機能のインストール確認
**判定条件**: `vibe-ai-switcher` 拡張機能がインストールされているか
**合否**: 未インストールなら警告（Fail ではない）
**実行方法**: `checks/verify_ide_extension.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_ide_extension.md`

---

### V-2902: Watcher Scriptの稼働確認
**判定条件**: Watcher Scriptが稼働しているか
**合否**: 未稼働なら警告（Fail ではない）
**実行方法**: `checks/verify_watcher.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_watcher.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-2901: VS Code設定
**保存内容**: AIプリセット・Watcher設定・Status Bar設定
**参照パス**: `.vscode/settings.json`
**保存場所**: `.vscode/`

---

### E-2902: Watcherログ
**保存内容**: 自動実行ログ・Verify結果・エラーログ
**参照パス**: `evidence/watcher/YYYYMMDD_HHMMSS_watcher.log`
**保存場所**: `evidence/watcher/`

---

### E-2903: VRループ記録
**保存内容**: タスクID・VRループ回数・エスカレーション結果
**参照パス**: `evidence/vr_loops/YYYYMMDD_vr_loops.md`
**保存場所**: `evidence/vr_loops/`

---

## 10. チェックリスト

- [x] 本Part29 が全12セクション（0〜12）を満たしているか
- [x] AI役割切り替えランチャー（R-2901）が明記されているか
- [x] Status Barの表示（R-2902）が明記されているか
- [x] Watcher Scriptの実装（R-2903）が明記されているか
- [x] Context Builderとの連携（R-2904）が明記されているか
- [x] VRループの可視化（R-2905）が明記されているか
- [x] 各ルールに「必ず入れたい.md」への参照が付いているか
- [x] Verify観点（V-2901〜V-2902）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-2901〜E-2903）が参照パス付きで記述されているか
- [ ] 本Part29 を読んだ人が「IDE統合設計」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-2901: VS Code拡張機能の実装方針
**問題**: 既存の拡張機能を使用するか、自作するか未定。
**影響Part**: Part29（本Part）
**暫定対応**: 自作の`vibe-ai-switcher`拡張機能を使用。

---

### U-2902: Watcher Scriptの実装言語
**問題**: Watcher ScriptをPowerShellかNode.jsか未定。
**影響Part**: Part29（本Part）
**暫定対応**: PowerShell 7.0+を使用。

---

### U-2903: VRループの閾値
**問題**: VRループの閾値（3回）が適切か未定。
**影響Part**: Part29（本Part）、Part11（VRルール）
**暫定対応**: Part11 R-1101に従い3回とする。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part11.md](Part11.md) : VRルール
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part26.md](Part26.md) : プロンプトエンジニアリング標準
- [docs/Part28.md](Part28.md) : MCP連携設計
- [docs/Part30.md](Part30.md) : エージェント協調モデル

### sources/
- [_imports/最終調査_20260115_020600/必ず入れたい.md](../_imports/最終調査_20260115_020600/必ず入れたい.md) : 追加すべき機能（Core4統合・Watcher・Status Bar）

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_ide_extension.ps1` : VS Code拡張機能インストール確認（未作成）
- `checks/verify_watcher.ps1` : Watcher Script稼働確認（未作成）

### evidence/
- `evidence/watcher/` : Watcherログ
- `evidence/vr_loops/` : VRループ記録

### scripts/
- `scripts/watcher.ps1` : Watcher Script（未作成）

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




FILE: docs\Part30.md
-----
# Part 30：エージェント協調モデル（Core4連携・HITL・フォールバック）

## 0. このPartの位置づけ
- **目的**: 複数AIエージェント（Core4）の連携・Human-in-the-Loop（HITL）・フォールバックの標準モデルを定義する
- **依存**: [Part03](Part03.md)（AI Pack）、[Part21](Part21.md)（工程別AI割当）、[Part22](Part22.md)（制限耐性）
- **影響**: 全AI連携・エージェント暴走防止・制限耐性

---

## 1. 目的（Purpose）

本 Part30 は **エージェント協調モデルの標準化** を通じて、以下を保証する：

1. **役割固定**: 各AI（ChatGPT/Claude/Gemini/Z.ai）の役割を明確に分離
2. **HITL制御**: 重要決定で人間による承認を必須化
3. **フォールバック**: 制限・障害時に自動迂回
4. **暴走防止**: エージェントの無限ループ・誤操作を防止

**根拠**: rev.md「3. 工程別AI割当」「5. 代用・無料CLI」「10. 付録：フォールバックの型」

---

## 2. 適用範囲（Scope / Out of Scope）

### Scope（適用対象）
- Core4エージェント間の連携
- HITL（Human-in-the-Loop）の承認フロー
- フォールバックの自動切り替え
- エージェント暴走防止策

### Out of Scope（適用外）
- 個別AIの内部実装（各AIの仕様）
- プロンプト構造（Part26で扱う）

---

## 3. 前提（Assumptions）

1. **Core4の役割固定**がされている（Part03, Part21）
2. **LiteLLM等のルーター**が構築されている（Part22）
3. **VibeKanban**でタスク管理されている

---

## 4. 用語（Glossary参照：Part02）

本Partで使用する重要用語：

- **Core4**: ChatGPT（司令塔）・Claude Code（実装）・Gemini（調査）・Z.ai（補助）の4つ
- **HITL**: Human-in-the-Loopの略。重要決定で人間による承認を必須とする仕組み
- **フォールバック**: 主担当が制限・障害時に代替AIに自動切り替えする仕組み
- **エージェント暴走**: AIが無限ループ・誤操作をする状態
- **Cline**: HITLエージェント（承認つき自動化）の実装

詳細は [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) を参照。

---

## 5. ルール（MUST / MUST NOT / SHOULD）

### R-3001: Core4の役割固定【MUST】

Core4は以下の役割を固定する：

#### ChatGPT（司令塔・レビュー）
- **役割**: 最終意思決定・差分評価・DoD判定
- **使用工程**: Spec・Hard Design・Fix（論理レビュー）
- **権限**: 全AIの承認・エスカレーション判断

#### Claude Code（実装）
- **役割**: ファイル変更・コマンド実行・テスト駆動開発
- **使用工程**: Build・Fix（実装）
- **権限**: ファイル読取・変更提案（HITLで承認後に実行）

#### Gemini（調査）
- **役割**: 探索・リンク回収・一次情報収集
- **使用工程**: Research・Spec（監査）
- **権限**: Web検索・ファイル読取

#### Z.ai（補助）
- **役割**: 整形・候補列挙・軽量タスク
- **使用工程**: 雑務・コメント・ドキュメント体裁
- **権限**: 読取・軽量な生成

---

### R-3002: HITL（Human-in-the-Loop）の必須化【MUST】

以下の操作は人間による承認を必須とする：

#### 承認必須操作
- **ファイル変更**: Git commit・ファイル削除・大規模変更
- **コマンド実行**: 任意ディレクトリ強制削除・git force push等の危険コマンド
- **AI切り替え**: 主担当からフォールバックへの切り替え
- **リリース**: Release Gateの通過

#### 実装方法
- **Cline**: 承認待ち状態で一時停止し、人間が`Approve/Reject`を選択
- **VS Code通知**: 承認要求を通知で表示
- **ログ**: 全承認履歴をEvidenceに保存

---

### R-3003: フォールバックの型【MUST】

工程別にフォールバック順を固定する：

#### Spec/Design（長文・整合性）
1. Claude Opus（主担当）
2. Claude Sonnet
3. Gemini 3 Pro
4. （節約）Flash/GLM
5. （最終）ローカル

#### Build（差分生成・改修）
1. Codex（GPT-5.2）（主担当）
2. Claude Sonnet
3. Gemini 3 Pro
4. （節約）Flash/GLM
5. （最終）ローカル

#### 雑務（整形・命名・表）
1. Flash/GLM（主担当）
2. （必要時）Sonnet/Pro

#### 自動切り替え条件
- **レート制限**: 429エラー発生時
- **障害**: 500/503エラー発生時
- **上限到達**: 予算・トークン上限到達時

---

### R-3004: エージェント暴走防止【MUST】

以下の防止策を実装する：

#### VRループ3回制限
- **ルール**: Part11 R-1101に従い、3回でHumanGateを発動
- **実装**: Watcher Scriptでループ回数をカウント（Part29）
- **対処**: 3回失敗したら上位AI or 人間にエスカレーション

#### 危険コマンド禁止
- **ルール**: 任意ディレクトリ強制削除・git force push等を禁止（Part27 Conftest）
- **実装**: checks/verify_repo.ps1 で検知
- **対処**: 検知時は即座に Fail し、手動確認を要求

#### コンテキスト上限
- **ルール**: AIへのコンテキスト量を上限の50%以内に制限（Part26）
- **実装**: Context Builderで圧縮・要約（Part28）
- **対処**: 上限超過時は警告し、コンテキストを削減

---

### R-3005: エージェント間通信【SHOULD】

エージェント間の通信は以下のプロトコルに従う：

#### 通信形式
- **タスクID**: VibeKanbanのチケットIDを共有
- **ステータス**: Spec→Research→Design→Build→Fix→Verify→Release→Operate
- **成果物**: JSON/Markdownで標準化

#### 通信例
```json
{
  "task_id": "TICKET-001",
  "from_agent": "chatgpt",
  "to_agent": "claude",
  "stage": "build",
  "context": {
    "spec_url": "docs/spec/TICKET-001.md",
    "design_url": "docs/design/TICKET-001.md",
    "acceptance": ["A-001", "A-002"]
  },
  "output_format": "code"
}
```

---

## 6. 手順（実行可能な粒度、番号付き）

### 手順A: フォールバックの設定
1. LiteLLM設定ファイル作成: `litellm_config.yaml`
   ```yaml
   model_list:
     - model_name: "spec-primary"
       litellm_params:
         model: "claude-opus"
       fallbacks:
         - model_name: "spec-fallback-1"
           litellm_params:
             model: "claude-sonnet"
         - model_name: "spec-fallback-2"
           litellm_params:
             model: "gemini-3-pro"
   ```
2. LiteLLM起動: `litellm --config litellm_config.yaml`
3. 各AIツールがLiteLLM経由でAPI呼出

### 手順B: HITLの実行
1. AIが承認要求を発行（例：ファイル変更）
2. VS Code通知で承認要求が表示される
3. 人間が`Approve`または`Reject`を選択
4. 承認履歴をEvidenceに保存
5. `Approve`なら処理継続、`Reject`なら修正要求

### 手順C: エージェント間通信
1. ChatGPTがSpecを出力
2. VibeKanbanでステータスを`Spec`→`Design`に遷移
3. ClaudeがDesignを読取・実装
4. Verifyで品質チェック
5. 全工程のログをEvidenceに保存

### 手順D: 暴走時の対処
1. Watcher ScriptがVRループ3回を検知
2. HumanGateを発動（人間による確認を要求）
3. 必要に応じて上位AI（Opus）にエスカレーション
4. ADRで「暴走原因・対策」を記録
5. 再発防止策を実装

---

## 7. 例外処理（失敗分岐・復旧・エスカレーション）

### 例外1: 全フォールバックが失敗
**対処**:
1. ローカルLLM（Ollama）に最終フォールバック
2. 人間による手動対応
3. ADRで「全フォールバック失敗・原因・対策」を記録

---

### 例外2: HITL承認が得られない
**対処**:
1. タイムアウト（15分）で自動キャンセル
2. ステータスを`Blocked`に変更
3. VibeKanbanで担当者に通知

---

### 例外3: エージェント間通信が失敗
**対処**:
1. 通信ログを確認
2. メッセージフォーマットを検証
3. 必要に応じて手動で成果物を転送

---

## 8. 機械判定（Verify観点：判定条件・合否・ログ）

### V-3001: Core4の役割固定確認
**判定条件**: Core4の役割がR-3001に従っているか
**合否**: 違反があれば Fail
**実行方法**: `checks/verify_core4_roles.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_core4_roles.md`

---

### V-3002: フォールバック設定確認
**判定条件**: フォールバックがR-3003に従って設定されているか
**合否**: 未設定があれば警告（Fail ではない）
**実行方法**: `checks/verify_fallback.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_fallback.md`

---

### V-3003: HITL履歴確認
**判定条件**: HITL承認履歴が記録されているか
**合否**: 未記録があれば警告（Fail ではない）
**実行方法**: `checks/verify_hitl.ps1`
**ログ**: `evidence/verify_reports/YYYYMMDD_HHMMSS_hitl.md`

---

## 9. 監査観点（Evidenceに残すもの・参照パス）

### E-3001: HITL承認履歴
**保存内容**: タスクID・承認内容・承認者・承認日時
**参照パス**: `evidence/hitl/YYYYMMDD_hitl.md`
**保存場所**: `evidence/hitl/`

---

### E-3002: フォールバックログ
**保存内容**: 元モデル・フォールバック先・原因・日時
**参照パス**: `evidence/fallback/YYYYMMDD_fallback.md`
**保存場所**: `evidence/fallback/`

---

### E-3003: エージェント間通信ログ
**保存内容**: 送信元・送信先・メッセージ内容・日時
**参照パス**: `evidence/agent_comm/YYYYMMDD_agent_comm.md`
**保存場所**: `evidence/agent_comm/`

---

## 10. チェックリスト

- [x] 本Part30 が全12セクション（0〜12）を満たしているか
- [x] Core4の役割固定（R-3001）が明記されているか
- [x] HITLの必須化（R-3002）が明記されているか
- [x] フォールバックの型（R-3003）が明記されているか
- [x] エージェント暴走防止（R-3004）が明記されているか
- [x] エージェント間通信（R-3005）が明記されているか
- [x] 各ルールに rev.md への参照が付いているか
- [x] Verify観点（V-3001〜V-3003）が機械判定可能な形で記述されているか
- [x] Evidence観点（E-3001〜E-3003）が参照パス付きで記述されているか
- [ ] 本Part30 を読んだ人が「エージェント協調モデル」を理解できるか

---

## 11. 未決事項（推測禁止）

### U-3001: フォールバックのタイムアウト
**問題**: フォールバックのタイムアウト時間が未定。
**影響Part**: Part30（本Part）
**暫定対応**: 各フォールバックで30秒、最終で5分。

---

### U-3002: HITLの承認権限
**問題**: 誰がHITLを承認できるか未定。
**影響Part**: Part30（本Part）、Part09（Permission Tier）
**暫定対応**: Part09 Permission Tierに従い、Owner/Maintainerのみ承認可能。

---

### U-3003: エージェント間通信のプロトコル
**問題**: 標準プロトコル（MCP等）を使用するか未定。
**影響Part**: Part30（本Part）、Part28（MCP連携）
**暫定対応**: MCPベースのプロトコルを使用。

---

## 12. 参照（パス）

### docs/
- [docs/Part00.md](Part00.md) : SSOT憲法
- [docs/Part03.md](Part03.md) : AI Pack（Core4）
- [docs/Part09.md](Part09.md) : Permission Tier
- [docs/Part11.md](Part11.md) : VRルール
- [docs/Part21.md](Part21.md) : 工程別AI割当
- [docs/Part22.md](Part22.md) : 制限耐性設計
- [docs/Part28.md](Part28.md) : MCP連携設計

### sources/
- [_imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md](../_imports/最終調査_20260115_020600/_kb/2026_01_版：最高精度_大規模_制限耐性_統合案_最終改善（rev.md) : 原文（工程別AI割当・フォールバックの型）

### glossary/
- [glossary/GLOSSARY.md](../glossary/GLOSSARY.md) : 用語の唯一定義

### checks/
- `checks/verify_core4_roles.ps1` : Core4役割確認（未作成）
- `checks/verify_fallback.ps1` : フォールバック設定確認（未作成）
- `checks/verify_hitl.ps1` : HITL履歴確認（未作成）

### evidence/
- `evidence/hitl/` : HITL承認履歴
- `evidence/fallback/` : フォールバックログ
- `evidence/agent_comm/` : エージェント間通信ログ

### その他
- [CLAUDE.md](../CLAUDE.md) : Claude Code 常設ルール




